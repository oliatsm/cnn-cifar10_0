# Loop optimizations in Conv_forward

50k images
Data on Device (O1,O3,O4,O6,O7, inputs, conv_layer)
Parallel - independent

## no loop opt

### code

### εκτελεση
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.014320 seconds
Create Network time:0.041002 seconds
Load Network Parameters time:0.008329 seconds
Create Ouputs time:0.000344 seconds

Net Forward total time:156.987069 seconds
    Time for conv1: 81.751137 seconds
    Time for relu1: 0.465725 seconds
    Time for pool1: 1.990362 seconds
    Time for conv2: 51.973828 seconds
    Time for relu2: 0.163996 seconds
    Time for pool2: 0.631269 seconds
    Time for conv3: 16.449615 seconds
    Time for relu3: 0.043113 seconds
    Time for pool3: 0.160235 seconds
    Time for fc: 0.213161 seconds
    Time for softmax: 0.012494 seconds

  Conv: 150.174580 seconds
  ReLU: 0.672833 seconds
  Pool: 2.781866 seconds
  FC:   0.213161 seconds
  Softmax: 0.012494 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001453 seconds
Free memory time:0.053949 seconds
Total time:158.106466 seconds
```

### Profiling

#### nvprof
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2238168== NVPROF is profiling process 2238168, command: ./cnn-cifar10-profile
Load Data time:1.357389 seconds
Create Network time:0.040419 seconds
Load Network Parameters time:0.008640 seconds
Create Ouputs time:0.000363 seconds

Net Forward total time:161.559177 seconds
    Time for conv1: 82.832080 seconds
    Time for relu1: 0.668755 seconds
    Time for pool1: 1.546140 seconds
    Time for conv2: 53.059061 seconds
    Time for relu2: 0.208821 seconds
    Time for pool2: 0.509127 seconds
    Time for conv3: 17.447760 seconds
    Time for relu3: 0.058472 seconds
    Time for pool3: 0.130219 seconds
    Time for fc: 0.216421 seconds
    Time for softmax: 0.015124 seconds

  Conv: 153.338901 seconds
  ReLU: 0.936048 seconds
  Pool: 2.185486 seconds
  FC:   0.216421 seconds
  Softmax: 0.015124 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001552 seconds
Free memory time:0.054238 seconds
Total time:163.021778 seconds
END!
==2238168== Profiling application: ./cnn-cifar10-profile
==2238168== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   99.13%  147.485s    150000  983.23us  309.47us  1.7999ms  _8layers_c_conv_forward_79_gpu
                    0.36%  533.41ms    150000  3.5560us  2.8800us  13.600us  _8layers_c_pad_input_60_gpu
                    0.30%  446.58ms    150000  2.9770us  1.3750us  18.432us  [CUDA memcpy DtoH]
                    0.21%  316.82ms    100031  3.1670us     640ns  138.87ms  [CUDA memcpy HtoD]
                    0.00%  2.8480us         1  2.8480us  2.8480us  2.8480us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   96.77%  149.738s    850015  176.16us     587ns  4.3312ms  cuStreamSynchronize
                    1.68%  2.59277s    150000  17.285us  10.315us  2.0484ms  cuMemcpyDtoHAsync
                    0.82%  1.27523s    300001  4.2500us  3.4240us  2.0429ms  cuLaunchKernel
                    0.44%  681.63ms    100031  6.8140us  2.8770us  139.07ms  cuMemcpyHtoDAsync
                    0.11%  172.99ms    600000     288ns     176ns  723.49us  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.11%  168.27ms         1  168.27ms  168.27ms  168.27ms  cuDevicePrimaryCtxRetain
                    0.03%  45.168ms    300010     150ns     116ns  16.790us  cuDeviceGetAttribute
                    0.03%  39.951ms         1  39.951ms  39.951ms  39.951ms  cuMemHostAlloc
                    0.01%  19.069ms     50019     381ns     224ns  777.48us  cuPointerGetAttributes
                    0.00%  3.6739ms        20  183.70us  2.0040us  3.1676ms  cuMemAlloc
                    0.00%  2.1350ms         1  2.1350ms  2.1350ms  2.1350ms  cuMemAllocHost
                    0.00%  557.52us         2  278.76us  115.25us  442.27us  cuModuleLoadDataEx
                    0.00%  10.895us         1  10.895us  10.895us  10.895us  cuDeviceGetPCIBusId
                    0.00%  10.350us         4  2.5870us     381ns  7.6750us  cuModuleGetFunction
                    0.00%  3.2930us         3  1.0970us     205ns  1.9520us  cuCtxSetCurrent
                    0.00%  1.2060us         3     402ns     173ns     858ns  cuDeviceGetCount
                    0.00%     820ns         3     273ns     122ns     490ns  cuDriverGetVersion
                    0.00%     553ns         1     553ns     553ns     553ns  cuCtxGetCurrent
                    0.00%     509ns         2     254ns     123ns     386ns  cuDeviceGet
                    0.00%     336ns         1     336ns     336ns     336ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  148.220s    300000  494.07us  1.6250us  4.3414ms  acc_wait@layers.c:79
                    0.00%  1.32777s     50000  26.555us  24.005us  1.1678ms  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  1.19167s    300000  3.9720us  1.2010us  814.36us  acc_wait@layers.c:60
                    0.00%  861.73ms    150000  5.7440us  4.7760us  800.02us  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  787.92ms     50000  15.758us  14.199us  2.0496ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  777.95ms    150000  5.1860us  4.3110us  2.0444ms  acc_enqueue_launch@layers.c:79 (_8layers_c_conv_forward_79_gpu)
                    0.00%  612.89ms     50000  12.257us  11.081us  88.903us  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  421.66ms    150000  2.8110us  2.3680us  1.1188ms  acc_compute_construct@layers.c:79
                    0.00%  420.21ms    150000  2.8010us  2.4570us  1.0734ms  acc_compute_construct@layers.c:60
                    0.00%  374.94ms     50000  7.4980us  6.1780us  1.0972ms  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  355.84ms     50000  7.1160us  2.0770us  1.0992ms  acc_wait@main.c:200
                    0.00%  298.67ms    150000  1.9910us  1.6560us  1.1880ms  acc_enter_data@layers.c:79
                    0.00%  291.89ms    150000  1.9450us  1.5130us  4.2043ms  acc_exit_data@layers.c:79
                    0.00%  286.63ms    150000  1.9100us  1.5360us  806.19us  acc_enter_data@layers.c:60
                    0.00%  262.48ms     50000  5.2490us  2.0550us  1.0846ms  acc_wait@main.c:215
                    0.00%  246.25ms     50000  4.9250us  3.9350us  2.0474ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  224.12ms    150000  1.4940us  1.2610us  732.27us  acc_exit_data@layers.c:60
                    0.00%  139.07ms         1  139.07ms  139.07ms  139.07ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  110.26ms     50000  2.2050us  1.7830us  894.04us  acc_wait@main.c:190
                    0.00%  107.51ms     50000  2.1500us  1.7830us  764.88us  acc_wait@main.c:205
                    0.00%  106.95ms     50000  2.1390us  1.7260us  1.1907ms  acc_wait@main.c:220
                    0.00%  99.485ms     50000  1.9890us  1.5960us  945.94us  acc_update@main.c:200
                    0.00%  95.964ms     50000  1.9190us  1.5340us  1.1490ms  acc_update@main.c:215
                    0.00%  94.488ms     50000  1.8890us  1.5350us  889.34us  acc_update@main.c:190
                    0.00%  91.794ms     50000  1.8350us  1.4440us  791.00us  acc_update@main.c:205
                    0.00%  87.003ms     50000  1.7400us  1.4190us  779.88us  acc_update@main.c:220
                    0.00%  40.137ms         9  4.4597ms  7.4510us  40.003ms  acc_enter_data@layers.c:42
                    0.00%  1.0649ms         1  1.0649ms  1.0649ms  1.0649ms  acc_exit_data@main.c:345
                    0.00%  534.74us         1  534.74us  534.74us  534.74us  acc_device_init@main.c:121
                    0.00%  86.917us        18  4.8280us     894ns  30.739us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  76.594us        18  4.2550us     860ns  31.169us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  67.817us         1  67.817us  67.817us  67.817us  acc_wait@main.c:121
                    0.00%  55.728us         9  6.1920us  4.5420us  9.5840us  acc_wait@layers.c:42
                    0.00%  48.512us         2  24.256us  3.1860us  45.326us  acc_exit_data@main.c:317
                    0.00%  47.130us         2  23.565us  15.189us  31.941us  acc_enter_data@main.c:182
                    0.00%  43.272us         3  14.424us  7.6540us  19.931us  acc_enqueue_upload@layers.c:312 (l->weights[:l->weights_size])
                    0.00%  43.271us         1  43.271us  43.271us  43.271us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  42.107us         9  4.6780us  1.7650us  14.537us  acc_exit_data@layers.c:53
                    0.00%  31.522us         3  10.507us  7.9080us  11.904us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  22.965us         3  7.6550us  4.2810us  14.043us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  21.171us         3  7.0570us  3.7150us  8.9620us  acc_wait@layers.c:312
                    0.00%  15.619us         3  5.2060us  3.3510us  7.7700us  acc_update@layers.c:312
                    0.00%  11.828us         3  3.9420us  3.6670us  4.2700us  acc_enqueue_upload@layers.c:312 (l->bias[:l->out_depth])
                    0.00%  4.3080us         2  2.1540us  1.6630us  2.6450us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```

#### NV_ACC_TIME
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:1.174824 seconds
Create Network time:0.038677 seconds
Load Network Parameters time:0.008000 seconds
Create Ouputs time:0.000341 seconds

Net Forward total time:160.408253 seconds
    Time for conv1: 82.336795 seconds
    Time for relu1: 0.469331 seconds
    Time for pool1: 1.971351 seconds
    Time for conv2: 52.500884 seconds
    Time for relu2: 0.143504 seconds
    Time for pool2: 0.628783 seconds
    Time for conv3: 16.970684 seconds
    Time for relu3: 0.054918 seconds
    Time for pool3: 0.159699 seconds
    Time for fc: 0.212738 seconds
    Time for softmax: 0.012185 seconds

  Conv: 151.808364 seconds
  ReLU: 0.667753 seconds
  Pool: 2.759833 seconds
  FC:   0.212738 seconds
  Softmax: 0.012185 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001563 seconds
Free memory time:0.055194 seconds
Total time:161.686852 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 223
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=223 max=28 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 176
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=176 max=28 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [960]  block: [128]
            elapsed time(us): total=1,967,075 max=1,206 min=11 avg=13
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    79: compute region reached 150000 times
        79: kernel launched 150000 times
            grid: [400]  block: [128]
            elapsed time(us): total=148,688,752 max=5,261 min=317 avg=991
    79: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 53
    312: update directive reached 3 times
        312: data copyin transfers: 6
             device time(us): total=53 max=20 min=3 avg=8
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/main.c
  main  NVIDIA  devicenum=0
    time(us): 2,901,511
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=56 max=56 min=56 avg=56
        121: data copyin transfers: 1
             device time(us): total=149,432 max=149,432 min=149,432 avg=149,432
    182: data region reached 2 times
    190: update directive reached 50000 times
        190: data copyout transfers: 50000
             device time(us): total=1,012,136 max=800 min=18 avg=20
    200: update directive reached 50000 times
        200: data copyin transfers: 50000
             device time(us): total=449,548 max=1,154 min=7 avg=8
    205: update directive reached 50000 times
        205: data copyout transfers: 50000
             device time(us): total=607,347 max=703 min=10 avg=12
    215: update directive reached 50000 times
        215: data copyin transfers: 50000
             device time(us): total=240,546 max=1,186 min=3 avg=4
    220: update directive reached 50000 times
        220: data copyout transfers: 50000
             device time(us): total=442,502 max=82 min=7 avg=8
    317: data region reached 2 times
    345: data region reached 1 time
```
## gang vector

### code
```c
60: void pad_input(float* restrict X, Conv_Layer* l) {
#pragma acc parallel loop present(l,X) gang
  for ( int c = 0; c < l->in_depth; c++) {
      #pragma acc loop independent auto
    for (int j = 0; j < l->in_height; j++) {
      #pragma acc loop independent vector
      for (int i = 0; i < l->in_width; i++) {
        int padded_idx = (j + l->padding) * l->padded_width + (i + l->padding) + c * l->padded_height * l->padded_width;
        int in_idx = j * l->in_width + i + c * l->in_height * l->in_width;
        l->in_padded[padded_idx] = X[in_idx];
      }
    }
  }
}

78: void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
    pad_input(X, l); //Create input with zero-padding
   // For each output feature map
#pragma acc parallel loop present(l,X,Y) gang
    for ( int m = 0; m < l->out_depth; m++) {
      #pragma acc loop independent auto
      for (int j = 0; j < l->out_height; j++) {
        #pragma acc loop independent auto
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); // Output index
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
        #pragma acc loop  reduction(+:sum) vector
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
                ...
```


### Minfo

```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c main.c -o main.o
main:
    121, Generating enter data copyin(input[:50000][:3072])
    182, Generating enter data create(O6[:L6->out_size],O7[:L7->out_size],O3[:L3->out_size],O1[:L1->out_size],O4[:L4->out_size])
    190, Generating update self(O1[:L1->out_size])
    200, Generating update device(O3[:L3->out_size])
    205, Generating update self(O4[:L4->out_size])
    215, Generating update device(O6[:L6->out_size])
    220, Generating update self(O7[:L7->out_size])
    317, Generating exit data delete(O6[:L6->out_size],O3[:L3->out_size],O1[:L1->out_size],O4[:L4->out_size],O7[:L7->out_size])
    345, Generating exit data delete(input[:50000][:3072])
arr2txt:
    368, Zero trip check eliminated
arr2txt_2:
    390, Zero trip check eliminated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(X[:],l[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         62, #pragma acc loop gang /* blockIdx.x */
         64, #pragma acc loop seq
         66, #pragma acc loop vector(128) /* threadIdx.x */
     64, Loop is parallelizable
     66, Loop is parallelizable
conv_forward:
     79, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         82, #pragma acc loop gang /* blockIdx.x */
         84, #pragma acc loop seq
         86, #pragma acc loop seq
         91, #pragma acc loop vector(128) /* threadIdx.x */
             Generating reduction(+:sum)
         92, #pragma acc loop seq
         93, #pragma acc loop seq
     84, Loop is parallelizable
     86, Loop is parallelizable
     91, Loop is parallelizable
     92, Loop is parallelizable
     93, Loop is parallelizable
     98, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    189, Zero trip check eliminated
fc_forward:
    250, FMA (fused multiply-add) instruction(s) generated
load_conv:
    312, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c malloc2D.c -o malloc2D.o
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c timer.c -o timer.o
cpu_timer_stop:
     11, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```

### Εκτέλεση
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.022507 seconds
Create Network time:0.038793 seconds
Load Network Parameters time:0.008028 seconds
Create Ouputs time:0.000334 seconds

Net Forward total time:161.345312 seconds
    Time for conv1: 113.778696 seconds
    Time for relu1: 0.461233 seconds
    Time for pool1: 2.002709 seconds
    Time for conv2: 31.635516 seconds
    Time for relu2: 0.147556 seconds
    Time for pool2: 0.635678 seconds
    Time for conv3: 8.975992 seconds
    Time for relu3: 0.042364 seconds
    Time for pool3: 0.161809 seconds
    Time for fc: 0.213486 seconds
    Time for softmax: 0.012515 seconds

  Conv: 154.390205 seconds
  ReLU: 0.651153 seconds
  Pool: 2.800195 seconds
  FC:   0.213486 seconds
  Softmax: 0.012515 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001588 seconds
Free memory time:0.057853 seconds
Total time:162.474415 seconds
END!
```

### Profiling

#### NV_ACC_TIMER

#### nvporf
```
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2506848== NVPROF is profiling process 2506848, command: ./cnn-cifar10-profile
Load Data time:1.323739 seconds
Create Network time:0.038265 seconds
Load Network Parameters time:0.007636 seconds
Create Ouputs time:0.000311 seconds

Net Forward total time:164.760993 seconds
    Time for conv1: 114.406950 seconds
    Time for relu1: 0.674602 seconds
    Time for pool1: 1.546217 seconds
    Time for conv2: 32.502217 seconds
    Time for relu2: 0.205632 seconds
    Time for pool2: 0.500433 seconds
    Time for conv3: 9.904041 seconds
    Time for relu3: 0.055883 seconds
    Time for pool3: 0.129078 seconds
    Time for fc: 0.212926 seconds
    Time for softmax: 0.016426 seconds

  Conv: 156.813209 seconds
  ReLU: 0.936117 seconds
  Pool: 2.175728 seconds
  FC:   0.212926 seconds
  Softmax: 0.016426 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001627 seconds
Free memory time:0.061305 seconds
Total time:166.193877 seconds
END!
==2506848== Profiling application: ./cnn-cifar10-profile
==2506848== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   99.14%  150.915s    150000  1.0061ms  159.77us  2.5216ms  _8layers_c_conv_forward_79_gpu
                    0.35%  532.21ms    150000  3.5480us  2.8790us  13.280us  _8layers_c_pad_input_60_gpu
                    0.29%  445.05ms    150000  2.9660us  1.3750us  18.400us  [CUDA memcpy DtoH]
                    0.21%  327.08ms    100031  3.2690us     640ns  149.07ms  [CUDA memcpy HtoD]
                    0.00%  2.6560us         1  2.6560us  2.6560us  2.6560us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   96.93%  153.056s    850015  180.06us     605ns  7.7708ms  cuStreamSynchronize
                    1.56%  2.46575s    150000  16.438us  10.286us  2.1196ms  cuMemcpyDtoHAsync
                    0.84%  1.32477s    300001  4.4150us  3.3250us  2.0563ms  cuLaunchKernel
                    0.38%  594.53ms    100031  5.9430us  2.6960us  149.27ms  cuMemcpyHtoDAsync
                    0.12%  184.43ms    600000     307ns     181ns  239.05us  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.11%  170.18ms         1  170.18ms  170.18ms  170.18ms  cuDevicePrimaryCtxRetain
                    0.03%  45.766ms    300010     152ns     116ns  16.949us  cuDeviceGetAttribute
                    0.02%  37.746ms         1  37.746ms  37.746ms  37.746ms  cuMemHostAlloc
                    0.01%  14.306ms     50019     286ns     220ns  823.53us  cuPointerGetAttributes
                    0.00%  5.3074ms        20  265.37us  1.8500us  4.9637ms  cuMemAlloc
                    0.00%  1.3054ms         1  1.3054ms  1.3054ms  1.3054ms  cuMemAllocHost
                    0.00%  250.32us         2  125.16us  103.03us  147.29us  cuModuleLoadDataEx
                    0.00%  20.287us         1  20.287us  20.287us  20.287us  cuDeviceGetPCIBusId
                    0.00%  10.513us         1  10.513us  10.513us  10.513us  cuCtxGetCurrent
                    0.00%  3.4730us         4     868ns     307ns  1.6500us  cuModuleGetFunction
                    0.00%  2.3360us         3     778ns     157ns  1.8240us  cuDeviceGetCount
                    0.00%  1.9900us         3     663ns     276ns  1.1690us  cuCtxSetCurrent
                    0.00%     980ns         2     490ns     215ns     765ns  cuDeviceGet
                    0.00%     732ns         1     732ns     732ns     732ns  cuDeviceComputeCapability
                    0.00%     676ns         3     225ns     153ns     265ns  cuDriverGetVersion
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  151.603s    300000  505.34us  1.5830us  7.7725ms  acc_wait@layers.c:79
                    0.00%  1.22710s     50000  24.542us  21.535us  1.4106ms  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  1.16116s    300000  3.8700us  1.2110us  1.4518ms  acc_wait@layers.c:60
                    0.00%  902.25ms    150000  6.0150us  4.6950us  2.3187ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  814.55ms    150000  5.4300us  4.2470us  2.0579ms  acc_enqueue_launch@layers.c:79 (_8layers_c_conv_forward_79_gpu)
                    0.00%  752.70ms     50000  15.053us  13.580us  2.1210ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  615.73ms     50000  12.314us  11.055us  481.48us  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  435.61ms    150000  2.9040us  2.4240us  1.5848ms  acc_compute_construct@layers.c:79
                    0.00%  434.50ms    150000  2.8960us  2.5230us  1.2545ms  acc_compute_construct@layers.c:60
                    0.00%  343.14ms     50000  6.8620us  1.8190us  944.75us  acc_wait@main.c:200
                    0.00%  306.37ms    150000  2.0420us  1.6700us  1.7793ms  acc_enter_data@layers.c:79
                    0.00%  295.04ms    150000  1.9660us  1.5570us  1.7908ms  acc_enter_data@layers.c:60
                    0.00%  287.03ms     50000  5.7400us  4.5100us  1.3378ms  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  286.13ms    150000  1.9070us  1.4800us  790.31us  acc_exit_data@layers.c:79
                    0.00%  248.97ms     50000  4.9790us  1.7890us  753.89us  acc_wait@main.c:215
                    0.00%  236.31ms     50000  4.7260us  3.7380us  2.1664ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  222.92ms    150000  1.4860us  1.2530us  839.05us  acc_exit_data@layers.c:60
                    0.00%  149.28ms         1  149.28ms  149.28ms  149.28ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  108.31ms     50000  2.1660us  1.7510us  841.24us  acc_wait@main.c:190
                    0.00%  106.30ms     50000  2.1250us  1.7470us  867.73us  acc_wait@main.c:205
                    0.00%  104.56ms     50000  2.0910us  1.7240us  690.80us  acc_wait@main.c:220
                    0.00%  97.684ms     50000  1.9530us  1.5580us  1.5808ms  acc_update@main.c:200
                    0.00%  96.121ms     50000  1.9220us  1.5490us  1.3973ms  acc_update@main.c:190
                    0.00%  94.799ms     50000  1.8950us  1.4960us  1.4868ms  acc_update@main.c:215
                    0.00%  89.733ms     50000  1.7940us  1.4350us  1.4478ms  acc_update@main.c:220
                    0.00%  88.891ms     50000  1.7770us  1.4170us  1.3592ms  acc_update@main.c:205
                    0.00%  37.987ms         9  4.2207ms  6.8530us  37.815ms  acc_enter_data@layers.c:42
                    0.00%  1.0657ms         1  1.0657ms  1.0657ms  1.0657ms  acc_exit_data@main.c:345
                    0.00%  187.59us         1  187.59us  187.59us  187.59us  acc_device_init@main.c:121
                    0.00%  103.98us        18  5.7760us     891ns  53.292us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  83.175us        18  4.6200us     822ns  27.782us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  59.318us         9  6.5900us  4.5200us  9.3940us  acc_wait@layers.c:42
                    0.00%  55.510us         1  55.510us  55.510us  55.510us  acc_wait@main.c:121
                    0.00%  51.358us         9  5.7060us  1.8640us  19.898us  acc_exit_data@layers.c:53
                    0.00%  49.116us         2  24.558us  13.813us  35.303us  acc_enter_data@main.c:182
                    0.00%  46.546us         1  46.546us  46.546us  46.546us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  44.385us         2  22.192us  3.4360us  40.949us  acc_exit_data@main.c:317
                    0.00%  38.989us         3  12.996us  7.2230us  16.830us  acc_enqueue_upload@layers.c:312 (l->weights[:l->weights_size])
                    0.00%  31.631us         3  10.543us  7.9700us  11.936us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  27.225us         3  9.0750us  3.8500us  18.805us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  21.596us         3  7.1980us  3.7990us  9.3430us  acc_wait@layers.c:312
                    0.00%  12.631us         3  4.2100us  2.8000us  6.9630us  acc_update@layers.c:312
                    0.00%  10.728us         3  3.5760us  3.3920us  3.6820us  acc_enqueue_upload@layers.c:312 (l->bias[:l->out_depth])
                    0.00%  4.2960us         2  2.1480us  1.7740us  2.5220us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```

---

## Worker

### code
```c
60: void pad_input(float* restrict X, Conv_Layer* l) {
#pragma acc parallel loop present(l,X) gang 
  for ( int c = 0; c < l->in_depth; c++) {
      #pragma acc loop independent auto
    for (int j = 0; j < l->in_height; j++) {
      #pragma acc loop independent vector
      for (int i = 0; i < l->in_width; i++) {
...

78: void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
    pad_input(X, l); //Create input with zero-padding
   // For each output feature map
#pragma acc parallel loop present(l,X,Y) gang
    for ( int m = 0; m < l->out_depth; m++) {
      #pragma acc loop independent worker
      for (int j = 0; j < l->out_height; j++) {
        #pragma acc loop independent auto
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); 
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
        #pragma acc loop  reduction(+:sum) vector
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
            ...
...
```
### Minfo
```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(X[:],l[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         62, #pragma acc loop gang /* blockIdx.x */
         64, #pragma acc loop seq
         66, #pragma acc loop vector(128) /* threadIdx.x */
     64, Loop is parallelizable
     66, Loop is parallelizable
conv_forward:
     79, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         82, #pragma acc loop gang /* blockIdx.x */
         84, #pragma acc loop worker(4) /* threadIdx.y */
         86, #pragma acc loop seq
         91, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
             Vector barrier inserted to share data across vector lanes
         92, #pragma acc loop seq
         93, #pragma acc loop seq
        100, Vector barrier inserted for vector loop reduction
     84, Loop is parallelizable
     86, Loop is parallelizable
     91, Loop is parallelizable
     92, Loop is parallelizable
     93, Loop is parallelizable
     98, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    189, Zero trip check eliminated
fc_forward:
    250, FMA (fused multiply-add) instruction(s) generated
load_conv:
    312, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```

### Εκτέλεση
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.018750 seconds
Create Network time:0.038343 seconds
Load Network Parameters time:0.007663 seconds
Create Ouputs time:0.000341 seconds

Net Forward total time:41.696018 seconds
    Time for conv1: 23.818175 seconds
    Time for relu1: 0.464759 seconds
    Time for pool1: 1.989912 seconds
    Time for conv2: 7.951383 seconds
    Time for relu2: 0.152791 seconds
    Time for pool2: 0.634841 seconds
    Time for conv3: 3.026573 seconds
    Time for relu3: 0.039136 seconds
    Time for pool3: 0.162469 seconds
    Time for fc: 0.212957 seconds
    Time for softmax: 0.011893 seconds

  Conv: 34.796130 seconds
  ReLU: 0.656686 seconds
  Pool: 2.787222 seconds
  FC:   0.212957 seconds
  Softmax: 0.011893 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001311 seconds
Free memory time:0.053608 seconds
Total time:42.816033 seconds
END!
```
## Worker (pad_input)
Δεν κάνει διαφορά
### Εκτέλεση
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.030749 seconds
Create Network time:0.038618 seconds
Load Network Parameters time:0.007704 seconds
Create Ouputs time:0.000353 seconds

Net Forward total time:41.613132 seconds
    Time for conv1: 23.715859 seconds
    Time for relu1: 0.453880 seconds
    Time for pool1: 2.003917 seconds
    Time for conv2: 7.934593 seconds
    Time for relu2: 0.152006 seconds
    Time for pool2: 0.638315 seconds
    Time for conv3: 3.037007 seconds
    Time for relu3: 0.042497 seconds
    Time for pool3: 0.163304 seconds
    Time for fc: 0.213773 seconds
    Time for softmax: 0.012459 seconds

  Conv: 34.687459 seconds
  ReLU: 0.648384 seconds
  Pool: 2.805536 seconds
  FC:   0.213773 seconds
  Softmax: 0.012459 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001363 seconds
Free memory time:0.053275 seconds
Total time:42.745195 seconds
END!
```

### Profiling
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:1.124704 seconds
Create Network time:0.038187 seconds
Load Network Parameters time:0.007898 seconds
Create Ouputs time:0.000343 seconds

Net Forward total time:45.543101 seconds
    Time for conv1: 24.433423 seconds
    Time for relu1: 0.476871 seconds
    Time for pool1: 1.969226 seconds
    Time for conv2: 8.493412 seconds
    Time for relu2: 0.158136 seconds
    Time for pool2: 0.628569 seconds
    Time for conv3: 3.594851 seconds
    Time for relu3: 0.041022 seconds
    Time for pool3: 0.160102 seconds
    Time for fc: 0.212242 seconds
    Time for softmax: 0.011979 seconds

  Conv: 36.521687 seconds
  ReLU: 0.676030 seconds
  Pool: 2.757897 seconds
  FC:   0.212242 seconds
  Softmax: 0.011979 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001486 seconds
Free memory time:0.054016 seconds
Total time:46.769734 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 251
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=251 max=36 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 226
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=226 max=31 min=4 avg=12
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [960]  block: [32x4]
            elapsed time(us): total=2,106,122 max=154 min=12 avg=14
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    79: compute region reached 150000 times
        79: kernel launched 150000 times
            grid: [720]  block: [32x4]
            elapsed time(us): total=33,279,329 max=4,413 min=50 avg=221
    79: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 54
    312: update directive reached 3 times
        312: data copyin transfers: 6
             device time(us): total=54 max=20 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/main.c
  main  NVIDIA  devicenum=0
    time(us): 3,142,100
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=62 max=62 min=62 avg=62
        121: data copyin transfers: 1
             device time(us): total=142,211 max=142,211 min=142,211 avg=142,211
    182: data region reached 2 times
    190: update directive reached 50000 times
        190: data copyout transfers: 50000
             device time(us): total=1,160,784 max=395 min=21 avg=23
    200: update directive reached 50000 times
        200: data copyin transfers: 50000
             device time(us): total=443,849 max=50 min=7 avg=8
    205: update directive reached 50000 times
        205: data copyout transfers: 50000
             device time(us): total=653,886 max=55 min=11 avg=13
    215: update directive reached 50000 times
        215: data copyin transfers: 50000
             device time(us): total=245,127 max=23 min=4 avg=4
    220: update directive reached 50000 times
        220: data copyout transfers: 50000
             device time(us): total=496,243 max=341 min=8 avg=9
    317: data region reached 2 times
    345: data region reached 1 time
```
#### nvprof
```
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2528203== NVPROF is profiling process 2528203, command: ./cnn-cifar10-profile
Load Data time:1.332586 seconds
Create Network time:0.038933 seconds
Load Network Parameters time:0.008436 seconds
Create Ouputs time:0.000337 seconds

Net Forward total time:45.765218 seconds
    Time for conv1: 24.757908 seconds
    Time for relu1: 0.640326 seconds
    Time for pool1: 1.546126 seconds
    Time for conv2: 8.894715 seconds
    Time for relu2: 0.199752 seconds
    Time for pool2: 0.502146 seconds
    Time for conv3: 3.978750 seconds
    Time for relu3: 0.055748 seconds
    Time for pool3: 0.130600 seconds
    Time for fc: 0.216917 seconds
    Time for softmax: 0.014711 seconds

  Conv: 37.631373 seconds
  ReLU: 0.895826 seconds
  Pool: 2.178872 seconds
  FC:   0.216917 seconds
  Softmax: 0.014711 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001672 seconds
Free memory time:0.064254 seconds
Total time:47.211435 seconds
END!
==2528203== Profiling application: ./cnn-cifar10-profile
==2528203== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   96.05%  31.7708s    150000  211.81us  40.800us  507.74us  _8layers_c_conv_forward_79_gpu
                    1.61%  533.58ms    150000  3.5570us  2.8800us  13.568us  _8layers_c_pad_input_60_gpu
                    1.35%  446.66ms    150000  2.9770us  1.3750us  18.592us  [CUDA memcpy DtoH]
                    0.98%  324.85ms    100031  3.2470us     640ns  146.80ms  [CUDA memcpy HtoD]
                    0.00%  2.7830us         1  2.7830us  2.7830us  2.7830us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   87.30%  34.0111s    850015  40.012us     594ns  5.2081ms  cuStreamSynchronize
                    6.57%  2.55987s    150000  17.065us  10.504us  2.0522ms  cuMemcpyDtoHAsync
                    3.21%  1.25154s    300001  4.1710us  3.3710us  2.0697ms  cuLaunchKernel
                    1.77%  691.27ms    100031  6.9100us  2.7960us  146.99ms  cuMemcpyHtoDAsync
                    0.47%  181.55ms    600000     302ns     179ns  793.98us  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.40%  154.04ms         1  154.04ms  154.04ms  154.04ms  cuDevicePrimaryCtxRetain
                    0.12%  48.502ms    300010     161ns     130ns  18.119us  cuDeviceGetAttribute
                    0.10%  38.388ms         1  38.388ms  38.388ms  38.388ms  cuMemHostAlloc
                    0.05%  17.670ms     50018     353ns     228ns  838.96us  cuPointerGetAttributes
                    0.01%  2.6415ms        20  132.08us  1.9030us  2.3051ms  cuMemAlloc
                    0.00%  1.4499ms         1  1.4499ms  1.4499ms  1.4499ms  cuMemAllocHost
                    0.00%  368.52us         2  184.26us  118.11us  250.42us  cuModuleLoadDataEx
                    0.00%  13.569us         1  13.569us  13.569us  13.569us  cuDeviceGetPCIBusId
                    0.00%  12.230us         4  3.0570us     365ns  9.3940us  cuModuleGetFunction
                    0.00%  3.1650us         3  1.0550us     288ns  1.5240us  cuCtxSetCurrent
                    0.00%  1.7020us         3     567ns     181ns  1.2720us  cuDeviceGetCount
                    0.00%     880ns         2     440ns     176ns     704ns  cuDeviceGet
                    0.00%     740ns         3     246ns     135ns     346ns  cuDriverGetVersion
                    0.00%     689ns         1     689ns     689ns     689ns  cuDeviceComputeCapability
                    0.00%     627ns         1     627ns     627ns     627ns  cuCtxGetCurrent
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  32.4925s    300000  108.31us  1.6380us  5.2414ms  acc_wait@layers.c:79
                    0.00%  1.25732s     50000  25.146us  23.067us  1.1053ms  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  1.19754s    300000  3.9910us  1.1930us  1.0300ms  acc_wait@layers.c:60
                    0.00%  846.33ms    150000  5.6420us  4.6950us  1.1253ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  799.29ms     50000  15.985us  14.391us  2.0539ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  776.90ms    150000  5.1790us  4.2720us  2.0716ms  acc_enqueue_launch@layers.c:79 (_8layers_c_conv_forward_79_gpu)
                    0.00%  624.90ms     50000  12.498us  11.267us  214.56us  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  442.60ms    150000  2.9500us  2.5430us  1.1496ms  acc_compute_construct@layers.c:60
                    0.00%  432.13ms    150000  2.8800us  2.3780us  1.1197ms  acc_compute_construct@layers.c:79
                    0.00%  379.44ms     50000  7.5880us  6.2240us  1.1094ms  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  351.45ms     50000  7.0290us  2.0450us  81.689us  acc_wait@main.c:200
                    0.00%  299.00ms    150000  1.9930us  1.6300us  807.27us  acc_enter_data@layers.c:79
                    0.00%  293.52ms    150000  1.9560us  1.5570us  1.3268ms  acc_enter_data@layers.c:60
                    0.00%  271.14ms    150000  1.8070us  1.4700us  1.1459ms  acc_exit_data@layers.c:79
                    0.00%  260.57ms     50000  5.2110us  2.0560us  810.61us  acc_wait@main.c:215
                    0.00%  245.52ms     50000  4.9100us  4.0310us  2.1857ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  226.36ms    150000  1.5090us  1.2590us  740.98us  acc_exit_data@layers.c:60
                    0.00%  146.99ms         1  146.99ms  146.99ms  146.99ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  111.91ms     50000  2.2380us  1.7860us  2.9156ms  acc_wait@main.c:190
                    0.00%  110.11ms     50000  2.2020us  1.7950us  1.5604ms  acc_wait@main.c:205
                    0.00%  107.55ms     50000  2.1510us  1.7420us  808.17us  acc_wait@main.c:220
                    0.00%  98.781ms     50000  1.9750us  1.5860us  752.27us  acc_update@main.c:200
                    0.00%  96.021ms     50000  1.9200us  1.5280us  1.1739ms  acc_update@main.c:215
                    0.00%  92.539ms     50000  1.8500us  1.5120us  799.72us  acc_update@main.c:190
                    0.00%  91.607ms     50000  1.8320us  1.4920us  753.36us  acc_update@main.c:205
                    0.00%  91.416ms     50000  1.8280us  1.4950us  763.93us  acc_update@main.c:220
                    0.00%  38.648ms         9  4.2942ms  7.3010us  38.452ms  acc_enter_data@layers.c:42
                    0.00%  1.1213ms         1  1.1213ms  1.1213ms  1.1213ms  acc_exit_data@main.c:345
                    0.00%  315.39us         1  315.39us  315.39us  315.39us  acc_device_init@main.c:121
                    0.00%  88.689us        18  4.9270us     909ns  27.096us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  80.982us        18  4.4990us     877ns  29.435us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  68.886us         1  68.886us  68.886us  68.886us  acc_wait@main.c:121
                    0.00%  59.312us         9  6.5900us  4.5540us  9.1880us  acc_wait@layers.c:42
                    0.00%  46.084us         2  23.042us  3.1200us  42.964us  acc_exit_data@main.c:317
                    0.00%  44.421us         2  22.210us  11.647us  32.774us  acc_enter_data@main.c:182
                    0.00%  42.030us         1  42.030us  42.030us  42.030us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  41.896us         3  13.965us  7.3010us  18.096us  acc_enqueue_upload@layers.c:312 (l->weights[:l->weights_size])
                    0.00%  40.052us         9  4.4500us  1.6930us  14.739us  acc_exit_data@layers.c:53
                    0.00%  33.163us         3  11.054us  7.8460us  12.686us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  25.361us         3  8.4530us  4.1830us  16.635us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  21.945us         3  7.3150us  3.6530us  10.281us  acc_wait@layers.c:312
                    0.00%  13.941us         3  4.6470us  3.2460us  7.2670us  acc_update@layers.c:312
                    0.00%  11.442us         3  3.8140us  3.7260us  3.8890us  acc_enqueue_upload@layers.c:312 (l->bias[:l->out_depth])
                    0.00%  4.0310us         2  2.0150us  1.4920us  2.5390us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```
### Profiling - worker on pad_input
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.019731 seconds
Create Network time:0.040073 seconds
Load Network Parameters time:0.007979 seconds
Create Ouputs time:0.000324 seconds

Net Forward total time:41.376192 seconds
    Time for conv1: 23.791537 seconds
    Time for relu1: 0.463492 seconds
    Time for pool1: 1.993918 seconds
    Time for conv2: 7.905447 seconds
    Time for relu2: 0.145575 seconds
    Time for pool2: 0.636328 seconds
    Time for conv3: 2.987771 seconds
    Time for relu3: 0.040167 seconds
    Time for pool3: 0.164144 seconds
    Time for fc: 0.213300 seconds
    Time for softmax: 0.012765 seconds

  Conv: 34.684756 seconds
  ReLU: 0.649234 seconds
  Pool: 2.794389 seconds
  FC:   0.213300 seconds
  Softmax: 0.012765 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001441 seconds
Free memory time:0.050899 seconds
Total time:42.496639 seconds
```
#### nvprof
```
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2531392== NVPROF is profiling process 2531392, command: ./cnn-cifar10-profile
Load Data time:1.344377 seconds
Create Network time:0.037840 seconds
Load Network Parameters time:0.007712 seconds
Create Ouputs time:0.000328 seconds

Net Forward total time:45.502411 seconds
    Time for conv1: 24.793752 seconds
    Time for relu1: 0.632253 seconds
    Time for pool1: 1.549506 seconds
    Time for conv2: 8.890892 seconds
    Time for relu2: 0.200825 seconds
    Time for pool2: 0.498253 seconds
    Time for conv3: 3.964683 seconds
    Time for relu3: 0.060670 seconds
    Time for pool3: 0.129303 seconds
    Time for fc: 0.213731 seconds
    Time for softmax: 0.015024 seconds

  Conv: 37.649327 seconds
  ReLU: 0.893747 seconds
  Pool: 2.177062 seconds
  FC:   0.213731 seconds
  Softmax: 0.015024 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001496 seconds
Free memory time:0.061087 seconds
Total time:46.955252 seconds
END!
==2531392== Profiling application: ./cnn-cifar10-profile
==2531392== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   95.98%  31.7670s    150000  211.78us  40.799us  507.55us  _8layers_c_conv_forward_79_gpu
                    1.70%  561.14ms    150000  3.7400us  2.8790us  13.536us  _8layers_c_pad_input_60_gpu
                    1.35%  445.31ms    150000  2.9680us  1.3750us  18.560us  [CUDA memcpy DtoH]
                    0.98%  324.17ms    100031  3.2400us     640ns  146.13ms  [CUDA memcpy HtoD]
                    0.00%  2.5920us         1  2.5920us  2.5920us  2.5920us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   87.52%  33.9033s    850015  39.885us     578ns  6.8335ms  cuStreamSynchronize
                    6.32%  2.44962s    150000  16.330us  10.138us  2.1430ms  cuMemcpyDtoHAsync
                    3.47%  1.34405s    300001  4.4800us  3.4350us  4.5081ms  cuLaunchKernel
                    1.50%  579.82ms    100031  5.7960us  2.6170us  146.33ms  cuMemcpyHtoDAsync
                    0.47%  183.07ms    600000     305ns     176ns  357.59us  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.42%  162.87ms         1  162.87ms  162.87ms  162.87ms  cuDevicePrimaryCtxRetain
                    0.12%  46.038ms    300010     153ns     118ns  40.078us  cuDeviceGetAttribute
                    0.10%  37.349ms         1  37.349ms  37.349ms  37.349ms  cuMemHostAlloc
                    0.05%  19.433ms     50019     388ns     231ns  828.16us  cuPointerGetAttributes
                    0.02%  6.1219ms         1  6.1219ms  6.1219ms  6.1219ms  cuMemAllocHost
                    0.01%  4.7578ms        20  237.89us  1.9530us  4.4735ms  cuMemAlloc
                    0.00%  552.68us         2  276.34us  107.65us  445.03us  cuModuleLoadDataEx
                    0.00%  10.877us         1  10.877us  10.877us  10.877us  cuDeviceGetPCIBusId
                    0.00%  4.1770us         4  1.0440us     303ns  1.9790us  cuModuleGetFunction
                    0.00%  3.5480us         3  1.1820us     216ns  1.9220us  cuCtxSetCurrent
                    0.00%  1.5830us         3     527ns     227ns  1.1210us  cuDeviceGetCount
                    0.00%     985ns         2     492ns     185ns     800ns  cuDeviceGet
                    0.00%     910ns         3     303ns     165ns     489ns  cuDriverGetVersion
                    0.00%     627ns         1     627ns     627ns     627ns  cuDeviceComputeCapability
                    0.00%     498ns         1     498ns     498ns     498ns  cuCtxGetCurrent
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  32.4433s    300000  108.14us  1.5810us  6.8348ms  acc_wait@layers.c:79
                    0.00%  1.18873s     50000  23.774us  21.719us  910.95us  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  1.18444s    300000  3.9480us  1.1900us  1.3712ms  acc_wait@layers.c:60
                    0.00%  904.28ms    150000  6.0280us  4.8610us  1.7756ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  822.34ms    150000  5.4820us  4.3400us  4.5617ms  acc_enqueue_launch@layers.c:79 (_8layers_c_conv_forward_79_gpu)
                    0.00%  771.31ms     50000  15.426us  13.813us  2.1444ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  614.90ms     50000  12.298us  10.913us  794.41us  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  429.01ms    150000  2.8600us  2.4590us  1.4318ms  acc_compute_construct@layers.c:60
                    0.00%  424.99ms    150000  2.8330us  2.3850us  1.3814ms  acc_compute_construct@layers.c:79
                    0.00%  343.80ms     50000  6.8760us  1.8250us  887.32us  acc_wait@main.c:200
                    0.00%  301.17ms    150000  2.0070us  1.6470us  1.6216ms  acc_enter_data@layers.c:79
                    0.00%  289.44ms    150000  1.9290us  1.5360us  1.6822ms  acc_enter_data@layers.c:60
                    0.00%  280.63ms     50000  5.6120us  4.4270us  1.3689ms  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  275.39ms    150000  1.8350us  1.4960us  1.5695ms  acc_exit_data@layers.c:79
                    0.00%  250.46ms     50000  5.0090us  1.8420us  941.57us  acc_wait@main.c:215
                    0.00%  230.34ms     50000  4.6060us  3.7260us  2.1536ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  223.59ms    150000  1.4900us  1.2550us  1.4482ms  acc_exit_data@layers.c:60
                    0.00%  146.33ms         1  146.33ms  146.33ms  146.33ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  104.38ms     50000  2.0870us  1.6980us  2.2847ms  acc_wait@main.c:190
                    0.00%  102.62ms     50000  2.0520us  1.7180us  762.85us  acc_wait@main.c:205
                    0.00%  100.99ms     50000  2.0190us  1.6910us  665.52us  acc_wait@main.c:220
                    0.00%  97.172ms     50000  1.9430us  1.5500us  1.3271ms  acc_update@main.c:200
                    0.00%  94.154ms     50000  1.8830us  1.4660us  1.3890ms  acc_update@main.c:215
                    0.00%  89.828ms     50000  1.7960us  1.4540us  1.3914ms  acc_update@main.c:190
                    0.00%  89.455ms     50000  1.7890us  1.4560us  1.3261ms  acc_update@main.c:205
                    0.00%  89.007ms     50000  1.7800us  1.4350us  1.3332ms  acc_update@main.c:220
                    0.00%  37.563ms         9  4.1736ms  6.8210us  37.408ms  acc_enter_data@layers.c:42
                    0.00%  1.0269ms         1  1.0269ms  1.0269ms  1.0269ms  acc_exit_data@main.c:345
                    0.00%  543.34us         1  543.34us  543.34us  543.34us  acc_device_init@main.c:121
                    0.00%  98.575us        18  5.4760us     841ns  49.913us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  94.502us        18  5.2500us     799ns  36.071us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  69.372us         1  69.372us  69.372us  69.372us  acc_wait@main.c:121
                    0.00%  58.946us         9  6.5490us  4.4310us  9.6040us  acc_wait@layers.c:42
                    0.00%  55.579us         3  18.526us  15.016us  23.688us  acc_enqueue_upload@layers.c:312 (l->weights[:l->weights_size])
                    0.00%  52.115us         9  5.7900us  1.6900us  26.905us  acc_exit_data@layers.c:53
                    0.00%  50.642us         2  25.321us  11.559us  39.083us  acc_enter_data@main.c:182
                    0.00%  41.000us         1  41.000us  41.000us  41.000us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  31.434us         2  15.717us  3.1510us  28.283us  acc_exit_data@main.c:317
                    0.00%  29.603us         3  9.8670us  6.9500us  11.499us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  22.793us         3  7.5970us  3.9830us  14.366us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  22.300us         3  7.4330us  3.7920us  9.6960us  acc_wait@layers.c:312
                    0.00%  12.600us         3  4.2000us  2.5790us  7.1320us  acc_update@layers.c:312
                    0.00%  10.832us         3  3.6100us  3.3550us  3.9660us  acc_enqueue_upload@layers.c:312 (l->bias[:l->out_depth])
                    0.00%  5.1050us         2  2.5520us  1.6870us  3.4180us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```

---

## gang collapse(2) worker vector

```c
60:void pad_input(float* restrict X, Conv_Layer* l) {
#pragma acc parallel loop present(l,X) gang 
  for ( int c = 0; c < l->in_depth; c++) {
      #pragma acc loop independent worker
    for (int j = 0; j < l->in_height; j++) {
      #pragma acc loop independent vector
      for (int i = 0; i < l->in_width; i++) {
...

78: void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
    pad_input(X, l); //Create input with zero-padding
   // For each output feature map
#pragma acc parallel loop present(l,X,Y) gang collapse(2)
    for ( int m = 0; m < l->out_depth; m++) {
      for (int j = 0; j < l->out_height; j++) {
        #pragma acc loop independent worker
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); // Output index
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
        #pragma acc loop  reduction(+:sum) vector//collapse(2) vector
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
```
### Minfo
```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(X[:],l[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         62, #pragma acc loop gang /* blockIdx.x */
         64, #pragma acc loop worker(4) /* threadIdx.y */
         66, #pragma acc loop vector(32) /* threadIdx.x */
     64, Loop is parallelizable
     66, Loop is parallelizable
conv_forward:
     79, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         82, #pragma acc loop gang collapse(2) /* blockIdx.x */
         83,   /* blockIdx.x collapsed */
         85, #pragma acc loop worker(4) /* threadIdx.y */
         90, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         91, #pragma acc loop seq
         92, #pragma acc loop seq
         99, Vector barrier inserted for vector loop reduction
     85, Loop is parallelizable
     90, Loop is parallelizable
     91, Loop is parallelizable
     92, Loop is parallelizable
     97, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    188, Zero trip check eliminated
fc_forward:
    249, FMA (fused multiply-add) instruction(s) generated
load_conv:
    311, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```

### Εκτέλεση
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.074566 seconds
Create Network time:0.038385 seconds
Load Network Parameters time:0.008019 seconds
Create Ouputs time:0.000344 seconds

Net Forward total time:13.713950 seconds
    Time for conv1: 2.887889 seconds
    Time for relu1: 0.454526 seconds
    Time for pool1: 1.950056 seconds
    Time for conv2: 2.391683 seconds
    Time for relu2: 0.144772 seconds
    Time for pool2: 0.622769 seconds
    Time for conv3: 1.540610 seconds
    Time for relu3: 0.042003 seconds
    Time for pool3: 0.157812 seconds
    Time for fc: 0.209624 seconds
    Time for softmax: 0.013099 seconds

  Conv: 6.820182 seconds
  ReLU: 0.641300 seconds
  Pool: 2.730638 seconds
  FC:   0.209624 seconds
  Softmax: 0.013099 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001381 seconds
Free memory time:0.053054 seconds
Total time:14.889698 seconds
END!

```
### Profiling
#### NV_ACC_TIME
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:1.170737 seconds
Create Network time:0.038958 seconds
Load Network Parameters time:0.008002 seconds
Create Ouputs time:0.000334 seconds

Net Forward total time:16.493950 seconds
    Time for conv1: 3.233715 seconds
    Time for relu1: 0.443237 seconds
    Time for pool1: 1.970857 seconds
    Time for conv2: 2.737361 seconds
    Time for relu2: 0.152142 seconds
    Time for pool2: 0.636669 seconds
    Time for conv3: 1.965784 seconds
    Time for relu3: 0.042686 seconds
    Time for pool3: 0.161262 seconds
    Time for fc: 0.212074 seconds
    Time for softmax: 0.012556 seconds

  Conv: 7.936859 seconds
  ReLU: 0.638065 seconds
  Pool: 2.768788 seconds
  FC:   0.212074 seconds
  Softmax: 0.012556 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001516 seconds
Free memory time:0.053855 seconds
Total time:17.767353 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 232
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=232 max=27 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 183
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=183 max=31 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [960]  block: [32x4]
            elapsed time(us): total=1,984,717 max=426 min=11 avg=13
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    79: compute region reached 150000 times
        79: kernel launched 150000 times
            grid: [160-512]  block: [32x4]
            elapsed time(us): total=4,880,906 max=2,032 min=19 avg=32
    79: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 53
    311: update directive reached 3 times
        311: data copyin transfers: 6
             device time(us): total=53 max=21 min=3 avg=8
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/main.c
  main  NVIDIA  devicenum=0
    time(us): 2,905,493
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=46 max=46 min=46 avg=46
        121: data copyin transfers: 1
             device time(us): total=145,059 max=145,059 min=145,059 avg=145,059
    182: data region reached 2 times
    190: update directive reached 50000 times
        190: data copyout transfers: 50000
             device time(us): total=1,067,301 max=4,203 min=19 avg=21
    200: update directive reached 50000 times
        200: data copyin transfers: 50000
             device time(us): total=432,488 max=30 min=7 avg=8
    205: update directive reached 50000 times
        205: data copyout transfers: 50000
             device time(us): total=585,874 max=52 min=10 avg=11
    215: update directive reached 50000 times
        215: data copyin transfers: 50000
             device time(us): total=235,505 max=65 min=4 avg=4
    220: update directive reached 50000 times
        220: data copyout transfers: 50000
             device time(us): total=439,266 max=38 min=7 avg=8
    317: data region reached 2 times

```
#### nprof
```
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2540474== NVPROF is profiling process 2540474, command: ./cnn-cifar10-profile
Load Data time:1.323494 seconds
Create Network time:0.039796 seconds
Load Network Parameters time:0.008490 seconds
Create Ouputs time:0.000324 seconds

Net Forward total time:17.876361 seconds
    Time for conv1: 3.833942 seconds
    Time for relu1: 0.634893 seconds
    Time for pool1: 1.616774 seconds
    Time for conv2: 3.331188 seconds
    Time for relu2: 0.205585 seconds
    Time for pool2: 0.513741 seconds
    Time for conv3: 2.440463 seconds
    Time for relu3: 0.059284 seconds
    Time for pool3: 0.129793 seconds
    Time for fc: 0.218604 seconds
    Time for softmax: 0.012857 seconds

  Conv: 9.605593 seconds
  ReLU: 0.899761 seconds
  Pool: 2.260309 seconds
  FC:   0.218604 seconds
  Softmax: 0.012857 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001628 seconds
Free memory time:0.056039 seconds
Total time:19.306132 seconds
END!
==2540474== Profiling application: ./cnn-cifar10-profile
==2540474== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   73.29%  3.91598s    150000  26.106us  11.903us  38.112us  _8layers_c_conv_forward_79_gpu
                   11.64%  622.02ms    150000  4.1460us  3.2310us  13.504us  _8layers_c_pad_input_60_gpu
                    8.68%  463.95ms    150000  3.0920us  1.1200us  18.496us  [CUDA memcpy DtoH]
                    6.39%  341.28ms    100031  3.4110us     736ns  142.55ms  [CUDA memcpy HtoD]
                    0.00%  2.6240us         1  2.6240us  2.6240us  2.6240us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   56.17%  6.32512s    850015  7.4410us     578ns  1.8372ms  cuStreamSynchronize
                   23.26%  2.61953s    150000  17.463us  10.572us  2.7463ms  cuMemcpyDtoHAsync
                   11.10%  1.25003s    300001  4.1660us  3.3520us  4.9117ms  cuLaunchKernel
                    6.11%  688.50ms    100031  6.8820us  2.8860us  142.75ms  cuMemcpyHtoDAsync
                    1.45%  163.69ms         1  163.69ms  163.69ms  163.69ms  cuDevicePrimaryCtxRetain
                    0.92%  104.12ms    300000     347ns     185ns  930.31us  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.43%  48.542ms    300010     161ns     116ns  752.85us  cuDeviceGetAttribute
                    0.35%  39.307ms         1  39.307ms  39.307ms  39.307ms  cuMemHostAlloc
                    0.18%  20.389ms     50018     407ns     229ns  864.10us  cuPointerGetAttributes
                    0.01%  1.2841ms         1  1.2841ms  1.2841ms  1.2841ms  cuMemAllocHost
                    0.01%  620.65us         2  310.33us  116.07us  504.58us  cuModuleLoadDataEx
                    0.00%  490.38us        20  24.518us  1.9910us  219.95us  cuMemAlloc
                    0.00%  10.992us         4  2.7480us     387ns  8.1200us  cuModuleGetFunction
                    0.00%  7.7830us         1  7.7830us  7.7830us  7.7830us  cuDeviceGetPCIBusId
                    0.00%  3.0990us         3  1.0330us     236ns  1.7800us  cuCtxSetCurrent
                    0.00%  1.3850us         3     461ns     148ns  1.0120us  cuDeviceGetCount
                    0.00%     908ns         3     302ns     125ns     489ns  cuDriverGetVersion
                    0.00%     599ns         2     299ns     140ns     459ns  cuDeviceGet
                    0.00%     507ns         1     507ns     507ns     507ns  cuCtxGetCurrent
                    0.00%     345ns         1     345ns     345ns     345ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.64382s    300000  15.479us  1.6200us  1.8452ms  acc_wait@layers.c:79
                    0.00%  1.33223s     50000  26.644us  24.169us  2.3156ms  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  1.30510s    300000  4.3500us  1.1990us  846.40us  acc_wait@layers.c:60
                    0.00%  808.27ms    150000  5.3880us  4.6930us  774.20us  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  794.78ms     50000  15.895us  14.301us  2.7484ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  775.07ms    150000  5.1670us  4.2620us  4.9150ms  acc_enqueue_launch@layers.c:79 (_8layers_c_conv_forward_79_gpu)
                    0.00%  635.57ms     50000  12.711us  11.347us  793.58us  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  447.95ms    150000  2.9860us  2.4820us  934.33us  acc_compute_construct@layers.c:60
                    0.00%  383.08ms     50000  7.6610us  2.0520us  780.40us  acc_wait@main.c:200
                    0.00%  379.15ms     50000  7.5820us  6.1930us  6.9869ms  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  294.51ms     50000  5.8900us  2.0410us  1.3699ms  acc_wait@main.c:215
                    0.00%  288.81ms    150000  1.9250us  1.6330us  770.96us  acc_enter_data@layers.c:79
                    0.00%  267.48ms    150000  1.7830us  1.5500us  874.81us  acc_enter_data@layers.c:60
                    0.00%  266.95ms    150000  1.7790us  1.5680us  754.95us  acc_compute_construct@layers.c:79
                    0.00%  250.70ms    150000  1.6710us  1.4620us  759.66us  acc_exit_data@layers.c:79
                    0.00%  244.94ms     50000  4.8980us  3.9790us  3.3868ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  218.73ms    150000  1.4580us  1.2560us  776.24us  acc_exit_data@layers.c:60
                    0.00%  142.75ms         1  142.75ms  142.75ms  142.75ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  100.03ms     50000  2.0000us  1.7820us  747.69us  acc_wait@main.c:190
                    0.00%  98.784ms     50000  1.9750us  1.7730us  644.16us  acc_wait@main.c:205
                    0.00%  98.677ms     50000  1.9730us  1.7500us  749.75us  acc_wait@main.c:220
                    0.00%  89.454ms     50000  1.7890us  1.5780us  27.497us  acc_update@main.c:200
                    0.00%  87.224ms     50000  1.7440us  1.5300us  28.084us  acc_update@main.c:215
                    0.00%  85.704ms     50000  1.7140us  1.4400us  765.73us  acc_update@main.c:190
                    0.00%  80.171ms     50000  1.6030us  1.4150us  656.52us  acc_update@main.c:205
                    0.00%  79.567ms     50000  1.5910us  1.4190us  19.719us  acc_update@main.c:220
                    0.00%  39.508ms         9  4.3897ms  7.5270us  39.367ms  acc_enter_data@layers.c:42
                    0.00%  1.1204ms         1  1.1204ms  1.1204ms  1.1204ms  acc_exit_data@main.c:345
                    0.00%  597.03us         1  597.03us  597.03us  597.03us  acc_device_init@main.c:121
                    0.00%  91.335us        18  5.0740us     931ns  31.275us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  67.415us        18  3.7450us     860ns  25.581us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  59.857us         9  6.6500us  4.8710us  10.282us  acc_wait@layers.c:42
                    0.00%  46.566us         2  23.283us  12.099us  34.467us  acc_enter_data@main.c:182
                    0.00%  44.966us         2  22.483us  3.1220us  41.844us  acc_exit_data@main.c:317
                    0.00%  43.271us         1  43.271us  43.271us  43.271us  acc_wait@main.c:121
                    0.00%  43.082us         9  4.7860us  1.6960us  15.537us  acc_exit_data@layers.c:53
                    0.00%  41.509us         3  13.836us  7.9040us  18.550us  acc_enqueue_upload@layers.c:311 (l->weights[:l->weights_size])
                    0.00%  41.449us         1  41.449us  41.449us  41.449us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  32.633us         3  10.877us  8.2290us  12.512us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  25.796us         3  8.5980us  4.2480us  16.755us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  22.614us         3  7.5380us  4.5000us  9.6230us  acc_wait@layers.c:311
                    0.00%  14.508us         3  4.8360us  3.1060us  8.2460us  acc_update@layers.c:311
                    0.00%  11.783us         3  3.9270us  3.7040us  4.1990us  acc_enqueue_upload@layers.c:311 (l->bias[:l->out_depth])
                    0.00%  4.1190us         2  2.0590us  1.6560us  2.4630us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```

## pad_input gang worker collapse(2)
!!! ΛΑΘΟΣ ΑΠΟΤΕΛΕΣΜΑΤΑ
### code
```c
60: void pad_input(float* restrict X, Conv_Layer* l) {
#pragma acc parallel loop present(l,X) collapse(2) gang worker 
  for ( int c = 0; c < l->in_depth; c++) {
    for (int j = 0; j < l->in_height; j++) {
      #pragma acc loop independent vector
      for (int i = 0; i < l->in_width; i++) {
```

### Minfo
```
...
pad_input:
     60, Generating present(X[:],l[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         62, #pragma acc loop gang, worker(4) collapse(2) /* blockIdx.x threadIdx.y */
         63,   /* blockIdx.x threadIdx.y collapsed */
         65, #pragma acc loop vector(32) /* threadIdx.x */
     65, Loop is parallelizable
conv_forward:
     78, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         81, #pragma acc loop gang collapse(2) /* blockIdx.x */
         82,   /* blockIdx.x collapsed */
         84, #pragma acc loop worker(4) /* threadIdx.y */
         89, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         90, #pragma acc loop seq
         91, #pragma acc loop seq
         98, Vector barrier inserted for vector loop reduction
     84, Loop is parallelizable
     89, Loop is parallelizable
     90, Loop is parallelizable
     91, Loop is parallelizable
     96, FMA (fused multiply-add) instruction(s) generated
...
```

### Εκτέλεση
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.028860 seconds
Create Network time:0.039213 seconds
Load Network Parameters time:0.008209 seconds
Create Ouputs time:0.000341 seconds

Net Forward total time:13.485061 seconds
    Time for conv1: 2.742101 seconds
    Time for relu1: 0.440415 seconds
    Time for pool1: 1.944791 seconds
    Time for conv2: 2.363980 seconds
    Time for relu2: 0.146147 seconds
    Time for pool2: 0.624254 seconds
    Time for conv3: 1.486304 seconds
    Time for relu3: 0.040939 seconds
    Time for pool3: 0.156532 seconds
    Time for fc: 0.211306 seconds
    Time for softmax: 0.010482 seconds

  Conv: 6.592385 seconds
  ReLU: 0.627501 seconds
  Pool: 2.725576 seconds
  FC:   0.211306 seconds
  Softmax: 0.010482 seconds

Net Accuracy: 10.00 % 
Net Accuracy time:0.001369 seconds
Free memory time:0.052529 seconds
Total time:14.615583 seconds
END!
```
## Pad_input: collapse(3) gang vector

### Κώδικας
```c
60: void pad_input(float* restrict X, Conv_Layer* l) {
#pragma acc parallel loop present(l,X) collapse(3) gang vector
  for ( int c = 0; c < l->in_depth; c++) {
    for (int j = 0; j < l->in_height; j++) {
      for (int i = 0; i < l->in_width; i++) {
        
76: void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
    pad_input(X, l); //Create input with zero-padding
   // For each output feature map
#pragma acc parallel loop present(l,X,Y) gang collapse(2)
    for ( int m = 0; m < l->out_depth; m++) {
      for (int j = 0; j < l->out_height; j++) {
        #pragma acc loop independent worker
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); 
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
        #pragma acc loop  reduction(+:sum) vector
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
                ...

```

### Εκτέλεση
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.027913 seconds
Create Network time:0.038284 seconds
Load Network Parameters time:0.007928 seconds
Create Ouputs time:0.000348 seconds

Net Forward total time:12.977017 seconds
    Time for conv1: 2.632449 seconds
    Time for relu1: 0.446651 seconds
    Time for pool1: 1.950939 seconds
    Time for conv2: 2.280469 seconds
    Time for relu2: 0.138894 seconds
    Time for pool2: 0.624284 seconds
    Time for conv3: 1.467270 seconds
    Time for relu3: 0.037759 seconds
    Time for pool3: 0.157995 seconds
    Time for fc: 0.210001 seconds
    Time for softmax: 0.010675 seconds

  Conv: 6.380188 seconds
  ReLU: 0.623303 seconds
  Pool: 2.733219 seconds
  FC:   0.210001 seconds
  Softmax: 0.010675 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001515 seconds
Free memory time:0.054273 seconds
Total time:14.107278 seconds
END!
```

### Profiling
#### NV_ACC_TIME
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:1.151050 seconds
Create Network time:0.038312 seconds
Load Network Parameters time:0.007968 seconds
Create Ouputs time:0.000354 seconds

Net Forward total time:16.266072 seconds
    Time for conv1: 3.095739 seconds
    Time for relu1: 0.434612 seconds
    Time for pool1: 1.952973 seconds
    Time for conv2: 2.733202 seconds
    Time for relu2: 0.147154 seconds
    Time for pool2: 0.625460 seconds
    Time for conv3: 1.962334 seconds
    Time for relu3: 0.039003 seconds
    Time for pool3: 0.159569 seconds
    Time for fc: 0.211155 seconds
    Time for softmax: 0.011797 seconds

  Conv: 7.791275 seconds
  ReLU: 0.620770 seconds
  Pool: 2.738001 seconds
  FC:   0.211155 seconds
  Softmax: 0.011797 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001660 seconds
Free memory time:0.060789 seconds
Total time:17.526206 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 232
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=232 max=26 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 190
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=190 max=31 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [800]  block: [128]
            elapsed time(us): total=1,881,598 max=4,331 min=11 avg=12
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    77: compute region reached 150000 times
        77: kernel launched 150000 times
            grid: [160-512]  block: [32x4]
            elapsed time(us): total=4,855,644 max=407 min=19 avg=32
    77: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 56
    309: update directive reached 3 times
        309: data copyin transfers: 6
             device time(us): total=56 max=21 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/main.c
  main  NVIDIA  devicenum=0
    time(us): 2,870,777
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=40 max=40 min=40 avg=40
        121: data copyin transfers: 1
             device time(us): total=137,948 max=137,948 min=137,948 avg=137,948
    182: data region reached 2 times
    190: update directive reached 50000 times
        190: data copyout transfers: 50000
             device time(us): total=1,052,969 max=368 min=19 avg=21
    200: update directive reached 50000 times
        200: data copyin transfers: 50000
             device time(us): total=428,105 max=37 min=6 avg=8
    205: update directive reached 50000 times
        205: data copyout transfers: 50000
             device time(us): total=579,453 max=73 min=10 avg=11
    215: update directive reached 50000 times
        215: data copyin transfers: 50000
             device time(us): total=234,658 max=313 min=3 avg=4
    220: update directive reached 50000 times
        220: data copyout transfers: 50000
             device time(us): total=437,644 max=53 min=7 avg=8
    317: data region reached 2 times
    345: data region reached 1 time
```

#### nvprof
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2300121== NVPROF is profiling process 2300121, command: ./cnn-cifar10-profile
Load Data time:1.310003 seconds
Create Network time:0.038859 seconds
Load Network Parameters time:0.008054 seconds
Create Ouputs time:0.000355 seconds

Net Forward total time:18.138982 seconds
    Time for conv1: 3.791344 seconds
    Time for relu1: 0.644497 seconds
    Time for pool1: 1.605786 seconds
    Time for conv2: 3.420345 seconds
    Time for relu2: 0.209677 seconds
    Time for pool2: 0.517998 seconds
    Time for conv3: 2.534582 seconds
    Time for relu3: 0.056532 seconds
    Time for pool3: 0.134349 seconds
    Time for fc: 0.223998 seconds
    Time for softmax: 0.013385 seconds

  Conv: 9.746271 seconds
  ReLU: 0.910706 seconds
  Pool: 2.258133 seconds
  FC:   0.223998 seconds
  Softmax: 0.013385 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001712 seconds
Free memory time:0.077411 seconds
Total time:19.575376 seconds
END!
==2300121== Profiling application: ./cnn-cifar10-profile
==2300121== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   74.80%  3.92237s    150000  26.149us  11.935us  38.048us  _8layers_c_conv_forward_77_gpu
                    9.80%  514.00ms    150000  3.4260us  3.3910us  13.663us  _8layers_c_pad_input_60_gpu
                    8.82%  462.48ms    150000  3.0830us  1.4710us  18.432us  [CUDA memcpy DtoH]
                    6.58%  344.92ms    100031  3.4480us     735ns  146.19ms  [CUDA memcpy HtoD]
                    0.00%  2.8480us         1  2.8480us  2.8480us  2.8480us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   55.25%  6.18745s    850015  7.2790us     620ns  6.5676ms  cuStreamSynchronize
                   23.56%  2.63792s    150000  17.586us  10.676us  10.492ms  cuMemcpyDtoHAsync
                   11.62%  1.30178s    300001  4.3390us  3.3300us  4.8059ms  cuLaunchKernel
                    6.18%  691.56ms    100031  6.9130us  2.7660us  146.38ms  cuMemcpyHtoDAsync
                    1.41%  157.54ms         1  157.54ms  157.54ms  157.54ms  cuDevicePrimaryCtxRetain
                    1.05%  117.28ms    300000     390ns     187ns  2.2030ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.40%  44.582ms    300010     148ns     114ns  117.77us  cuDeviceGetAttribute
                    0.34%  38.363ms         1  38.363ms  38.363ms  38.363ms  cuMemHostAlloc
                    0.15%  17.101ms     50018     341ns     218ns  799.67us  cuPointerGetAttributes
                    0.03%  2.9921ms        20  149.60us  1.8990us  2.5771ms  cuMemAlloc
                    0.01%  1.3365ms         1  1.3365ms  1.3365ms  1.3365ms  cuMemAllocHost
                    0.00%  323.88us         2  161.94us  119.50us  204.39us  cuModuleLoadDataEx
                    0.00%  8.9290us         1  8.9290us  8.9290us  8.9290us  cuDeviceGetPCIBusId
                    0.00%  3.6300us         4     907ns     327ns  1.5590us  cuModuleGetFunction
                    0.00%  2.0300us         3     676ns     253ns  1.0780us  cuCtxSetCurrent
                    0.00%  1.5000us         3     500ns     114ns  1.2180us  cuDeviceGetCount
                    0.00%     609ns         3     203ns     120ns     294ns  cuDriverGetVersion
                    0.00%     574ns         1     574ns     574ns     574ns  cuDeviceComputeCapability
                    0.00%     455ns         2     227ns     145ns     310ns  cuDeviceGet
                    0.00%     386ns         1     386ns     386ns     386ns  cuCtxGetCurrent
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.66527s    300000  15.550us  1.7550us  1.5653ms  acc_wait@layers.c:77
                    0.00%  1.31106s     50000  26.221us  23.671us  2.6414ms  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  1.21036s    300000  4.0340us  1.2940us  6.5690ms  acc_wait@layers.c:60
                    0.00%  861.94ms    150000  5.7460us  4.8670us  811.12us  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  824.00ms     50000  16.480us  14.471us  10.496ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  806.36ms    150000  5.3750us  4.2950us  4.8676ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  660.07ms     50000  13.201us  11.540us  915.11us  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  473.61ms    150000  3.1570us  2.5560us  2.2108ms  acc_compute_construct@layers.c:60
                    0.00%  387.90ms     50000  7.7570us  6.2210us  4.0225ms  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  383.78ms     50000  7.6750us  2.1940us  1.2811ms  acc_wait@main.c:200
                    0.00%  311.16ms    150000  2.0740us  1.6870us  815.04us  acc_enter_data@layers.c:77
                    0.00%  290.11ms     50000  5.8020us  2.0790us  840.83us  acc_wait@main.c:215
                    0.00%  281.87ms    150000  1.8790us  1.6330us  1.4106ms  acc_compute_construct@layers.c:77
                    0.00%  281.35ms    150000  1.8750us  1.6260us  19.028us  acc_enter_data@layers.c:60
                    0.00%  263.75ms    150000  1.7580us  1.5220us  792.08us  acc_exit_data@layers.c:77
                    0.00%  244.47ms     50000  4.8890us  4.0270us  2.4214ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  227.44ms    150000  1.5160us  1.3010us  795.36us  acc_exit_data@layers.c:60
                    0.00%  146.39ms         1  146.39ms  146.39ms  146.39ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  114.03ms     50000  2.2800us  1.8610us  5.6491ms  acc_wait@main.c:190
                    0.00%  108.92ms     50000  2.1780us  1.8690us  680.56us  acc_wait@main.c:205
                    0.00%  106.62ms     50000  2.1320us  1.8360us  804.84us  acc_wait@main.c:220
                    0.00%  93.880ms     50000  1.8770us  1.6330us  18.899us  acc_update@main.c:200
                    0.00%  91.235ms     50000  1.8240us  1.5800us  18.681us  acc_update@main.c:215
                    0.00%  86.605ms     50000  1.7320us  1.5020us  803.94us  acc_update@main.c:190
                    0.00%  85.098ms     50000  1.7010us  1.4800us  1.3401ms  acc_update@main.c:220
                    0.00%  84.347ms     50000  1.6860us  1.4780us  22.270us  acc_update@main.c:205
                    0.00%  38.576ms         9  4.2862ms  7.2580us  38.415ms  acc_enter_data@layers.c:42
                    0.00%  1.0965ms         1  1.0965ms  1.0965ms  1.0965ms  acc_exit_data@main.c:345
                    0.00%  267.88us         1  267.88us  267.88us  267.88us  acc_device_init@main.c:121
                    0.00%  82.572us        18  4.5870us     858ns  29.415us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  71.996us        18  3.9990us     960ns  27.988us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  70.119us         1  70.119us  70.119us  70.119us  acc_wait@main.c:121
                    0.00%  58.339us         9  6.4820us  4.4560us  10.052us  acc_wait@layers.c:42
                    0.00%  47.214us         2  23.607us  3.3730us  43.841us  acc_exit_data@main.c:317
                    0.00%  46.432us         9  5.1590us  1.8180us  17.665us  acc_exit_data@layers.c:53
                    0.00%  44.200us         1  44.200us  44.200us  44.200us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  43.573us         2  21.786us  11.032us  32.541us  acc_enter_data@main.c:182
                    0.00%  40.578us         3  13.526us  7.5390us  17.887us  acc_enqueue_upload@layers.c:309 (l->weights[:l->weights_size])
                    0.00%  30.129us         3  10.043us  7.3390us  11.473us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  23.312us         3  7.7700us  3.9290us  15.026us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  22.449us         3  7.4830us  3.7980us  9.7570us  acc_wait@layers.c:309
                    0.00%  12.770us         3  4.2560us  2.7000us  7.1610us  acc_update@layers.c:309
                    0.00%  11.789us         3  3.9290us  3.6220us  4.5360us  acc_enqueue_upload@layers.c:309 (l->bias[:l->out_depth])
                    0.00%  4.9070us         2  2.4530us  1.6650us  3.2420us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```
## Con_forward: collapse(3) gang worker 
```c
60: void pad_input(float* restrict X, Conv_Layer* l) {
#pragma acc parallel loop present(l,X) collapse(3) gang vector 
  for ( int c = 0; c < l->in_depth; c++) {
    for (int j = 0; j < l->in_height; j++) {
      for (int i = 0; i < l->in_width; i++) {
        ...
...
76: void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
    pad_input(X, l); //Create input with zero-padding
   // For each output feature map
#pragma acc parallel loop present(l,X,Y) collapse(3) gang worker 
    for ( int m = 0; m < l->out_depth; m++) {
      for (int j = 0; j < l->out_height; j++) {
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); 
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
        #pragma acc loop  reduction(+:sum) vector
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
                ...
...
```
### Minfo
```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c main.c -o main.o
main:
    121, Generating enter data copyin(input[:50000][:3072])
    182, Generating enter data create(O6[:L6->out_size],O7[:L7->out_size],O3[:L3->out_size],O1[:L1->out_size],O4[:L4->out_size])
    190, Generating update self(O1[:L1->out_size])
    200, Generating update device(O3[:L3->out_size])
    205, Generating update self(O4[:L4->out_size])
    215, Generating update device(O6[:L6->out_size])
    220, Generating update self(O7[:L7->out_size])
    317, Generating exit data delete(O6[:L6->out_size],O3[:L3->out_size],O1[:L1->out_size],O4[:L4->out_size],O7[:L7->out_size])
    345, Generating exit data delete(input[:50000][:3072])
arr2txt:
    368, Zero trip check eliminated
arr2txt_2:
    390, Zero trip check eliminated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(l[:],X[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         62, #pragma acc loop gang, vector(128) collapse(3) /* blockIdx.x threadIdx.x */
         63,   /* blockIdx.x threadIdx.x collapsed */
         64,   /* blockIdx.x threadIdx.x collapsed */
conv_forward:
     77, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         80, #pragma acc loop gang, worker(4) collapse(3) /* blockIdx.x threadIdx.y */
         81,   /* blockIdx.x threadIdx.y collapsed */
         82,   /* blockIdx.x threadIdx.y collapsed */
         87, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         88, #pragma acc loop seq
         89, #pragma acc loop seq
         96, Vector barrier inserted for vector loop reduction
     87, Loop is parallelizable
     88, Loop is parallelizable
     89, Loop is parallelizable
     94, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    185, Zero trip check eliminated
fc_forward:
    246, FMA (fused multiply-add) instruction(s) generated
load_conv:
    308, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c malloc2D.c -o malloc2D.o
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c timer.c -o timer.o
cpu_timer_stop:
     11, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```

### Εκτέλεση
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.063655 seconds
Create Network time:0.038608 seconds
Load Network Parameters time:0.008317 seconds
Create Ouputs time:0.000382 seconds

Net Forward total time:14.095878 seconds
    Time for conv1: 2.774423 seconds
    Time for relu1: 0.445891 seconds
    Time for pool1: 2.148393 seconds
    Time for conv2: 2.553710 seconds
    Time for relu2: 0.142683 seconds
    Time for pool2: 0.655110 seconds
    Time for conv3: 1.584945 seconds
    Time for relu3: 0.042361 seconds
    Time for pool3: 0.166615 seconds
    Time for fc: 0.219663 seconds
    Time for softmax: 0.011622 seconds

  Conv: 6.913078 seconds
  ReLU: 0.630934 seconds
  Pool: 2.970118 seconds
  FC:   0.219663 seconds
  Softmax: 0.011622 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001551 seconds
Free memory time:0.062355 seconds
Total time:15.270745 seconds
END!
```
### Profiling
#### NV_ACC
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:1.174555 seconds
Create Network time:0.040844 seconds
Load Network Parameters time:0.008282 seconds
Create Ouputs time:0.000375 seconds

Net Forward total time:16.650918 seconds
    Time for conv1: 3.079667 seconds
    Time for relu1: 0.448158 seconds
    Time for pool1: 2.085504 seconds
    Time for conv2: 2.834308 seconds
    Time for relu2: 0.143289 seconds
    Time for pool2: 0.640747 seconds
    Time for conv3: 1.989799 seconds
    Time for relu3: 0.041606 seconds
    Time for pool3: 0.162403 seconds
    Time for fc: 0.215652 seconds
    Time for softmax: 0.012449 seconds

  Conv: 7.903774 seconds
  ReLU: 0.633053 seconds
  Pool: 2.888653 seconds
  FC:   0.215652 seconds
  Softmax: 0.012449 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001498 seconds
Free memory time:0.055912 seconds
Total time:17.932384 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 233
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=233 max=31 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 188
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=188 max=31 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [800]  block: [128]
            elapsed time(us): total=1,894,231 max=3,907 min=11 avg=12
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    77: compute region reached 150000 times
        77: kernel launched 150000 times
            grid: [320-4096]  block: [32x4]
            elapsed time(us): total=4,863,148 max=1,148 min=18 avg=32
    77: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 53
    308: update directive reached 3 times
        308: data copyin transfers: 6
             device time(us): total=53 max=20 min=3 avg=8
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/main.c
  main  NVIDIA  devicenum=0
    time(us): 2,920,468
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=69 max=69 min=69 avg=69
        121: data copyin transfers: 1
             device time(us): total=145,046 max=145,046 min=145,046 avg=145,046
    182: data region reached 2 times
    190: update directive reached 50000 times
        190: data copyout transfers: 50000
             device time(us): total=1,031,811 max=865 min=19 avg=20
    200: update directive reached 50000 times
        200: data copyin transfers: 50000
             device time(us): total=438,302 max=1,163 min=7 avg=8
    205: update directive reached 50000 times
        205: data copyout transfers: 50000
             device time(us): total=613,057 max=1,089 min=10 avg=12
    215: update directive reached 50000 times
        215: data copyin transfers: 50000
             device time(us): total=240,987 max=22 min=3 avg=4
    220: update directive reached 50000 times
        220: data copyout transfers: 50000
             device time(us): total=451,265 max=350 min=7 avg=9
    317: data region reached 2 times
    345: data region reached 1 time
```
#### nvprof
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2313733== NVPROF is profiling process 2313733, command: ./cnn-cifar10-profile
Load Data time:1.325165 seconds
Create Network time:0.038189 seconds
Load Network Parameters time:0.008131 seconds
Create Ouputs time:0.000356 seconds

Net Forward total time:17.634062 seconds
    Time for conv1: 3.675475 seconds
    Time for relu1: 0.638422 seconds
    Time for pool1: 1.575514 seconds
    Time for conv2: 3.456513 seconds
    Time for relu2: 0.211423 seconds
    Time for pool2: 0.509378 seconds
    Time for conv3: 2.454909 seconds
    Time for relu3: 0.055376 seconds
    Time for pool3: 0.133669 seconds
    Time for fc: 0.225627 seconds
    Time for softmax: 0.015235 seconds

  Conv: 9.586898 seconds
  ReLU: 0.905221 seconds
  Pool: 2.218560 seconds
  FC:   0.225627 seconds
  Softmax: 0.015235 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001978 seconds
Free memory time:0.072839 seconds
Total time:19.080719 seconds
END!
==2313733== Profiling application: ./cnn-cifar10-profile
==2313733== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   74.80%  3.91615s    150000  26.107us  11.456us  37.376us  _8layers_c_conv_forward_77_gpu
                    9.77%  511.68ms    150000  3.4110us  3.3590us  13.536us  _8layers_c_pad_input_60_gpu
                    8.83%  462.31ms    150000  3.0820us  1.4710us  18.560us  [CUDA memcpy DtoH]
                    6.59%  345.06ms    100031  3.4490us     735ns  146.27ms  [CUDA memcpy HtoD]
                    0.00%  2.8160us         1  2.8160us  2.8160us  2.8160us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   55.73%  6.11937s    850015  7.1990us     600ns  833.25us  cuStreamSynchronize
                   22.83%  2.50704s    150000  16.713us  10.296us  6.7211ms  cuMemcpyDtoHAsync
                   12.32%  1.35234s    300001  4.5070us  3.3640us  9.6316ms  cuLaunchKernel
                    5.55%  609.86ms    100031  6.0960us  2.7350us  146.46ms  cuMemcpyHtoDAsync
                    1.52%  166.58ms         1  166.58ms  166.58ms  166.58ms  cuDevicePrimaryCtxRetain
                    1.04%  114.47ms    300000     381ns     189ns  4.7925ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.46%  50.530ms    300010     168ns     119ns  1.1602ms  cuDeviceGetAttribute
                    0.34%  37.699ms         1  37.699ms  37.699ms  37.699ms  cuMemHostAlloc
                    0.15%  16.766ms     50019     335ns     251ns  796.87us  cuPointerGetAttributes
                    0.05%  5.1367ms         1  5.1367ms  5.1367ms  5.1367ms  cuMemAllocHost
                    0.00%  523.90us        20  26.195us  2.0280us  245.42us  cuMemAlloc
                    0.00%  357.54us         2  178.77us  115.12us  242.43us  cuModuleLoadDataEx
                    0.00%  21.018us         1  21.018us  21.018us  21.018us  cuCtxGetCurrent
                    0.00%  18.787us         1  18.787us  18.787us  18.787us  cuDeviceGetPCIBusId
                    0.00%  4.0660us         4  1.0160us     351ns  1.8980us  cuModuleGetFunction
                    0.00%  2.2430us         3     747ns     263ns  1.7040us  cuDeviceGetCount
                    0.00%  1.8700us         3     623ns     245ns     870ns  cuCtxSetCurrent
                    0.00%     919ns         2     459ns     222ns     697ns  cuDeviceGet
                    0.00%     716ns         3     238ns     166ns     293ns  cuDriverGetVersion
                    0.00%     594ns         1     594ns     594ns     594ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.60326s    300000  15.344us  1.5800us  541.01us  acc_wait@layers.c:77
                    0.00%  1.23749s     50000  24.749us  22.424us  3.1650ms  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  1.17304s    300000  3.9100us  1.2040us  7.0072ms  acc_wait@layers.c:60
                    0.00%  871.75ms    150000  5.8110us  4.7980us  9.6356ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  822.85ms    150000  5.4850us  4.2800us  4.5217ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  777.26ms     50000  15.545us  13.941us  1.6123ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  645.58ms     50000  12.911us  11.096us  6.7232ms  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  458.04ms    150000  3.0530us  2.4470us  6.9802ms  acc_compute_construct@layers.c:60
                    0.00%  371.68ms     50000  7.4330us  1.7940us  873.06us  acc_wait@main.c:200
                    0.00%  302.88ms     50000  6.0570us  4.3670us  10.220ms  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  302.04ms    150000  2.0130us  1.6320us  821.49us  acc_enter_data@layers.c:77
                    0.00%  289.47ms     50000  5.7890us  1.7980us  878.08us  acc_wait@main.c:215
                    0.00%  269.11ms    150000  1.7940us  1.5690us  1.4000ms  acc_compute_construct@layers.c:77
                    0.00%  266.67ms    150000  1.7770us  1.5270us  48.831us  acc_enter_data@layers.c:60
                    0.00%  249.46ms    150000  1.6630us  1.4600us  756.53us  acc_exit_data@layers.c:77
                    0.00%  239.45ms     50000  4.7890us  3.6280us  4.9653ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  222.10ms    150000  1.4800us  1.2600us  773.23us  acc_exit_data@layers.c:60
                    0.00%  146.47ms         1  146.47ms  146.47ms  146.47ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  97.528ms     50000  1.9500us  1.6600us  787.91us  acc_wait@main.c:220
                    0.00%  96.899ms     50000  1.9370us  1.6780us  771.71us  acc_wait@main.c:190
                    0.00%  96.449ms     50000  1.9280us  1.6710us  280.82us  acc_wait@main.c:205
                    0.00%  87.775ms     50000  1.7550us  1.5120us  49.375us  acc_update@main.c:200
                    0.00%  86.234ms     50000  1.7240us  1.4790us  34.519us  acc_update@main.c:215
                    0.00%  84.383ms     50000  1.6870us  1.4150us  790.90us  acc_update@main.c:190
                    0.00%  81.520ms     50000  1.6300us  1.4180us  34.783us  acc_update@main.c:220
                    0.00%  80.356ms     50000  1.6070us  1.3990us  92.259us  acc_update@main.c:205
                    0.00%  37.915ms         9  4.2128ms  7.0490us  37.751ms  acc_enter_data@layers.c:42
                    0.00%  1.1419ms         1  1.1419ms  1.1419ms  1.1419ms  acc_exit_data@main.c:345
                    0.00%  300.69us         1  300.69us  300.69us  300.69us  acc_device_init@main.c:121
                    0.00%  80.243us        18  4.4570us     826ns  25.300us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  78.954us        18  4.3860us     906ns  34.927us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  65.991us         1  65.991us  65.991us  65.991us  acc_wait@main.c:121
                    0.00%  59.078us         9  6.5640us  4.6450us  9.5770us  acc_wait@layers.c:42
                    0.00%  51.876us         1  51.876us  51.876us  51.876us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  48.675us         9  5.4080us  1.7600us  20.813us  acc_exit_data@layers.c:53
                    0.00%  44.380us         2  22.190us  14.265us  30.115us  acc_enter_data@main.c:182
                    0.00%  39.492us         3  13.164us  7.1150us  16.904us  acc_enqueue_upload@layers.c:308 (l->weights[:l->weights_size])
                    0.00%  36.968us         2  18.484us  3.4500us  33.518us  acc_exit_data@main.c:317
                    0.00%  30.662us         3  10.220us  7.2160us  11.855us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  24.108us         3  8.0360us  3.9180us  15.944us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  21.156us         3  7.0520us  3.6400us  9.1970us  acc_wait@layers.c:308
                    0.00%  13.400us         3  4.4660us  2.9960us  7.3900us  acc_update@layers.c:308
                    0.00%  11.269us         3  3.7560us  3.5630us  3.9290us  acc_enqueue_upload@layers.c:308 (l->bias[:l->out_depth])
                    0.00%  3.9460us         2  1.9730us  1.6250us  2.3210us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```
### Profile pad_input: collapse(3) gang worker vector   
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2553136== NVPROF is profiling process 2553136, command: ./cnn-cifar10-profile
Load Data time:1.367031 seconds
Create Network time:0.037665 seconds
Load Network Parameters time:0.007806 seconds
Create Ouputs time:0.000327 seconds

Net Forward total time:17.693606 seconds
    Time for conv1: 3.750022 seconds
    Time for relu1: 0.631975 seconds
    Time for pool1: 1.573987 seconds
    Time for conv2: 3.358242 seconds
    Time for relu2: 0.202538 seconds
    Time for pool2: 0.506891 seconds
    Time for conv3: 2.482785 seconds
    Time for relu3: 0.062013 seconds
    Time for pool3: 0.131977 seconds
    Time for fc: 0.216436 seconds
    Time for softmax: 0.014923 seconds

  Conv: 9.591049 seconds
  ReLU: 0.896527 seconds
  Pool: 2.212855 seconds
  FC:   0.216436 seconds
  Softmax: 0.014923 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001882 seconds
Free memory time:0.052529 seconds
Total time:19.160848 seconds
END!
==2553136== Profiling application: ./cnn-cifar10-profile
==2553136== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   74.79%  3.92173s    150000  26.144us  11.936us  37.568us  _8layers_c_conv_forward_77_gpu
                    9.83%  515.42ms    150000  3.4360us  3.3910us  13.504us  _8layers_c_pad_input_60_gpu
                    8.81%  461.77ms    150000  3.0780us  1.4710us  18.464us  [CUDA memcpy DtoH]
                    6.58%  344.88ms    100031  3.4470us     703ns  146.15ms  [CUDA memcpy HtoD]
                    0.00%  3.2320us         1  3.2320us  3.2320us  3.2320us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   55.41%  6.13053s    850015  7.2120us     600ns  4.5043ms  cuStreamSynchronize
                   23.28%  2.57614s    150000  17.174us  10.494us  8.6194ms  cuMemcpyDtoHAsync
                   12.33%  1.36466s    300001  4.5480us  3.4520us  4.4907ms  cuLaunchKernel
                    5.52%  611.32ms    100031  6.1110us  2.5550us  146.36ms  cuMemcpyHtoDAsync
                    1.53%  169.47ms         1  169.47ms  169.47ms  169.47ms  cuDevicePrimaryCtxRetain
                    0.94%  103.99ms    300000     346ns     175ns  975.56us  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.45%  49.368ms    300010     164ns     124ns  764.01us  cuDeviceGetAttribute
                    0.34%  37.190ms         1  37.190ms  37.190ms  37.190ms  cuMemHostAlloc
                    0.18%  19.623ms     50019     392ns     236ns  816.29us  cuPointerGetAttributes
                    0.01%  1.3000ms         1  1.3000ms  1.3000ms  1.3000ms  cuMemAllocHost
                    0.00%  546.37us         2  273.19us  106.58us  439.80us  cuModuleLoadDataEx
                    0.00%  486.75us        20  24.337us  1.9770us  212.93us  cuMemAlloc
                    0.00%  11.670us         1  11.670us  11.670us  11.670us  cuDeviceGetPCIBusId
                    0.00%  9.2560us         1  9.2560us  9.2560us  9.2560us  cuCtxGetCurrent
                    0.00%  4.0830us         4  1.0200us     341ns  1.8390us  cuModuleGetFunction
                    0.00%  3.1110us         3  1.0370us     163ns  1.8130us  cuCtxSetCurrent
                    0.00%  2.1040us         3     701ns     302ns  1.4740us  cuDeviceGetCount
                    0.00%     950ns         2     475ns     122ns     828ns  cuDeviceGet
                    0.00%     833ns         3     277ns     111ns     541ns  cuDriverGetVersion
                    0.00%     723ns         1     723ns     723ns     723ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.61345s    300000  15.378us  1.5810us  2.0087ms  acc_wait@layers.c:77
                    0.00%  1.27258s     50000  25.451us  23.238us  3.5712ms  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  1.17329s    300000  3.9100us  1.2240us  4.5319ms  acc_wait@layers.c:60
                    0.00%  872.58ms    150000  5.8170us  4.7720us  4.4940ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  825.14ms    150000  5.5000us  4.3390us  2.9507ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  795.40ms     50000  15.907us  14.059us  8.6219ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  648.73ms     50000  12.974us  11.291us  6.5875ms  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  447.39ms    150000  2.9820us  2.4690us  979.63us  acc_compute_construct@layers.c:60
                    0.00%  378.25ms     50000  7.5650us  1.8180us  851.41us  acc_wait@main.c:200
                    0.00%  300.10ms    150000  2.0000us  1.6300us  1.6332ms  acc_enter_data@layers.c:77
                    0.00%  299.16ms     50000  5.9830us  4.4140us  8.7658ms  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  277.82ms     50000  5.5560us  1.8360us  789.84us  acc_wait@main.c:215
                    0.00%  266.96ms    150000  1.7790us  1.5230us  32.293us  acc_enter_data@layers.c:60
                    0.00%  266.53ms    150000  1.7760us  1.5730us  776.96us  acc_compute_construct@layers.c:77
                    0.00%  258.01ms    150000  1.7200us  1.4930us  790.20us  acc_exit_data@layers.c:77
                    0.00%  245.26ms     50000  4.9050us  3.6850us  8.7883ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  218.58ms    150000  1.4570us  1.2530us  723.35us  acc_exit_data@layers.c:60
                    0.00%  146.36ms         1  146.36ms  146.36ms  146.36ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  100.63ms     50000  2.0120us  1.6930us  823.21us  acc_wait@main.c:190
                    0.00%  100.54ms     50000  2.0100us  1.6960us  1.4539ms  acc_wait@main.c:205
                    0.00%  98.756ms     50000  1.9750us  1.6880us  723.03us  acc_wait@main.c:220
                    0.00%  92.194ms     50000  1.8430us  1.5950us  62.535us  acc_update@main.c:200
                    0.00%  89.789ms     50000  1.7950us  1.4430us  824.49us  acc_update@main.c:190
                    0.00%  88.506ms     50000  1.7700us  1.5200us  28.557us  acc_update@main.c:215
                    0.00%  82.579ms     50000  1.6510us  1.4310us  764.78us  acc_update@main.c:205
                    0.00%  82.186ms     50000  1.6430us  1.4160us  808.00us  acc_update@main.c:220
                    0.00%  37.397ms         9  4.1552ms  6.8060us  37.243ms  acc_enter_data@layers.c:42
                    0.00%  1.1373ms         1  1.1373ms  1.1373ms  1.1373ms  acc_exit_data@main.c:345
                    0.00%  530.45us         1  530.45us  530.45us  530.45us  acc_device_init@main.c:121
                    0.00%  86.458us        18  4.8030us     849ns  24.862us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  75.342us        18  4.1850us     914ns  31.408us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  69.654us         1  69.654us  69.654us  69.654us  acc_wait@main.c:121
                    0.00%  60.747us         9  6.7490us  4.4800us  10.847us  acc_wait@layers.c:42
                    0.00%  52.609us         1  52.609us  52.609us  52.609us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  48.633us         9  5.4030us  1.7170us  20.584us  acc_exit_data@layers.c:53
                    0.00%  47.655us         2  23.827us  3.7120us  43.943us  acc_exit_data@main.c:317
                    0.00%  44.792us         2  22.396us  11.411us  33.381us  acc_enter_data@main.c:182
                    0.00%  40.180us         3  13.393us  7.8020us  17.589us  acc_enqueue_upload@layers.c:309 (l->weights[:l->weights_size])
                    0.00%  30.415us         3  10.138us  7.1130us  11.811us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  22.402us         3  7.4670us  3.8270us  14.252us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  22.353us         3  7.4510us  3.9410us  9.6240us  acc_wait@layers.c:309
                    0.00%  13.395us         3  4.4650us  2.8210us  7.6580us  acc_update@layers.c:309
                    0.00%  10.800us         3  3.6000us  3.3460us  4.0610us  acc_enqueue_upload@layers.c:309 (l->bias[:l->out_depth])
                    0.00%  4.6620us         2  2.3310us  1.5360us  3.1260us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```

## conv_forwad : independent collapse(3) gang worker
### κώδικας
```c
60: void pad_input(float* restrict X, Conv_Layer* l) {
#pragma acc parallel loop present(l,X) collapse(3) gang vector //collapse(3) gang vector vector_length(32) 
  for ( int c = 0; c < l->in_depth; c++) {
    for (int j = 0; j < l->in_height; j++) {
      for (int i = 0; i < l->in_width; i++) {
...
76: void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
    pad_input(X, l); //Create input with zero-padding
   // For each output feature map
#pragma acc parallel loop present(l,X,Y) independent collapse(3) gang worker //vector_length(32) 
    for ( int m = 0; m < l->out_depth; m++) {
      for (int j = 0; j < l->out_height; j++) {
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); // Output index
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
        #pragma acc loop  reduction(+:sum) vector//collapse(2) vector
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
            ...
```
### Minfo
```
...
pad_input:
     60, Generating present(l[:],X[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         62, #pragma acc loop gang, vector(128) collapse(3) /* blockIdx.x threadIdx.x */
         63,   /* blockIdx.x threadIdx.x collapsed */
         64,   /* blockIdx.x threadIdx.x collapsed */
conv_forward:
     77, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         80, #pragma acc loop gang, worker(4) collapse(3) /* blockIdx.x threadIdx.y */
         81,   /* blockIdx.x threadIdx.y collapsed */
         82,   /* blockIdx.x threadIdx.y collapsed */
         87, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         88, #pragma acc loop seq
         89, #pragma acc loop seq
         96, Vector barrier inserted for vector loop reduction
     87, Loop is parallelizable
     88, Loop is parallelizable
     89, Loop is parallelizable
     94, FMA (fused multiply-add) instruction(s) generated
...
```

### Εκτέλεση
1.
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.030366 seconds
Create Network time:0.040178 seconds
Load Network Parameters time:0.008447 seconds
Create Ouputs time:0.000363 seconds

Net Forward total time:13.409848 seconds
    Time for conv1: 2.621197 seconds
    Time for relu1: 0.452162 seconds
    Time for pool1: 2.105233 seconds
    Time for conv2: 2.410298 seconds
    Time for relu2: 0.148732 seconds
    Time for pool2: 0.650406 seconds
    Time for conv3: 1.489251 seconds
    Time for relu3: 0.046200 seconds
    Time for pool3: 0.163762 seconds
    Time for fc: 0.214809 seconds
    Time for softmax: 0.011844 seconds

  Conv: 6.520747 seconds
  ReLU: 0.647093 seconds
  Pool: 2.919401 seconds
  FC:   0.214809 seconds
  Softmax: 0.011844 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001470 seconds
Free memory time:0.057538 seconds
Total time:14.548209 seconds
END!
```

2.
```
$ ./cnn-cifar10
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.026798 seconds
Create Network time:0.040100 seconds
Load Network Parameters time:0.008395 seconds
Create Ouputs time:0.000329 seconds

Net Forward total time:13.113166 seconds
    Time for conv1: 2.620520 seconds
    Time for relu1: 0.445842 seconds
    Time for pool1: 1.938760 seconds
    Time for conv2: 2.394771 seconds
    Time for relu2: 0.145300 seconds
    Time for pool2: 0.637371 seconds
    Time for conv3: 1.474881 seconds
    Time for relu3: 0.041264 seconds
    Time for pool3: 0.159630 seconds
    Time for fc: 0.210165 seconds
    Time for softmax: 0.012182 seconds

  Conv: 6.490172 seconds
  ReLU: 0.632407 seconds
  Pool: 2.735762 seconds
  FC:   0.210165 seconds
  Softmax: 0.012182 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001495 seconds
Free memory time:0.051999 seconds
Total time:14.242282 seconds
END!
```

### Profiling
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:1.181801 seconds
Create Network time:0.040837 seconds
Load Network Parameters time:0.008877 seconds
Create Ouputs time:0.000326 seconds

Net Forward total time:16.400647 seconds
    Time for conv1: 3.062719 seconds
    Time for relu1: 0.457093 seconds
    Time for pool1: 2.038807 seconds
    Time for conv2: 2.799594 seconds
    Time for relu2: 0.147844 seconds
    Time for pool2: 0.627553 seconds
    Time for conv3: 1.942890 seconds
    Time for relu3: 0.042561 seconds
    Time for pool3: 0.159395 seconds
    Time for fc: 0.211351 seconds
    Time for softmax: 0.011713 seconds

  Conv: 7.805203 seconds
  ReLU: 0.647498 seconds
  Pool: 2.825755 seconds
  FC:   0.211351 seconds
  Softmax: 0.011713 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001624 seconds
Free memory time:0.055807 seconds
Total time:17.689920 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 271
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=271 max=29 min=3 avg=11
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 190
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=190 max=34 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [800]  block: [128]
            elapsed time(us): total=1,876,728 max=3,894 min=11 avg=12
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    77: compute region reached 150000 times
        77: kernel launched 150000 times
            grid: [320-4096]  block: [32x4]
            elapsed time(us): total=4,858,147 max=4,285 min=18 avg=32
    77: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 54
    308: update directive reached 3 times
        308: data copyin transfers: 6
             device time(us): total=54 max=21 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/main.c
  main  NVIDIA  devicenum=0
    time(us): 2,865,455
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=42 max=42 min=42 avg=42
        121: data copyin transfers: 1
             device time(us): total=138,501 max=138,501 min=138,501 avg=138,501
    182: data region reached 2 times
    190: update directive reached 50000 times
        190: data copyout transfers: 50000
             device time(us): total=1,032,319 max=1,182 min=19 avg=20
    200: update directive reached 50000 times
        200: data copyin transfers: 50000
             device time(us): total=432,276 max=322 min=7 avg=8
    205: update directive reached 50000 times
        205: data copyout transfers: 50000
             device time(us): total=589,048 max=1,194 min=10 avg=11
    215: update directive reached 50000 times
        215: data copyin transfers: 50000
             device time(us): total=238,909 max=334 min=3 avg=4
    220: update directive reached 50000 times
        220: data copyout transfers: 50000
             device time(us): total=434,402 max=45 min=7 avg=8
    317: data region reached 2 times
    345: data region reached 1 time
```

## conv_forward: gang collpase(2) - worker - vector
### code
```c
60:void pad_input(float* restrict X, Conv_Layer* l) {
#pragma acc parallel loop present(l,X) collapse(3) gang vector //collapse(3) gang vector vector_length(32) 
  for ( int c = 0; c < l->in_depth; c++) {
    for (int j = 0; j < l->in_height; j++) {
      for (int i = 0; i < l->in_width; i++) {
        ...

76: void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
    pad_input(X, l); //Create input with zero-padding
   // For each output feature map
#pragma acc parallel loop present(l,X,Y) independent collapse(2) gang 
    for ( int m = 0; m < l->out_depth; m++) {
      for (int j = 0; j < l->out_height; j++) {
      #pragma acc loop independent worker
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height));
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
        #pragma acc loop  reduction(+:sum) vector
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
```
### Minfo
```
pad_input:
     60, Generating present(l[:],X[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         62, #pragma acc loop gang, vector(128) collapse(3) /* blockIdx.x threadIdx.x */
         63,   /* blockIdx.x threadIdx.x collapsed */
         64,   /* blockIdx.x threadIdx.x collapsed */
conv_forward:
     77, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         80, #pragma acc loop gang collapse(2) /* blockIdx.x */
         81,   /* blockIdx.x collapsed */
         83, #pragma acc loop worker(4) /* threadIdx.y */
         88, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         90, #pragma acc loop seq
         91, #pragma acc loop seq
         98, Vector barrier inserted for vector loop reduction
     83, Loop is parallelizable
     88, Loop is parallelizable
     90, Loop is parallelizable
     91, Loop is parallelizable
     96, FMA (fused multiply-add) instruction(s) generated
```

### Εκτέλεση
1. 
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.022507 seconds
Create Network time:0.040625 seconds
Load Network Parameters time:0.008082 seconds
Create Ouputs time:0.000365 seconds

Net Forward total time:13.191097 seconds
    Time for conv1: 2.684483 seconds
    Time for relu1: 0.457222 seconds
    Time for pool1: 1.962657 seconds
    Time for conv2: 2.326387 seconds
    Time for relu2: 0.144071 seconds
    Time for pool2: 0.626387 seconds
    Time for conv3: 1.497818 seconds
    Time for relu3: 0.039181 seconds
    Time for pool3: 0.160674 seconds
    Time for fc: 0.211193 seconds
    Time for softmax: 0.011451 seconds

  Conv: 6.508687 seconds
  ReLU: 0.640474 seconds
  Pool: 2.749718 seconds
  FC:   0.211193 seconds
  Softmax: 0.011451 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001449 seconds
Free memory time:0.047335 seconds
Total time:14.311461 seconds
END!
```
2 .
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.039280 seconds
Create Network time:0.041084 seconds
Load Network Parameters time:0.008607 seconds
Create Ouputs time:0.000349 seconds

Net Forward total time:12.943799 seconds
    Time for conv1: 2.624666 seconds
    Time for relu1: 0.444260 seconds
    Time for pool1: 1.952219 seconds
    Time for conv2: 2.264589 seconds
    Time for relu2: 0.137880 seconds
    Time for pool2: 0.622029 seconds
    Time for conv3: 1.458304 seconds
    Time for relu3: 0.039482 seconds
    Time for pool3: 0.159226 seconds
    Time for fc: 0.209922 seconds
    Time for softmax: 0.011289 seconds

  Conv: 6.347560 seconds
  ReLU: 0.621622 seconds
  Pool: 2.733474 seconds
  FC:   0.209922 seconds
  Softmax: 0.011289 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001512 seconds
Free memory time:0.053559 seconds
Total time:14.088192 seconds
END!
```

### Profiling
#### NV_ACC

```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:1.172966 seconds
Create Network time:0.038634 seconds
Load Network Parameters time:0.007961 seconds
Create Ouputs time:0.000353 seconds

Net Forward total time:16.535118 seconds
    Time for conv1: 3.141854 seconds
    Time for relu1: 0.456881 seconds
    Time for pool1: 2.001337 seconds
    Time for conv2: 2.760702 seconds
    Time for relu2: 0.147891 seconds
    Time for pool2: 0.642626 seconds
    Time for conv3: 1.990687 seconds
    Time for relu3: 0.045396 seconds
    Time for pool3: 0.165046 seconds
    Time for fc: 0.215114 seconds
    Time for softmax: 0.012220 seconds

  Conv: 7.893243 seconds
  ReLU: 0.650169 seconds
  Pool: 2.809009 seconds
  FC:   0.215114 seconds
  Softmax: 0.012220 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001597 seconds
Free memory time:0.056412 seconds
Total time:17.813040 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 226
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=226 max=28 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 177
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=177 max=28 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [800]  block: [128]
            elapsed time(us): total=1,880,285 max=1,071 min=11 avg=12
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    77: compute region reached 150000 times
        77: kernel launched 150000 times
            grid: [160-512]  block: [32x4]
            elapsed time(us): total=4,892,444 max=4,300 min=19 avg=32
    77: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 54
    310: update directive reached 3 times
        310: data copyin transfers: 6
             device time(us): total=54 max=20 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/main.c
  main  NVIDIA  devicenum=0
    time(us): 2,899,991
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=55 max=55 min=55 avg=55
        121: data copyin transfers: 1
             device time(us): total=151,879 max=151,879 min=151,879 avg=151,879
    182: data region reached 2 times
    190: update directive reached 50000 times
        190: data copyout transfers: 50000
             device time(us): total=1,026,747 max=1,968 min=18 avg=20
    200: update directive reached 50000 times
        200: data copyin transfers: 50000
             device time(us): total=433,799 max=48 min=7 avg=8
    205: update directive reached 50000 times
        205: data copyout transfers: 50000
             device time(us): total=607,069 max=803 min=10 avg=12
    215: update directive reached 50000 times
        215: data copyin transfers: 50000
             device time(us): total=237,844 max=837 min=3 avg=4
    220: update directive reached 50000 times
        220: data copyout transfers: 50000
             device time(us): total=442,653 max=52 min=7 avg=8
    317: data region reached 2 times
    345: data region reached 1 time
```

#### nvprof

```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2362405== NVPROF is profiling process 2362405, command: ./cnn-cifar10-profile
Load Data time:1.355419 seconds
Create Network time:0.038191 seconds
Load Network Parameters time:0.007943 seconds
Create Ouputs time:0.000336 seconds

Net Forward total time:17.818642 seconds
    Time for conv1: 3.765786 seconds
    Time for relu1: 0.637415 seconds
    Time for pool1: 1.599623 seconds
    Time for conv2: 3.371103 seconds
    Time for relu2: 0.208060 seconds
    Time for pool2: 0.512653 seconds
    Time for conv3: 2.513305 seconds
    Time for relu3: 0.060913 seconds
    Time for pool3: 0.133401 seconds
    Time for fc: 0.219790 seconds
    Time for softmax: 0.015163 seconds

  Conv: 9.650195 seconds
  ReLU: 0.906389 seconds
  Pool: 2.245677 seconds
  FC:   0.219790 seconds
  Softmax: 0.015163 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.002075 seconds
Free memory time:0.062123 seconds
Total time:19.284729 seconds
END!
==2362405== Profiling application: ./cnn-cifar10-profile
==2362405== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   74.82%  3.92239s    150000  26.149us  11.936us  37.856us  _8layers_c_conv_forward_77_gpu
                    9.80%  514.00ms    150000  3.4260us  3.3910us  13.504us  _8layers_c_pad_input_60_gpu
                    8.81%  461.99ms    150000  3.0790us  1.4710us  19.456us  [CUDA memcpy DtoH]
                    6.57%  344.34ms    100031  3.4420us     736ns  145.60ms  [CUDA memcpy HtoD]
                    0.00%  2.5920us         1  2.5920us  2.5920us  2.5920us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   55.40%  6.15877s    850015  7.2450us     594ns  5.3930ms  cuStreamSynchronize
                   23.28%  2.58754s    150000  17.250us  10.568us  6.9635ms  cuMemcpyDtoHAsync
                   12.09%  1.34390s    300001  4.4790us  3.3270us  4.8636ms  cuLaunchKernel
                    5.71%  634.53ms    100031  6.3430us  2.6320us  145.81ms  cuMemcpyHtoDAsync
                    1.43%  158.85ms         1  158.85ms  158.85ms  158.85ms  cuDevicePrimaryCtxRetain
                    1.09%  121.72ms    300000     405ns     185ns  928.04us  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.41%  45.219ms    300010     150ns     117ns  22.745us  cuDeviceGetAttribute
                    0.34%  37.700ms         1  37.700ms  37.700ms  37.700ms  cuMemHostAlloc
                    0.18%  20.275ms     50019     405ns     230ns  902.22us  cuPointerGetAttributes
                    0.05%  6.0651ms         1  6.0651ms  6.0651ms  6.0651ms  cuMemAllocHost
                    0.02%  1.7879ms        20  89.394us  1.9170us  1.4959ms  cuMemAlloc
                    0.01%  603.70us         2  301.85us  127.25us  476.45us  cuModuleLoadDataEx
                    0.00%  16.936us         1  16.936us  16.936us  16.936us  cuDeviceGetPCIBusId
                    0.00%  12.176us         4  3.0440us     353ns  9.3930us  cuModuleGetFunction
                    0.00%  2.9000us         3     966ns     178ns  1.9740us  cuCtxSetCurrent
                    0.00%  1.5370us         3     512ns     120ns  1.2320us  cuDeviceGetCount
                    0.00%     879ns         3     293ns     130ns     534ns  cuDriverGetVersion
                    0.00%     768ns         2     384ns     148ns     620ns  cuDeviceGet
                    0.00%     595ns         1     595ns     595ns     595ns  cuCtxGetCurrent
                    0.00%     528ns         1     528ns     528ns     528ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.63466s    300000  15.448us  1.5990us  1.4801ms  acc_wait@layers.c:77
                    0.00%  1.28346s     50000  25.669us  23.378us  6.9658ms  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  1.17482s    300000  3.9160us  1.1980us  5.4291ms  acc_wait@layers.c:60
                    0.00%  866.71ms    150000  5.7780us  4.6900us  898.73us  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  833.17ms    150000  5.5540us  4.2170us  4.8706ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  806.26ms     50000  16.125us  14.125us  2.1380ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  633.99ms     50000  12.679us  11.332us  908.82us  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  469.79ms    150000  3.1310us  2.4470us  1.2652ms  acc_compute_construct@layers.c:60
                    0.00%  387.35ms     50000  7.7470us  1.8210us  826.50us  acc_wait@main.c:200
                    0.00%  333.79ms     50000  6.6750us  4.4260us  11.433ms  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  302.68ms    150000  2.0170us  1.6310us  973.78us  acc_enter_data@layers.c:77
                    0.00%  275.51ms     50000  5.5100us  1.7890us  808.03us  acc_wait@main.c:215
                    0.00%  266.37ms    150000  1.7750us  1.5190us  741.14us  acc_enter_data@layers.c:60
                    0.00%  265.69ms    150000  1.7710us  1.5250us  375.02us  acc_compute_construct@layers.c:77
                    0.00%  256.21ms    150000  1.7080us  1.4770us  744.69us  acc_exit_data@layers.c:77
                    0.00%  234.02ms     50000  4.6800us  3.7120us  2.5240ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  224.59ms    150000  1.4970us  1.2680us  781.34us  acc_exit_data@layers.c:60
                    0.00%  145.81ms         1  145.81ms  145.81ms  145.81ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  98.535ms     50000  1.9700us  1.6730us  715.24us  acc_wait@main.c:190
                    0.00%  97.375ms     50000  1.9470us  1.6640us  177.68us  acc_wait@main.c:205
                    0.00%  97.125ms     50000  1.9420us  1.6720us  719.93us  acc_wait@main.c:220
                    0.00%  89.156ms     50000  1.7830us  1.5380us  54.585us  acc_update@main.c:200
                    0.00%  86.762ms     50000  1.7350us  1.4940us  32.778us  acc_update@main.c:215
                    0.00%  83.578ms     50000  1.6710us  1.4180us  674.85us  acc_update@main.c:190
                    0.00%  81.948ms     50000  1.6380us  1.4200us  27.953us  acc_update@main.c:220
                    0.00%  80.823ms     50000  1.6160us  1.3890us  31.105us  acc_update@main.c:205
                    0.00%  37.924ms         9  4.2138ms  7.2000us  37.766ms  acc_enter_data@layers.c:42
                    0.00%  1.0549ms         1  1.0549ms  1.0549ms  1.0549ms  acc_exit_data@main.c:345
                    0.00%  572.16us         1  572.16us  572.16us  572.16us  acc_device_init@main.c:121
                    0.00%  80.900us        18  4.4940us     784ns  25.992us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  75.518us        18  4.1950us     855ns  32.363us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  68.544us         1  68.544us  68.544us  68.544us  acc_wait@main.c:121
                    0.00%  57.726us         9  6.4140us  4.5950us  9.2410us  acc_wait@layers.c:42
                    0.00%  51.118us         1  51.118us  51.118us  51.118us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  49.232us         9  5.4700us  1.6820us  21.377us  acc_exit_data@layers.c:53
                    0.00%  45.366us         2  22.683us  11.540us  33.826us  acc_enter_data@main.c:182
                    0.00%  38.742us         3  12.914us  7.1670us  16.902us  acc_enqueue_upload@layers.c:309 (l->weights[:l->weights_size])
                    0.00%  30.582us         2  15.291us  3.2880us  27.294us  acc_exit_data@main.c:317
                    0.00%  30.422us         3  10.140us  7.4810us  11.874us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  25.830us         3  8.6100us  3.7120us  17.909us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  21.907us         3  7.3020us  3.9120us  9.2270us  acc_wait@layers.c:309
                    0.00%  12.805us         3  4.2680us  2.9500us  6.7810us  acc_update@layers.c:309
                    0.00%  10.608us         3  3.5360us  3.3240us  3.7440us  acc_enqueue_upload@layers.c:309 (l->bias[:l->out_depth])
                    0.00%  4.0720us         2  2.0360us  1.6170us  2.4550us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```

## Loop opt -

### code
```c
60: void pad_input(float* restrict X, Conv_Layer* l) {
#pragma acc parallel loop present(l,X) collapse(3) gang worker vector   
  for ( int c = 0; c < l->in_depth; c++) {
    for (int j = 0; j < l->in_height; j++) {
      for (int i = 0; i < l->in_width; i++) {
...
76: void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
    pad_input(X, l); //Create input with zero-padding
   // For each output feature map
#pragma acc parallel loop present(l,X,Y) gang collapse(2)
    for ( int m = 0; m < l->out_depth; m++) {
      for (int j = 0; j < l->out_height; j++) {
        #pragma acc loop independent worker
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); // Output index
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
        #pragma acc loop  reduction(+:sum) vector 
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
                ...
...
```
### Minfo
```
...
pad_input:
     60, Generating present(l[:],X[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         62, #pragma acc loop gang, worker(4), vector(32) collapse(3) blockIdx.x threadIdx.y threadIdx.x */
         63,   /* blockIdx.x threadIdx.y threadIdx.x collapsed */
         64,   /* blockIdx.x threadIdx.y threadIdx.x collapsed */
conv_forward:
     77, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         80, #pragma acc loop gang collapse(2) /* blockIdx.x */
         81,   /* blockIdx.x collapsed */
         83, #pragma acc loop worker(4) /* threadIdx.y */
         88, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         89, #pragma acc loop seq
         90, #pragma acc loop seq
         97, Vector barrier inserted for vector loop reduction
     83, Loop is parallelizable
     88, Loop is parallelizable
     89, Loop is parallelizable
     90, Loop is parallelizable
     95, FMA (fused multiply-add) instruction(s) generated
...
```
### Execution
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.038795 seconds
Create Network time:0.039709 seconds
Load Network Parameters time:0.007993 seconds
Create Ouputs time:0.000362 seconds

Net Forward total time:12.955126 seconds
    Time for conv1: 2.614917 seconds
    Time for relu1: 0.435048 seconds
    Time for pool1: 1.939649 seconds
    Time for conv2: 2.287832 seconds
    Time for relu2: 0.147643 seconds
    Time for pool2: 0.620214 seconds
    Time for conv3: 1.457046 seconds
    Time for relu3: 0.041705 seconds
    Time for pool3: 0.157259 seconds
    Time for fc: 0.209013 seconds
    Time for softmax: 0.010396 seconds

  Conv: 6.359796 seconds
  ReLU: 0.624395 seconds
  Pool: 2.717121 seconds
  FC:   0.209013 seconds
  Softmax: 0.010396 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001478 seconds
Free memory time:0.048266 seconds
Total time:14.091728 seconds
```

### Profile

#### nvprof
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2570753== NVPROF is profiling process 2570753, command: ./cnn-cifar10-profile
Load Data time:1.326091 seconds
Create Network time:0.037984 seconds
Load Network Parameters time:0.007805 seconds
Create Ouputs time:0.000330 seconds

Net Forward total time:17.538730 seconds
    Time for conv1: 3.728141 seconds
    Time for relu1: 0.620873 seconds
    Time for pool1: 1.543105 seconds
    Time for conv2: 3.359599 seconds
    Time for relu2: 0.198418 seconds
    Time for pool2: 0.497892 seconds
    Time for conv3: 2.504256 seconds
    Time for relu3: 0.056016 seconds
    Time for pool3: 0.129652 seconds
    Time for fc: 0.214550 seconds
    Time for softmax: 0.014757 seconds

  Conv: 9.591996 seconds
  ReLU: 0.875307 seconds
  Pool: 2.170650 seconds
  FC:   0.214550 seconds
  Softmax: 0.014757 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001765 seconds
Free memory time:0.056100 seconds
Total time:18.968806 seconds
END!
==2570753== Profiling application: ./cnn-cifar10-profile
==2570753== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   74.80%  3.92248s    150000  26.149us  11.935us  37.664us  _8layers_c_conv_forward_77_gpu
                    9.83%  515.56ms    150000  3.4370us  3.3910us  13.408us  _8layers_c_pad_input_60_gpu
                    8.80%  461.32ms    150000  3.0750us  1.4710us  18.400us  [CUDA memcpy DtoH]
                    6.58%  344.88ms    100031  3.4470us     736ns  146.15ms  [CUDA memcpy HtoD]
                    0.00%  2.6240us         1  2.6240us  2.6240us  2.6240us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   55.70%  6.11088s    850015  7.1890us     598ns  945.55us  cuStreamSynchronize
                   22.83%  2.50528s    150000  16.701us  10.575us  3.8471ms  cuMemcpyDtoHAsync
                   12.34%  1.35364s    300001  4.5120us  3.3840us  12.241ms  cuLaunchKernel
                    5.57%  611.05ms    100031  6.1080us  2.7330us  146.35ms  cuMemcpyHtoDAsync
                    1.58%  173.31ms         1  173.31ms  173.31ms  173.31ms  cuDevicePrimaryCtxRetain
                    0.97%  106.73ms    300000     355ns     181ns  5.1070ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.46%  50.800ms    300010     169ns     138ns  128.68us  cuDeviceGetAttribute
                    0.34%  37.519ms         1  37.519ms  37.519ms  37.519ms  cuMemHostAlloc
                    0.18%  20.085ms     50018     401ns     226ns  987.10us  cuPointerGetAttributes
                    0.01%  1.3134ms         1  1.3134ms  1.3134ms  1.3134ms  cuMemAllocHost
                    0.01%  558.38us         2  279.19us  101.06us  457.32us  cuModuleLoadDataEx
                    0.00%  483.66us        20  24.183us  1.9400us  203.10us  cuMemAlloc
                    0.00%  10.403us         4  2.6000us     319ns  7.9550us  cuModuleGetFunction
                    0.00%  9.9320us         1  9.9320us  9.9320us  9.9320us  cuDeviceGetPCIBusId
                    0.00%  3.0390us         3  1.0130us     317ns  2.1270us  cuDeviceGetCount
                    0.00%  2.8270us         3     942ns     209ns  1.7350us  cuCtxSetCurrent
                    0.00%  1.3100us         3     436ns     175ns     782ns  cuDriverGetVersion
                    0.00%  1.1560us         2     578ns     239ns     917ns  cuDeviceGet
                    0.00%     895ns         1     895ns     895ns     895ns  cuDeviceComputeCapability
                    0.00%     727ns         1     727ns     727ns     727ns  cuCtxGetCurrent
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.60230s    300000  15.341us  1.5570us  783.66us  acc_wait@layers.c:77
                    0.00%  1.21409s     50000  24.281us  22.447us  4.8036ms  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  1.17346s    300000  3.9110us  1.2090us  947.60us  acc_wait@layers.c:60
                    0.00%  849.85ms    150000  5.6650us  4.7310us  779.25us  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  840.05ms    150000  5.6000us  4.2800us  12.244ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  797.96ms     50000  15.959us  14.299us  2.9391ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  639.82ms     50000  12.796us  11.327us  3.8491ms  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  470.00ms    150000  3.1330us  2.5270us  5.2450ms  acc_compute_construct@layers.c:60
                    0.00%  370.90ms     50000  7.4170us  1.8290us  826.01us  acc_wait@main.c:200
                    0.00%  300.54ms     50000  6.0100us  4.4690us  2.6991ms  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  296.54ms    150000  1.9760us  1.6970us  1.3108ms  acc_enter_data@layers.c:77
                    0.00%  274.45ms    150000  1.8290us  1.5700us  31.111us  acc_enter_data@layers.c:60
                    0.00%  271.46ms     50000  5.4290us  1.8060us  790.16us  acc_wait@main.c:215
                    0.00%  270.39ms    150000  1.8020us  1.6270us  717.06us  acc_compute_construct@layers.c:77
                    0.00%  250.91ms    150000  1.6720us  1.4770us  790.86us  acc_exit_data@layers.c:77
                    0.00%  244.57ms     50000  4.8910us  3.8040us  2.2626ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  218.18ms    150000  1.4540us  1.2560us  759.76us  acc_exit_data@layers.c:60
                    0.00%  146.35ms         1  146.35ms  146.35ms  146.35ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  97.213ms     50000  1.9440us  1.6920us  766.93us  acc_wait@main.c:205
                    0.00%  96.220ms     50000  1.9240us  1.6860us  719.95us  acc_wait@main.c:190
                    0.00%  95.724ms     50000  1.9140us  1.6430us  757.76us  acc_wait@main.c:220
                    0.00%  94.713ms     50000  1.8940us  1.4620us  866.87us  acc_update@main.c:190
                    0.00%  89.105ms     50000  1.7820us  1.5810us  37.527us  acc_update@main.c:200
                    0.00%  85.834ms     50000  1.7160us  1.4990us  42.383us  acc_update@main.c:215
                    0.00%  81.278ms     50000  1.6250us  1.4420us  136.10us  acc_update@main.c:205
                    0.00%  80.987ms     50000  1.6190us  1.4470us  108.47us  acc_update@main.c:220
                    0.00%  37.716ms         9  4.1906ms  6.9470us  37.569ms  acc_enter_data@layers.c:42
                    0.00%  1.0579ms         1  1.0579ms  1.0579ms  1.0579ms  acc_exit_data@main.c:345
                    0.00%  551.22us         1  551.22us  551.22us  551.22us  acc_device_init@main.c:121
                    0.00%  79.855us        18  4.4360us     820ns  26.906us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  77.156us        18  4.2860us     905ns  32.099us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  71.207us         1  71.207us  71.207us  71.207us  acc_wait@main.c:121
                    0.00%  58.827us         9  6.5360us  4.5650us  9.3280us  acc_wait@layers.c:42
                    0.00%  51.399us         2  25.699us  15.020us  36.379us  acc_enter_data@main.c:182
                    0.00%  46.277us         9  5.1410us  1.6550us  19.769us  acc_exit_data@layers.c:53
                    0.00%  45.165us         2  22.582us  3.3000us  41.865us  acc_exit_data@main.c:317
                    0.00%  39.930us         1  39.930us  39.930us  39.930us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  38.477us         3  12.825us  7.4610us  16.286us  acc_enqueue_upload@layers.c:309 (l->weights[:l->weights_size])
                    0.00%  31.781us         3  10.593us  7.5900us  12.594us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  24.729us         3  8.2430us  3.8240us  16.487us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  23.129us         3  7.7090us  3.5560us  10.913us  acc_wait@layers.c:309
                    0.00%  13.117us         3  4.3720us  2.6680us  7.7160us  acc_update@layers.c:309
                    0.00%  10.877us         3  3.6250us  3.4470us  3.8470us  acc_enqueue_upload@layers.c:309 (l->bias[:l->out_depth])
                    0.00%  4.2660us         2  2.1330us  1.5770us  2.6890us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```

## Συμπέρασμα
A:
```c
#pragma acc parallel loop present(l,X,Y) independent collapse(2) gang
      #pragma acc loop independent worker
        #pragma acc loop  reduction(+:sum) vector
```
B:
```c
#pragma acc parallel loop present(l,X,Y) independent collapse(3) gang worker
        #pragma acc loop  reduction(+:sum) vector
```

Το Α και το B δεν έχουν διαφορά στην εκτέλεση
---

## gang collapse vector worker 

Data on Device. All input on device. O1,O2,O3,O4,O5,O9,O11

### Code

```c
First line:59
// Add zero-padding to input data of conv_layer l
void pad_input(float* restrict X, Conv_Layer* l) {
#pragma acc parallel loop present(l,X) collapse(3) gang vector vector_length(32) 
  for ( int c = 0; c < l->in_depth; c++) {
    for (int j = 0; j < l->in_height; j++) {
      for (int i = 0; i < l->in_width; i++) {
        int padded_idx = (j + l->padding) * l->padded_width + (i + l->padding) + c * l->padded_height * l->padded_width;
        int in_idx = j * l->in_width + i + c * l->in_height * l->in_width;
        l->in_padded[padded_idx] = X[in_idx];
      }
    }
  }
}


// Performs the forward pass for a convolutional layer.
// X: Input data, l: Convolutional layer, Y: Output data
void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
    pad_input(X, l); //Create input with zero-padding
   // For each output feature map
#pragma acc parallel loop present(l,X,Y) collapse(3) gang worker vector_length(32) 
    for ( int m = 0; m < l->out_depth; m++) {
      for (int j = 0; j < l->out_height; j++) {
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); // Output index
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
        #pragma acc loop  reduction(+:sum) collapse(2) vector
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
                int f_idx = f_i + (f_j * l->filter_width) + (c + m * l->in_depth) * (l->filter_width * l->filter_width); // Filter Index
                int x_j = j * l->stride + f_j; // Input height index, increased by stride
                int x_i = i * l->stride + f_i; // Input width index, increased by stride
                int x_idx = c * l->padded_height * l->padded_width + x_j * l->padded_width + x_i; // Input index
                sum += l->weights[f_idx] * l->in_padded[x_idx];
              } // for f_i
            } // for f_j
          } // for c
          sum += l->bias[m]; // Add bias
          Y[y_idx] = sum; // Save output result
        } // for i
      } // for j
    } // for m
}
```

### `-Minfo=all`

```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c main.c -o main.o
main:
    121, Generating enter data copyin(input[:50000][:3072])
    181, Generating enter data create(O2[:L2->out_size],O1[:L1->out_size],O11[:50000][:L11->out_size],O5[:L5->out_size],O4[:L4->out_size],O3[:L3->out_size],O9[:L9->out_size],O8[:L8->out_size],O7[:L7->out_size],O6[:L6->out_size],O10[:L10->out_size])
    189, Generating update self(O1[:L1->out_size])
    199, Generating update device(O3[:L3->out_size])
    204, Generating update self(O4[:L4->out_size])
    214, Generating update device(O6[:L6->out_size])
    219, Generating update self(O7[:L7->out_size])
    241, Generating update self(O4[:L4->out_size],O1[:L1->out_size])
    314, Generating exit data delete(O2[:L2->out_size],O1[:L1->out_size],O11[:50000][:L11->out_size],O5[:L5->out_size],O4[:L4->out_size],O3[:L3->out_size],O8[:L8->out_size],O7[:L7->out_size],O6[:L6->out_size],O10[:L10->out_size],O9[:L9->out_size])
    342, Generating exit data delete(input[:50000][:3072])
arr2txt:
    365, Zero trip check eliminated
arr2txt_2:
    387, Zero trip check eliminated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(l[:],X[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         62, #pragma acc loop gang, vector(32) collapse(3) /* blockIdx.x threadIdx.x */
         63,   /* blockIdx.x threadIdx.x collapsed */
         64,   /* blockIdx.x threadIdx.x collapsed */
conv_forward:
     77, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         80, #pragma acc loop gang, worker(4) collapse(3) /* blockIdx.x threadIdx.y */
         81,   /* blockIdx.x threadIdx.y collapsed */
         82,   /* blockIdx.x threadIdx.y collapsed */
         87, #pragma acc loop vector(32) collapse(2) /* threadIdx.x */
             Generating reduction(+:sum)
         88,   /* threadIdx.x collapsed */
         89, #pragma acc loop seq
         96, Vector barrier inserted for vector loop reduction
             Vector barrier inserted due to potential dependence out of a vector loop
     87, Loop is parallelizable
     88, Loop is parallelizable
     89, Loop is parallelizable
     94, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    176, Zero trip check eliminated
fc_forward:
    231, FMA (fused multiply-add) instruction(s) generated
load_conv:
    292, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c malloc2D.c -o malloc2D.o
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c timer.c -o timer.o
cpu_timer_stop:
     11, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```

### Εκτέλεση

```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.032027 seconds
Create Network time:0.040885 seconds
Load Network Parameters time:0.008307 seconds
Create Ouputs time:0.000342 seconds

Net Forward total time:12.346689 seconds
    Time for conv1: 2.270531 seconds
    Time for relu1: 0.435219 seconds
    Time for pool1: 1.948057 seconds
    Time for conv2: 2.007092 seconds
    Time for relu2: 0.139434 seconds
    Time for pool2: 0.620968 seconds
    Time for conv3: 1.461494 seconds
    Time for relu3: 0.043176 seconds
    Time for pool3: 0.156690 seconds
    Time for fc: 0.210264 seconds
    Time for softmax: 0.012159 seconds

  Conv: 5.739117 seconds
  ReLU: 0.617828 seconds
  Pool: 2.725715 seconds
  FC:   0.210264 seconds
  Softmax: 0.012159 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001506 seconds
Free memory time:0.054640 seconds
Total time:13.484395 seconds
```

# Vector Length

## code
```c
76: void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
    pad_input(X, l); //Create input with zero-padding
   // For each output feature map
#pragma acc parallel loop present(l,X,Y) independent collapse(3) gang worker vector_length(32) 
    for ( int m = 0; m < l->out_depth; m++) {
      for (int j = 0; j < l->out_height; j++) {
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); // Output index
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
        #pragma acc loop  reduction(+:sum) vector collapse(3)
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
```

## Minfo
```
pad_input:
     60, Generating present(l[:],X[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         62, #pragma acc loop gang, vector(128) collapse(3) /* blockIdx.x threadIdx.x */
         63,   /* blockIdx.x threadIdx.x collapsed */
         64,   /* blockIdx.x threadIdx.x collapsed */
conv_forward:
     77, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         80, #pragma acc loop gang, worker(4) collapse(3) /* blockIdx.x threadIdx.y */
         81,   /* blockIdx.x threadIdx.y collapsed */
         82,   /* blockIdx.x threadIdx.y collapsed */
         87, #pragma acc loop vector(32) collapse(3) /* threadIdx.x */
             Generating reduction(+:sum)
         88,   /* threadIdx.x collapsed */
         89,   /* threadIdx.x collapsed */
         96, Vector barrier inserted for vector loop reduction
             Vector barrier inserted due to potential dependence out of a vector loop
     87, Loop is parallelizable
     88, Loop is parallelizable
     89, Loop is parallelizable
     94, FMA (fused multiply-add) instruction(s) generated
```

## Results
### 32
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.058124 seconds
Create Network time:0.039264 seconds
Load Network Parameters time:0.007944 seconds
Create Ouputs time:0.000344 seconds

Net Forward total time:13.267639 seconds
    Time for conv1: 2.529938 seconds
    Time for relu1: 0.443498 seconds
    Time for pool1: 1.945606 seconds
    Time for conv2: 2.412274 seconds
    Time for relu2: 0.148300 seconds
    Time for pool2: 0.622402 seconds
    Time for conv3: 1.659990 seconds
    Time for relu3: 0.039597 seconds
    Time for pool3: 0.159001 seconds
    Time for fc: 0.210386 seconds
    Time for softmax: 0.011327 seconds

  Conv: 6.602202 seconds
  ReLU: 0.631395 seconds
  Pool: 2.727009 seconds
  FC:   0.210386 seconds
  Softmax: 0.011327 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001464 seconds
Free memory time:0.053432 seconds
Total time:14.428210 seconds
END!
```

### 64
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.058177 seconds
Create Network time:0.039348 seconds
Load Network Parameters time:0.008190 seconds
Create Ouputs time:0.000341 seconds

Net Forward total time:15.128853 seconds
    Time for conv1: 4.090991 seconds
    Time for relu1: 0.433625 seconds
    Time for pool1: 1.951313 seconds
    Time for conv2: 2.850813 seconds
    Time for relu2: 0.142658 seconds
    Time for pool2: 0.624857 seconds
    Time for conv3: 1.561061 seconds
    Time for relu3: 0.042700 seconds
    Time for pool3: 0.158325 seconds
    Time for fc: 0.209917 seconds
    Time for softmax: 0.011992 seconds

  Conv: 8.502865 seconds
  ReLU: 0.618983 seconds
  Pool: 2.734496 seconds
  FC:   0.209917 seconds
  Softmax: 0.011992 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001566 seconds
Free memory time:0.053066 seconds
Total time:16.289541 seconds
END!
```

### 128
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.007400 seconds
Create Network time:0.040140 seconds
Load Network Parameters time:0.008259 seconds
Create Ouputs time:0.000329 seconds

Net Forward total time:15.689622 seconds
    Time for conv1: 4.445217 seconds
    Time for relu1: 0.450232 seconds
    Time for pool1: 1.963581 seconds
    Time for conv2: 3.012985 seconds
    Time for relu2: 0.147535 seconds
    Time for pool2: 0.627257 seconds
    Time for conv3: 1.591433 seconds
    Time for relu3: 0.041651 seconds
    Time for pool3: 0.159275 seconds
    Time for fc: 0.209842 seconds
    Time for softmax: 0.011396 seconds

  Conv: 9.049635 seconds
  ReLU: 0.639419 seconds
  Pool: 2.750113 seconds
  FC:   0.209842 seconds
  Softmax: 0.011396 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001547 seconds
Free memory time:0.049775 seconds
Total time:16.797072 seconds
```

## vector length 32

### code 
```c
60: void pad_input(float* restrict X, Conv_Layer* l) {
#pragma acc parallel loop present(l,X) independent collapse(3) gang vector vector_length(32) 
  for ( int c = 0; c < l->in_depth; c++) {
    for (int j = 0; j < l->in_height; j++) {
      for (int i = 0; i < l->in_width; i++) {
        ...
...        

76: void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
    pad_input(X, l); //Create input with zero-padding
   // For each output feature map
#pragma acc parallel loop present(l,X,Y) independent collapse(3) gang worker vector_length(32) 
    for ( int m = 0; m < l->out_depth; m++) {
      for (int j = 0; j < l->out_height; j++) {
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); // Output index
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
        #pragma acc loop  reduction(+:sum) vector collapse(3)
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
                ...
...
```

## Minfo

```
vate(m)
         Generating NVIDIA GPU code
         80, #pragma acc loop gang, worker(4) collapse(3) /* blockIdx.x threadIdx.y */
         81,   /* blockIdx.x threadIdx.y collapsed */
         82,   /* blockIdx.x threadIdx.y collapsed */
         87, #pragma acc loop vector(32) collapse(3) /* threadIdx.x */
             Generating reduction(+:sum)
         88,   /* threadIdx.x collapsed */
         89,   /* threadIdx.x collapsed */
         96, Vector barrier inserted for vector loop reduction
             Vector barrier inserted due to potential dependence out of a vector loop
     87, Loop is parallelizable
     88, Loop is parallelizable
     89, Loop is parallelizable
     94, FMA (fused multiply-add) instruction(s) generated
```

### execution

```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.989799 seconds
Create Network time:0.038310 seconds
Load Network Parameters time:0.007685 seconds
Create Ouputs time:0.000311 seconds

Net Forward total time:13.356754 seconds
    Time for conv1: 2.574260 seconds
    Time for relu1: 0.433855 seconds
    Time for pool1: 1.944759 seconds
    Time for conv2: 2.454962 seconds
    Time for relu2: 0.146844 seconds
    Time for pool2: 0.621210 seconds
    Time for conv3: 1.755994 seconds
    Time for relu3: 0.041449 seconds
    Time for pool3: 0.158586 seconds
    Time for fc: 0.209838 seconds
    Time for softmax: 0.011950 seconds

  Conv: 6.785216 seconds
  ReLU: 0.622148 seconds
  Pool: 2.724554 seconds
  FC:   0.209838 seconds
  Softmax: 0.011950 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001885 seconds
Free memory time:0.075919 seconds
Total time:14.470663 seconds
END!
```

### Profiling

#### NV_ACC_TIME
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:1.141592 seconds
Create Network time:0.037984 seconds
Load Network Parameters time:0.007870 seconds
Create Ouputs time:0.000324 seconds

Net Forward total time:17.576190 seconds
    Time for conv1: 3.169854 seconds
    Time for relu1: 0.457074 seconds
    Time for pool1: 1.993464 seconds
    Time for conv2: 3.008691 seconds
    Time for relu2: 0.168356 seconds
    Time for pool2: 0.635697 seconds
    Time for conv3: 2.332197 seconds
    Time for relu3: 0.044261 seconds
    Time for pool3: 0.162084 seconds
    Time for fc: 0.214851 seconds
    Time for softmax: 0.013586 seconds

  Conv: 8.510741 seconds
  ReLU: 0.669692 seconds
  Pool: 2.791246 seconds
  FC:   0.214851 seconds
  Softmax: 0.013586 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001469 seconds
Free memory time:0.063876 seconds
Total time:18.829304 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 242
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=242 max=32 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 200
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=200 max=33 min=3 avg=11
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [2560]  block: [32]
            elapsed time(us): total=2,410,792 max=3,916 min=15 avg=16
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    77: compute region reached 150000 times
        77: kernel launched 150000 times
            grid: [640]  block: [32x4]
            elapsed time(us): total=4,921,210 max=1,415 min=22 avg=32
    77: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 63
    308: update directive reached 3 times
        308: data copyin transfers: 6
             device time(us): total=63 max=28 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/main.c
  main  NVIDIA  devicenum=0
    time(us): 3,134,569
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=55 max=55 min=55 avg=55
        121: data copyin transfers: 1
             device time(us): total=143,057 max=143,057 min=143,057 avg=143,057
    182: data region reached 2 times
    190: update directive reached 50000 times
        190: data copyout transfers: 50000
             device time(us): total=1,160,769 max=800 min=21 avg=23
    200: update directive reached 50000 times
        200: data copyin transfers: 50000
             device time(us): total=436,423 max=992 min=6 avg=8
    205: update directive reached 50000 times
        205: data copyout transfers: 50000
             device time(us): total=656,621 max=156 min=11 avg=13
    215: update directive reached 50000 times
        215: data copyin transfers: 50000
             device time(us): total=248,883 max=782 min=4 avg=4
    220: update directive reached 50000 times
        220: data copyout transfers: 50000
             device time(us): total=488,816 max=44 min=7 avg=9
    317: data region reached 2 times
    345: data region reached 1 time
```
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2485864== NVPROF is profiling process 2485864, command: ./cnn-cifar10-profile
Load Data time:1.364617 seconds
Create Network time:0.038713 seconds
Load Network Parameters time:0.008036 seconds
Create Ouputs time:0.000348 seconds

Net Forward total time:18.328524 seconds
    Time for conv1: 3.735047 seconds
    Time for relu1: 0.630916 seconds
    Time for pool1: 1.564273 seconds
    Time for conv2: 3.611588 seconds
    Time for relu2: 0.198243 seconds
    Time for pool2: 0.505266 seconds
    Time for conv3: 2.800761 seconds
    Time for relu3: 0.056347 seconds
    Time for pool3: 0.131175 seconds
    Time for fc: 0.218246 seconds
    Time for softmax: 0.016031 seconds

  Conv: 10.147396 seconds
  ReLU: 0.885506 seconds
  Pool: 2.200714 seconds
  FC:   0.218246 seconds
  Softmax: 0.016031 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001466 seconds
Free memory time:0.055449 seconds
Total time:19.797152 seconds
END!
==2485864== Profiling application: ./cnn-cifar10-profile
==2485864== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   68.82%  3.85237s    150000  25.682us  14.368us  33.920us  _8layers_c_conv_forward_77_gpu
                   16.89%  945.74ms    150000  6.3040us  6.2400us  13.537us  _8layers_c_pad_input_60_gpu
                    8.29%  464.24ms    150000  3.0940us  1.4710us  18.879us  [CUDA memcpy DtoH]
                    6.00%  335.60ms    100031  3.3540us     704ns  136.84ms  [CUDA memcpy HtoD]
                    0.00%  2.7850us         1  2.7850us  2.7850us  2.7850us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   57.09%  6.54793s    850015  7.7030us     590ns  4.3049ms  cuStreamSynchronize
                   22.64%  2.59663s    150000  17.310us  10.741us  2.8716ms  cuMemcpyDtoHAsync
                   10.64%  1.22006s    300001  4.0660us  3.2790us  2.1762ms  cuLaunchKernel
                    5.84%  670.08ms    100031  6.6980us  2.7030us  137.04ms  cuMemcpyHtoDAsync
                    1.58%  180.83ms    600000     301ns     184ns  4.7395ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    1.28%  147.15ms         1  147.15ms  147.15ms  147.15ms  cuDevicePrimaryCtxRetain
                    0.41%  46.735ms    300010     155ns     117ns  16.946us  cuDeviceGetAttribute
                    0.33%  38.236ms         1  38.236ms  38.236ms  38.236ms  cuMemHostAlloc
                    0.13%  14.860ms     50019     297ns     230ns  773.95us  cuPointerGetAttributes
                    0.05%  6.1127ms         1  6.1127ms  6.1127ms  6.1127ms  cuMemAllocHost
                    0.00%  412.73us        20  20.636us  1.8720us  181.77us  cuMemAlloc
                    0.00%  269.81us         2  134.90us  106.18us  163.63us  cuModuleLoadDataEx
                    0.00%  11.524us         4  2.8810us     314ns  8.6770us  cuModuleGetFunction
                    0.00%  8.1330us         1  8.1330us  8.1330us  8.1330us  cuDeviceGetPCIBusId
                    0.00%  2.0710us         3     690ns     220ns  1.2210us  cuCtxSetCurrent
                    0.00%  1.3800us         3     460ns     196ns     905ns  cuDeviceGetCount
                    0.00%     845ns         2     422ns     187ns     658ns  cuDeviceGet
                    0.00%     586ns         3     195ns     156ns     258ns  cuDriverGetVersion
                    0.00%     522ns         1     522ns     522ns     522ns  cuCtxGetCurrent
                    0.00%     427ns         1     427ns     427ns     427ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.58188s    300000  15.272us  1.6450us  4.3063ms  acc_wait@layers.c:77
                    0.00%  1.61122s    300000  5.3700us  1.2140us  1.1211ms  acc_wait@layers.c:60
                    0.00%  1.29258s     50000  25.851us  23.745us  1.2339ms  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  843.45ms    150000  5.6220us  4.6300us  2.1939ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  789.74ms     50000  15.794us  14.345us  2.8734ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  764.53ms    150000  5.0960us  4.1840us  2.1731ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  639.18ms     50000  12.783us  11.570us  1.0652ms  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  434.75ms    150000  2.8980us  2.6030us  2.5162ms  acc_compute_construct@layers.c:60
                    0.00%  412.19ms    150000  2.7470us  2.4300us  5.6875ms  acc_compute_construct@layers.c:77
                    0.00%  374.30ms     50000  7.4860us  6.1580us  4.5830ms  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  371.84ms     50000  7.4360us  2.0560us  146.32us  acc_wait@main.c:200
                    0.00%  314.72ms    150000  2.0980us  1.5820us  899.17us  acc_enter_data@layers.c:60
                    0.00%  309.54ms    150000  2.0630us  1.6680us  1.1169ms  acc_enter_data@layers.c:77
                    0.00%  287.11ms    150000  1.9140us  1.4820us  815.78us  acc_exit_data@layers.c:77
                    0.00%  278.18ms     50000  5.5630us  2.0220us  742.71us  acc_wait@main.c:215
                    0.00%  238.02ms     50000  4.7600us  3.9980us  2.1157ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  232.41ms    150000  1.5490us  1.2670us  806.65us  acc_exit_data@layers.c:60
                    0.00%  137.05ms         1  137.05ms  137.05ms  137.05ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  111.55ms     50000  2.2300us  1.7680us  804.11us  acc_wait@main.c:190
                    0.00%  101.10ms     50000  2.0220us  1.7770us  129.68us  acc_wait@main.c:205
                    0.00%  101.05ms     50000  2.0210us  1.5220us  848.68us  acc_update@main.c:215
                    0.00%  99.485ms     50000  1.9890us  1.7530us  27.338us  acc_wait@main.c:220
                    0.00%  95.318ms     50000  1.9060us  1.6420us  1.6544ms  acc_update@main.c:200
                    0.00%  87.311ms     50000  1.7460us  1.4980us  1.1763ms  acc_update@main.c:205
                    0.00%  86.159ms     50000  1.7230us  1.5350us  762.01us  acc_update@main.c:190
                    0.00%  85.576ms     50000  1.7110us  1.5100us  839.83us  acc_update@main.c:220
                    0.00%  38.420ms         9  4.2689ms  7.0940us  38.288ms  acc_enter_data@layers.c:42
                    0.00%  1.0434ms         1  1.0434ms  1.0434ms  1.0434ms  acc_exit_data@main.c:345
                    0.00%  201.40us         1  201.40us  201.40us  201.40us  acc_device_init@main.c:121
                    0.00%  84.255us        18  4.6800us     844ns  29.241us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  67.000us        18  3.7220us     922ns  23.654us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  64.779us         1  64.779us  64.779us  64.779us  acc_wait@main.c:121
                    0.00%  55.634us         9  6.1810us  4.6120us  9.0770us  acc_wait@layers.c:42
                    0.00%  46.811us         2  23.405us  3.2200us  43.591us  acc_exit_data@main.c:317
                    0.00%  42.670us         1  42.670us  42.670us  42.670us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  42.354us         9  4.7060us  1.7570us  14.450us  acc_exit_data@layers.c:53
                    0.00%  42.337us         2  21.168us  14.027us  28.310us  acc_enter_data@main.c:182
                    0.00%  39.965us         3  13.321us  7.8880us  17.542us  acc_enqueue_upload@layers.c:308 (l->weights[:l->weights_size])
                    0.00%  31.145us         3  10.381us  7.4880us  12.242us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  25.004us         3  8.3340us  4.0180us  15.986us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  21.028us         3  7.0090us  3.8150us  8.6230us  acc_wait@layers.c:308
                    0.00%  14.098us         3  4.6990us  2.6990us  8.0730us  acc_update@layers.c:308
                    0.00%  11.629us         3  3.8760us  3.5070us  4.1440us  acc_enqueue_upload@layers.c:308 (l->bias[:l->out_depth])
                    0.00%  4.4500us         2  2.2250us  1.6380us  2.8120us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```

## Profile without vector_length(32)
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2488303== NVPROF is profiling process 2488303, command: ./cnn-cifar10-profile
Load Data time:1.284872 seconds
Create Network time:0.039849 seconds
Load Network Parameters time:0.008230 seconds
Create Ouputs time:0.000358 seconds

Net Forward total time:18.077171 seconds
    Time for conv1: 3.682751 seconds
    Time for relu1: 0.626429 seconds
    Time for pool1: 1.579648 seconds
    Time for conv2: 3.499462 seconds
    Time for relu2: 0.218417 seconds
    Time for pool2: 0.509032 seconds
    Time for conv3: 2.676132 seconds
    Time for relu3: 0.063113 seconds
    Time for pool3: 0.133371 seconds
    Time for fc: 0.218351 seconds
    Time for softmax: 0.013502 seconds

  Conv: 9.858346 seconds
  ReLU: 0.907960 seconds
  Pool: 2.222051 seconds
  FC:   0.218351 seconds
  Softmax: 0.013502 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001228 seconds
Free memory time:0.056112 seconds
Total time:19.467821 seconds
END!
==2488303== Profiling application: ./cnn-cifar10-profile
==2488303== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   75.24%  3.99790s    150000  26.652us  14.623us  36.352us  _8layers_c_conv_forward_77_gpu
                    9.67%  513.82ms    150000  3.4250us  3.3910us  13.568us  _8layers_c_pad_input_60_gpu
                    8.73%  463.94ms    150000  3.0920us  1.4710us  18.656us  [CUDA memcpy DtoH]
                    6.36%  338.04ms    100031  3.3790us     704ns  139.28ms  [CUDA memcpy HtoD]
                    0.00%  2.7840us         1  2.7840us  2.7840us  2.7840us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   55.91%  6.29104s    850015  7.4010us     594ns  1.8085ms  cuStreamSynchronize
                   23.24%  2.61512s    150000  17.434us  10.554us  3.2328ms  cuMemcpyDtoHAsync
                   10.99%  1.23627s    300001  4.1200us  3.3630us  2.6982ms  cuLaunchKernel
                    5.89%  662.40ms    100031  6.6210us  2.7620us  139.48ms  cuMemcpyHtoDAsync
                    1.57%  176.79ms    600000     294ns     177ns  3.5294ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    1.42%  159.82ms         1  159.82ms  159.82ms  159.82ms  cuDevicePrimaryCtxRetain
                    0.42%  47.583ms    300010     158ns     120ns  16.758us  cuDeviceGetAttribute
                    0.35%  39.412ms         1  39.412ms  39.412ms  39.412ms  cuMemHostAlloc
                    0.18%  19.811ms     50019     396ns     229ns  982.17us  cuPointerGetAttributes
                    0.02%  2.1938ms        20  109.69us  2.0180us  1.8211ms  cuMemAlloc
                    0.01%  1.4494ms         1  1.4494ms  1.4494ms  1.4494ms  cuMemAllocHost
                    0.01%  595.93us         2  297.96us  109.65us  486.28us  cuModuleLoadDataEx
                    0.00%  11.593us         4  2.8980us     354ns  8.9570us  cuModuleGetFunction
                    0.00%  9.3570us         1  9.3570us  9.3570us  9.3570us  cuDeviceGetPCIBusId
                    0.00%  3.2420us         3  1.0800us     222ns  2.1860us  cuCtxSetCurrent
                    0.00%     956ns         3     318ns     121ns     611ns  cuDriverGetVersion
                    0.00%     951ns         3     317ns     122ns     672ns  cuDeviceGetCount
                    0.00%     501ns         2     250ns     143ns     358ns  cuDeviceGet
                    0.00%     466ns         1     466ns     466ns     466ns  cuCtxGetCurrent
                    0.00%     328ns         1     328ns     328ns     328ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.72949s    300000  15.764us  1.6390us  1.8193ms  acc_wait@layers.c:77
                    0.00%  1.32638s     50000  26.527us  24.196us  1.3345ms  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  1.17384s    300000  3.9120us  1.1990us  769.04us  acc_wait@layers.c:60
                    0.00%  859.74ms    150000  5.7310us  4.6750us  867.48us  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  779.64ms     50000  15.592us  14.127us  2.0410ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  771.32ms    150000  5.1420us  4.2520us  2.7010ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  632.76ms     50000  12.655us  11.381us  3.2577ms  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  416.95ms    150000  2.7790us  2.4580us  2.8417ms  acc_compute_construct@layers.c:60
                    0.00%  403.05ms    150000  2.6860us  2.3710us  3.5435ms  acc_compute_construct@layers.c:77
                    0.00%  373.84ms     50000  7.4760us  1.9950us  90.412us  acc_wait@main.c:200
                    0.00%  365.63ms     50000  7.3120us  6.1090us  2.6453ms  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  311.61ms    150000  2.0770us  1.5490us  876.13us  acc_enter_data@layers.c:60
                    0.00%  311.59ms    150000  2.0770us  1.6400us  1.0102ms  acc_enter_data@layers.c:77
                    0.00%  294.46ms    150000  1.9630us  1.5220us  783.21us  acc_exit_data@layers.c:77
                    0.00%  279.41ms     50000  5.5880us  1.9970us  780.96us  acc_wait@main.c:215
                    0.00%  237.15ms    150000  1.5800us  1.2700us  1.0799ms  acc_exit_data@layers.c:60
                    0.00%  234.34ms     50000  4.6860us  3.9650us  2.0427ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  139.48ms         1  139.48ms  139.48ms  139.48ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  113.23ms     50000  2.2640us  1.7830us  782.88us  acc_wait@main.c:190
                    0.00%  102.30ms     50000  2.0460us  1.5210us  800.35us  acc_update@main.c:215
                    0.00%  100.24ms     50000  2.0040us  1.7770us  33.356us  acc_wait@main.c:205
                    0.00%  99.544ms     50000  1.9900us  1.7550us  109.03us  acc_wait@main.c:220
                    0.00%  96.223ms     50000  1.9240us  1.5970us  4.2575ms  acc_update@main.c:200
                    0.00%  83.586ms     50000  1.6710us  1.4730us  756.56us  acc_update@main.c:190
                    0.00%  82.882ms     50000  1.6570us  1.4400us  778.79us  acc_update@main.c:220
                    0.00%  82.576ms     50000  1.6510us  1.4470us  767.68us  acc_update@main.c:205
                    0.00%  39.581ms         9  4.3979ms  7.4140us  39.465ms  acc_enter_data@layers.c:42
                    0.00%  994.95us         1  994.95us  994.95us  994.95us  acc_exit_data@main.c:345
                    0.00%  576.93us         1  576.93us  576.93us  576.93us  acc_device_init@main.c:121
                    0.00%  94.351us        18  5.2410us     839ns  30.516us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  69.309us         1  69.309us  69.309us  69.309us  acc_wait@main.c:121
                    0.00%  60.622us        18  3.3670us     862ns  18.521us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  55.391us         9  6.1540us  4.6130us  9.3800us  acc_wait@layers.c:42
                    0.00%  45.080us         2  22.540us  14.919us  30.161us  acc_enter_data@main.c:182
                    0.00%  41.229us         9  4.5810us  1.7860us  15.643us  acc_exit_data@layers.c:53
                    0.00%  40.912us         3  13.637us  7.8060us  17.821us  acc_enqueue_upload@layers.c:308 (l->weights[:l->weights_size])
                    0.00%  40.296us         1  40.296us  40.296us  40.296us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  31.042us         3  10.347us  7.7790us  11.765us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  29.246us         2  14.623us  3.3490us  25.897us  acc_exit_data@main.c:317
                    0.00%  22.017us         3  7.3390us  3.9280us  13.829us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  21.914us         3  7.3040us  3.8690us  9.1570us  acc_wait@layers.c:308
                    0.00%  14.397us         3  4.7990us  2.9060us  8.0810us  acc_update@layers.c:308
                    0.00%  11.410us         3  3.8030us  3.5130us  4.2420us  acc_enqueue_upload@layers.c:308 (l->bias[:l->out_depth])
                    0.00%  4.8380us         2  2.4190us  2.0570us  2.7810us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```

## Profile nvprof vector_length(32) on conv_forward

```
$ make profile 
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -pg -c layers.c -o layers.o
make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(l[:],X[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         62, #pragma acc loop gang, vector(128) collapse(3) /* blockIdx.x threadIdx.x */
         63,   /* blockIdx.x threadIdx.x collapsed */
         64,   /* blockIdx.x threadIdx.x collapsed */
conv_forward:
     77, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         80, #pragma acc loop gang, worker(4) collapse(3) /* blockIdx.x threadIdx.y */
         81,   /* blockIdx.x threadIdx.y collapsed */
         82,   /* blockIdx.x threadIdx.y collapsed */
         87, #pragma acc loop vector(32) collapse(3) /* threadIdx.x */
             Generating reduction(+:sum)
         88,   /* threadIdx.x collapsed */
         89,   /* threadIdx.x collapsed */
         96, Vector barrier inserted for vector loop reduction
             Vector barrier inserted due to potential dependence out of a vector loop
     87, Loop is parallelizable
     88, Loop is parallelizable
     89, Loop is parallelizable
     94, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    185, Zero trip check eliminated
fc_forward:
    246, FMA (fused multiply-add) instruction(s) generated
load_conv:
    308, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -pg -o cnn-cifar10-profile main.o layers.o malloc2D.o timer.o
olia@krylov100:~/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2491590== NVPROF is profiling process 2491590, command: ./cnn-cifar10-profile
Load Data time:1.309417 seconds
Create Network time:0.039394 seconds
Load Network Parameters time:0.008219 seconds
Create Ouputs time:0.000339 seconds

Net Forward total time:17.838029 seconds
    Time for conv1: 3.569797 seconds
    Time for relu1: 0.636392 seconds
    Time for pool1: 1.563828 seconds
    Time for conv2: 3.454109 seconds
    Time for relu2: 0.200747 seconds
    Time for pool2: 0.506358 seconds
    Time for conv3: 2.652029 seconds
    Time for relu3: 0.056640 seconds
    Time for pool3: 0.131669 seconds
    Time for fc: 0.217125 seconds
    Time for softmax: 0.013723 seconds

  Conv: 9.675934 seconds
  ReLU: 0.893779 seconds
  Pool: 2.201855 seconds
  FC:   0.217125 seconds
  Softmax: 0.013723 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001507 seconds
Free memory time:0.054362 seconds
Total time:19.251267 seconds
END!
==2491590== Profiling application: ./cnn-cifar10-profile
==2491590== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   74.56%  3.85556s    150000  25.703us  14.399us  33.952us  _8layers_c_conv_forward_77_gpu
                    9.93%  513.67ms    150000  3.4240us  3.3600us  13.504us  _8layers_c_pad_input_60_gpu
                    8.97%  463.94ms    150000  3.0920us  1.1190us  18.656us  [CUDA memcpy DtoH]
                    6.54%  338.26ms    100031  3.3810us     735ns  139.50ms  [CUDA memcpy HtoD]
                    0.00%  2.5920us         1  2.5920us  2.5920us  2.5920us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   55.45%  6.14162s    850015  7.2250us     587ns  3.2750ms  cuStreamSynchronize
                   23.57%  2.61060s    150000  17.404us  10.546us  3.4633ms  cuMemcpyDtoHAsync
                   11.03%  1.22123s    300001  4.0700us  3.3550us  2.8644ms  cuLaunchKernel
                    5.98%  661.87ms    100031  6.6160us  2.7110us  139.69ms  cuMemcpyHtoDAsync
                    1.53%  169.56ms    600000     282ns     185ns  768.55us  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    1.42%  157.44ms         1  157.44ms  157.44ms  157.44ms  cuDevicePrimaryCtxRetain
                    0.43%  47.579ms    300010     158ns     122ns  16.775us  cuDeviceGetAttribute
                    0.35%  38.921ms         1  38.921ms  38.921ms  38.921ms  cuMemHostAlloc
                    0.18%  19.504ms     50018     389ns     222ns  797.91us  cuPointerGetAttributes
                    0.05%  5.6219ms        20  281.09us  1.9480us  3.0501ms  cuMemAlloc
                    0.01%  1.3005ms         1  1.3005ms  1.3005ms  1.3005ms  cuMemAllocHost
                    0.01%  562.76us         2  281.38us  114.88us  447.87us  cuModuleLoadDataEx
                    0.00%  17.880us         1  17.880us  17.880us  17.880us  cuCtxGetCurrent
                    0.00%  16.660us         1  16.660us  16.660us  16.660us  cuDeviceGetPCIBusId
                    0.00%  3.5150us         4     878ns     296ns  1.7740us  cuModuleGetFunction
                    0.00%  3.0780us         3  1.0260us     224ns  1.8120us  cuCtxSetCurrent
                    0.00%     975ns         3     325ns     114ns     701ns  cuDeviceGetCount
                    0.00%     834ns         3     278ns      98ns     533ns  cuDriverGetVersion
                    0.00%     568ns         2     284ns     164ns     404ns  cuDeviceGet
                    0.00%     329ns         1     329ns     329ns     329ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.57611s    300000  15.253us  1.6290us  1.4451ms  acc_wait@layers.c:77
                    0.00%  1.32671s     50000  26.534us  24.170us  3.4719ms  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  1.17119s    300000  3.9030us  1.1830us  3.2972ms  acc_wait@layers.c:60
                    0.00%  840.92ms    150000  5.6060us  4.6730us  1.1153ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  781.44ms     50000  15.628us  14.227us  1.5545ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  775.80ms    150000  5.1720us  4.2970us  2.8668ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  624.15ms     50000  12.482us  11.344us  51.740us  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  415.20ms    150000  2.7670us  2.4700us  755.78us  acc_compute_construct@layers.c:60
                    0.00%  401.47ms    150000  2.6760us  2.3770us  771.41us  acc_compute_construct@layers.c:77
                    0.00%  375.67ms     50000  7.5130us  1.9980us  85.797us  acc_wait@main.c:200
                    0.00%  364.75ms     50000  7.2950us  6.1090us  2.0441ms  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  311.83ms    150000  2.0780us  1.6710us  848.75us  acc_enter_data@layers.c:77
                    0.00%  309.82ms    150000  2.0650us  1.5670us  799.10us  acc_enter_data@layers.c:60
                    0.00%  294.07ms    150000  1.9600us  1.4800us  835.99us  acc_exit_data@layers.c:77
                    0.00%  282.16ms     50000  5.6430us  2.0040us  766.87us  acc_wait@main.c:215
                    0.00%  234.51ms     50000  4.6900us  3.9220us  2.0243ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  233.83ms    150000  1.5580us  1.2620us  874.30us  acc_exit_data@layers.c:60
                    0.00%  139.70ms         1  139.70ms  139.70ms  139.70ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  109.42ms     50000  2.1880us  1.7510us  771.12us  acc_wait@main.c:190
                    0.00%  99.970ms     50000  1.9990us  1.4880us  789.01us  acc_update@main.c:215
                    0.00%  99.692ms     50000  1.9930us  1.7330us  754.31us  acc_wait@main.c:205
                    0.00%  97.794ms     50000  1.9550us  1.7160us  787.89us  acc_wait@main.c:220
                    0.00%  88.280ms     50000  1.7650us  1.5430us  27.044us  acc_update@main.c:200
                    0.00%  81.541ms     50000  1.6300us  1.4410us  31.283us  acc_update@main.c:220
                    0.00%  81.228ms     50000  1.6240us  1.4560us  26.565us  acc_update@main.c:190
                    0.00%  80.979ms     50000  1.6190us  1.4150us  19.623us  acc_update@main.c:205
                    0.00%  39.121ms         9  4.3468ms  7.2680us  38.974ms  acc_enter_data@layers.c:42
                    0.00%  1.0035ms         1  1.0035ms  1.0035ms  1.0035ms  acc_exit_data@main.c:345
                    0.00%  538.19us         1  538.19us  538.19us  538.19us  acc_device_init@main.c:121
                    0.00%  87.946us        18  4.8850us     898ns  32.025us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  66.927us        18  3.7180us     879ns  26.085us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  57.589us         9  6.3980us  4.5420us  9.7890us  acc_wait@layers.c:42
                    0.00%  51.160us         1  51.160us  51.160us  51.160us  acc_wait@main.c:121
                    0.00%  48.310us         1  48.310us  48.310us  48.310us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  43.769us         2  21.884us  14.478us  29.291us  acc_enter_data@main.c:182
                    0.00%  41.609us         9  4.6230us  1.6360us  15.190us  acc_exit_data@layers.c:53
                    0.00%  40.773us         3  13.591us  6.9890us  18.189us  acc_enqueue_upload@layers.c:308 (l->weights[:l->weights_size])
                    0.00%  31.530us         3  10.510us  7.5560us  12.621us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  30.218us         2  15.109us  3.3680us  26.850us  acc_exit_data@main.c:317
                    0.00%  23.218us         3  7.7390us  4.1910us  14.523us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  21.640us         3  7.2130us  3.8720us  9.1750us  acc_wait@layers.c:308
                    0.00%  14.028us         3  4.6760us  2.8410us  8.0640us  acc_update@layers.c:308
                    0.00%  10.959us         3  3.6530us  3.5040us  3.8810us  acc_enqueue_upload@layers.c:308 (l->bias[:l->out_depth])
                    0.00%  4.1660us         2  2.0830us  1.6940us  2.4720us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```

## Profile nvprof vector(32) only on pad_input

```
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2497861== NVPROF is profiling process 2497861, command: ./cnn-cifar10-profile
Load Data time:1.325425 seconds
Create Network time:0.038512 seconds
Load Network Parameters time:0.007899 seconds
Create Ouputs time:0.000339 seconds

Net Forward total time:18.413139 seconds
    Time for conv1: 3.845494 seconds
    Time for relu1: 0.634063 seconds
    Time for pool1: 1.556339 seconds
    Time for conv2: 3.638104 seconds
    Time for relu2: 0.200042 seconds
    Time for pool2: 0.502494 seconds
    Time for conv3: 2.828915 seconds
    Time for relu3: 0.056236 seconds
    Time for pool3: 0.131270 seconds
    Time for fc: 0.217274 seconds
    Time for softmax: 0.013213 seconds

  Conv: 10.312513 seconds
  ReLU: 0.890340 seconds
  Pool: 2.190103 seconds
  FC:   0.217274 seconds
  Softmax: 0.013213 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001410 seconds
Free memory time:0.051754 seconds
Total time:19.838478 seconds
END!
==2497861== Profiling application: ./cnn-cifar10-profile
==2497861== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   69.58%  3.99677s    150000  26.645us  14.624us  36.096us  _8layers_c_conv_forward_77_gpu
                   16.46%  945.72ms    150000  6.3040us  6.2390us  13.760us  _8layers_c_pad_input_60_gpu
                    8.07%  463.84ms    150000  3.0920us  1.4710us  18.592us  [CUDA memcpy DtoH]
                    5.88%  337.97ms    100031  3.3780us     735ns  139.20ms  [CUDA memcpy HtoD]
                    0.00%  2.6240us         1  2.6240us  2.6240us  2.6240us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   57.63%  6.71394s    850015  7.8980us     574ns  2.5006ms  cuStreamSynchronize
                   21.96%  2.55837s    150000  17.055us  10.536us  3.4525ms  cuMemcpyDtoHAsync
                   10.76%  1.25347s    300001  4.1780us  3.4360us  4.3013ms  cuLaunchKernel
                    5.67%  660.10ms    100031  6.5980us  2.8210us  139.38ms  cuMemcpyHtoDAsync
                    1.54%  179.17ms    600000     298ns     185ns  3.4149ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    1.51%  175.79ms         1  175.79ms  175.79ms  175.79ms  cuDevicePrimaryCtxRetain
                    0.40%  46.464ms    300010     154ns     117ns  16.866us  cuDeviceGetAttribute
                    0.33%  38.091ms         1  38.091ms  38.091ms  38.091ms  cuMemHostAlloc
                    0.14%  16.835ms     50018     336ns     224ns  812.51us  cuPointerGetAttributes
                    0.05%  5.2853ms        20  264.27us  1.9350us  4.9314ms  cuMemAlloc
                    0.01%  1.4308ms         1  1.4308ms  1.4308ms  1.4308ms  cuMemAllocHost
                    0.00%  410.09us         2  205.04us  113.50us  296.59us  cuModuleLoadDataEx
                    0.00%  10.821us         4  2.7050us     370ns  8.1540us  cuModuleGetFunction
                    0.00%  10.438us         1  10.438us  10.438us  10.438us  cuDeviceGetPCIBusId
                    0.00%  2.4110us         3     803ns     238ns  1.1480us  cuCtxSetCurrent
                    0.00%  1.1050us         3     368ns     117ns     796ns  cuDeviceGetCount
                    0.00%     558ns         3     186ns     108ns     259ns  cuDriverGetVersion
                    0.00%     490ns         2     245ns     116ns     374ns  cuDeviceGet
                    0.00%     453ns         1     453ns     453ns     453ns  cuCtxGetCurrent
                    0.00%     436ns         1     436ns     436ns     436ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.71892s    300000  15.729us  1.6430us  783.84us  acc_wait@layers.c:77
                    0.00%  1.61357s    300000  5.3780us  1.1990us  2.5117ms  acc_wait@layers.c:60
                    0.00%  1.26832s     50000  25.366us  23.356us  87.670us  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  864.86ms    150000  5.7650us  4.8350us  840.72us  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  797.52ms    150000  5.3160us  4.3900us  4.3035ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  788.38ms     50000  15.767us  14.258us  3.4633ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  620.74ms     50000  12.414us  11.301us  999.94us  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  425.12ms    150000  2.8340us  2.5000us  6.2750ms  acc_compute_construct@layers.c:60
                    0.00%  407.81ms    150000  2.7180us  2.4140us  2.2426ms  acc_compute_construct@layers.c:77
                    0.00%  377.75ms     50000  7.5540us  2.0460us  1.4809ms  acc_wait@main.c:200
                    0.00%  365.82ms     50000  7.3160us  6.1110us  4.3075ms  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  308.23ms    150000  2.0540us  1.5720us  1.3269ms  acc_enter_data@layers.c:60
                    0.00%  307.86ms    150000  2.0520us  1.6740us  822.37us  acc_enter_data@layers.c:77
                    0.00%  291.75ms    150000  1.9450us  1.4630us  835.28us  acc_exit_data@layers.c:77
                    0.00%  284.58ms     50000  5.6910us  1.9930us  3.3779ms  acc_wait@main.c:215
                    0.00%  233.58ms    150000  1.5570us  1.2640us  789.30us  acc_exit_data@layers.c:60
                    0.00%  232.43ms     50000  4.6480us  3.9160us  2.1150ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  139.39ms         1  139.39ms  139.39ms  139.39ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  113.49ms     50000  2.2690us  1.7690us  795.20us  acc_wait@main.c:190
                    0.00%  101.39ms     50000  2.0270us  1.5130us  827.17us  acc_update@main.c:215
                    0.00%  99.780ms     50000  1.9950us  1.7650us  1.0779ms  acc_wait@main.c:205
                    0.00%  96.937ms     50000  1.9380us  1.7350us  26.218us  acc_wait@main.c:220
                    0.00%  88.634ms     50000  1.7720us  1.5480us  25.632us  acc_update@main.c:200
                    0.00%  82.000ms     50000  1.6400us  1.4520us  18.513us  acc_update@main.c:220
                    0.00%  81.523ms     50000  1.6300us  1.4470us  43.497us  acc_update@main.c:190
                    0.00%  81.322ms     50000  1.6260us  1.4330us  19.875us  acc_update@main.c:205
                    0.00%  38.245ms         9  4.2494ms  7.1280us  38.142ms  acc_enter_data@layers.c:42
                    0.00%  1.0558ms         1  1.0558ms  1.0558ms  1.0558ms  acc_exit_data@main.c:345
                    0.00%  360.32us         1  360.32us  360.32us  360.32us  acc_device_init@main.c:121
                    0.00%  87.939us        18  4.8850us     832ns  33.320us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  68.943us         1  68.943us  68.943us  68.943us  acc_wait@main.c:121
                    0.00%  60.402us        18  3.3550us     913ns  17.641us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  55.954us         9  6.2170us  4.6260us  9.3970us  acc_wait@layers.c:42
                    0.00%  46.692us         2  23.346us  3.2690us  43.423us  acc_exit_data@main.c:317
                    0.00%  42.131us         9  4.6810us  1.6810us  14.769us  acc_exit_data@layers.c:53
                    0.00%  41.766us         2  20.883us  13.956us  27.810us  acc_enter_data@main.c:182
                    0.00%  41.323us         1  41.323us  41.323us  41.323us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  40.482us         3  13.494us  8.0920us  17.673us  acc_enqueue_upload@layers.c:308 (l->weights[:l->weights_size])
                    0.00%  30.168us         3  10.056us  7.2070us  12.060us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  22.561us         3  7.5200us  3.8110us  14.421us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  21.605us         3  7.2010us  3.8160us  9.1980us  acc_wait@layers.c:308
                    0.00%  13.343us         3  4.4470us  2.7320us  7.7610us  acc_update@layers.c:308
                    0.00%  11.105us         3  3.7010us  3.5720us  3.9560us  acc_enqueue_upload@layers.c:308 (l->bias[:l->out_depth])
                    0.00%  4.2410us         2  2.1200us  1.5640us  2.6770us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```