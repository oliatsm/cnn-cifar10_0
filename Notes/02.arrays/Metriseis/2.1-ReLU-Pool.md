# ReLU - Pool Data 
## code
```c
109: ReLU_Layer* make_relu_layer(int W, int H, int D) {
...
124: #pragma acc enter data copyin(layer[0:1])

  return layer;
}

...
131: void relu_forward(float* restrict X, ReLU_Layer* l, float* restrict Y) {
  #pragma acc parallel loop present(l,X,Y) //vector 
  for (int i = 0; i < l->out_size; i++) {
    Y[i] = (X[i] < 0.0f) ? 0.0f : X[i];
  }
}

...
140:void free_relu(ReLU_Layer* l) {
#pragma acc exit data delete(l[0:1])
...

150: Pool_Layer* make_pool_layer(int W, int H, int D, int K, int S) {
    ...
168: #pragma acc enter data copyin(layer[0:1])

  return layer;
}    
175: void pool_forward(float* restrict X, Pool_Layer* l, float* restrict Y) {
  // For each output feature map
  #pragma acc parallel loop present(X,l,Y) //collapse(3) gang worker vector_length(32) 
  for (int m = 0; m < l->out_depth; m++) {
    for (int j = 0; j < l->out_height; j++) {
      for (int i = 0; i < l->out_width; i++) {
        int y_idx = i + l->out_width * (j + m * l->out_height); // Output index
        // Find Max in pooling filter
        float max = -INFINITY;
        #pragma acc loop reduction(max:max) //vector
        for (int p_j = 0; p_j < l->pool_width; p_j++) {
          for (int p_i = 0; p_i < l->pool_width; p_i++) {
            ...
...
203: void free_pool(Pool_Layer* l) {
  #pragma acc exit data delete(l)
...

```

## Minfo
```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c main.c -o main.o
main:
    121, Generating enter data copyin(input[:50000][:3072])
    179, Generating enter data create(O2[:L2->out_size],O1[:L1->out_size],O5[:L5->out_size],O4[:L4->out_size],O3[:L3->out_size],O9[:L9->out_size],O8[:L8->out_size],O7[:L7->out_size],O6[:L6->out_size])
    227, Generating update self(O9[:L9->out_size])
    311, Generating exit data delete(O2[:L2->out_size],O1[:L1->out_size],O5[:L5->out_size],O4[:L4->out_size],O3[:L3->out_size],O8[:L8->out_size],O7[:L7->out_size],O6[:L6->out_size],O9[:L9->out_size])
    339, Generating exit data delete(input[:50000][:3072])
arr2txt:
    362, Zero trip check eliminated
arr2txt_2:
    384, Zero trip check eliminated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(l[:],X[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         62, #pragma acc loop gang, worker(4), vector(32) collapse(3) blockIdx.x threadIdx.y threadIdx.x */
         63,   /* blockIdx.x threadIdx.y threadIdx.x collapsed */
         64,   /* blockIdx.x threadIdx.y threadIdx.x collapsed */
conv_forward:
     77, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         80, #pragma acc loop gang collapse(2) /* blockIdx.x */
         81,   /* blockIdx.x collapsed */
         83, #pragma acc loop worker(4) /* threadIdx.y */
         88, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         89, #pragma acc loop seq
         90, #pragma acc loop seq
         97, Vector barrier inserted for vector loop reduction
     83, Loop is parallelizable
     88, Loop is parallelizable
     89, Loop is parallelizable
     90, Loop is parallelizable
     95, FMA (fused multiply-add) instruction(s) generated
make_relu_layer:
    126, Generating enter data copyin(layer[:1])
relu_forward:
    131, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(i)
         Generating NVIDIA GPU code
        133, #pragma acc loop gang, vector(128) /* blockIdx.x threadIdx.x */
free_relu:
    143, Generating exit data delete(l[:1])
make_pool_layer:
    170, Generating enter data copyin(layer[:1])
pool_forward:
    175, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
        178, #pragma acc loop gang /* blockIdx.x */
        179, #pragma acc loop seq
        180, #pragma acc loop seq
        185, #pragma acc loop seq
        186, #pragma acc loop vector(128) /* threadIdx.x */
             Generating reduction(max:max)
    179, Loop carried dependence of Y-> prevents parallelization
         Loop carried backward dependence of Y-> prevents vectorization
    180, Loop carried dependence of Y-> prevents parallelization
         Loop carried backward dependence of Y-> prevents vectorization
    185, Loop is parallelizable
    186, Loop is parallelizable
free_pool:
    205, Generating exit data delete(l[:1])
fc_forward:
    247, FMA (fused multiply-add) instruction(s) generated
load_conv:
    309, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c malloc2D.c -o malloc2D.o
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c timer.c -o timer.o
cpu_timer_stop:
     11, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -o cnn-cifar10 main.o layers.o malloc2D.o timer.o

```

## exectution
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.015444 seconds
Create Network time:0.040225 seconds
Load Network Parameters time:0.008454 seconds
Create Ouputs time:0.000348 seconds

Net Forward total time:29.128668 seconds
    Time for conv1: 2.534069 seconds
    Time for relu1: 0.571318 seconds
    Time for pool1: 15.015237 seconds
    Time for conv2: 2.224343 seconds
    Time for relu2: 0.574592 seconds
    Time for pool2: 4.140886 seconds
    Time for conv3: 1.436198 seconds
    Time for relu3: 0.581575 seconds
    Time for pool3: 1.400365 seconds
    Time for fc: 0.216663 seconds
    Time for softmax: 0.011562 seconds

  Conv: 6.194610 seconds
  ReLU: 1.727485 seconds
  Pool: 20.556488 seconds
  FC:   0.216663 seconds
  Softmax: 0.011562 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001487 seconds
Free memory time:0.052843 seconds
Total time:30.247469 seconds
END!
```

## Profiling
### nvprof
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2666773== NVPROF is profiling process 2666773, command: ./cnn-cifar10-profile
Load Data time:1.366362 seconds
Create Network time:0.040736 seconds
Load Network Parameters time:0.008668 seconds
Create Ouputs time:0.000333 seconds

Net Forward total time:35.178051 seconds
    Time for conv1: 3.468395 seconds
    Time for relu1: 1.052890 seconds
    Time for pool1: 15.488592 seconds
    Time for conv2: 3.155416 seconds
    Time for relu2: 1.045240 seconds
    Time for pool2: 4.624226 seconds
    Time for conv3: 2.354630 seconds
    Time for relu3: 1.054225 seconds
    Time for pool3: 1.879779 seconds
    Time for fc: 0.227680 seconds
    Time for softmax: 0.014174 seconds

  Conv: 8.978441 seconds
  ReLU: 3.152354 seconds
  Pool: 21.992596 seconds
  FC:   0.227680 seconds
  Softmax: 0.014174 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001537 seconds
Free memory time:0.064208 seconds
Total time:36.659896 seconds
END!
==2666773== Profiling application: ./cnn-cifar10-profile
==2666773== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   80.76%  19.3174s    150000  128.78us  19.903us  326.01us  _8layers_c_pool_forward_175_gpu
                   14.31%  3.42408s    150000  22.827us  10.335us  36.639us  _8layers_c_conv_forward_77_gpu
                    2.15%  515.26ms    150000  3.4350us  3.3910us  13.439us  _8layers_c_relu_forward_131_gpu
                    1.90%  453.55ms    150000  3.0230us  2.9750us  13.473us  _8layers_c_pad_input_60_gpu
                    0.62%  147.78ms        37  3.9941ms     640ns  147.74ms  [CUDA memcpy HtoD]
                    0.26%  62.384ms     50000  1.2470us  1.2150us  1.8240us  [CUDA memcpy DtoH]
                    0.00%  2.5920us         1  2.5920us  2.5920us  2.5920us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   87.32%  25.7983s   1250022  20.638us     652ns  4.4579ms  cuStreamSynchronize
                    8.16%  2.41049s    600001  4.0170us  3.3110us  2.3710ms  cuLaunchKernel
                    1.84%  544.66ms     50000  10.893us  9.6140us  403.14us  cuMemcpyDtoHAsync
                    0.98%  290.30ms    900000     322ns     183ns  6.1415ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.62%  184.14ms         1  184.14ms  184.14ms  184.14ms  cuDevicePrimaryCtxRetain
                    0.50%  148.23ms        37  4.0061ms  2.7090us  147.99ms  cuMemcpyHtoDAsync
                    0.33%  98.432ms    600010     164ns     114ns  794.10us  cuDeviceGetAttribute
                    0.14%  40.117ms         1  40.117ms  40.117ms  40.117ms  cuMemHostAlloc
                    0.07%  20.315ms     50029     406ns     236ns  1.0010ms  cuPointerGetAttributes
                    0.02%  5.9371ms         1  5.9371ms  5.9371ms  5.9371ms  cuMemAllocHost
                    0.01%  4.2671ms        30  142.24us  2.0160us  3.9546ms  cuMemAlloc
                    0.00%  826.23us         2  413.12us  206.91us  619.32us  cuModuleLoadDataEx
                    0.00%  10.283us         1  10.283us  10.283us  10.283us  cuDeviceGetPCIBusId
                    0.00%  8.2520us         1  8.2520us  8.2520us  8.2520us  cuCtxGetCurrent
                    0.00%  5.6200us         6     936ns     404ns  1.6640us  cuModuleGetFunction
                    0.00%  2.7290us         3     909ns     205ns  1.6750us  cuCtxSetCurrent
                    0.00%  1.7500us         3     583ns     107ns  1.4540us  cuDeviceGetCount
                    0.00%     839ns         3     279ns     105ns     531ns  cuDriverGetVersion
                    0.00%     605ns         2     302ns     121ns     484ns  cuDeviceGet
                    0.00%     552ns         1     552ns     552ns     552ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  20.0836s    300000  66.945us  1.6480us  2.0472ms  acc_wait@layers.c:175
                    0.00%  4.15598s    300000  13.853us  1.6390us  4.4872ms  acc_wait@layers.c:77
                    0.00%  1.22736s    300000  4.0910us  1.6580us  1.5524ms  acc_wait@layers.c:131
                    0.00%  1.17584s    300000  3.9190us  1.3900us  1.6308ms  acc_wait@layers.c:60
                    0.00%  804.66ms    150000  5.3640us  4.2880us  2.3727ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  762.30ms    150000  5.0810us  4.2680us  1.3114ms  acc_enqueue_launch@layers.c:131 (_8layers_c_relu_forward_131_gpu)
                    0.00%  759.13ms    150000  5.0600us  4.1950us  2.3430ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  753.75ms    150000  5.0250us  4.2760us  2.1045ms  acc_enqueue_launch@layers.c:175 (_8layers_c_pool_forward_175_gpu)
                    0.00%  588.50ms     50000  11.770us  10.366us  778.29us  acc_enqueue_download@main.c:227 (O9[:L9->out_size])
                    0.00%  436.61ms    150000  2.9100us  2.3270us  6.3988ms  acc_compute_construct@layers.c:60
                    0.00%  415.59ms    150000  2.7700us  2.4090us  2.1032ms  acc_compute_construct@layers.c:175
                    0.00%  412.27ms    150000  2.7480us  2.3200us  795.13us  acc_compute_construct@layers.c:131
                    0.00%  297.06ms    150000  1.9800us  1.7050us  1.0243ms  acc_enter_data@layers.c:131
                    0.00%  290.46ms    150000  1.9360us  1.6660us  20.059us  acc_enter_data@layers.c:175
                    0.00%  286.78ms    150000  1.9110us  1.6190us  790.61us  acc_enter_data@layers.c:77
                    0.00%  278.87ms    150000  1.8590us  1.5590us  1.3539ms  acc_exit_data@layers.c:131
                    0.00%  267.16ms    150000  1.7810us  1.5330us  823.10us  acc_compute_construct@layers.c:77
                    0.00%  266.08ms    150000  1.7730us  1.4940us  806.11us  acc_exit_data@layers.c:77
                    0.00%  264.78ms    150000  1.7650us  1.4840us  637.63us  acc_exit_data@layers.c:175
                    0.00%  260.03ms    150000  1.7330us  1.3440us  755.70us  acc_enter_data@layers.c:60
                    0.00%  216.71ms    150000  1.4440us  1.2380us  27.460us  acc_exit_data@layers.c:60
                    0.00%  148.00ms         1  148.00ms  148.00ms  148.00ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  102.85ms     50000  2.0560us  1.7200us  788.38us  acc_wait@main.c:227
                    0.00%  81.518ms     50000  1.6300us  1.4120us  22.550us  acc_update@main.c:227
                    0.00%  40.352ms         9  4.4836ms  7.5030us  40.178ms  acc_enter_data@layers.c:42
                    0.00%  1.0609ms         1  1.0609ms  1.0609ms  1.0609ms  acc_exit_data@main.c:339
                    0.00%  709.96us         1  709.96us  709.96us  709.96us  acc_device_init@main.c:121
                    0.00%  91.013us        18  5.0560us     887ns  31.628us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  74.193us         3  24.731us  16.912us  36.924us  acc_enter_data@main.c:179
                    0.00%  72.194us        18  4.0100us     899ns  25.710us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  65.441us         1  65.441us  65.441us  65.441us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  62.651us         1  62.651us  62.651us  62.651us  acc_wait@main.c:121
                    0.00%  61.546us         9  6.8380us  4.5030us  10.751us  acc_wait@layers.c:42
                    0.00%  54.478us         3  18.159us  4.4210us  45.320us  acc_exit_data@main.c:311
                    0.00%  44.417us         3  14.805us  8.1840us  21.173us  acc_enqueue_upload@layers.c:309 (l->weights[:l->weights_size])
                    0.00%  40.192us         9  4.4650us  1.7590us  13.049us  acc_exit_data@layers.c:53
                    0.00%  31.350us         3  10.450us  7.5140us  12.110us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  28.535us         3  9.5110us  3.9500us  20.369us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  24.260us         3  8.0860us  6.6580us  9.7240us  acc_enter_data@layers.c:170
                    0.00%  22.272us         3  7.4240us  6.9280us  8.3560us  acc_enter_data@layers.c:126
                    0.00%  21.281us         3  7.0930us  3.9970us  8.8090us  acc_wait@layers.c:309
                    0.00%  15.402us         3  5.1340us  3.7950us  6.9270us  acc_enqueue_upload@layers.c:126 (layer[:1])
                    0.00%  15.308us         3  5.1020us  2.7670us  7.7630us  acc_update@layers.c:309
                    0.00%  14.180us         3  4.7260us  4.6040us  4.7960us  acc_wait@layers.c:170
                    0.00%  14.124us         3  4.7080us  4.5730us  4.7970us  acc_wait@layers.c:126
                    0.00%  11.526us         3  3.8420us  3.7670us  3.9800us  acc_enqueue_upload@layers.c:170 (layer[:1])
                    0.00%  11.495us         3  3.8310us  3.5090us  4.0100us  acc_enqueue_upload@layers.c:309 (l->bias[:l->out_depth])
                    0.00%  8.8590us         3  2.9530us  1.7420us  5.3060us  acc_exit_data@layers.c:205
                    0.00%  6.4380us         3  2.1460us  1.5040us  3.3160us  acc_wait@main.c:179
                    0.00%  5.8230us         3  1.9410us  1.6940us  2.3470us  acc_exit_data@layers.c:143
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:170
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:126
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:205
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:170
                    0.00%       0ns         9       0ns       0ns       0ns  acc_alloc@main.c:179
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:339
                    0.00%       0ns         9       0ns       0ns       0ns  acc_create@main.c:179
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:143
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:126
                    0.00%       0ns         9       0ns       0ns       0ns  acc_delete@main.c:311
```

### NV_ACC_TIME
```
l$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:1.150869 seconds
Create Network time:0.038750 seconds
Load Network Parameters time:0.008038 seconds
Create Ouputs time:0.000339 seconds

Net Forward total time:32.294158 seconds
    Time for conv1: 3.039519 seconds
    Time for relu1: 0.809903 seconds
    Time for pool1: 15.161634 seconds
    Time for conv2: 2.671967 seconds
    Time for relu2: 0.804129 seconds
    Time for pool2: 4.364178 seconds
    Time for conv3: 1.908814 seconds
    Time for relu3: 0.803237 seconds
    Time for pool3: 1.641243 seconds
    Time for fc: 0.218617 seconds
    Time for softmax: 0.010611 seconds

  Conv: 7.620301 seconds
  ReLU: 2.417269 seconds
  Pool: 21.167055 seconds
  FC:   0.218617 seconds
  Softmax: 0.010611 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001362 seconds
Free memory time:0.049322 seconds
Total time:33.542838 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 238
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=238 max=29 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 186
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=186 max=31 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [800]  block: [32x4]
            elapsed time(us): total=1,852,499 max=383 min=11 avg=12
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    77: compute region reached 150000 times
        77: kernel launched 150000 times
            grid: [160-512]  block: [32x4]
            elapsed time(us): total=4,740,152 max=439 min=18 avg=31
    77: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_relu_layer  NVIDIA  devicenum=0
    time(us): 11
    126: data region reached 3 times
        126: data copyin transfers: 3
             device time(us): total=11 max=4 min=3 avg=3
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  relu_forward  NVIDIA  devicenum=0
    time(us): 0
    131: compute region reached 150000 times
        131: kernel launched 150000 times
            grid: [1280]  block: [128]
            elapsed time(us): total=1,854,729 max=382 min=11 avg=12
    131: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_relu  NVIDIA  devicenum=0
    time(us): 0
    143: data region reached 3 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_pool_layer  NVIDIA  devicenum=0
    time(us): 9
    170: data region reached 3 times
        170: data copyin transfers: 3
             device time(us): total=9 max=3 min=3 avg=3
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pool_forward  NVIDIA  devicenum=0
    time(us): 0
    175: compute region reached 150000 times
        175: kernel launched 150000 times
            grid: [720]  block: [128]
            elapsed time(us): total=20,587,879 max=4,183 min=28 avg=137
    175: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_pool  NVIDIA  devicenum=0
    time(us): 0
    205: data region reached 3 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 53
    309: update directive reached 3 times
        309: data copyin transfers: 6
             device time(us): total=53 max=20 min=3 avg=8
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/main.c
  main  NVIDIA  devicenum=0
    time(us): 545,654
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=48 max=48 min=48 avg=48
        121: data copyin transfers: 1
             device time(us): total=140,055 max=140,055 min=140,055 avg=140,055
    179: data region reached 3 times
    227: update directive reached 50000 times
        227: data copyout transfers: 50000
             device time(us): total=405,599 max=61 min=6 avg=8
    311: data region reached 3 times
    339: data region reached 1 time
```

# Pool Loop opt

## code 

```c
131: void relu_forward(float* restrict X, ReLU_Layer* l, float* restrict Y) {
  #pragma acc parallel loop present(l,X,Y)  
  for (int i = 0; i < l->out_size; i++) {
    Y[i] = (X[i] < 0.0f) ? 0.0f : X[i];
  }
}
...

175: void pool_forward(float* restrict X, Pool_Layer* l, float* restrict Y) {
  // For each output feature map
  #pragma acc parallel loop present(X,l,Y) collapse(2) gang  
  for (int m = 0; m < l->out_depth; m++) {
    for (int j = 0; j < l->out_height; j++) {
      #pragma acc loop independent worker
      for (int i = 0; i < l->out_width; i++) {
        int y_idx = i + l->out_width * (j + m * l->out_height); // Output index
        // Find Max in pooling filter
        float max = -INFINITY;
        #pragma acc loop reduction(max:max) vector
        for (int p_j = 0; p_j < l->pool_width; p_j++) {
          for (int p_i = 0; p_i < l->pool_width; p_i++) {
            ...
```

## Minfo
```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c main.c -o main.o
main:
    121, Generating enter data copyin(input[:50000][:3072])
    179, Generating enter data create(O2[:L2->out_size],O1[:L1->out_size],O5[:L5->out_size],O4[:L4->out_size],O3[:L3->out_size],O9[:L9->out_size],O8[:L8->out_size],O7[:L7->out_size],O6[:L6->out_size])
    227, Generating update self(O9[:L9->out_size])
    311, Generating exit data delete(O2[:L2->out_size],O1[:L1->out_size],O5[:L5->out_size],O4[:L4->out_size],O3[:L3->out_size],O8[:L8->out_size],O7[:L7->out_size],O6[:L6->out_size],O9[:L9->out_size])
    339, Generating exit data delete(input[:50000][:3072])
...
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
...
make_relu_layer:
    126, Generating enter data copyin(layer[:1])
relu_forward:
    131, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(i)
         Generating NVIDIA GPU code
        133, #pragma acc loop gang, vector(128) /* blockIdx.x threadIdx.x */
free_relu:
    143, Generating exit data delete(l[:1])
make_pool_layer:
    170, Generating enter data copyin(layer[:1])
pool_forward:
    175, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
        178, #pragma acc loop gang collapse(2) /* blockIdx.x */
        179,   /* blockIdx.x collapsed */
        181, #pragma acc loop worker(4) /* threadIdx.y */
        186, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(max:max)
        187, #pragma acc loop seq
        194, Vector barrier inserted for vector loop reduction
    181, Loop is parallelizable
    186, Loop is parallelizable
    187, Loop is parallelizable
free_pool:
    206, Generating exit data delete(l[:1])

```

## execute

```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.019230 seconds
Create Network time:0.040638 seconds
Load Network Parameters time:0.008086 seconds
Create Ouputs time:0.000318 seconds

Net Forward total time:10.254458 seconds
    Time for conv1: 2.499250 seconds
    Time for relu1: 0.562956 seconds
    Time for pool1: 0.713772 seconds
    Time for conv2: 2.192745 seconds
    Time for relu2: 0.564989 seconds
    Time for pool2: 0.580803 seconds
    Time for conv3: 1.412624 seconds
    Time for relu3: 0.565966 seconds
    Time for pool3: 0.512729 seconds
    Time for fc: 0.218783 seconds
    Time for softmax: 0.010193 seconds

  Conv: 6.104619 seconds
  ReLU: 1.693911 seconds
  Pool: 1.807305 seconds
  FC:   0.218783 seconds
  Softmax: 0.010193 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001402 seconds
Free memory time:0.044656 seconds
Total time:11.368789 seconds
```
## Profiling
### NV_ACC

```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:1.224125 seconds
Create Network time:0.040283 seconds
Load Network Parameters time:0.008733 seconds
Create Ouputs time:0.000350 seconds

Net Forward total time:13.849943 seconds
    Time for conv1: 3.070260 seconds
    Time for relu1: 0.824399 seconds
    Time for pool1: 0.969763 seconds
    Time for conv2: 2.699679 seconds
    Time for relu2: 0.819972 seconds
    Time for pool2: 0.839825 seconds
    Time for conv3: 1.935191 seconds
    Time for relu3: 0.816493 seconds
    Time for pool3: 0.777795 seconds
    Time for fc: 0.218595 seconds
    Time for softmax: 0.011158 seconds

  Conv: 7.705131 seconds
  ReLU: 2.460864 seconds
  Pool: 2.587383 seconds
  FC:   0.218595 seconds
  Softmax: 0.011158 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001357 seconds
Free memory time:0.049941 seconds
Total time:15.174733 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 225
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=225 max=27 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 191
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=191 max=32 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [800]  block: [32x4]
            elapsed time(us): total=1,866,711 max=1,985 min=11 avg=12
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    77: compute region reached 150000 times
        77: kernel launched 150000 times
            grid: [160-512]  block: [32x4]
            elapsed time(us): total=4,765,197 max=4,064 min=18 avg=31
    77: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_relu_layer  NVIDIA  devicenum=0
    time(us): 10
    126: data region reached 3 times
        126: data copyin transfers: 3
             device time(us): total=10 max=4 min=3 avg=3
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  relu_forward  NVIDIA  devicenum=0
    time(us): 0
    131: compute region reached 150000 times
        131: kernel launched 150000 times
            grid: [1280]  block: [128]
            elapsed time(us): total=1,879,814 max=3,753 min=11 avg=12
    131: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_relu  NVIDIA  devicenum=0
    time(us): 0
    143: data region reached 3 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_pool_layer  NVIDIA  devicenum=0
    time(us): 9
    170: data region reached 3 times
        170: data copyin transfers: 3
             device time(us): total=9 max=3 min=3 avg=3
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pool_forward  NVIDIA  devicenum=0
    time(us): 0
    175: compute region reached 150000 times
        175: kernel launched 150000 times
            grid: [80-256]  block: [32x4]
            elapsed time(us): total=2,036,372 max=419 min=11 avg=13
    175: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_pool  NVIDIA  devicenum=0
    time(us): 0
    206: data region reached 3 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 54
    310: update directive reached 3 times
        310: data copyin transfers: 6
             device time(us): total=54 max=22 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/main.c
  main  NVIDIA  devicenum=0
    time(us): 550,953
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=45 max=45 min=45 avg=45
        121: data copyin transfers: 1
             device time(us): total=141,082 max=141,082 min=141,082 avg=141,082
    179: data region reached 3 times
    227: update directive reached 50000 times
        227: data copyout transfers: 50000
             device time(us): total=409,871 max=39 min=6 avg=8
    311: data region reached 3 times
    339: data region reached 1 time
```

### nvprof
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2679811== NVPROF is profiling process 2679811, command: ./cnn-cifar10-profile
Load Data time:1.387267 seconds
Create Network time:0.040387 seconds
Load Network Parameters time:0.008458 seconds
Create Ouputs time:0.000301 seconds

Net Forward total time:17.182630 seconds
    Time for conv1: 3.715066 seconds
    Time for relu1: 1.090007 seconds
    Time for pool1: 1.239950 seconds
    Time for conv2: 3.322901 seconds
    Time for relu2: 1.100102 seconds
    Time for pool2: 1.080519 seconds
    Time for conv3: 2.468302 seconds
    Time for relu3: 1.101795 seconds
    Time for pool3: 0.999671 seconds
    Time for fc: 0.226416 seconds
    Time for softmax: 0.014357 seconds

  Conv: 9.506269 seconds
  ReLU: 3.291903 seconds
  Pool: 3.320140 seconds
  FC:   0.226416 seconds
  Softmax: 0.014357 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.002172 seconds
Free memory time:0.055280 seconds
Total time:18.676497 seconds
END!
==2679811== Profiling application: ./cnn-cifar10-profile
==2679811== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   64.71%  3.80965s    150000  25.397us  11.520us  36.896us  _8layers_c_conv_forward_77_gpu
                   13.10%  771.21ms    150000  5.1410us  3.1350us  13.407us  _8layers_c_pool_forward_175_gpu
                    9.81%  577.66ms    150000  3.8510us  3.8070us  13.600us  _8layers_c_relu_forward_131_gpu
                    8.77%  516.38ms    150000  3.4420us  3.3910us  13.472us  _8layers_c_pad_input_60_gpu
                    2.48%  146.24ms        37  3.9525ms     735ns  146.20ms  [CUDA memcpy HtoD]
                    1.13%  66.511ms     50000  1.3300us  1.3110us  1.9200us  [CUDA memcpy DtoH]
                    0.00%  2.6560us         1  2.6560us  2.6560us  2.6560us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   67.03%  7.72195s   1250022  6.1770us     599ns  4.4032ms  cuStreamSynchronize
                   22.40%  2.58056s    600001  4.3000us  3.3480us  5.2650ms  cuLaunchKernel
                    4.79%  552.24ms     50000  11.044us  9.8140us  1.5166ms  cuMemcpyDtoHAsync
                    1.64%  188.87ms    600000     314ns     185ns  8.0733ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    1.61%  185.22ms         1  185.22ms  185.22ms  185.22ms  cuDevicePrimaryCtxRetain
                    1.27%  146.63ms        37  3.9629ms  2.6220us  146.42ms  cuMemcpyHtoDAsync
                    0.73%  83.858ms    600010     139ns     113ns  16.832us  cuDeviceGetAttribute
                    0.35%  39.810ms         1  39.810ms  39.810ms  39.810ms  cuMemHostAlloc
                    0.17%  19.221ms     50029     384ns     234ns  782.20us  cuPointerGetAttributes
                    0.01%  1.3164ms         1  1.3164ms  1.3164ms  1.3164ms  cuMemAllocHost
                    0.01%  696.91us         2  348.46us  107.36us  589.55us  cuModuleLoadDataEx
                    0.00%  542.66us        30  18.088us  1.8930us  233.85us  cuMemAlloc
                    0.00%  12.975us         1  12.975us  12.975us  12.975us  cuCtxGetCurrent
                    0.00%  11.266us         1  11.266us  11.266us  11.266us  cuDeviceGetPCIBusId
                    0.00%  4.3290us         6     721ns     346ns  1.6860us  cuModuleGetFunction
                    0.00%  3.4480us         3  1.1490us     173ns  1.6810us  cuCtxSetCurrent
                    0.00%  2.3420us         3     780ns     195ns  1.8510us  cuDeviceGetCount
                    0.00%  1.4180us         3     472ns     240ns     666ns  cuDriverGetVersion
                    0.00%  1.1840us         2     592ns     240ns     944ns  cuDeviceGet
                    0.00%     771ns         1     771ns     771ns     771ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.55490s    300000  15.182us  1.5500us  1.8130ms  acc_wait@layers.c:77
                    0.00%  1.52241s    300000  5.0740us  1.5500us  2.6052ms  acc_wait@layers.c:175
                    0.00%  1.26811s    300000  4.2270us  1.5810us  4.4309ms  acc_wait@layers.c:131
                    0.00%  1.21917s    300000  4.0630us  1.2450us  2.1620ms  acc_wait@layers.c:60
                    0.00%  842.25ms    150000  5.6140us  4.2990us  2.7724ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  818.47ms    150000  5.4560us  4.3240us  5.3033ms  acc_enqueue_launch@layers.c:131 (_8layers_c_relu_forward_131_gpu)
                    0.00%  794.71ms    150000  5.2980us  4.2730us  1.5107ms  acc_enqueue_launch@layers.c:175 (_8layers_c_pool_forward_175_gpu)
                    0.00%  786.30ms    150000  5.2420us  4.2170us  2.1127ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  594.15ms     50000  11.882us  10.562us  1.5214ms  acc_enqueue_download@main.c:227 (O9[:L9->out_size])
                    0.00%  455.04ms    150000  3.0330us  2.3530us  15.437ms  acc_compute_construct@layers.c:60
                    0.00%  427.15ms    150000  2.8470us  2.3280us  4.1749ms  acc_compute_construct@layers.c:131
                    0.00%  326.33ms    150000  2.1750us  1.7490us  951.54us  acc_enter_data@layers.c:131
                    0.00%  309.59ms    150000  2.0630us  1.6870us  836.31us  acc_enter_data@layers.c:175
                    0.00%  287.60ms    150000  1.9170us  1.6350us  768.27us  acc_enter_data@layers.c:77
                    0.00%  276.88ms    150000  1.8450us  1.5390us  1.4812ms  acc_exit_data@layers.c:131
                    0.00%  266.83ms    150000  1.7780us  1.4080us  815.26us  acc_enter_data@layers.c:60
                    0.00%  260.71ms    150000  1.7380us  1.5300us  914.51us  acc_compute_construct@layers.c:77
                    0.00%  258.51ms    150000  1.7230us  1.4800us  1.1034ms  acc_exit_data@layers.c:175
                    0.00%  258.24ms    150000  1.7210us  1.5130us  723.37us  acc_compute_construct@layers.c:175
                    0.00%  258.07ms    150000  1.7200us  1.4870us  1.3089ms  acc_exit_data@layers.c:77
                    0.00%  228.37ms    150000  1.5220us  1.2000us  909.62us  acc_exit_data@layers.c:60
                    0.00%  146.42ms         1  146.42ms  146.42ms  146.42ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  96.248ms     50000  1.9240us  1.4390us  886.21us  acc_update@main.c:227
                    0.00%  93.926ms     50000  1.8780us  1.6590us  140.35us  acc_wait@main.c:227
                    0.00%  40.017ms         9  4.4463ms  6.3860us  39.868ms  acc_enter_data@layers.c:42
                    0.00%  1.0811ms         1  1.0811ms  1.0811ms  1.0811ms  acc_exit_data@main.c:339
                    0.00%  679.74us         1  679.74us  679.74us  679.74us  acc_device_init@main.c:121
                    0.00%  85.913us        18  4.7720us     830ns  30.685us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  68.699us         1  68.699us  68.699us  68.699us  acc_wait@main.c:121
                    0.00%  67.343us         3  22.447us  19.056us  29.043us  acc_enter_data@main.c:179
                    0.00%  64.025us        18  3.5560us     922ns  19.118us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  60.793us         9  6.7540us  4.5620us  10.024us  acc_wait@layers.c:42
                    0.00%  51.523us         3  17.174us  4.4420us  42.563us  acc_exit_data@main.c:311
                    0.00%  50.393us         1  50.393us  50.393us  50.393us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  41.145us         3  13.715us  8.1380us  17.129us  acc_enqueue_upload@layers.c:310 (l->weights[:l->weights_size])
                    0.00%  36.272us         9  4.0300us  1.7910us  10.364us  acc_exit_data@layers.c:53
                    0.00%  29.438us         3  9.8120us  6.8220us  11.416us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  24.233us         3  8.0770us  6.1460us  11.425us  acc_enter_data@layers.c:170
                    0.00%  23.640us         3  7.8800us  3.5990us  16.191us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  21.175us         3  7.0580us  6.5070us  7.9400us  acc_enter_data@layers.c:126
                    0.00%  20.984us         3  6.9940us  3.5820us  9.1660us  acc_wait@layers.c:310
                    0.00%  15.547us         3  5.1820us  3.3390us  8.6490us  acc_update@layers.c:310
                    0.00%  14.396us         3  4.7980us  4.7320us  4.8900us  acc_wait@layers.c:170
                    0.00%  14.082us         3  4.6940us  4.5620us  4.7650us  acc_wait@layers.c:126
                    0.00%  11.642us         3  3.8800us  3.5290us  4.4470us  acc_enqueue_upload@layers.c:126 (layer[:1])
                    0.00%  11.015us         3  3.6710us  3.3520us  3.9860us  acc_enqueue_upload@layers.c:310 (l->bias[:l->out_depth])
                    0.00%  10.999us         3  3.6660us  3.4730us  3.9480us  acc_enqueue_upload@layers.c:170 (layer[:1])
                    0.00%  8.3160us         3  2.7720us  1.6560us  4.7250us  acc_exit_data@layers.c:206
                    0.00%  6.2850us         3  2.0950us  1.7050us  2.7610us  acc_exit_data@layers.c:143
                    0.00%  5.4550us         3  1.8180us  1.4670us  2.3680us  acc_wait@main.c:179
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:170
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:126
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:206
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:170
                    0.00%       0ns         9       0ns       0ns       0ns  acc_alloc@main.c:179
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:339
                    0.00%       0ns         9       0ns       0ns       0ns  acc_create@main.c:179
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:143
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:126
                    0.00%       0ns         9       0ns       0ns       0ns  acc_delete@main.c:311
```
# Pool Loop Vector_length(32)

## code
`  #pragma acc parallel loop present(X,l,Y) collapse(2) gang vector_length(32) `

## Minfo
```
...
pool_forward:
    175, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
        178, #pragma acc loop gang collapse(2) /* blockIdx.x */
        179,   /* blockIdx.x collapsed */
        181, #pragma acc loop worker(4) /* threadIdx.y */
        186, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(max:max)
        187, #pragma acc loop seq
        194, Vector barrier inserted for vector loop reduction
    181, Loop is parallelizable
    186, Loop is parallelizable
    187, Loop is parallelizable
    ...
```

## execution
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.026724 seconds
Create Network time:0.039851 seconds
Load Network Parameters time:0.008191 seconds
Create Ouputs time:0.000323 seconds

Net Forward total time:10.218912 seconds
    Time for conv1: 2.508227 seconds
    Time for relu1: 0.567647 seconds
    Time for pool1: 0.671753 seconds
    Time for conv2: 2.196010 seconds
    Time for relu2: 0.564758 seconds
    Time for pool2: 0.564984 seconds
    Time for conv3: 1.426151 seconds
    Time for relu3: 0.568961 seconds
    Time for pool3: 0.505670 seconds
    Time for fc: 0.217083 seconds
    Time for softmax: 0.010375 seconds

  Conv: 6.130387 seconds
  ReLU: 1.701367 seconds
  Pool: 1.742407 seconds
  FC:   0.217083 seconds
  Softmax: 0.010375 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001382 seconds
Free memory time:0.050493 seconds
Total time:11.345876 seconds
```

## Profiling
### NV_ACC
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:1.159820 seconds
Create Network time:0.038815 seconds
Load Network Parameters time:0.008010 seconds
Create Ouputs time:0.000332 seconds

Net Forward total time:13.789934 seconds
    Time for conv1: 3.070837 seconds
    Time for relu1: 0.826434 seconds
    Time for pool1: 0.927598 seconds
    Time for conv2: 2.705807 seconds
    Time for relu2: 0.819166 seconds
    Time for pool2: 0.817567 seconds
    Time for conv3: 1.933388 seconds
    Time for relu3: 0.813456 seconds
    Time for pool3: 0.770046 seconds
    Time for fc: 0.217590 seconds
    Time for softmax: 0.012613 seconds

  Conv: 7.710032 seconds
  ReLU: 2.459057 seconds
  Pool: 2.515210 seconds
  FC:   0.217590 seconds
  Softmax: 0.012613 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001393 seconds
Free memory time:0.047799 seconds
Total time:15.046102 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 222
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=222 max=26 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 180
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=180 max=30 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [800]  block: [32x4]
            elapsed time(us): total=1,866,754 max=1,122 min=11 avg=12
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    77: compute region reached 150000 times
        77: kernel launched 150000 times
            grid: [160-512]  block: [32x4]
            elapsed time(us): total=4,763,260 max=1,615 min=18 avg=31
    77: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_relu_layer  NVIDIA  devicenum=0
    time(us): 9
    126: data region reached 3 times
        126: data copyin transfers: 3
             device time(us): total=9 max=3 min=3 avg=3
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  relu_forward  NVIDIA  devicenum=0
    time(us): 0
    131: compute region reached 150000 times
        131: kernel launched 150000 times
            grid: [1280]  block: [128]
            elapsed time(us): total=1,874,333 max=4,075 min=11 avg=12
    131: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_relu  NVIDIA  devicenum=0
    time(us): 0
    143: data region reached 3 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_pool_layer  NVIDIA  devicenum=0
    time(us): 9
    170: data region reached 3 times
        170: data copyin transfers: 3
             device time(us): total=9 max=3 min=3 avg=3
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pool_forward  NVIDIA  devicenum=0
    time(us): 0
    175: compute region reached 150000 times
        175: kernel launched 150000 times
            grid: [80-256]  block: [32x4]
            elapsed time(us): total=1,958,175 max=1,179 min=10 avg=13
    175: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_pool  NVIDIA  devicenum=0
    time(us): 0
    206: data region reached 3 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 52
    310: update directive reached 3 times
        310: data copyin transfers: 6
             device time(us): total=52 max=20 min=3 avg=8
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/main.c
  main  NVIDIA  devicenum=0
    time(us): 568,445
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=42 max=42 min=42 avg=42
        121: data copyin transfers: 1
             device time(us): total=152,101 max=152,101 min=152,101 avg=152,101
    179: data region reached 3 times
    227: update directive reached 50000 times
        227: data copyout transfers: 50000
             device time(us): total=416,344 max=1,026 min=6 avg=8
    311: data region reached 3 times
    339: data region reached 1 time
```

### nvprof
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2691664== NVPROF is profiling process 2691664, command: ./cnn-cifar10-profile
Load Data time:1.296408 seconds
Create Network time:0.037944 seconds
Load Network Parameters time:0.007918 seconds
Create Ouputs time:0.000336 seconds

Net Forward total time:16.989288 seconds
    Time for conv1: 3.712296 seconds
    Time for relu1: 1.076279 seconds
    Time for pool1: 1.189123 seconds
    Time for conv2: 3.319605 seconds
    Time for relu2: 1.093874 seconds
    Time for pool2: 1.046553 seconds
    Time for conv3: 2.434141 seconds
    Time for relu3: 1.085411 seconds
    Time for pool3: 0.980388 seconds
    Time for fc: 0.224380 seconds
    Time for softmax: 0.013705 seconds

  Conv: 9.466043 seconds
  ReLU: 3.255564 seconds
  Pool: 3.216063 seconds
  FC:   0.224380 seconds
  Softmax: 0.013705 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001951 seconds
Free memory time:0.053345 seconds
Total time:18.387190 seconds
END!
==2691664== Profiling application: ./cnn-cifar10-profile
==2691664== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   65.66%  3.80908s    150000  25.393us  11.520us  36.704us  _8layers_c_conv_forward_77_gpu
                   11.82%  685.59ms    150000  4.5700us  2.9110us  13.440us  _8layers_c_pool_forward_175_gpu
                    9.95%  577.36ms    150000  3.8490us  3.7760us  13.248us  _8layers_c_relu_forward_131_gpu
                    8.88%  515.06ms    150000  3.4330us  3.3910us  13.408us  _8layers_c_pad_input_60_gpu
                    2.54%  147.58ms        37  3.9886ms     736ns  147.53ms  [CUDA memcpy HtoD]
                    1.14%  66.381ms     50000  1.3270us  1.2800us  2.0800us  [CUDA memcpy DtoH]
                    0.00%  2.6240us         1  2.6240us  2.6240us  2.6240us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   67.16%  7.63760s   1250022  6.1090us     707ns  4.0484ms  cuStreamSynchronize
                   22.47%  2.55524s    600001  4.2580us  3.3530us  4.8268ms  cuLaunchKernel
                    4.82%  548.52ms     50000  10.970us  9.8130us  132.92us  cuMemcpyDtoHAsync
                    1.63%  185.69ms    600000     309ns     184ns  8.1748ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    1.32%  150.26ms         1  150.26ms  150.26ms  150.26ms  cuDevicePrimaryCtxRetain
                    1.30%  147.97ms        37  3.9993ms  2.7370us  147.77ms  cuMemcpyHtoDAsync
                    0.76%  86.234ms    600010     143ns     118ns  16.956us  cuDeviceGetAttribute
                    0.33%  37.365ms         1  37.365ms  37.365ms  37.365ms  cuMemHostAlloc
                    0.19%  21.566ms     50029     431ns     245ns  842.37us  cuPointerGetAttributes
                    0.01%  1.2777ms         1  1.2777ms  1.2777ms  1.2777ms  cuMemAllocHost
                    0.01%  754.65us         2  377.32us  103.33us  651.32us  cuModuleLoadDataEx
                    0.00%  494.77us        30  16.492us  1.8320us  201.15us  cuMemAlloc
                    0.00%  10.752us         1  10.752us  10.752us  10.752us  cuDeviceGetPCIBusId
                    0.00%  4.8080us         6     801ns     340ns  2.0600us  cuModuleGetFunction
                    0.00%  4.7620us         3  1.5870us     209ns  3.0670us  cuCtxSetCurrent
                    0.00%  2.9740us         3     991ns     276ns  2.3860us  cuDeviceGetCount
                    0.00%  2.0500us         3     683ns     158ns  1.5480us  cuDriverGetVersion
                    0.00%     804ns         2     402ns     203ns     601ns  cuDeviceGet
                    0.00%     621ns         1     621ns     621ns     621ns  cuCtxGetCurrent
                    0.00%     574ns         1     574ns     574ns     574ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.55527s    300000  15.184us  1.5600us  4.0975ms  acc_wait@layers.c:77
                    0.00%  1.43474s    300000  4.7820us  1.5680us  1.3233ms  acc_wait@layers.c:175
                    0.00%  1.26125s    300000  4.2040us  1.5670us  1.2150ms  acc_wait@layers.c:131
                    0.00%  1.21215s    300000  4.0400us  1.4410us  848.79us  acc_wait@layers.c:60
                    0.00%  833.91ms    150000  5.5590us  4.3000us  2.9901ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  806.25ms    150000  5.3740us  4.3000us  919.05us  acc_enqueue_launch@layers.c:131 (_8layers_c_relu_forward_131_gpu)
                    0.00%  787.81ms    150000  5.2520us  4.2310us  4.8342ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  784.61ms    150000  5.2300us  4.2530us  871.87us  acc_enqueue_launch@layers.c:175 (_8layers_c_pool_forward_175_gpu)
                    0.00%  587.72ms     50000  11.754us  10.525us  800.80us  acc_enqueue_download@main.c:227 (O9[:L9->out_size])
                    0.00%  453.50ms    150000  3.0230us  2.3830us  15.042ms  acc_compute_construct@layers.c:60
                    0.00%  423.28ms    150000  2.8210us  2.3690us  4.7097ms  acc_compute_construct@layers.c:131
                    0.00%  314.07ms    150000  2.0930us  1.7060us  903.98us  acc_enter_data@layers.c:131
                    0.00%  306.26ms    150000  2.0410us  1.6870us  1.2381ms  acc_enter_data@layers.c:175
                    0.00%  279.40ms    150000  1.8620us  1.5870us  799.02us  acc_exit_data@layers.c:131
                    0.00%  279.33ms    150000  1.8620us  1.6170us  1.5412ms  acc_enter_data@layers.c:77
                    0.00%  263.46ms    150000  1.7560us  1.3870us  832.31us  acc_enter_data@layers.c:60
                    0.00%  258.64ms    150000  1.7240us  1.5190us  772.08us  acc_exit_data@layers.c:175
                    0.00%  257.49ms    150000  1.7160us  1.5390us  775.49us  acc_compute_construct@layers.c:175
                    0.00%  257.02ms    150000  1.7130us  1.5380us  1.1908ms  acc_compute_construct@layers.c:77
                    0.00%  255.76ms    150000  1.7050us  1.5380us  740.77us  acc_exit_data@layers.c:77
                    0.00%  231.92ms    150000  1.5460us  1.2550us  874.17us  acc_exit_data@layers.c:60
                    0.00%  147.77ms         1  147.77ms  147.77ms  147.77ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  94.617ms     50000  1.8920us  1.4570us  846.35us  acc_update@main.c:227
                    0.00%  93.408ms     50000  1.8680us  1.6490us  199.88us  acc_wait@main.c:227
                    0.00%  37.566ms         9  4.1740ms  6.7380us  37.416ms  acc_enter_data@layers.c:42
                    0.00%  1.0611ms         1  1.0611ms  1.0611ms  1.0611ms  acc_exit_data@main.c:339
                    0.00%  761.76us         1  761.76us  761.76us  761.76us  acc_device_init@main.c:121
                    0.00%  82.845us        18  4.6020us     820ns  27.238us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  69.502us         3  23.167us  19.335us  30.563us  acc_enter_data@main.c:179
                    0.00%  69.360us         1  69.360us  69.360us  69.360us  acc_wait@main.c:121
                    0.00%  62.049us         9  6.8940us  4.5850us  10.232us  acc_wait@layers.c:42
                    0.00%  61.207us        18  3.4000us     894ns  17.170us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  56.242us         1  56.242us  56.242us  56.242us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  52.077us         3  17.359us  4.5430us  42.798us  acc_exit_data@main.c:311
                    0.00%  41.277us         3  13.759us  7.7740us  18.264us  acc_enqueue_upload@layers.c:310 (l->weights[:l->weights_size])
                    0.00%  35.707us         9  3.9670us  1.7300us  10.255us  acc_exit_data@layers.c:53
                    0.00%  30.437us         3  10.145us  7.4460us  11.789us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  23.797us         3  7.9320us  3.5470us  16.227us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  23.695us         3  7.8980us  6.2790us  11.050us  acc_enter_data@layers.c:170
                    0.00%  22.422us         3  7.4740us  4.3640us  9.4220us  acc_wait@layers.c:310
                    0.00%  20.751us         3  6.9170us  6.4940us  7.7210us  acc_enter_data@layers.c:126
                    0.00%  14.782us         3  4.9270us  4.6910us  5.2770us  acc_wait@layers.c:170
                    0.00%  14.425us         3  4.8080us  4.6930us  4.9650us  acc_wait@layers.c:126
                    0.00%  12.236us         3  4.0780us  2.8310us  6.3720us  acc_update@layers.c:310
                    0.00%  11.257us         3  3.7520us  3.5120us  4.1320us  acc_enqueue_upload@layers.c:126 (layer[:1])
                    0.00%  10.928us         3  3.6420us  3.5560us  3.7310us  acc_enqueue_upload@layers.c:310 (l->bias[:l->out_depth])
                    0.00%  10.893us         3  3.6310us  3.5360us  3.8000us  acc_enqueue_upload@layers.c:170 (layer[:1])
                    0.00%  7.9250us         3  2.6410us  1.6050us  4.4980us  acc_exit_data@layers.c:206
                    0.00%  5.9740us         3  1.9910us  1.6860us  2.3970us  acc_exit_data@layers.c:143
                    0.00%  5.8570us         3  1.9520us  1.5600us  2.4490us  acc_wait@main.c:179
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:170
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:126
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:206
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:170
                    0.00%       0ns         9       0ns       0ns       0ns  acc_alloc@main.c:179
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:339
                    0.00%       0ns         9       0ns       0ns       0ns  acc_create@main.c:179
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:143
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:126
                    0.00%       0ns         9       0ns       0ns       0ns  acc_delete@main.c:311
```

# ReLU 
## code
```c
131: void relu_forward(float* restrict X, ReLU_Layer* l, float* restrict Y) {
  #pragma acc parallel loop present(l,X,Y) gang worker vector vector_length(32)
  for (int i = 0; i < l->out_size; i++) {
    Y[i] = (X[i] < 0.0f) ? 0.0f : X[i];
  }
}
```
## Minfo
```
...
make_relu_layer:
    126, Generating enter data copyin(layer[:1])
relu_forward:
    131, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(i)
         Generating NVIDIA GPU code
        133, #pragma acc loop gang, worker(4), vector(32) /* blockIdx.x threadIdx.y threadIdx.x */
free_relu:
    143, Generating exit data delete(l[:1])
...
```

## Execution
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.035670 seconds
Create Network time:0.039480 seconds
Load Network Parameters time:0.008263 seconds
Create Ouputs time:0.000364 seconds

Net Forward total time:10.329776 seconds
    Time for conv1: 2.520450 seconds
    Time for relu1: 0.575796 seconds
    Time for pool1: 0.682345 seconds
    Time for conv2: 2.215865 seconds
    Time for relu2: 0.577275 seconds
    Time for pool2: 0.568757 seconds
    Time for conv3: 1.440829 seconds
    Time for relu3: 0.581835 seconds
    Time for pool3: 0.511723 seconds
    Time for fc: 0.222235 seconds
    Time for softmax: 0.011539 seconds

  Conv: 6.177144 seconds
  ReLU: 1.734906 seconds
  Pool: 1.762825 seconds
  FC:   0.222235 seconds
  Softmax: 0.011539 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001408 seconds
Free memory time:0.044694 seconds
Total time:11.459655 seconds 
```

## NV_ACC

```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:1.160030 seconds
Create Network time:0.039489 seconds
Load Network Parameters time:0.008564 seconds
Create Ouputs time:0.000345 seconds

Net Forward total time:13.651947 seconds
    Time for conv1: 3.055025 seconds
    Time for relu1: 0.810735 seconds
    Time for pool1: 0.915680 seconds
    Time for conv2: 2.679416 seconds
    Time for relu2: 0.806139 seconds
    Time for pool2: 0.811408 seconds
    Time for conv3: 1.914281 seconds
    Time for relu3: 0.804184 seconds
    Time for pool3: 0.761969 seconds
    Time for fc: 0.216294 seconds
    Time for softmax: 0.010440 seconds

  Conv: 7.648722 seconds
  ReLU: 2.421059 seconds
  Pool: 2.489056 seconds
  FC:   0.216294 seconds
  Softmax: 0.010440 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001339 seconds
Free memory time:0.048468 seconds
Total time:14.910181 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 248
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=248 max=28 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 186
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=186 max=32 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [800]  block: [32x4]
            elapsed time(us): total=1,855,322 max=68 min=11 avg=12
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    77: compute region reached 150000 times
        77: kernel launched 150000 times
            grid: [160-512]  block: [32x4]
            elapsed time(us): total=4,745,164 max=497 min=18 avg=31
    77: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_relu_layer  NVIDIA  devicenum=0
    time(us): 10
    126: data region reached 3 times
        126: data copyin transfers: 3
             device time(us): total=10 max=4 min=3 avg=3
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  relu_forward  NVIDIA  devicenum=0
    time(us): 0
    131: compute region reached 150000 times
        131: kernel launched 150000 times
            grid: [1280]  block: [32x4]
            elapsed time(us): total=1,857,312 max=3,600 min=11 avg=12
    131: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_relu  NVIDIA  devicenum=0
    time(us): 0
    143: data region reached 3 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_pool_layer  NVIDIA  devicenum=0
    time(us): 10
    170: data region reached 3 times
        170: data copyin transfers: 3
             device time(us): total=10 max=4 min=3 avg=3
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pool_forward  NVIDIA  devicenum=0
    time(us): 0
    175: compute region reached 150000 times
        175: kernel launched 150000 times
            grid: [80-256]  block: [32x4]
            elapsed time(us): total=1,945,949 max=1,521 min=10 avg=12
    175: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_pool  NVIDIA  devicenum=0
    time(us): 0
    206: data region reached 3 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 54
    310: update directive reached 3 times
        310: data copyin transfers: 6
             device time(us): total=54 max=20 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/main.c
  main  NVIDIA  devicenum=0
    time(us): 561,685
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=54 max=54 min=54 avg=54
        121: data copyin transfers: 1
             device time(us): total=150,649 max=150,649 min=150,649 avg=150,649
    179: data region reached 3 times
    227: update directive reached 50000 times
        227: data copyout transfers: 50000
             device time(us): total=411,036 max=337 min=6 avg=8
    311: data region reached 3 times
    339: data region reached 1 time
```

### nvprof
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2706244== NVPROF is profiling process 2706244, command: ./cnn-cifar10-profile
Load Data time:1.263807 seconds
Create Network time:0.037554 seconds
Load Network Parameters time:0.008076 seconds
Create Ouputs time:0.000353 seconds

Net Forward total time:16.298869 seconds
    Time for conv1: 3.477200 seconds
    Time for relu1: 1.050937 seconds
    Time for pool1: 1.142767 seconds
    Time for conv2: 3.129883 seconds
    Time for relu2: 1.080576 seconds
    Time for pool2: 1.013656 seconds
    Time for conv3: 2.344964 seconds
    Time for relu3: 1.058179 seconds
    Time for pool3: 0.955581 seconds
    Time for fc: 0.221531 seconds
    Time for softmax: 0.015119 seconds

  Conv: 8.952047 seconds
  ReLU: 3.189692 seconds
  Pool: 3.112003 seconds
  FC:   0.221531 seconds
  Softmax: 0.015119 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001941 seconds
Free memory time:0.043726 seconds
Total time:17.654326 seconds
END!
==2706244== Profiling application: ./cnn-cifar10-profile
==2706244== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   65.53%  3.41863s    150000  22.790us  10.304us  32.799us  _8layers_c_conv_forward_77_gpu
                   11.72%  611.62ms    150000  4.0770us  2.5910us  13.408us  _8layers_c_pool_forward_175_gpu
                    9.93%  517.95ms    150000  3.4530us  3.4230us  13.600us  _8layers_c_relu_forward_131_gpu
                    8.82%  459.89ms    150000  3.0650us  3.0070us  13.663us  _8layers_c_pad_input_60_gpu
                    2.81%  146.72ms        37  3.9653ms     639ns  146.68ms  [CUDA memcpy HtoD]
                    1.19%  62.037ms     50000  1.2400us  1.2150us  1.8880us  [CUDA memcpy DtoH]
                    0.00%  2.6240us         1  2.6240us  2.6240us  2.6240us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   65.27%  6.94798s   1250022  5.5580us     733ns  839.16us  cuStreamSynchronize
                   23.95%  2.54946s    600001  4.2490us  3.3270us  4.5452ms  cuLaunchKernel
                    5.10%  542.82ms     50000  10.856us  9.6960us  131.98us  cuMemcpyDtoHAsync
                    1.78%  189.36ms    600000     315ns     178ns  10.530ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    1.38%  147.11ms        37  3.9760ms  2.6620us  146.89ms  cuMemcpyHtoDAsync
                    1.19%  126.23ms         1  126.23ms  126.23ms  126.23ms  cuDevicePrimaryCtxRetain
                    0.78%  82.500ms    600010     137ns     114ns  16.912us  cuDeviceGetAttribute
                    0.35%  36.980ms         1  36.980ms  36.980ms  36.980ms  cuMemHostAlloc
                    0.19%  19.945ms     50029     398ns     237ns  1.0105ms  cuPointerGetAttributes
                    0.01%  1.2926ms         1  1.2926ms  1.2926ms  1.2926ms  cuMemAllocHost
                    0.01%  712.60us         2  356.30us  103.50us  609.10us  cuModuleLoadDataEx
                    0.00%  515.16us        30  17.172us  1.9820us  210.95us  cuMemAlloc
                    0.00%  18.760us         1  18.760us  18.760us  18.760us  cuDeviceGetPCIBusId
                    0.00%  12.825us         6  2.1370us     363ns  8.5000us  cuModuleGetFunction
                    0.00%  3.2150us         3  1.0710us     189ns  1.8250us  cuCtxSetCurrent
                    0.00%  2.3460us         3     782ns     239ns  1.7930us  cuDeviceGetCount
                    0.00%     890ns         3     296ns     131ns     550ns  cuDriverGetVersion
                    0.00%     567ns         2     283ns     138ns     429ns  cuDeviceGet
                    0.00%     542ns         1     542ns     542ns     542ns  cuCtxGetCurrent
                    0.00%     529ns         1     529ns     529ns     529ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.13568s    300000  13.785us  1.5540us  852.18us  acc_wait@layers.c:77
                    0.00%  1.33255s    300000  4.4410us  1.5510us  840.38us  acc_wait@layers.c:175
                    0.00%  1.17789s    300000  3.9260us  1.5680us  820.07us  acc_wait@layers.c:131
                    0.00%  1.12833s    300000  3.7610us  1.4330us  791.94us  acc_wait@layers.c:60
                    0.00%  831.58ms    150000  5.5430us  4.2780us  2.6864ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  806.09ms    150000  5.3730us  4.2730us  4.5542ms  acc_enqueue_launch@layers.c:131 (_8layers_c_relu_forward_131_gpu)
                    0.00%  788.61ms    150000  5.2570us  4.2500us  2.9539ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  787.10ms    150000  5.2470us  4.2890us  920.28us  acc_enqueue_launch@layers.c:175 (_8layers_c_pool_forward_175_gpu)
                    0.00%  582.28ms     50000  11.645us  10.425us  794.95us  acc_enqueue_download@main.c:227 (O9[:L9->out_size])
                    0.00%  446.33ms    150000  2.9750us  2.3520us  11.792ms  acc_compute_construct@layers.c:60
                    0.00%  427.60ms    150000  2.8500us  2.3600us  9.8834ms  acc_compute_construct@layers.c:131
                    0.00%  317.64ms    150000  2.1170us  1.7220us  893.93us  acc_enter_data@layers.c:131
                    0.00%  306.46ms    150000  2.0430us  1.6710us  1.4645ms  acc_enter_data@layers.c:175
                    0.00%  281.22ms    150000  1.8740us  1.5330us  835.01us  acc_exit_data@layers.c:131
                    0.00%  281.02ms    150000  1.8730us  1.6290us  796.83us  acc_enter_data@layers.c:77
                    0.00%  265.15ms    150000  1.7670us  1.3740us  2.1335ms  acc_enter_data@layers.c:60
                    0.00%  257.19ms    150000  1.7140us  1.5430us  789.28us  acc_compute_construct@layers.c:175
                    0.00%  256.08ms    150000  1.7070us  1.5310us  754.03us  acc_compute_construct@layers.c:77
                    0.00%  255.35ms    150000  1.7020us  1.4650us  176.43us  acc_exit_data@layers.c:175
                    0.00%  255.01ms    150000  1.7000us  1.5040us  784.78us  acc_exit_data@layers.c:77
                    0.00%  225.96ms    150000  1.5060us  1.2270us  809.19us  acc_exit_data@layers.c:60
                    0.00%  146.90ms         1  146.90ms  146.90ms  146.90ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  94.039ms     50000  1.8800us  1.4230us  857.21us  acc_update@main.c:227
                    0.00%  92.622ms     50000  1.8520us  1.6370us  113.87us  acc_wait@main.c:227
                    0.00%  37.182ms         9  4.1314ms  6.5330us  37.030ms  acc_enter_data@layers.c:42
                    0.00%  1.1220ms         1  1.1220ms  1.1220ms  1.1220ms  acc_exit_data@main.c:339
                    0.00%  697.86us         1  697.86us  697.86us  697.86us  acc_device_init@main.c:121
                    0.00%  77.451us        18  4.3020us     818ns  25.471us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  75.659us         3  25.219us  17.058us  31.717us  acc_enter_data@main.c:179
                    0.00%  73.437us        18  4.0790us     870ns  29.335us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  69.996us         1  69.996us  69.996us  69.996us  acc_wait@main.c:121
                    0.00%  60.956us         9  6.7720us  4.1990us  10.937us  acc_wait@layers.c:42
                    0.00%  50.117us         3  16.705us  4.2850us  41.333us  acc_exit_data@main.c:311
                    0.00%  47.910us         1  47.910us  47.910us  47.910us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  44.501us         9  4.9440us  1.7700us  18.651us  acc_exit_data@layers.c:53
                    0.00%  40.195us         3  13.398us  7.3630us  18.051us  acc_enqueue_upload@layers.c:310 (l->weights[:l->weights_size])
                    0.00%  37.909us         3  12.636us  7.1020us  19.034us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  24.309us         3  8.1030us  6.4430us  11.336us  acc_enter_data@layers.c:170
                    0.00%  22.915us         3  7.6380us  3.6570us  15.366us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  21.929us         3  7.3090us  5.1690us  8.3970us  acc_wait@layers.c:310
                    0.00%  21.689us         3  7.2290us  6.5440us  8.3140us  acc_enter_data@layers.c:126
                    0.00%  15.007us         3  5.0020us  4.5680us  5.2240us  acc_wait@layers.c:170
                    0.00%  14.428us         3  4.8090us  4.3130us  5.6520us  acc_wait@layers.c:126
                    0.00%  12.848us         3  4.2820us  2.7790us  6.9470us  acc_update@layers.c:310
                    0.00%  11.336us         3  3.7780us  3.4950us  4.1450us  acc_enqueue_upload@layers.c:126 (layer[:1])
                    0.00%  10.918us         3  3.6390us  3.5510us  3.7770us  acc_enqueue_upload@layers.c:170 (layer[:1])
                    0.00%  10.902us         3  3.6340us  3.3750us  3.9810us  acc_enqueue_upload@layers.c:310 (l->bias[:l->out_depth])
                    0.00%  7.4630us         3  2.4870us  1.6460us  3.8730us  acc_exit_data@layers.c:206
                    0.00%  6.0200us         3  2.0060us  1.6780us  2.5040us  acc_exit_data@layers.c:143
                    0.00%  5.9580us         3  1.9860us  1.5230us  2.8680us  acc_wait@main.c:179
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:170
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:126
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:206
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:170
                    0.00%       0ns         9       0ns       0ns       0ns  acc_alloc@main.c:179
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:339
                    0.00%       0ns         9       0ns       0ns       0ns  acc_create@main.c:179
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:143
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:126
                    0.00%       0ns         9       0ns       0ns       0ns  acc_delete@main.c:311
```
## ReLU: #pragma acc parallel loop present(l,X,Y) gang worker vector

### nvprof
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2709523== NVPROF is profiling process 2709523, command: ./cnn-cifar10-profile
Load Data time:1.324596 seconds
Create Network time:0.038822 seconds
Load Network Parameters time:0.008276 seconds
Create Ouputs time:0.000325 seconds

Net Forward total time:17.137536 seconds
    Time for conv1: 3.723543 seconds
    Time for relu1: 1.098921 seconds
    Time for pool1: 1.200115 seconds
    Time for conv2: 3.326587 seconds
    Time for relu2: 1.101236 seconds
    Time for pool2: 1.079737 seconds
    Time for conv3: 2.460087 seconds
    Time for relu3: 1.103468 seconds
    Time for pool3: 0.987971 seconds
    Time for fc: 0.224057 seconds
    Time for softmax: 0.013942 seconds

  Conv: 9.510217 seconds
  ReLU: 3.303625 seconds
  Pool: 3.267823 seconds
  FC:   0.224057 seconds
  Softmax: 0.013942 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001904 seconds
Free memory time:0.049213 seconds
Total time:18.560672 seconds
END!
==2709523== Profiling application: ./cnn-cifar10-profile
==2709523== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   65.63%  3.80883s    150000  25.392us  11.519us  36.800us  _8layers_c_conv_forward_77_gpu
                   11.82%  685.70ms    150000  4.5710us  2.9110us  13.664us  _8layers_c_pool_forward_175_gpu
                   10.00%  580.48ms    150000  3.8690us  3.8070us  13.472us  _8layers_c_relu_forward_131_gpu
                    8.87%  514.83ms    150000  3.4320us  3.3910us  13.440us  _8layers_c_pad_input_60_gpu
                    2.53%  146.86ms        37  3.9692ms     736ns  146.82ms  [CUDA memcpy HtoD]
                    1.15%  66.488ms     50000  1.3290us  1.2800us  1.9840us  [CUDA memcpy DtoH]
                    0.00%  2.6240us         1  2.6240us  2.6240us  2.6240us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   66.65%  7.62365s   1250022  6.0980us     624ns  4.6524ms  cuStreamSynchronize
                   23.08%  2.63934s    600001  4.3980us  3.2120us  15.441ms  cuLaunchKernel
                    4.85%  554.64ms     50000  11.092us  9.8190us  4.2151ms  cuMemcpyDtoHAsync
                    1.51%  172.70ms    600000     287ns     186ns  5.8109ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    1.37%  156.64ms         1  156.64ms  156.64ms  156.64ms  cuDevicePrimaryCtxRetain
                    1.29%  147.24ms        37  3.9795ms  2.7540us  147.02ms  cuMemcpyHtoDAsync
                    0.73%  83.328ms    600010     138ns     119ns  16.831us  cuDeviceGetAttribute
                    0.33%  38.230ms         1  38.230ms  38.230ms  38.230ms  cuMemHostAlloc
                    0.17%  19.389ms     50029     387ns     225ns  990.58us  cuPointerGetAttributes
                    0.01%  1.3564ms         1  1.3564ms  1.3564ms  1.3564ms  cuMemAllocHost
                    0.01%  704.41us         2  352.21us  108.71us  595.70us  cuModuleLoadDataEx
                    0.00%  562.60us        30  18.753us  1.9920us  239.84us  cuMemAlloc
                    0.00%  21.250us         1  21.250us  21.250us  21.250us  cuCtxGetCurrent
                    0.00%  11.746us         1  11.746us  11.746us  11.746us  cuDeviceGetPCIBusId
                    0.00%  5.4610us         6     910ns     363ns  1.9580us  cuModuleGetFunction
                    0.00%  3.1950us         3  1.0650us     198ns  1.8760us  cuCtxSetCurrent
                    0.00%  2.6760us         3     892ns     201ns  2.1400us  cuDeviceGetCount
                    0.00%     966ns         3     322ns     170ns     547ns  cuDriverGetVersion
                    0.00%     925ns         2     462ns     170ns     755ns  cuDeviceGet
                    0.00%     676ns         1     676ns     676ns     676ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.54867s    300000  15.162us  1.5700us  4.6823ms  acc_wait@layers.c:77
                    0.00%  1.43188s    300000  4.7720us  1.5770us  864.46us  acc_wait@layers.c:175
                    0.00%  1.26519s    300000  4.2170us  1.5760us  1.2448ms  acc_wait@layers.c:131
                    0.00%  1.21147s    300000  4.0380us  1.3740us  1.3659ms  acc_wait@layers.c:60
                    0.00%  859.55ms    150000  5.7300us  4.1840us  3.0164ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  834.66ms    150000  5.5640us  4.1850us  15.445ms  acc_enqueue_launch@layers.c:175 (_8layers_c_pool_forward_175_gpu)
                    0.00%  825.22ms    150000  5.5010us  4.2090us  887.26us  acc_enqueue_launch@layers.c:131 (_8layers_c_relu_forward_131_gpu)
                    0.00%  809.35ms    150000  5.3950us  4.1440us  1.5768ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  594.30ms     50000  11.886us  10.537us  4.2168ms  acc_enqueue_download@main.c:227 (O9[:L9->out_size])
                    0.00%  434.95ms    150000  2.8990us  2.4150us  1.9892ms  acc_compute_construct@layers.c:60
                    0.00%  434.24ms    150000  2.8940us  2.3790us  9.7821ms  acc_compute_construct@layers.c:131
                    0.00%  328.20ms    150000  2.1870us  1.7300us  821.90us  acc_enter_data@layers.c:131
                    0.00%  311.22ms    150000  2.0740us  1.6690us  792.26us  acc_enter_data@layers.c:175
                    0.00%  290.27ms    150000  1.9350us  1.6200us  703.94us  acc_enter_data@layers.c:77
                    0.00%  274.66ms    150000  1.8310us  1.5450us  830.13us  acc_exit_data@layers.c:131
                    0.00%  270.04ms    150000  1.8000us  1.3950us  860.31us  acc_enter_data@layers.c:60
                    0.00%  259.91ms    150000  1.7320us  1.5520us  1.9024ms  acc_compute_construct@layers.c:175
                    0.00%  256.82ms    150000  1.7120us  1.5420us  739.59us  acc_compute_construct@layers.c:77
                    0.00%  254.51ms    150000  1.6960us  1.5220us  145.88us  acc_exit_data@layers.c:77
                    0.00%  253.83ms    150000  1.6920us  1.4750us  749.89us  acc_exit_data@layers.c:175
                    0.00%  226.31ms    150000  1.5080us  1.2200us  838.63us  acc_exit_data@layers.c:60
                    0.00%  147.03ms         1  147.03ms  147.03ms  147.03ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  93.651ms     50000  1.8730us  1.4260us  791.34us  acc_update@main.c:227
                    0.00%  92.404ms     50000  1.8480us  1.6370us  110.94us  acc_wait@main.c:227
                    0.00%  38.444ms         9  4.2715ms  7.1630us  38.287ms  acc_enter_data@layers.c:42
                    0.00%  1.1200ms         1  1.1200ms  1.1200ms  1.1200ms  acc_exit_data@main.c:339
                    0.00%  688.58us         1  688.58us  688.58us  688.58us  acc_device_init@main.c:121
                    0.00%  82.743us        18  4.5960us     944ns  26.420us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  73.596us        18  4.0880us     906ns  26.537us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  70.592us         1  70.592us  70.592us  70.592us  acc_wait@main.c:121
                    0.00%  68.535us         3  22.845us  19.077us  30.227us  acc_enter_data@main.c:179
                    0.00%  60.596us         9  6.7320us  4.5720us  9.7300us  acc_wait@layers.c:42
                    0.00%  52.697us         3  17.565us  4.5950us  43.468us  acc_exit_data@main.c:311
                    0.00%  50.848us         1  50.848us  50.848us  50.848us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  40.845us         3  13.615us  7.6250us  18.088us  acc_enqueue_upload@layers.c:310 (l->weights[:l->weights_size])
                    0.00%  40.398us         9  4.4880us  1.8170us  12.889us  acc_exit_data@layers.c:53
                    0.00%  31.514us         3  10.504us  8.0170us  12.231us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  26.054us         3  8.6840us  6.6870us  12.422us  acc_enter_data@layers.c:170
                    0.00%  23.678us         3  7.8920us  3.9410us  11.160us  acc_wait@layers.c:310
                    0.00%  23.398us         3  7.7990us  7.0500us  8.7360us  acc_enter_data@layers.c:126
                    0.00%  22.743us         3  7.5810us  3.9450us  14.840us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  14.649us         3  4.8830us  4.7460us  5.1300us  acc_wait@layers.c:126
                    0.00%  14.240us         3  4.7460us  4.7150us  4.7810us  acc_wait@layers.c:170
                    0.00%  13.542us         3  4.5140us  2.9880us  7.3490us  acc_update@layers.c:310
                    0.00%  12.230us         3  4.0760us  3.7990us  4.5220us  acc_enqueue_upload@layers.c:126 (layer[:1])
                    0.00%  11.423us         3  3.8070us  3.6930us  4.0190us  acc_enqueue_upload@layers.c:170 (layer[:1])
                    0.00%  11.003us         3  3.6670us  3.6190us  3.7410us  acc_enqueue_upload@layers.c:310 (l->bias[:l->out_depth])
                    0.00%  9.0710us         3  3.0230us  1.7620us  5.2860us  acc_exit_data@layers.c:206
                    0.00%  6.0520us         3  2.0170us  1.7200us  2.4150us  acc_exit_data@layers.c:143
                    0.00%  5.7250us         3  1.9080us  1.4790us  2.7120us  acc_wait@main.c:179
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:170
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:126
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:206
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:170
                    0.00%       0ns         9       0ns       0ns       0ns  acc_alloc@main.c:179
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:339
                    0.00%       0ns         9       0ns       0ns       0ns  acc_create@main.c:179
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:143
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:126
                    0.00%       0ns         9       0ns       0ns       0ns  acc_delete@main.c:311
```

## ReLU: #pragma acc parallel loop present(l,X,Y) gang vector
### nvprof
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2719867== NVPROF is profiling process 2719867, command: ./cnn-cifar10-profile
Load Data time:1.311087 seconds
Create Network time:0.037798 seconds
Load Network Parameters time:0.007796 seconds
Create Ouputs time:0.000352 seconds

Net Forward total time:16.950026 seconds
    Time for conv1: 3.709608 seconds
    Time for relu1: 1.071447 seconds
    Time for pool1: 1.178128 seconds
    Time for conv2: 3.305522 seconds
    Time for relu2: 1.089033 seconds
    Time for pool2: 1.049111 seconds
    Time for conv3: 2.425693 seconds
    Time for relu3: 1.084465 seconds
    Time for pool3: 0.968275 seconds
    Time for fc: 0.224747 seconds
    Time for softmax: 0.015222 seconds

  Conv: 9.440824 seconds
  ReLU: 3.244944 seconds
  Pool: 3.195514 seconds
  FC:   0.224747 seconds
  Softmax: 0.015222 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001715 seconds
Free memory time:0.052431 seconds
Total time:18.361206 seconds
END!
==2719867== Profiling application: ./cnn-cifar10-profile
==2719867== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   65.66%  3.80913s    150000  25.394us  11.488us  36.928us  _8layers_c_conv_forward_77_gpu
                   11.82%  685.54ms    150000  4.5700us  2.9110us  13.312us  _8layers_c_pool_forward_175_gpu
                    9.95%  577.30ms    150000  3.8480us  3.8070us  12.992us  _8layers_c_relu_forward_131_gpu
                    8.87%  514.77ms    150000  3.4310us  3.3910us  13.280us  _8layers_c_pad_input_60_gpu
                    2.55%  147.99ms        37  3.9998ms     736ns  147.95ms  [CUDA memcpy HtoD]
                    1.14%  66.418ms     50000  1.3280us  1.3110us  1.8560us  [CUDA memcpy DtoH]
                    0.00%  2.8480us         1  2.8480us  2.8480us  2.8480us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   66.80%  7.56354s   1250022  6.0500us     771ns  4.5347ms  cuStreamSynchronize
                   22.70%  2.56981s    600001  4.2830us  3.2140us  13.946ms  cuLaunchKernel
                    4.97%  562.69ms     50000  11.253us  9.7950us  9.1835ms  cuMemcpyDtoHAsync
                    1.52%  172.10ms    600000     286ns     180ns  3.9008ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    1.37%  155.18ms         1  155.18ms  155.18ms  155.18ms  cuDevicePrimaryCtxRetain
                    1.31%  148.39ms        37  4.0106ms  2.5250us  148.16ms  cuMemcpyHtoDAsync
                    0.76%  86.101ms    600010     143ns     118ns  16.983us  cuDeviceGetAttribute
                    0.33%  37.241ms         1  37.241ms  37.241ms  37.241ms  cuMemHostAlloc
                    0.18%  20.421ms     50028     408ns     234ns  789.97us  cuPointerGetAttributes
                    0.04%  4.8404ms        30  161.35us  1.9280us  4.4313ms  cuMemAlloc
                    0.01%  1.3003ms         1  1.3003ms  1.3003ms  1.3003ms  cuMemAllocHost
                    0.01%  722.87us         2  361.44us  123.92us  598.95us  cuModuleLoadDataEx
                    0.00%  10.359us         1  10.359us  10.359us  10.359us  cuDeviceGetPCIBusId
                    0.00%  8.0200us         1  8.0200us  8.0200us  8.0200us  cuCtxGetCurrent
                    0.00%  5.6530us         6     942ns     337ns  2.0110us  cuModuleGetFunction
                    0.00%  2.9980us         3     999ns     180ns  1.9490us  cuCtxSetCurrent
                    0.00%  1.8360us         3     612ns     123ns  1.5230us  cuDeviceGetCount
                    0.00%     793ns         3     264ns     122ns     483ns  cuDriverGetVersion
                    0.00%     737ns         1     737ns     737ns     737ns  cuDeviceComputeCapability
                    0.00%     596ns         2     298ns     135ns     461ns  cuDeviceGet
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.54444s    300000  15.148us  1.5480us  4.5357ms  acc_wait@layers.c:77
                    0.00%  1.41200s    300000  4.7060us  1.5480us  1.0166ms  acc_wait@layers.c:175
                    0.00%  1.23605s    300000  4.1200us  1.5550us  747.14us  acc_wait@layers.c:131
                    0.00%  1.19524s    300000  3.9840us  1.5640us  819.19us  acc_wait@layers.c:60
                    0.00%  842.85ms    150000  5.6180us  4.2080us  6.2595ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  810.50ms    150000  5.4030us  4.2670us  821.92us  acc_enqueue_launch@layers.c:131 (_8layers_c_relu_forward_131_gpu)
                    0.00%  790.72ms    150000  5.2710us  4.1430us  13.950ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  786.83ms    150000  5.2450us  4.2140us  2.4982ms  acc_enqueue_launch@layers.c:175 (_8layers_c_pool_forward_175_gpu)
                    0.00%  601.41ms     50000  12.028us  10.522us  9.1861ms  acc_enqueue_download@main.c:227 (O9[:L9->out_size])
                    0.00%  434.46ms    150000  2.8960us  2.3790us  3.7863ms  acc_compute_construct@layers.c:60
                    0.00%  434.27ms    150000  2.8950us  2.3930us  3.9080ms  acc_compute_construct@layers.c:131
                    0.00%  315.06ms    150000  2.1000us  1.7000us  849.87us  acc_enter_data@layers.c:131
                    0.00%  302.91ms    150000  2.0190us  1.6610us  3.7999ms  acc_enter_data@layers.c:175
                    0.00%  280.01ms    150000  1.8660us  1.6100us  751.94us  acc_enter_data@layers.c:77
                    0.00%  274.16ms    150000  1.8270us  1.5110us  874.92us  acc_exit_data@layers.c:131
                    0.00%  265.58ms    150000  1.7700us  1.5750us  745.00us  acc_compute_construct@layers.c:175
                    0.00%  264.06ms    150000  1.7600us  1.5630us  751.35us  acc_compute_construct@layers.c:77
                    0.00%  263.01ms    150000  1.7530us  1.3810us  827.23us  acc_enter_data@layers.c:60
                    0.00%  256.95ms    150000  1.7130us  1.5020us  122.71us  acc_exit_data@layers.c:77
                    0.00%  254.06ms    150000  1.6930us  1.4450us  701.19us  acc_exit_data@layers.c:175
                    0.00%  231.37ms    150000  1.5420us  1.2300us  811.55us  acc_exit_data@layers.c:60
                    0.00%  148.17ms         1  148.17ms  148.17ms  148.17ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  96.110ms     50000  1.9220us  1.4490us  768.73us  acc_update@main.c:227
                    0.00%  92.638ms     50000  1.8520us  1.6360us  186.06us  acc_wait@main.c:227
                    0.00%  37.412ms         9  4.1569ms  6.6400us  37.308ms  acc_enter_data@layers.c:42
                    0.00%  2.3801ms         1  2.3801ms  2.3801ms  2.3801ms  acc_exit_data@main.c:339
                    0.00%  709.59us         1  709.59us  709.59us  709.59us  acc_device_init@main.c:121
                    0.00%  112.20us        18  6.2330us  2.0990us  30.098us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  88.815us        18  4.9340us     822ns  34.898us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  70.736us         3  23.578us  20.161us  29.960us  acc_enter_data@main.c:179
                    0.00%  64.521us         9  7.1690us  3.7270us  14.096us  acc_exit_data@layers.c:53
                    0.00%  63.992us         1  63.992us  63.992us  63.992us  acc_wait@main.c:121
                    0.00%  58.101us         9  6.4550us  4.5450us  9.2480us  acc_wait@layers.c:42
                    0.00%  52.219us         1  52.219us  52.219us  52.219us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  45.840us         3  15.280us  8.3570us  29.074us  acc_exit_data@main.c:311
                    0.00%  37.999us         3  12.666us  7.4330us  16.913us  acc_enqueue_upload@layers.c:310 (l->weights[:l->weights_size])
                    0.00%  30.194us         3  10.064us  7.1950us  11.774us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  24.433us         3  8.1440us  3.7300us  16.848us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  23.533us         3  7.8440us  4.3890us  10.448us  acc_wait@layers.c:310
                    0.00%  23.282us         3  7.7600us  6.0410us  10.819us  acc_enter_data@layers.c:170
                    0.00%  20.983us         3  6.9940us  6.3800us  7.8160us  acc_enter_data@layers.c:126
                    0.00%  16.086us         3  5.3620us  3.8050us  8.2230us  acc_exit_data@layers.c:206
                    0.00%  14.430us         3  4.8100us  4.7730us  4.8630us  acc_wait@layers.c:126
                    0.00%  14.395us         3  4.7980us  4.7750us  4.8410us  acc_wait@layers.c:170
                    0.00%  12.653us         3  4.2170us  2.7490us  7.1340us  acc_update@layers.c:310
                    0.00%  12.222us         3  4.0740us  3.6960us  4.6640us  acc_exit_data@layers.c:143
                    0.00%  11.340us         3  3.7800us  3.5010us  4.1270us  acc_enqueue_upload@layers.c:126 (layer[:1])
                    0.00%  10.749us         3  3.5830us  3.2490us  3.8540us  acc_enqueue_upload@layers.c:310 (l->bias[:l->out_depth])
                    0.00%  10.546us         3  3.5150us  3.4730us  3.5750us  acc_enqueue_upload@layers.c:170 (layer[:1])
                    0.00%  5.6670us         3  1.8890us  1.5840us  2.4830us  acc_wait@main.c:179
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:170
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:126
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:206
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:170
                    0.00%       0ns         9       0ns       0ns       0ns  acc_alloc@main.c:179
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:339
                    0.00%       0ns         9       0ns       0ns       0ns  acc_create@main.c:179
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:143
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:126
                    0.00%       0ns         9       0ns       0ns       0ns  acc_delete@main.c:311
```
## ReLU: gang worker vector(32)
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.974305 seconds
Create Network time:0.037718 seconds
Load Network Parameters time:0.007704 seconds
Create Ouputs time:0.000302 seconds

Net Forward total time:10.484352 seconds
    Time for conv1: 2.547694 seconds
    Time for relu1: 0.588705 seconds
    Time for pool1: 0.691739 seconds
    Time for conv2: 2.230573 seconds
    Time for relu2: 0.590462 seconds
    Time for pool2: 0.583471 seconds
    Time for conv3: 1.456762 seconds
    Time for relu3: 0.594181 seconds
    Time for pool3: 0.528822 seconds
    Time for fc: 0.216575 seconds
    Time for softmax: 0.010900 seconds

  Conv: 6.235028 seconds
  ReLU: 1.773348 seconds
  Pool: 1.804031 seconds
  FC:   0.216575 seconds
  Softmax: 0.010900 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001403 seconds
Free memory time:0.047460 seconds
Total time:11.553245 seconds
```
# BEST
## code
```c
131:void relu_forward(float* restrict X, ReLU_Layer* l, float* restrict Y) {
  #pragma acc parallel loop present(l,X,Y) gang worker vector vector_length(32)
  for (int i = 0; i < l->out_size; i++) {
...

175: void pool_forward(float* restrict X, Pool_Layer* l, float* restrict Y) {
  // For each output feature map
  #pragma acc parallel loop present(X,l,Y) collapse(2) gang vector_length(32) 
  for (int m = 0; m < l->out_depth; m++) {
    for (int j = 0; j < l->out_height; j++) {
      #pragma acc loop independent worker
      for (int i = 0; i < l->out_width; i++) {
        int y_idx = i + l->out_width * (j + m * l->out_height); // Output index
        // Find Max in pooling filter
        float max = -INFINITY;
        #pragma acc loop reduction(max:max) vector 
        for (int p_j = 0; p_j < l->pool_width; p_j++) {
          for (int p_i = 0; p_i < l->pool_width; p_i++) {
            ...
```
## Minfo
```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(l[:],X[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         62, #pragma acc loop gang, worker(4), vector(32) collapse(3) blockIdx.x threadIdx.y threadIdx.x */
         63,   /* blockIdx.x threadIdx.y threadIdx.x collapsed */
         64,   /* blockIdx.x threadIdx.y threadIdx.x collapsed */
conv_forward:
     77, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         80, #pragma acc loop gang collapse(2) /* blockIdx.x */
         81,   /* blockIdx.x collapsed */
         83, #pragma acc loop worker(4) /* threadIdx.y */
         88, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         89, #pragma acc loop seq
         90, #pragma acc loop seq
         97, Vector barrier inserted for vector loop reduction
     83, Loop is parallelizable
     88, Loop is parallelizable
     89, Loop is parallelizable
     90, Loop is parallelizable
     95, FMA (fused multiply-add) instruction(s) generated
make_relu_layer:
    126, Generating enter data copyin(layer[:1])
relu_forward:
    131, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(i)
         Generating NVIDIA GPU code
        133, #pragma acc loop gang, worker(4), vector(32) /* blockIdx.x threadIdx.y threadIdx.x */
free_relu:
    143, Generating exit data delete(l[:1])
make_pool_layer:
    170, Generating enter data copyin(layer[:1])
pool_forward:
    175, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
        178, #pragma acc loop gang collapse(2) /* blockIdx.x */
        179,   /* blockIdx.x collapsed */
        181, #pragma acc loop worker(4) /* threadIdx.y */
        186, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(max:max)
        187, #pragma acc loop seq
        194, Vector barrier inserted for vector loop reduction
    181, Loop is parallelizable
    186, Loop is parallelizable
    187, Loop is parallelizable
free_pool:
    206, Generating exit data delete(l[:1])
fc_forward:
    248, FMA (fused multiply-add) instruction(s) generated
load_conv:
    310, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```

## execution
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.031568 seconds
Create Network time:0.040703 seconds
Load Network Parameters time:0.008394 seconds
Create Ouputs time:0.000351 seconds

Net Forward total time:10.212985 seconds
    Time for conv1: 2.505377 seconds
    Time for relu1: 0.571288 seconds
    Time for pool1: 0.670539 seconds
    Time for conv2: 2.195129 seconds
    Time for relu2: 0.564954 seconds
    Time for pool2: 0.565167 seconds
    Time for conv3: 1.419742 seconds
    Time for relu3: 0.568087 seconds
    Time for pool3: 0.507155 seconds
    Time for fc: 0.219980 seconds
    Time for softmax: 0.010404 seconds

  Conv: 6.120248 seconds
  ReLU: 1.704329 seconds
  Pool: 1.742861 seconds
  FC:   0.219980 seconds
  Softmax: 0.010404 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001397 seconds
Free memory time:0.039770 seconds
Total time:11.335169 seconds
END!
```

## Profiling
### nvprof
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2745633== NVPROF is profiling process 2745633, command: ./cnn-cifar10-profile
Load Data time:1.300152 seconds
Create Network time:0.038771 seconds
Load Network Parameters time:0.008970 seconds
Create Ouputs time:0.000354 seconds

Net Forward total time:17.228804 seconds
    Time for conv1: 3.730436 seconds
    Time for relu1: 1.097345 seconds
    Time for pool1: 1.195481 seconds
    Time for conv2: 3.345286 seconds
    Time for relu2: 1.126235 seconds
    Time for pool2: 1.063793 seconds
    Time for conv3: 2.475194 seconds
    Time for relu3: 1.123181 seconds
    Time for pool3: 0.992525 seconds
    Time for fc: 0.226309 seconds
    Time for softmax: 0.013126 seconds

  Conv: 9.550916 seconds
  ReLU: 3.346762 seconds
  Pool: 3.251799 seconds
  FC:   0.226309 seconds
  Softmax: 0.013126 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001327 seconds
Free memory time:0.043546 seconds
Total time:18.621924 seconds
END!
==2745633== Profiling application: ./cnn-cifar10-profile
==2745633== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   65.72%  3.81138s    150000  25.409us  11.519us  36.672us  _8layers_c_conv_forward_77_gpu
                   11.83%  685.90ms    150000  4.5720us  2.9110us  13.632us  _8layers_c_pool_forward_175_gpu
                   10.01%  580.71ms    150000  3.8710us  3.8070us  14.048us  _8layers_c_relu_forward_131_gpu
                    8.88%  515.07ms    150000  3.4330us  3.3910us  14.144us  _8layers_c_pad_input_60_gpu
                    2.41%  139.73ms        37  3.7765ms     736ns  139.69ms  [CUDA memcpy HtoD]
                    1.15%  66.871ms     50000  1.3370us     928ns  2.0480us  [CUDA memcpy DtoH]
                    0.00%  2.6240us         1  2.6240us  2.6240us  2.6240us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   68.19%  7.77832s   1250022  6.2220us     670ns  1.9268ms  cuStreamSynchronize
                   21.30%  2.42901s    600001  4.0480us  3.2450us  3.0803ms  cuLaunchKernel
                    4.92%  561.55ms     50000  11.231us  9.9980us  1.2234ms  cuMemcpyDtoHAsync
                    1.56%  178.11ms    600000     296ns     178ns  5.1613ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    1.46%  166.18ms         1  166.18ms  166.18ms  166.18ms  cuDevicePrimaryCtxRetain
                    1.23%  140.10ms        37  3.7864ms  2.7060us  139.88ms  cuMemcpyHtoDAsync
                    0.75%  85.177ms    600010     141ns     114ns  41.140us  cuDeviceGetAttribute
                    0.33%  38.205ms         1  38.205ms  38.205ms  38.205ms  cuMemHostAlloc
                    0.18%  20.185ms     50030     403ns     237ns  771.39us  cuPointerGetAttributes
                    0.05%  5.7580ms         1  5.7580ms  5.7580ms  5.7580ms  cuMemAllocHost
                    0.03%  3.0473ms        30  101.58us  1.9600us  2.7901ms  cuMemAlloc
                    0.01%  699.68us         2  349.84us  120.42us  579.26us  cuModuleLoadDataEx
                    0.00%  25.139us         1  25.139us  25.139us  25.139us  cuCtxGetCurrent
                    0.00%  17.450us         1  17.450us  17.450us  17.450us  cuDeviceGetPCIBusId
                    0.00%  4.7010us         6     783ns     319ns  1.7350us  cuModuleGetFunction
                    0.00%  3.0060us         3  1.0020us     228ns  1.8410us  cuCtxSetCurrent
                    0.00%  1.5390us         3     513ns     133ns  1.2480us  cuDeviceGetCount
                    0.00%     773ns         3     257ns     111ns     485ns  cuDriverGetVersion
                    0.00%     587ns         2     293ns     116ns     471ns  cuDeviceGet
                    0.00%     548ns         1     548ns     548ns     548ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.59466s    300000  15.315us  1.6300us  1.9346ms  acc_wait@layers.c:77
                    0.00%  1.46708s    300000  4.8900us  1.6320us  935.51us  acc_wait@layers.c:175
                    0.00%  1.30401s    300000  4.3460us  1.6400us  957.48us  acc_wait@layers.c:131
                    0.00%  1.25428s    300000  4.1800us  1.3910us  807.28us  acc_wait@layers.c:60
                    0.00%  815.29ms    150000  5.4350us  4.2400us  3.0830ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  795.14ms    150000  5.3000us  4.2300us  1.4787ms  acc_enqueue_launch@layers.c:131 (_8layers_c_relu_forward_131_gpu)
                    0.00%  761.59ms    150000  5.0770us  4.1610us  1.1588ms  acc_enqueue_launch@layers.c:175 (_8layers_c_pool_forward_175_gpu)
                    0.00%  761.25ms    150000  5.0740us  4.1610us  2.8906ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  601.65ms     50000  12.032us  10.700us  1.2317ms  acc_enqueue_download@main.c:227 (O9[:L9->out_size])
                    0.00%  450.77ms    150000  3.0050us  2.3720us  9.9992ms  acc_compute_construct@layers.c:131
                    0.00%  445.57ms    150000  2.9700us  2.3730us  2.8230ms  acc_compute_construct@layers.c:60
                    0.00%  332.01ms    150000  2.2130us  1.7540us  1.4866ms  acc_enter_data@layers.c:131
                    0.00%  311.68ms    150000  2.0770us  1.6920us  798.68us  acc_enter_data@layers.c:175
                    0.00%  291.54ms    150000  1.9430us  1.6490us  36.998us  acc_enter_data@layers.c:77
                    0.00%  281.80ms    150000  1.8780us  1.5420us  841.46us  acc_exit_data@layers.c:131
                    0.00%  275.30ms    150000  1.8350us  1.5610us  2.5719ms  acc_compute_construct@layers.c:77
                    0.00%  271.33ms    150000  1.8080us  1.3880us  837.68us  acc_enter_data@layers.c:60
                    0.00%  269.82ms    150000  1.7980us  1.5540us  1.5212ms  acc_compute_construct@layers.c:175
                    0.00%  259.45ms    150000  1.7290us  1.4610us  20.648us  acc_exit_data@layers.c:175
                    0.00%  256.18ms    150000  1.7070us  1.4540us  22.743us  acc_exit_data@layers.c:77
                    0.00%  239.70ms    150000  1.5970us  1.2250us  3.1381ms  acc_exit_data@layers.c:60
                    0.00%  139.88ms         1  139.88ms  139.88ms  139.88ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  101.12ms     50000  2.0220us  1.7220us  755.53us  acc_wait@main.c:227
                    0.00%  97.966ms     50000  1.9590us  1.4340us  796.48us  acc_update@main.c:227
                    0.00%  38.388ms         9  4.2654ms  7.5150us  38.258ms  acc_enter_data@layers.c:42
                    0.00%  1.0070ms         1  1.0070ms  1.0070ms  1.0070ms  acc_exit_data@main.c:339
                    0.00%  669.28us         1  669.28us  669.28us  669.28us  acc_device_init@main.c:121
                    0.00%  610.58us         4  152.65us  4.0420us  573.99us  acc_exit_data@main.c:311
                    0.00%  94.475us        18  5.2480us     869ns  30.919us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  83.435us         3  27.811us  16.780us  45.741us  acc_enter_data@main.c:179
                    0.00%  68.407us        18  3.8000us     916ns  23.712us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  65.551us         1  65.551us  65.551us  65.551us  acc_wait@main.c:121
                    0.00%  55.354us         9  6.1500us  4.4950us  9.4380us  acc_wait@layers.c:42
                    0.00%  49.103us         1  49.103us  49.103us  49.103us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  41.433us         3  13.811us  8.1240us  18.241us  acc_enqueue_upload@layers.c:310 (l->weights[:l->weights_size])
                    0.00%  40.987us         9  4.5540us  1.7840us  13.461us  acc_exit_data@layers.c:53
                    0.00%  30.598us         3  10.199us  7.6420us  11.812us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  24.470us         3  8.1560us  7.1810us  9.8590us  acc_enter_data@layers.c:170
                    0.00%  22.236us         3  7.4120us  4.0770us  9.6390us  acc_wait@layers.c:310
                    0.00%  21.563us         3  7.1870us  3.9010us  13.337us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  21.489us         3  7.1630us  6.8080us  7.8150us  acc_enter_data@layers.c:126
                    0.00%  14.527us         3  4.8420us  4.7930us  4.9330us  acc_wait@layers.c:170
                    0.00%  14.268us         3  4.7560us  3.1160us  7.7400us  acc_update@layers.c:310
                    0.00%  14.254us         3  4.7510us  4.6860us  4.8320us  acc_wait@layers.c:126
                    0.00%  11.971us         3  3.9900us  3.8020us  4.1960us  acc_enqueue_upload@layers.c:170 (layer[:1])
                    0.00%  11.762us         3  3.9200us  3.7880us  4.1690us  acc_enqueue_upload@layers.c:126 (layer[:1])
                    0.00%  11.125us         3  3.7080us  3.4440us  3.9660us  acc_enqueue_upload@layers.c:310 (l->bias[:l->out_depth])
                    0.00%  10.002us         3  3.3340us  1.5150us  6.7520us  acc_wait@main.c:179
                    0.00%  8.5860us         3  2.8620us  1.6520us  5.1250us  acc_exit_data@layers.c:206
                    0.00%  7.0590us         3  2.3530us  1.8000us  3.2490us  acc_exit_data@layers.c:143
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:170
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:126
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:206
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:170
                    0.00%       0ns         9       0ns       0ns       0ns  acc_alloc@main.c:179
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:339
                    0.00%       0ns         9       0ns       0ns       0ns  acc_create@main.c:179
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:143
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:126
                    0.00%       0ns         9       0ns       0ns       0ns  acc_delete@main.c:311
```

### NV_ACC

```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:1.182070 seconds
Create Network time:0.038699 seconds
Load Network Parameters time:0.008053 seconds
Create Ouputs time:0.000356 seconds

Net Forward total time:13.627831 seconds
    Time for conv1: 3.046852 seconds
    Time for relu1: 0.814165 seconds
    Time for pool1: 0.917814 seconds
    Time for conv2: 2.676006 seconds
    Time for relu2: 0.805791 seconds
    Time for pool2: 0.805456 seconds
    Time for conv3: 1.913594 seconds
    Time for relu3: 0.806790 seconds
    Time for pool3: 0.759190 seconds
    Time for fc: 0.214598 seconds
    Time for softmax: 0.011323 seconds

  Conv: 7.636452 seconds
  ReLU: 2.426746 seconds
  Pool: 2.482460 seconds
  FC:   0.214598 seconds
  Softmax: 0.011323 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001333 seconds
Free memory time:0.043579 seconds
Total time:14.901921 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 225
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=225 max=27 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 177
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=177 max=27 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [800]  block: [32x4]
            elapsed time(us): total=1,853,368 max=1,328 min=11 avg=12
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    77: compute region reached 150000 times
        77: kernel launched 150000 times
            grid: [160-512]  block: [32x4]
            elapsed time(us): total=4,743,768 max=3,674 min=18 avg=31
    77: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_relu_layer  NVIDIA  devicenum=0
    time(us): 10
    126: data region reached 3 times
        126: data copyin transfers: 3
             device time(us): total=10 max=4 min=3 avg=3
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  relu_forward  NVIDIA  devicenum=0
    time(us): 0
    131: compute region reached 150000 times
        131: kernel launched 150000 times
            grid: [1280]  block: [32x4]
            elapsed time(us): total=1,856,124 max=54 min=11 avg=12
    131: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_relu  NVIDIA  devicenum=0
    time(us): 0
    143: data region reached 3 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_pool_layer  NVIDIA  devicenum=0
    time(us): 10
    170: data region reached 3 times
        170: data copyin transfers: 3
             device time(us): total=10 max=4 min=3 avg=3
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pool_forward  NVIDIA  devicenum=0
    time(us): 0
    175: compute region reached 150000 times
        175: kernel launched 150000 times
            grid: [80-256]  block: [32x4]
            elapsed time(us): total=1,944,894 max=49 min=11 avg=12
    175: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_pool  NVIDIA  devicenum=0
    time(us): 0
    206: data region reached 3 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 54
    310: update directive reached 3 times
        310: data copyin transfers: 6
             device time(us): total=54 max=21 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/main.c
  main  NVIDIA  devicenum=0
    time(us): 547,702
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=43 max=43 min=43 avg=43
        121: data copyin transfers: 1
             device time(us): total=144,467 max=144,467 min=144,467 avg=144,467
    179: data region reached 3 times
    227: update directive reached 50000 times
        227: data copyout transfers: 50000
             device time(us): total=403,235 max=396 min=6 avg=8
    311: data region reached 4 times
    339: data region reached 1 time
```
