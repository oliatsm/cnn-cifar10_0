# Conv Parallel - Data on Device


## Parallel Construct - Managed Memory
`-gpu=managed`

### Code
```c
first line: 50
void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
    // For each output feature map
  #pragma acc parallel loop 
    for (int m = 0; m < l->out_depth; m++) {
      #pragma acc loop independent
      for (int j = 0; j < l->out_height; j++) {
        #pragma acc loop independent
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); // Output index
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
          #pragma acc loop reduction(+:sum) //collapse(3) vector
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
                int f_idx = f_i + (f_j * l->filter_width) + (c + m * l->in_depth) * (l->filter_width * l->filter_width); // Filter Index
                int x_j = -l->padding + j * l->stride + f_j; // Input height index, increased by stride
                int x_i = -l->padding + i * l->stride + f_i; // Input width index, increased by stride
                // If in range of image, else zero
                if (x_j >= 0 && x_i >= 0 && x_j < l->in_height && x_i < l->in_width) {
                  int x_idx = c * l->in_height * l->in_width + x_j * l->in_width + x_i; // Input index
                  sum += l->weights[f_idx] * X[x_idx];
                } // if
              } // for f_i
            } // for f_j
          } // for c
          sum += l->bias[m]; // Add bias
          Y[y_idx] = sum; // Save output result
        } // for i
      } // for j
    } // for m
}
```

### Minfo

```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -gpu=managed -c main.c -o main.o
arr2txt:
    333, Zero trip check eliminated
arr2txt_2:
    355, Zero trip check eliminated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -gpu=managed -c layers.c -o layers.o
conv_forward:
     50, Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         53, #pragma acc loop gang /* blockIdx.x */
         55, #pragma acc loop seq
         57, #pragma acc loop seq
         62, #pragma acc loop seq
         63, #pragma acc loop seq
         64, #pragma acc loop vector(128) /* threadIdx.x */
             Generating reduction(+:sum)
     50, Generating implicit copyin(l) [if not already present]
         Generating implicit copy(Y[:]) [if not already present]
         Generating implicit copyin(X[:]) [if not already present]
     55, Loop is parallelizable
     57, Loop is parallelizable
     62, Loop is parallelizable
     63, Loop is parallelizable
     64, Loop is parallelizable
     71, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    155, Zero trip check eliminated
fc_forward:
    210, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -gpu=managed -c malloc2D.c -o malloc2D.o
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -gpu=managed -c timer.c -o timer.o
cpu_timer_stop:
     11, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -gpu=managed -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```

### Εκτέλεση

```
$ ./cnn-cifar10 
Parallel (if) Code
CNN for 1200 images
Loading input batch 1...
Load Data time:0.012663 seconds
Create Network time:0.000084 seconds
Load Network Parameters time:0.007823 seconds
Create Ouputs time:0.000048 seconds

Net Forward total time:7.530944 seconds
    Time for conv1: 3.149435 seconds
    Time for relu1: 0.172451 seconds
    Time for pool1: 0.057182 seconds
    Time for conv2: 2.803019 seconds
    Time for relu2: 0.073069 seconds
    Time for pool2: 0.015800 seconds
    Time for conv3: 1.094539 seconds
    Time for relu3: 0.070087 seconds
    Time for pool3: 0.024194 seconds
    Time for fc: 0.070241 seconds
    Time for softmax: 0.000529 seconds

  Conv: 7.046993 seconds
  ReLU: 0.315607 seconds
  Pool: 0.097175 seconds
  FC:   0.070241 seconds
  Softmax: 0.000529 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000022 seconds
Free memory time:0.000086 seconds
Total time:7.551671 seconds
```

### Profiling

#### export NV_ACC_TIME=1
```
$ ./cnn-cifar10 
Parallel (if) Code
CNN for 1200 images
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Loading input batch 1...
Load Data time:0.023605 seconds
Create Network time:0.000056 seconds
Load Network Parameters time:0.008564 seconds
Create Ouputs time:0.000050 seconds

Net Forward total time:7.502775 seconds
    Time for conv1: 3.137234 seconds
    Time for relu1: 0.171552 seconds
    Time for pool1: 0.057982 seconds
    Time for conv2: 2.788937 seconds
    Time for relu2: 0.073413 seconds
    Time for pool2: 0.015685 seconds
    Time for conv3: 1.092459 seconds
    Time for relu3: 0.070440 seconds
    Time for pool3: 0.024006 seconds
    Time for fc: 0.070141 seconds
    Time for softmax: 0.000537 seconds

  Conv: 7.018629 seconds
  ReLU: 0.315405 seconds
  Pool: 0.097672 seconds
  FC:   0.070141 seconds
  Softmax: 0.000537 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000027 seconds
Free memory time:0.000091 seconds
Total time:7.535168 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-1.2-data-on-device/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    50: compute region reached 3600 times
        50: kernel launched 3600 times
            grid: [560]  block: [128]
            elapsed time(us): total=7,002,711 max=3,477 min=700 avg=1,945
    50: data region reached 7200 times
```

#### NVPROF

```
$ nvprof ./cnn-cifar10-profile 
Parallel (if) Code
CNN for 1200 images
==2148690== NVPROF is profiling process 2148690, command: ./cnn-cifar10-profile
Loading input batch 1...
Load Data time:0.021723 seconds
Create Network time:0.000082 seconds
Load Network Parameters time:0.008465 seconds
Create Ouputs time:0.000071 seconds

Net Forward total time:8.255983 seconds
    Time for conv1: 3.258019 seconds
    Time for relu1: 0.373632 seconds
    Time for pool1: 0.051262 seconds
    Time for conv2: 2.892388 seconds
    Time for relu2: 0.157929 seconds
    Time for pool2: 0.012958 seconds
    Time for conv3: 1.142865 seconds
    Time for relu3: 0.146272 seconds
    Time for pool3: 0.054568 seconds
    Time for fc: 0.164787 seconds
    Time for softmax: 0.000706 seconds

  Conv: 7.293272 seconds
  ReLU: 0.677832 seconds
  Pool: 0.118788 seconds
  FC:   0.164787 seconds
  Softmax: 0.000706 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000030 seconds
Free memory time:0.000081 seconds
Total time:8.286436 seconds
END!
==2148690== Profiling application: ./cnn-cifar10-profile
==2148690== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:  100.00%  7.19461s      3600  1.9985ms  704.86us  3.3043ms  _8layers_c_conv_forward_50_gpu
      API calls:   96.87%  7.21054s      7200  1.0015ms  1.2880us  3.3064ms  cuStreamSynchronize
                    2.27%  168.88ms         1  168.88ms  168.88ms  168.88ms  cuDevicePrimaryCtxRetain
                    0.30%  22.193ms      3600  6.1640us  4.8380us  813.27us  cuLaunchKernel
                    0.28%  20.633ms         1  20.633ms  20.633ms  20.633ms  cuMemAllocManaged
                    0.14%  10.702ms         1  10.702ms  10.702ms  10.702ms  cuModuleGetFunction
                    0.08%  5.8816ms         1  5.8816ms  5.8816ms  5.8816ms  cuMemAllocHost
                    0.03%  2.4741ms      7200     343ns     188ns  159.69us  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.01%  773.34us      3609     214ns     163ns  5.9610us  cuDeviceGetAttribute
                    0.01%  724.83us      1208     600ns     307ns  27.198us  cuPointerGetAttributes
                    0.00%  187.15us         1  187.15us  187.15us  187.15us  cuModuleLoadDataEx
                    0.00%  131.73us         1  131.73us  131.73us  131.73us  cuMemAlloc
                    0.00%  9.6370us         1  9.6370us  9.6370us  9.6370us  cuCtxGetCurrent
                    0.00%  7.4990us         1  7.4990us  7.4990us  7.4990us  cuDeviceGetPCIBusId
                    0.00%  3.3610us         3  1.1200us     205ns  1.8220us  cuCtxSetCurrent
                    0.00%  1.5380us         3     512ns     150ns  1.2070us  cuDeviceGetCount
                    0.00%     825ns         1     825ns     825ns     825ns  cuDeviceComputeCapability
                    0.00%     709ns         2     354ns     160ns     549ns  cuDeviceTotalMem
                    0.00%     620ns         3     206ns     131ns     289ns  cuDriverGetVersion
                    0.00%     541ns         2     270ns     174ns     367ns  cuDeviceGet
 OpenACC (excl):   99.20%  7.21829s      7200  1.0025ms  1.9830us  3.3072ms  acc_wait@layers.c:50
                    0.37%  27.077ms      3600  7.5210us  6.0390us  815.06us  acc_enqueue_launch@layers.c:50 (_8layers_c_conv_forward_50_gpu)
                    0.17%  12.704ms      3600  3.5280us  2.8200us  906.70us  acc_compute_construct@layers.c:50
                    0.16%  11.931ms      3600  3.3140us  1.9040us  1.9149ms  acc_enter_data@layers.c:50
                    0.09%  6.2103ms      3600  1.7250us  1.1900us  849.41us  acc_exit_data@layers.c:50
                    0.00%  247.61us         1  247.61us  247.61us  247.61us  acc_device_init

==2148690== Unified Memory profiling result:
Device "Tesla V100-PCIE-32GB (0)"
   Count  Avg Size  Min Size  Max Size  Total Size  Total Time  Name
   19993  14.196KB  4.0000KB  0.9961MB  277.1875MB  64.29811ms  Host To Device
   26676  10.096KB  4.0000KB  448.00KB  263.0156MB  47.56318ms  Device To Host
    9502         -         -         -           -   1.753963s  Gpu page fault groups
    7465  4.0000KB  4.0000KB  4.0000KB  29.16016MB           -  Memory thrashes
Total CPU Page faults: 18271
Total CPU thrashes: 7465
```

---

## Parallel - Data on device
### Κώδικας
```c
7: Conv_Layer* make_conv_layer(int W, int H, int D, int K, int M, int S, int P) {
...
  30: layer->weights = malloc(sizeof(float) * K * K * M * D);
  layer->bias = malloc(sizeof(float) * M);
  #pragma acc enter data copyin(layer[0:1])
  #pragma acc enter data create(layer->weights[0:layer->weights_size],layer->bias[0:M])

  return layer;
...
40:void free_conv(Conv_Layer* l) {
#pragma acc exit data delete(l->weights[0:l->weights_size],l->bias[0:l->out_depth])
#pragma acc exit data delete(l[0:1])
  free(l->bias);
  free(l->weights);
  free(l);
}
...
230: int load_conv(Conv_Layer* l, char* file_name) {
...
269:   fclose(fin);
  #pragma acc update device (l->weights[0:l->weights_size],l->bias[0:l->out_depth])
  return 0;
}

...

50: void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
  
  int in_size = l->in_width*l->in_height*l->in_depth;
    // For each output feature map
  #pragma acc parallel loop present(l) copyin(X[0:in_size]) copyout(Y[0:l->out_size])
    for (int m = 0; m < l->out_depth; m++) {
      #pragma acc loop independent
      for (int j = 0; j < l->out_height; j++) {
        #pragma acc loop independent
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); // Output index
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
          #pragma acc loop reduction(+:sum) //collapse(3) vector
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
                int f_idx = f_i + (f_j * l->filter_width) + (c + m * l->in_depth) * (l->filter_width * l->filter_width); // Filter Index
                int x_j = -l->padding + j * l->stride + f_j; // Input height index, increased by stride
                int x_i = -l->padding + i * l->stride + f_i; // Input width index, increased by stride
                // If in range of image, else zero
                if (x_j >= 0 && x_i >= 0 && x_j < l->in_height && x_i < l->in_width) {
...
```
### Minfo
```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c main.c -o main.o
arr2txt:
    333, Zero trip check eliminated
arr2txt_2:
    355, Zero trip check eliminated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
make_conv_layer:
     35, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size],layer->bias[:M])
free_conv:
     43, Generating exit data delete(l->bias[:l->out_depth],l[:1],l->weights[:l->weights_size])
conv_forward:
     52, Generating present(l[:])
         Generating copyout(Y[:l->out_size]) [if not already present]
         Generating copyin(X[:in_size]) [if not already present]
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         55, #pragma acc loop gang /* blockIdx.x */
         57, #pragma acc loop seq
         59, #pragma acc loop seq
         64, #pragma acc loop seq
         65, #pragma acc loop seq
         66, #pragma acc loop vector(128) /* threadIdx.x */
             Generating reduction(+:sum)
     57, Loop is parallelizable
     59, Loop is parallelizable
     64, Loop is parallelizable
     65, Loop is parallelizable
     66, Loop is parallelizable
     73, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    157, Zero trip check eliminated
fc_forward:
    212, FMA (fused multiply-add) instruction(s) generated
load_conv:
    271, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c malloc2D.c -o malloc2D.o
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c timer.c -o timer.o
cpu_timer_stop:
     11, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```

### Εκτέλεση
```
$ ./cnn-cifar10 
Parallel (if) Code
CNN for 1200 images
Loading input batch 1...
Load Data time:0.022522 seconds
Create Network time:0.225905 seconds
Load Network Parameters time:0.008454 seconds
Create Ouputs time:0.000032 seconds

Net Forward total time:5.700644 seconds
    Time for conv1: 2.747778 seconds
    Time for relu1: 0.011358 seconds
    Time for pool1: 0.046932 seconds
    Time for conv2: 2.182606 seconds
    Time for relu2: 0.003728 seconds
    Time for pool2: 0.014969 seconds
    Time for conv3: 0.682760 seconds
    Time for relu3: 0.001002 seconds
    Time for pool3: 0.003805 seconds
    Time for fc: 0.005035 seconds
    Time for softmax: 0.000309 seconds

  Conv: 5.613144 seconds
  ReLU: 0.016089 seconds
  Pool: 0.065707 seconds
  FC:   0.005035 seconds
  Softmax: 0.000309 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000022 seconds
Free memory time:0.001352 seconds
Total time:5.958931 seconds
```

### Profiling

#### nvporf
```
$ nvprof ./cnn-cifar10-profile 
Parallel (if) Code
CNN for 1200 images
Loading input batch 1...
Load Data time:0.020782 seconds
==2174872== NVPROF is profiling process 2174872, command: ./cnn-cifar10-profile
Create Network time:0.471195 seconds
Load Network Parameters time:0.007850 seconds
Create Ouputs time:0.000033 seconds

Net Forward total time:5.759263 seconds
    Time for conv1: 2.776911 seconds
    Time for relu1: 0.016524 seconds
    Time for pool1: 0.036957 seconds
    Time for conv2: 2.199978 seconds
    Time for relu2: 0.005045 seconds
    Time for pool2: 0.011902 seconds
    Time for conv3: 0.701428 seconds
    Time for relu3: 0.001358 seconds
    Time for pool3: 0.003062 seconds
    Time for fc: 0.005114 seconds
    Time for softmax: 0.000387 seconds

  Conv: 5.678317 seconds
  ReLU: 0.022927 seconds
  Pool: 0.051921 seconds
  FC:   0.005114 seconds
  Softmax: 0.000387 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000049 seconds
Free memory time:0.001380 seconds
Total time:6.260552 seconds
END!
==2174872== Profiling application: ./cnn-cifar10-profile
==2174872== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   99.68%  5.46897s      3600  1.5192ms  536.06us  2.4909ms  _8layers_c_conv_forward_52_gpu
                    0.20%  10.846ms      3600  3.0120us  1.3750us  16.736us  [CUDA memcpy DtoH]
                    0.12%  6.6762ms      3621  1.8430us     640ns  5.7600us  [CUDA memcpy HtoD]
      API calls:   94.35%  5.49458s     10809  508.33us  1.1100us  2.4928ms  cuStreamSynchronize
                    2.85%  166.18ms         1  166.18ms  166.18ms  166.18ms  cuDevicePrimaryCtxRetain
                    1.09%  63.456ms      3600  17.626us  10.432us  102.19us  cuMemcpyDtoHAsync
                    0.78%  45.300ms         1  45.300ms  45.300ms  45.300ms  cuMemHostAlloc
                    0.46%  26.905ms      3621  7.4300us  2.7840us  36.954us  cuMemcpyHtoDAsync
                    0.29%  16.886ms      3600  4.6900us  4.0020us  33.912us  cuLaunchKernel
                    0.09%  5.2566ms         1  5.2566ms  5.2566ms  5.2566ms  cuMemAllocHost
                    0.05%  2.7771ms      7200     385ns     184ns  751.72us  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.02%  1.3875ms      3609     384ns     139ns  743.98us  cuDeviceGetAttribute
                    0.01%  708.12us      1214     583ns     303ns  24.136us  cuPointerGetAttributes
                    0.00%  201.51us        16  12.594us  2.4830us  129.01us  cuMemAlloc
                    0.00%  146.63us         1  146.63us  146.63us  146.63us  cuModuleLoadDataEx
                    0.00%  19.764us         1  19.764us  19.764us  19.764us  cuCtxGetCurrent
                    0.00%  9.4250us         1  9.4250us  9.4250us  9.4250us  cuDeviceGetPCIBusId
                    0.00%  2.1950us         3     731ns     232ns  1.1440us  cuCtxSetCurrent
                    0.00%  1.5590us         1  1.5590us  1.5590us  1.5590us  cuModuleGetFunction
                    0.00%  1.4460us         3     482ns     247ns     949ns  cuDeviceGetCount
                    0.00%     760ns         2     380ns     164ns     596ns  cuDeviceGet
                    0.00%     568ns         3     189ns     141ns     242ns  cuDriverGetVersion
                    0.00%     396ns         1     396ns     396ns     396ns  cuDeviceComputeCapability
 OpenACC (excl):   96.07%  5.49511s      7200  763.21us  2.0660us  2.4935ms  acc_wait@layers.c:52
                    1.17%  66.694ms      3600  18.526us  11.164us  112.06us  acc_enqueue_download@layers.c:82 (Y[:l->out_size])
                    0.80%  45.689ms         6  7.6148ms  13.459us  45.427ms  acc_enter_data@layers.c:35
                    0.52%  29.752ms      3600  8.2640us  4.3480us  37.822us  acc_enqueue_upload@layers.c:52 (X[:in_size])
                    0.48%  27.350ms      3600  7.5970us  5.0860us  802.26us  acc_enqueue_launch@layers.c:52 (_8layers_c_conv_forward_52_gpu)
                    0.35%  19.766ms      3600  5.4900us  4.4980us  35.886us  acc_enter_data@layers.c:52
                    0.27%  15.701ms      3600  4.3610us  3.6710us  28.989us  acc_exit_data@layers.c:52
                    0.21%  12.040ms      3600  3.3440us  2.5800us  755.80us  acc_compute_construct@layers.c:52
                    0.13%  7.2896ms      3600  2.0240us  1.7830us  18.459us  acc_wait@layers.c:82
                    0.00%  196.33us         1  196.33us  196.33us  196.33us  acc_device_init@layers.c:35
                    0.00%  71.130us        12  5.9270us     865ns  29.051us  acc_enqueue_upload@layers.c:35 (.attach.)
                    0.00%  53.518us        12  4.4590us     927ns  24.779us  acc_enqueue_upload@layers.c:43 (.detach.)
                    0.00%  49.204us         3  16.401us  4.6000us  39.063us  acc_enqueue_upload@layers.c:35 (layer[:1])
                    0.00%  41.262us         3  13.754us  7.8630us  16.732us  acc_enqueue_upload@layers.c:271 (l->weights[:l->weights_size])
                    0.00%  36.126us         6  6.0210us  1.6860us  20.596us  acc_exit_data@layers.c:43
                    0.00%  35.495us         6  5.9150us  4.5790us  8.8660us  acc_wait@layers.c:35
                    0.00%  20.612us         3  6.8700us  3.5140us  9.1830us  acc_wait@layers.c:271
                    0.00%  13.638us         3  4.5460us  2.9580us  7.6280us  acc_update@layers.c:271
                    0.00%  11.979us         3  3.9930us  3.7360us  4.3910us  acc_enqueue_upload@layers.c:271 (l->bias[:l->out_depth])
                    0.00%       0ns      7200       0ns       0ns       0ns  acc_delete@layers.c:82
                    0.00%       0ns         9       0ns       0ns       0ns  acc_delete@layers.c:43
                    0.00%       0ns         6       0ns       0ns       0ns  acc_alloc@layers.c:52
                    0.00%       0ns      7200       0ns       0ns       0ns  acc_create@layers.c:52
                    0.00%       0ns         9       0ns       0ns       0ns  acc_alloc@layers.c:35
                    0.00%       0ns         9       0ns       0ns       0ns  acc_create@layers.c:35
```

### NV_ACC_TIME
```
$ ./cnn-cifar10 
Parallel (if) Code
CNN for 1200 images
Loading input batch 1...
Load Data time:0.020629 seconds
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Create Network time:0.331250 seconds
Load Network Parameters time:0.007981 seconds
Create Ouputs time:0.000033 seconds

Net Forward total time:5.769437 seconds
    Time for conv1: 2.770551 seconds
    Time for relu1: 0.011288 seconds
    Time for pool1: 0.046835 seconds
    Time for conv2: 2.204322 seconds
    Time for relu2: 0.003622 seconds
    Time for pool2: 0.015210 seconds
    Time for conv3: 0.706797 seconds
    Time for relu3: 0.001226 seconds
    Time for pool3: 0.003838 seconds
    Time for fc: 0.005070 seconds
    Time for softmax: 0.000313 seconds

  Conv: 5.681670 seconds
  ReLU: 0.016136 seconds
  Pool: 0.065882 seconds
  FC:   0.005070 seconds
  Softmax: 0.000313 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000033 seconds
Free memory time:0.001446 seconds
Total time:6.130809 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-1.2-data-on-device/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 219
    35: data region reached 6 times
        35: data copyin transfers: 15
             device time(us): total=219 max=38 min=4 avg=14
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-1.2-data-on-device/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 131
    43: data region reached 6 times
        43: data copyin transfers: 12
             device time(us): total=131 max=23 min=4 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-1.2-data-on-device/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 88,046
    52: compute region reached 3600 times
        52: kernel launched 3600 times
            grid: [560]  block: [128]
            elapsed time(us): total=5,507,493 max=2,526 min=547 avg=1,529
    52: data region reached 7200 times
        52: data copyin transfers: 3600
             device time(us): total=32,266 max=30 min=4 avg=8
        82: data copyout transfers: 3600
             device time(us): total=55,780 max=91 min=8 avg=15
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-1.2-data-on-device/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 60
    271: update directive reached 3 times
        271: data copyin transfers: 6
             device time(us): total=60 max=24 min=3 avg=10
```

## ALL Input Data on device
Δεν έχει διαφορά

### code

### Minfo
```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c main.c -o main.o
main:
    122, Generating enter data copyin(input[:1200][:3072])
    184, Generating enter data create(O3[:L3->out_size],O1[:L1->out_size],O7[:L7->out_size],O6[:L6->out_size],O4[:L4->out_size])
    192, Generating update self(O1[:L1->out_size])
    202, Generating update device(O3[:L3->out_size])
    207, Generating update self(O4[:L4->out_size])
    217, Generating update device(O6[:L6->out_size])
    222, Generating update self(O7[:L7->out_size])
    320, Generating exit data delete(O3[:L3->out_size],O1[:L1->out_size],O6[:L6->out_size],O4[:L4->out_size],O7[:L7->out_size])
    348, Generating exit data delete(input[:1200][:3072])
arr2txt:
    371, Zero trip check eliminated
arr2txt_2:
    393, Zero trip check eliminated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
make_conv_layer:
     35, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size],layer->bias[:M])
free_conv:
     43, Generating exit data delete(l->bias[:l->out_depth],l[:1],l->weights[:l->weights_size])
conv_forward:
     52, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         55, #pragma acc loop gang /* blockIdx.x */
         57, #pragma acc loop seq
         59, #pragma acc loop seq
         64, #pragma acc loop seq
         65, #pragma acc loop seq
         66, #pragma acc loop vector(128) /* threadIdx.x */
             Generating reduction(+:sum)
     57, Loop is parallelizable
     59, Loop is parallelizable
     64, Loop is parallelizable
     65, Loop is parallelizable
     66, Loop is parallelizable
     73, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    157, Zero trip check eliminated
fc_forward:
    212, FMA (fused multiply-add) instruction(s) generated
load_conv:
    271, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c malloc2D.c -o malloc2D.o
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c timer.c -o timer.o
cpu_timer_stop:
     11, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```
### εκτέλεση
```
$ ./cnn-cifar10 
Parallel (if) Code
CNN for 1200 images
Loading input batch 1...
Load Data time:0.210632 seconds
Create Network time:0.037928 seconds
Load Network Parameters time:0.007707 seconds
Create Ouputs time:0.000048 seconds

Net Forward total time:5.691954 seconds
    Time for conv1: 2.711793 seconds
    Time for relu1: 0.011260 seconds
    Time for pool1: 0.049688 seconds
    Time for conv2: 2.148444 seconds
    Time for relu2: 0.003986 seconds
    Time for pool2: 0.015930 seconds
    Time for conv3: 0.660975 seconds
    Time for relu3: 0.000960 seconds
    Time for pool3: 0.003903 seconds
    Time for fc: 0.005096 seconds
    Time for softmax: 0.000288 seconds

  Conv: 5.521211 seconds
  ReLU: 0.016206 seconds
  Pool: 0.069522 seconds
  FC:   0.005096 seconds
  Softmax: 0.000288 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000022 seconds
Free memory time:0.001402 seconds
Total time:5.949692 seconds
END!
```
### profiling

#### nvprof

#### NV_ACC_TIME
```
$ ./cnn-cifar10 
Parallel (if) Code
CNN for 1200 images
Loading input batch 1...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:0.342237 seconds
Create Network time:0.048563 seconds
Load Network Parameters time:0.008281 seconds
Create Ouputs time:0.000033 seconds

Net Forward total time:5.762764 seconds
    Time for conv1: 2.721083 seconds
    Time for relu1: 0.011018 seconds
    Time for pool1: 0.048709 seconds
    Time for conv2: 2.157064 seconds
    Time for relu2: 0.003778 seconds
    Time for pool2: 0.015112 seconds
    Time for conv3: 0.665733 seconds
    Time for relu3: 0.001135 seconds
    Time for pool3: 0.003786 seconds
    Time for fc: 0.005065 seconds
    Time for softmax: 0.000294 seconds

  Conv: 5.543879 seconds
  ReLU: 0.015931 seconds
  Pool: 0.067607 seconds
  FC:   0.005065 seconds
  Softmax: 0.000294 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000034 seconds
Free memory time:0.001570 seconds
Total time:6.163482 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-1.2-data-on-device/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 192
    35: data region reached 6 times
        35: data copyin transfers: 15
             device time(us): total=192 max=37 min=3 avg=12
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-1.2-data-on-device/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 149
    43: data region reached 6 times
        43: data copyin transfers: 12
             device time(us): total=149 max=30 min=4 avg=12
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-1.2-data-on-device/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    52: compute region reached 3600 times
        52: kernel launched 3600 times
            grid: [560]  block: [128]
            elapsed time(us): total=5,528,906 max=2,539 min=547 avg=1,535
    52: data region reached 7200 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-1.2-data-on-device/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 62
    271: update directive reached 3 times
        271: data copyin transfers: 6
             device time(us): total=62 max=25 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-1.2-data-on-device/main.c
  main  NVIDIA  devicenum=0
    time(us): 79,304
    122: data region reached 1 time
        44: kernel launched 1 time
            grid: [10]  block: [128]
            elapsed time(us): total=105 max=105 min=105 avg=105
        122: data copyin transfers: 1
             device time(us): total=6,131 max=6,131 min=6,131 avg=6,131
    184: data region reached 2 times
    192: update directive reached 1200 times
        192: data copyout transfers: 1200
             device time(us): total=28,505 max=93 min=22 avg=23
    202: update directive reached 1200 times
        202: data copyin transfers: 1200
             device time(us): total=10,917 max=25 min=8 avg=9
    207: update directive reached 1200 times
        207: data copyout transfers: 1200
             device time(us): total=15,730 max=30 min=12 avg=13
    217: update directive reached 1200 times
        217: data copyin transfers: 1200
             device time(us): total=6,152 max=21 min=4 avg=5
    222: update directive reached 1200 times
        222: data copyout transfers: 1200
             device time(us): total=11,869 max=26 min=9 avg=9
    320: data region reached 2 times
    348: data region reached 1 time
```