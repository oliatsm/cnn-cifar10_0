# Vector length 32

## code

```c
60: void pad_input(float* restrict X, Conv_Layer* l) {
#pragma acc parallel loop present(l,X) collapse(3) gang worker vector vector_length(32)   
  for ( int c = 0; c < l->in_depth; c++) {
    for (int j = 0; j < l->in_height; j++) {
      for (int i = 0; i < l->in_width; i++) {
...

76: void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
    pad_input(X, l); //Create input with zero-padding
   // For each output feature map
#pragma acc parallel loop present(l,X,Y) gang collapse(2) vector_length(32)
    for ( int m = 0; m < l->out_depth; m++) {
      for (int j = 0; j < l->out_height; j++) {
        #pragma acc loop independent worker
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); // Output index
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
        #pragma acc loop  reduction(+:sum) vector 
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
            ...
```

## Minfo

```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c main.c -o main.o
main:
    121, Generating enter data copyin(input[:50000][:3072])
    182, Generating enter data create(O6[:L6->out_size],O7[:L7->out_size],O3[:L3->out_size],O1[:L1->out_size],O4[:L4->out_size])
    190, Generating update self(O1[:L1->out_size])
    200, Generating update device(O3[:L3->out_size])
    205, Generating update self(O4[:L4->out_size])
    215, Generating update device(O6[:L6->out_size])
    220, Generating update self(O7[:L7->out_size])
    317, Generating exit data delete(O6[:L6->out_size],O3[:L3->out_size],O1[:L1->out_size],O4[:L4->out_size],O7[:L7->out_size])
    345, Generating exit data delete(input[:50000][:3072])
arr2txt:
    368, Zero trip check eliminated
arr2txt_2:
    390, Zero trip check eliminated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(l[:],X[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         62, #pragma acc loop gang, worker(4), vector(32) collapse(3) blockIdx.x threadIdx.y threadIdx.x */
         63,   /* blockIdx.x threadIdx.y threadIdx.x collapsed */
         64,   /* blockIdx.x threadIdx.y threadIdx.x collapsed */
conv_forward:
     77, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         80, #pragma acc loop gang collapse(2) /* blockIdx.x */
         81,   /* blockIdx.x collapsed */
         83, #pragma acc loop worker(4) /* threadIdx.y */
         88, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         89, #pragma acc loop seq
         90, #pragma acc loop seq
         97, Vector barrier inserted for vector loop reduction
     83, Loop is parallelizable
     88, Loop is parallelizable
     89, Loop is parallelizable
     90, Loop is parallelizable
     95, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    186, Zero trip check eliminated
fc_forward:
    247, FMA (fused multiply-add) instruction(s) generated
load_conv:
    309, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c malloc2D.c -o malloc2D.o
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c timer.c -o timer.o
cpu_timer_stop:
     11, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```
## execution

```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:1.038795 seconds
Create Network time:0.039709 seconds
Load Network Parameters time:0.007993 seconds
Create Ouputs time:0.000362 seconds

Net Forward total time:12.955126 seconds
    Time for conv1: 2.614917 seconds
    Time for relu1: 0.435048 seconds
    Time for pool1: 1.939649 seconds
    Time for conv2: 2.287832 seconds
    Time for relu2: 0.147643 seconds
    Time for pool2: 0.620214 seconds
    Time for conv3: 1.457046 seconds
    Time for relu3: 0.041705 seconds
    Time for pool3: 0.157259 seconds
    Time for fc: 0.209013 seconds
    Time for softmax: 0.010396 seconds

  Conv: 6.359796 seconds
  ReLU: 0.624395 seconds
  Pool: 2.717121 seconds
  FC:   0.209013 seconds
  Softmax: 0.010396 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001478 seconds
Free memory time:0.048266 seconds
Total time:14.091728 seconds
END!
```
## Profile

### nvprof
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
==2626173== NVPROF is profiling process 2626173, command: ./cnn-cifar10-profile
Load Data time:1.331808 seconds
Create Network time:0.037662 seconds
Load Network Parameters time:0.007704 seconds
Create Ouputs time:0.000336 seconds

Net Forward total time:17.625581 seconds
    Time for conv1: 3.668072 seconds
    Time for relu1: 0.710471 seconds
    Time for pool1: 1.581972 seconds
    Time for conv2: 3.344528 seconds
    Time for relu2: 0.203518 seconds
    Time for pool2: 0.506100 seconds
    Time for conv3: 2.451488 seconds
    Time for relu3: 0.063325 seconds
    Time for pool3: 0.131907 seconds
    Time for fc: 0.217141 seconds
    Time for softmax: 0.014932 seconds

  Conv: 9.464089 seconds
  ReLU: 0.977314 seconds
  Pool: 2.219979 seconds
  FC:   0.217141 seconds
  Softmax: 0.014932 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.002064 seconds
Free memory time:0.057818 seconds
Total time:19.062974 seconds
END!
==2626173== Profiling application: ./cnn-cifar10-profile
==2626173== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   74.17%  3.79963s    150000  25.330us  11.456us  36.383us  _8layers_c_conv_forward_77_gpu
                   10.07%  515.63ms    150000  3.4370us  3.3910us  13.536us  _8layers_c_pad_input_60_gpu
                    9.02%  461.85ms    150000  3.0790us  1.4710us  18.528us  [CUDA memcpy DtoH]
                    6.75%  345.76ms    100031  3.4560us     736ns  147.04ms  [CUDA memcpy HtoD]
                    0.00%  2.8470us         1  2.8470us  2.8470us  2.8470us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   55.08%  6.00642s    850015  7.0660us     606ns  4.5990ms  cuStreamSynchronize
                   23.36%  2.54719s    150000  16.981us  10.504us  7.6266ms  cuMemcpyDtoHAsync
                   12.36%  1.34783s    300001  4.4920us  3.3920us  11.819ms  cuLaunchKernel
                    5.48%  597.87ms    100031  5.9760us  2.6380us  147.29ms  cuMemcpyHtoDAsync
                    1.63%  178.18ms         1  178.18ms  178.18ms  178.18ms  cuDevicePrimaryCtxRetain
                    1.02%  111.36ms    300000     371ns     180ns  3.6893ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.44%  47.966ms    300010     159ns     115ns  728.82us  cuDeviceGetAttribute
                    0.34%  37.186ms         1  37.186ms  37.186ms  37.186ms  cuMemHostAlloc
                    0.19%  20.718ms     50019     414ns     227ns  1.0013ms  cuPointerGetAttributes
                    0.05%  5.3679ms         1  5.3679ms  5.3679ms  5.3679ms  cuMemAllocHost
                    0.04%  3.9794ms        20  198.97us  1.8140us  3.6000ms  cuMemAlloc
                    0.01%  576.89us         2  288.45us  138.84us  438.05us  cuModuleLoadDataEx
                    0.00%  9.9820us         1  9.9820us  9.9820us  9.9820us  cuDeviceGetPCIBusId
                    0.00%  9.5870us         1  9.5870us  9.5870us  9.5870us  cuCtxGetCurrent
                    0.00%  3.8460us         4     961ns     480ns  1.4180us  cuModuleGetFunction
                    0.00%  2.9770us         3     992ns     212ns  1.8650us  cuCtxSetCurrent
                    0.00%  1.9950us         3     665ns     246ns  1.4930us  cuDeviceGetCount
                    0.00%     919ns         2     459ns     167ns     752ns  cuDeviceGet
                    0.00%     837ns         3     279ns     146ns     456ns  cuDriverGetVersion
                    0.00%     573ns         1     573ns     573ns     573ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         1  1.7e+10s  1.7e+10s  1.7e+10s  acc_enter_data@main.c:121
                    0.00%  4.49093s    300000  14.969us  1.5920us  4.6261ms  acc_wait@layers.c:77
                    0.00%  1.24777s     50000  24.955us  22.158us  7.6292ms  acc_enqueue_download@main.c:190 (O1[:L1->out_size])
                    0.00%  1.16255s    300000  3.8750us  1.2230us  799.80us  acc_wait@layers.c:60
                    0.00%  855.97ms    150000  5.7060us  4.7010us  1.2452ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  831.48ms    150000  5.5430us  4.3090us  11.823ms  acc_enqueue_launch@layers.c:77 (_8layers_c_conv_forward_77_gpu)
                    0.00%  799.18ms     50000  15.983us  14.270us  3.0208ms  acc_enqueue_download@main.c:205 (O4[:L4->out_size])
                    0.00%  650.09ms     50000  13.001us  11.303us  839.24us  acc_enqueue_download@main.c:220 (O7[:L7->out_size])
                    0.00%  454.75ms    150000  3.0310us  2.4950us  3.7063ms  acc_compute_construct@layers.c:60
                    0.00%  379.11ms     50000  7.5820us  1.8580us  834.22us  acc_wait@main.c:200
                    0.00%  303.41ms    150000  2.0220us  1.6520us  806.50us  acc_enter_data@layers.c:77
                    0.00%  289.50ms     50000  5.7900us  1.8590us  823.81us  acc_wait@main.c:215
                    0.00%  288.95ms     50000  5.7780us  4.4550us  782.86us  acc_enqueue_upload@main.c:200 (O3[:L3->out_size])
                    0.00%  267.93ms    150000  1.7860us  1.5470us  33.190us  acc_enter_data@layers.c:60
                    0.00%  267.50ms    150000  1.7830us  1.5760us  64.664us  acc_compute_construct@layers.c:77
                    0.00%  253.07ms    150000  1.6870us  1.4600us  758.31us  acc_exit_data@layers.c:77
                    0.00%  238.44ms     50000  4.7680us  3.7250us  2.3353ms  acc_enqueue_upload@main.c:215 (O6[:L6->out_size])
                    0.00%  222.86ms    150000  1.4850us  1.2460us  715.89us  acc_exit_data@layers.c:60
                    0.00%  147.30ms         1  147.30ms  147.30ms  147.30ms  acc_enqueue_upload@main.c:121 (input[:50000][:3072])
                    0.00%  98.624ms     50000  1.9720us  1.7180us  804.75us  acc_wait@main.c:205
                    0.00%  98.196ms     50000  1.9630us  1.7190us  704.11us  acc_wait@main.c:190
                    0.00%  97.267ms     50000  1.9450us  1.6900us  705.94us  acc_wait@main.c:220
                    0.00%  92.197ms     50000  1.8430us  1.5830us  536.55us  acc_update@main.c:200
                    0.00%  90.625ms     50000  1.8120us  1.4590us  801.74us  acc_update@main.c:190
                    0.00%  88.660ms     50000  1.7730us  1.5400us  25.201us  acc_update@main.c:215
                    0.00%  82.180ms     50000  1.6430us  1.4340us  29.482us  acc_update@main.c:220
                    0.00%  81.831ms     50000  1.6360us  1.4140us  28.400us  acc_update@main.c:205
                    0.00%  37.378ms         9  4.1531ms  7.0980us  37.239ms  acc_enter_data@layers.c:42
                    0.00%  1.1893ms         1  1.1893ms  1.1893ms  1.1893ms  acc_exit_data@main.c:345
                    0.00%  529.19us         1  529.19us  529.19us  529.19us  acc_device_init@main.c:121
                    0.00%  91.469us        18  5.0810us     824ns  35.293us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  86.855us         2  43.427us  3.2470us  83.608us  acc_exit_data@main.c:317
                    0.00%  85.830us        18  4.7680us     909ns  33.705us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  70.630us         1  70.630us  70.630us  70.630us  acc_wait@main.c:121
                    0.00%  60.494us         9  6.7210us  4.5250us  9.5890us  acc_wait@layers.c:42
                    0.00%  58.954us         1  58.954us  58.954us  58.954us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  53.026us         9  5.8910us  1.7470us  23.374us  acc_exit_data@layers.c:53
                    0.00%  47.276us         2  23.638us  10.884us  36.392us  acc_enter_data@main.c:182
                    0.00%  39.426us         3  13.142us  7.3730us  17.244us  acc_enqueue_upload@layers.c:309 (l->weights[:l->weights_size])
                    0.00%  30.194us         3  10.064us  7.0660us  11.761us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  22.825us         3  7.6080us  4.0000us  14.644us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  22.191us         3  7.3970us  3.9220us  9.9860us  acc_wait@layers.c:309
                    0.00%  13.406us         3  4.4680us  2.9550us  7.4300us  acc_update@layers.c:309
                    0.00%  11.121us         3  3.7070us  3.4130us  3.8690us  acc_enqueue_upload@layers.c:309 (l->bias[:l->out_depth])
                    0.00%  4.5070us         2  2.2530us  1.4610us  3.0460us  acc_wait@main.c:182
                    0.00%       0ns         5       0ns       0ns       0ns  acc_delete@main.c:317
                    0.00%       0ns         2       0ns       0ns       0ns  acc_alloc@main.c:121
                    0.00%       0ns         2       0ns       0ns       0ns  acc_create@main.c:121
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns         5       0ns       0ns       0ns  acc_alloc@main.c:182
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         2       0ns       0ns       0ns  acc_delete@main.c:345
                    0.00%       0ns         5       0ns       0ns       0ns  acc_create@main.c:182
```

### NV_ACC_TIME

```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Load Data time:1.153809 seconds
Create Network time:0.038643 seconds
Load Network Parameters time:0.007960 seconds
Create Ouputs time:0.000337 seconds

Net Forward total time:16.137563 seconds
    Time for conv1: 3.046507 seconds
    Time for relu1: 0.438243 seconds
    Time for pool1: 1.945219 seconds
    Time for conv2: 2.692187 seconds
    Time for relu2: 0.149498 seconds
    Time for pool2: 0.621242 seconds
    Time for conv3: 1.934501 seconds
    Time for relu3: 0.043576 seconds
    Time for pool3: 0.158656 seconds
    Time for fc: 0.209626 seconds
    Time for softmax: 0.010742 seconds

  Conv: 7.673195 seconds
  ReLU: 0.631318 seconds
  Pool: 2.725116 seconds
  FC:   0.209626 seconds
  Softmax: 0.010742 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001573 seconds
Free memory time:0.048545 seconds
Total time:17.388429 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 225
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=225 max=28 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 183
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=183 max=29 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [800]  block: [32x4]
            elapsed time(us): total=1,865,693 max=413 min=11 avg=12
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    77: compute region reached 150000 times
        77: kernel launched 150000 times
            grid: [160-512]  block: [32x4]
            elapsed time(us): total=4,742,734 max=4,095 min=18 avg=31
    77: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 55
    309: update directive reached 3 times
        309: data copyin transfers: 6
             device time(us): total=55 max=21 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-3.1-conv-pool/main.c
  main  NVIDIA  devicenum=0
    time(us): 2,889,449
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=42 max=42 min=42 avg=42
        121: data copyin transfers: 1
             device time(us): total=151,767 max=151,767 min=151,767 avg=151,767
    182: data region reached 2 times
    190: update directive reached 50000 times
        190: data copyout transfers: 50000
             device time(us): total=1,048,487 max=80 min=19 avg=20
    200: update directive reached 50000 times
        200: data copyin transfers: 50000
             device time(us): total=434,535 max=3,665 min=6 avg=8
    205: update directive reached 50000 times
        205: data copyout transfers: 50000
             device time(us): total=581,529 max=328 min=10 avg=11
    215: update directive reached 50000 times
        215: data copyin transfers: 50000
             device time(us): total=238,049 max=300 min=4 avg=4
    220: update directive reached 50000 times
        220: data copyout transfers: 50000
             device time(us): total=435,082 max=40 min=7 avg=8
    317: data region reached 2 times
    345: data region reached 1 time
```