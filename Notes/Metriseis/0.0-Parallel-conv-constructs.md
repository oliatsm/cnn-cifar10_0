# Kernels Construct

## Code

```c
50:
void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
  // int in_size = l->in_width*l->in_height*l->in_depth;
  
    // For each output feature map
  #pragma acc kernels 
    for (int m = 0; m < l->out_depth; m++) {
      #pragma acc loop independent
      for (int j = 0; j < l->out_height; j++) {
        #pragma acc loop independent
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); // Output index
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
          #pragma acc loop reduction(+:sum) //collapse(3) vector
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
```

## -Minfo

```
conv_forward:
     50, Generating implicit copy(Y[:]) [if not already present]
         Generating implicit copyin(l,X[:]) [if not already present]
     55, Loop carried dependence due to exposed use of Y prevents parallelization
         Generating NVIDIA GPU code
         55, #pragma acc loop seq
         57, #pragma acc loop seq
         59, #pragma acc loop seq
         64, #pragma acc loop vector(128) collapse(3) /* threadIdx.x */
             Generating reduction(+:sum)
         65,   /* threadIdx.x auto-collapsed */
         66,   /* threadIdx.x auto-collapsed */
     57, Loop carried dependence due to exposed use of Y prevents parallelization
     59, Loop carried dependence due to exposed use of Y prevents parallelization
     64, Loop is parallelizable
     65, Loop is parallelizable
     66, Loop is parallelizable
     73, FMA (fused multiply-add) instruction(s) generated
```

## Execution

```
$ ./cnn-cifar10 
Parallel (if) Code
CNN for 50000 images
Load Data time:0.633233 seconds
Create Network time:0.001031 seconds
Load Network Parameters time:0.008243 seconds
Create Ouputs time:0.001010 seconds

Net Forward total time:2283.827071 seconds
    Time for conv1: 1253.331528 seconds
    Time for relu1: 9.617472 seconds
    Time for pool1: 5.781419 seconds
    Time for conv2: 788.429874 seconds
    Time for relu2: 8.163245 seconds
    Time for pool2: 1.725178 seconds
    Time for conv3: 208.739566 seconds
    Time for relu3: 5.969851 seconds
    Time for pool3: 0.607189 seconds
    Time for fc: 1.427644 seconds
    Time for softmax: 0.016495 seconds

  Conv: 2250.500968 seconds
  ReLU: 23.750568 seconds
  Pool: 8.113786 seconds
  FC:   1.427644 seconds
  Softmax: 0.016495 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000687 seconds
Free memory time:0.021408 seconds
Total time:2284.492684 seconds
```
---
# Kernels Independent
##
```
$ make
nvc -acc -gpu=managed -Minfo=all -c11 -Wall -Wextra -march=native  -c main.c -o main.o
arr2txt:
    333, Zero trip check eliminated
arr2txt_2:
    355, Zero trip check eliminated
nvc -acc -gpu=managed -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
conv_forward:
     55, Generating implicit copy(Y[:]) [if not already present]
         Generating implicit copyin(l,X[:]) [if not already present]
     57, Loop is parallelizable
         Generating NVIDIA GPU code
         57, #pragma acc loop gang, vector(128) /* blockIdx.x threadIdx.x */
         59, #pragma acc loop seq
         61, #pragma acc loop seq
         66, #pragma acc loop seq collapse(3)
         67,   auto-collapsed */
         68,   auto-collapsed */
             Generating reduction(+:sum)
     59, Loop is parallelizable
     61, Loop is parallelizable
     66, Loop is parallelizable
     67, Loop is parallelizable
     68, Loop is parallelizable
     75, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    160, Zero trip check eliminated
fc_forward:
    215, FMA (fused multiply-add) instruction(s) generated
nvc -acc -gpu=managed -Minfo=all -c11 -Wall -Wextra -march=native  -c malloc2D.c -o malloc2D.o
nvc -acc -gpu=managed -Minfo=all -c11 -Wall -Wextra -march=native  -c timer.c -o timer.o
cpu_timer_stop:
     11, FMA (fused multiply-add) instruction(s) generated
nvc -acc -gpu=managed -Minfo=all -c11 -Wall -Wextra -march=native  -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
olia@krylov100:~/Diplomatiki/cnn-cifar10_0/serial2parallel-1-if$ ./cnn-cifar10 
Parallel (if) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.625343 seconds
Create Network time:0.001007 seconds
Load Network Parameters time:0.007840 seconds
Create Ouputs time:0.000998 seconds

Net Forward total time:522.414667 seconds
    Time for conv1: 174.521422 seconds
    Time for relu1: 9.601620 seconds
    Time for pool1: 5.669073 seconds
    Time for conv2: 238.740952 seconds
    Time for relu2: 8.301698 seconds
    Time for pool2: 1.801416 seconds
    Time for conv3: 75.508413 seconds
    Time for relu3: 6.149491 seconds
    Time for pool3: 0.610273 seconds
    Time for fc: 1.479231 seconds
    Time for softmax: 0.014411 seconds

  Conv: 488.770787 seconds
  ReLU: 24.052809 seconds
  Pool: 8.080762 seconds
  FC:   1.479231 seconds
  Softmax: 0.014411 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000712 seconds
Free memory time:0.021553 seconds
Total time:523.072120 seconds
END!
```

## nvprof

```
$ nvprof ./cnn-cifar10-profile 
Parallel (if) Code
CNN for 50000 images
==3516318== NVPROF is profiling process 3516318, command: ./cnn-cifar10-profile
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.690688 seconds
Create Network time:0.001064 seconds
Load Network Parameters time:0.008230 seconds
Create Ouputs time:0.001200 seconds

Net Forward total time:553.722634 seconds
    Time for conv1: 175.395242 seconds
    Time for relu1: 19.529646 seconds
    Time for pool1: 9.095138 seconds
    Time for conv2: 238.790541 seconds
    Time for relu2: 15.101654 seconds
    Time for pool2: 3.536553 seconds
    Time for conv3: 77.575811 seconds
    Time for relu3: 11.168946 seconds
    Time for pool3: 1.140111 seconds
    Time for fc: 2.337544 seconds
    Time for softmax: 0.022009 seconds

  Conv: 491.761594 seconds
  ReLU: 45.800246 seconds
  Pool: 13.771802 seconds
  FC:   2.337544 seconds
  Softmax: 0.022009 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000766 seconds
Free memory time:0.021880 seconds
Total time:554.446462 seconds
END!
==3516318== Profiling application: ./cnn-cifar10-profile
==3516318== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:  100.00%  487.887s    150000  3.2526ms  1.3155ms  11.572ms  _8layers_c_conv_forward_57_gpu
      API calls:   99.73%  488.547s    300000  1.6285ms  1.1530us  11.655ms  cuStreamSynchronize
                    0.21%  1.04669s    150000  6.9770us  4.5950us  1.2055ms  cuLaunchKernel
                    0.03%  160.13ms         1  160.13ms  160.13ms  160.13ms  cuDevicePrimaryCtxRetain
                    0.01%  48.076ms     50014     961ns     358ns  655.04us  cuPointerGetAttributes
                    0.01%  44.932ms    150009     299ns     169ns  799.98us  cuDeviceGetAttribute
                    0.00%  21.793ms         1  21.793ms  21.793ms  21.793ms  cuMemFree
                    0.00%  20.728ms         2  10.364ms  108.61us  20.620ms  cuMemAllocManaged
                    0.00%  1.6389ms         1  1.6389ms  1.6389ms  1.6389ms  cuMemAllocHost
                    0.00%  130.75us         1  130.75us  130.75us  130.75us  cuMemAlloc
                    0.00%  110.77us         1  110.77us  110.77us  110.77us  cuModuleLoadDataEx
                    0.00%  23.488us         1  23.488us  23.488us  23.488us  cuCtxGetCurrent
                    0.00%  11.566us         1  11.566us  11.566us  11.566us  cuDeviceGetPCIBusId
                    0.00%  4.4370us         1  4.4370us  4.4370us  4.4370us  cuModuleGetFunction
                    0.00%  2.0840us         2  1.0420us     161ns  1.9230us  cuDeviceTotalMem
                    0.00%  1.6620us         3     554ns     166ns  1.1510us  cuCtxSetCurrent
                    0.00%  1.5520us         3     517ns     202ns  1.0210us  cuDeviceGetCount
                    0.00%  1.1570us         2     578ns     232ns     925ns  cuDeviceGet
                    0.00%     889ns         3     296ns     256ns     354ns  cuDriverGetVersion
                    0.00%     681ns         1     681ns     681ns     681ns  cuDeviceComputeCapability
 OpenACC (excl):   99.39%  488.470s    150000  3.2565ms  166.70us  11.683ms  acc_wait@layers.c:57
                    0.27%  1.30657s    150000  8.7100us  5.7870us  1.2118ms  acc_enqueue_launch@layers.c:57 (_8layers_c_conv_forward_57_gpu)
                    0.11%  554.97ms    150000  3.6990us  2.0530us  2.0085ms  acc_enter_data@layers.c:55
                    0.09%  419.63ms    150000  2.7970us  1.8320us  832.78us  acc_wait@layers.c:55
                    0.08%  416.45ms    150000  2.7760us  1.9140us  1.1836ms  acc_compute_construct@layers.c:55
                    0.07%  322.61ms    150000  2.1500us  1.4340us  705.83us  acc_exit_data@layers.c:55
                    0.00%  151.52us         1  151.52us  151.52us  151.52us  acc_device_init

==3516318== Unified Memory profiling result:
Device "Tesla V100-PCIE-32GB (0)"
   Count  Avg Size  Min Size  Max Size  Total Size  Total Time  Name
 1098811  25.134KB  4.0000KB  0.9961MB  26.33870GB   4.535821s  Host To Device
 1920376  14.068KB  4.0000KB  252.00KB  25.76656GB   3.937030s  Device To Host
  224287         -         -         -           -  44.980082s  Gpu page fault groups
  680282  4.0000KB  4.0000KB  4.0000KB  2.595070GB           -  Memory thrashes
Total CPU Page faults: 1177264
Total CPU thrashes: 680282
```
