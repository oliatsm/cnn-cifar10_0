# Parallelizing loops

using `-gpu=manged `for data transfers

### Serial code Baseline

```
$ ./cnn-cifar10-serial
Serial Code
CNN for 1200 images
Loading input batch 1...
Load Data time:0.028702 seconds
Create Network time:0.000012 seconds
Load Network Parameters time:0.008674 seconds
Create Ouputs time:0.000049 seconds

Net Forward total time:38.171430 seconds
    Time for conv1: 12.309057 seconds
    Time for relu1: 0.104257 seconds
    Time for pool1: 0.149919 seconds
    Time for conv2: 19.745590 seconds
    Time for relu2: 0.029865 seconds
    Time for pool2: 0.045366 seconds
    Time for conv3: 5.752236 seconds
    Time for relu3: 0.008066 seconds
    Time for pool3: 0.012428 seconds
    Time for fc: 0.013277 seconds
    Time for softmax: 0.000622 seconds

  Conv: 37.806883 seconds
  ReLU: 0.142188 seconds
  Pool: 0.207713 seconds
  FC:   0.013277 seconds
  Softmax: 0.000622 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000085 seconds
Free memory time:0.001533 seconds
Total time:38.210487 seconds
END!
```

## Kernels Construct

```c
void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
  
#pragma acc kernels
  {
    // For each output feature map
    for (int m = 0; m < l->out_depth; m++) {
/// ...

```

```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -gpu=managed -c layers.c -o layers.o
conv_forward:
     48, Generating implicit copy(Y[:]) [if not already present]
         Generating implicit copyin(l,X[:]) [if not already present]
     52, Loop carried dependence due to exposed use of Y prevents parallelization
         Generating NVIDIA GPU code
         52, #pragma acc loop seq
         54, #pragma acc loop seq
         56, #pragma acc loop seq
         61, #pragma acc loop vector(128) collapse(3) /* threadIdx.x */
             Generating implicit reduction(+:sum)
         62,   /* threadIdx.x auto-collapsed */
         63,   /* threadIdx.x auto-collapsed */
     54, Loop carried dependence due to exposed use of Y prevents parallelization
     56, Loop carried dependence due to exposed use of Y prevents parallelization
     61, Loop is parallelizable
     62, Loop is parallelizable
     63, Loop is parallelizable
     70, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    155, Zero trip check eliminated
fc_forward:
    210, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -gpu=managed -o cnn-cifar10 main.o layers.o malloc2D.o timer.o

$ ./cnn-cifar10
Conv: Kernels Code
CNN for 1200 images
Loading input batch 1...
Load Data time:0.015023 seconds
Create Network time:0.000060 seconds
Load Network Parameters time:0.008623 seconds
Create Ouputs time:0.000034 seconds

Net Forward total time:54.501967 seconds
    Time for conv1: 29.932590 seconds
    Time for relu1: 0.175017 seconds
    Time for pool1: 0.058816 seconds
    Time for conv2: 19.034199 seconds
    Time for relu2: 0.072634 seconds
    Time for pool2: 0.017005 seconds
    Time for conv3: 5.042233 seconds
    Time for relu3: 0.070464 seconds
    Time for pool3: 0.024876 seconds
    Time for fc: 0.073039 seconds
    Time for softmax: 0.000647 seconds

  Conv: 54.009022 seconds
  ReLU: 0.318115 seconds
  Pool: 0.100697 seconds
  FC:   0.073039 seconds
  Softmax: 0.000647 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000035 seconds
Free memory time:0.000071 seconds
Total time:54.525814 seconds
END!
```


## Kernels - Loop independent

```c
void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
  
#pragma acc kernels
  {
    // For each output feature map
  #pragma acc loop independent
    for (int m = 0; m < l->out_depth; m++) {
    #pragma acc loop independent
      for (int j = 0; j < l->out_height; j++) {
      #pragma acc loop independent
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); // Output index
          // Calculate dot product of Weights*Input
          float sum = 0.0;
          #pragma acc loop reduction(+:sum)
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
                int f_idx = f_i + (f_j * l->filter_width) + (c + m * l->in_depth) * (l->filter_width * l->filter_width); // Filter Index
                int x_j = -l->padding + j * l->stride + f_j;
                int x_i = -l->padding + i * l->stride + f_i;
                // If in range of image, else zero
                if (x_j >= 0 && x_i >= 0 && x_j < l->in_height && x_i < l->in_width) {
                  int x_idx = c * l->in_height * l->in_width + x_j * l->in_width + x_i; 
                  sum += l->weights[f_idx] * X[x_idx];
                } // if
```


```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -gpu=managed -c layers.c -o layers.o
conv_forward:
     48, Generating implicit copy(Y[:]) [if not already present]
         Generating implicit copyin(l,X[:]) [if not already present]
     52, Loop is parallelizable
         Generating NVIDIA GPU code
         52, #pragma acc loop gang, vector(128) /* blockIdx.x threadIdx.x */
         54, #pragma acc loop seq
         56, #pragma acc loop seq
         61, #pragma acc loop seq collapse(3)
         62,   auto-collapsed */
         63,   auto-collapsed */
             Generating reduction(+:sum)
     54, Loop is parallelizable
     56, Loop is parallelizable
     61, Loop is parallelizable
     62, Loop is parallelizable
     63, Loop is parallelizable
     70, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    155, Zero trip check eliminated
fc_forward:
    210, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -gpu=managed -o cnn-cifar10 main.o layers.o malloc2D.o timer.o


$ ./cnn-cifar10
Conv: Kernels- loop independent Code
CNN for 1200 images
Loading input batch 1...
Load Data time:0.013188 seconds
Create Network time:0.000061 seconds
Load Network Parameters time:0.008326 seconds
Create Ouputs time:0.000033 seconds

Net Forward total time:13.937582 seconds
    Time for conv1: 4.678869 seconds
    Time for relu1: 0.183440 seconds
    Time for pool1: 0.058579 seconds
    Time for conv2: 6.696192 seconds
    Time for relu2: 0.076535 seconds
    Time for pool2: 0.017234 seconds
    Time for conv3: 2.052730 seconds
    Time for relu3: 0.069548 seconds
    Time for pool3: 0.026343 seconds
    Time for fc: 0.076976 seconds
    Time for softmax: 0.000676 seconds

  Conv: 13.427791 seconds
  ReLU: 0.329523 seconds
  Pool: 0.102156 seconds
  FC:   0.076976 seconds
  Softmax: 0.000676 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000020 seconds
Free memory time:0.000066 seconds
Total time:13.959275 seconds
END!
```

## Parallel Construct

#### 1200 images
```
$ ./cnn-cifar10 
Conv:Parallel - loop Code
CNN for 1200 images
Loading input batch 1...
Load Data time:0.012991 seconds
Create Network time:0.000073 seconds
Load Network Parameters time:0.008162 seconds
Create Ouputs time:0.000042 seconds

Net Forward total time:7.479005 seconds
    Time for conv1: 3.147115 seconds
    Time for relu1: 0.181251 seconds
    Time for pool1: 0.056948 seconds
    Time for conv2: 2.768099 seconds
    Time for relu2: 0.074302 seconds
    Time for pool2: 0.017020 seconds
    Time for conv3: 1.061247 seconds
    Time for relu3: 0.069157 seconds
    Time for pool3: 0.026114 seconds
    Time for fc: 0.076715 seconds
    Time for softmax: 0.000618 seconds

  Conv: 6.976461 seconds
  ReLU: 0.324710 seconds
  Pool: 0.100081 seconds
  FC:   0.076715 seconds
  Softmax: 0.000618 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000036 seconds
Free memory time:0.000068 seconds
Total time:7.500379 seconds
END!
```

#### 50000 images
```
$ ./cnn-cifar10
Conv:Parallel - loop Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.586575 seconds
Create Network time:0.000634 seconds
Load Network Parameters time:0.008383 seconds
Create Ouputs time:0.000637 seconds

Net Forward total time:302.497609 seconds
    Time for conv1: 128.678537 seconds
    Time for relu1: 9.762374 seconds
    Time for pool1: 5.872076 seconds
    Time for conv2: 100.174411 seconds
    Time for relu2: 8.266072 seconds
    Time for pool2: 1.866317 seconds
    Time for conv3: 39.605659 seconds
    Time for relu3: 6.125257 seconds
    Time for pool3: 0.620170 seconds
    Time for fc: 1.489888 seconds
    Time for softmax: 0.016679 seconds

  Conv: 268.458607 seconds
  ReLU: 24.153703 seconds
  Pool: 8.358563 seconds
  FC:   1.489888 seconds
  Softmax: 0.016679 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000820 seconds
Free memory time:0.023130 seconds
Total time:303.117788 seconds
END!
```

### Profiling Parallel

#### 1200 images
```
$ nvprof ./cnn-cifar10-profile 
Conv:Parallel - loop Code
CNN for 1200 images
==1059090== NVPROF is profiling process 1059090, command: ./cnn-cifar10-profile
Loading input batch 1...
Load Data time:0.025058 seconds
Create Network time:0.000102 seconds
Load Network Parameters time:0.009040 seconds
Create Ouputs time:0.000114 seconds

Net Forward total time:8.290609 seconds
    Time for conv1: 3.197660 seconds
    Time for relu1: 0.431680 seconds
    Time for pool1: 0.070202 seconds
    Time for conv2: 2.841435 seconds
    Time for relu2: 0.189475 seconds
    Time for pool2: 0.017487 seconds
    Time for conv3: 1.107206 seconds
    Time for relu3: 0.173630 seconds
    Time for pool3: 0.064853 seconds
    Time for fc: 0.195692 seconds
    Time for softmax: 0.000729 seconds

  Conv: 7.146301 seconds
  ReLU: 0.794784 seconds
  Pool: 0.152542 seconds
  FC:   0.195692 seconds
  Softmax: 0.000729 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000020 seconds
Free memory time:0.000071 seconds
Total time:8.325014 seconds
END!
==1059090== Profiling application: ./cnn-cifar10-profile
==1059090== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:  100.00%  7.03903s      3600  1.9553ms  652.70us  3.4856ms  _8layers_c_conv_forward_48_gpu
      API calls:   96.77%  7.05510s      7200  979.87us  1.3550us  4.8775ms  cuStreamSynchronize
                    2.47%  180.23ms         1  180.23ms  180.23ms  180.23ms  cuDevicePrimaryCtxRetain
                    0.37%  26.989ms      3600  7.4960us  4.7950us  825.82us  cuLaunchKernel
                    0.28%  20.550ms         1  20.550ms  20.550ms  20.550ms  cuMemAllocManaged
                    0.04%  2.9661ms      7200     411ns     190ns  74.135us  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.03%  1.8925ms      3609     524ns     158ns  794.56us  cuDeviceGetAttribute
                    0.02%  1.3419ms         1  1.3419ms  1.3419ms  1.3419ms  cuMemAllocHost
                    0.02%  1.1835ms      1208     979ns     275ns  53.337us  cuPointerGetAttributes
                    0.00%  130.36us         1  130.36us  130.36us  130.36us  cuMemAlloc
                    0.00%  114.16us         1  114.16us  114.16us  114.16us  cuModuleLoadDataEx
                    0.00%  23.173us         1  23.173us  23.173us  23.173us  cuModuleGetFunction
                    0.00%  12.853us         1  12.853us  12.853us  12.853us  cuDeviceGetPCIBusId
                    0.00%  1.9960us         3     665ns     208ns  1.5470us  cuDeviceGetCount
                    0.00%  1.4860us         3     495ns     225ns     785ns  cuCtxSetCurrent
                    0.00%     856ns         1     856ns     856ns     856ns  cuDeviceComputeCapability
                    0.00%     680ns         2     340ns     187ns     493ns  cuDeviceGet
                    0.00%     644ns         1     644ns     644ns     644ns  cuCtxGetCurrent
                    0.00%     590ns         3     196ns     167ns     244ns  cuDriverGetVersion
                    0.00%     435ns         2     217ns     110ns     325ns  cuDeviceTotalMem
 OpenACC (excl):   98.98%  7.06513s      7200  981.27us  2.0370us  4.8786ms  acc_wait@layers.c:48
                    0.48%  34.519ms      3600  9.5880us  6.0130us  845.11us  acc_enqueue_launch@layers.c:48 (_8layers_c_conv_forward_48_gpu)
                    0.23%  16.530ms      3600  4.5910us  2.8360us  801.01us  acc_compute_construct@layers.c:48
                    0.20%  14.358ms      3600  3.9880us  1.8960us  801.03us  acc_enter_data@layers.c:48
                    0.10%  7.4090ms      3600  2.0580us  1.1730us  46.292us  acc_exit_data@layers.c:48
                    0.00%  147.77us         1  147.77us  147.77us  147.77us  acc_device_init

==1059090== Unified Memory profiling result:
Device "Tesla V100-PCIE-32GB (0)"
   Count  Avg Size  Min Size  Max Size  Total Size  Total Time  Name
   20013  13.705KB  4.0000KB  0.9961MB  267.8555MB  63.43604ms  Host To Device
   27669  9.3877KB  4.0000KB  448.00KB  253.6758MB  48.49001ms  Device To Host
    9633         -         -         -           -   1.606729s  Gpu page fault groups
    7116  4.0000KB  4.0000KB  4.0000KB  27.79688MB           -  Memory thrashes
Total CPU Page faults: 18057
Total CPU thrashes: 7116
```

#### 50000 images
```
$ nvprof ./cnn-cifar10-profile 
Conv:Parallel - loop Code
CNN for 50000 images
==1108531== NVPROF is profiling process 1108531, command: ./cnn-cifar10-profile
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.597716 seconds
Create Network time:0.000644 seconds
Load Network Parameters time:0.016217 seconds
Create Ouputs time:0.000829 seconds

Net Forward total time:348.456847 seconds
    Time for conv1: 135.364732 seconds
    Time for relu1: 20.921233 seconds
    Time for pool1: 10.041152 seconds
    Time for conv2: 103.875268 seconds
    Time for relu2: 14.484225 seconds
    Time for pool2: 3.501787 seconds
    Time for conv3: 46.575234 seconds
    Time for relu3: 10.700219 seconds
    Time for pool3: 1.259931 seconds
    Time for fc: 1.694125 seconds
    Time for softmax: 0.017843 seconds

  Conv: 285.815234 seconds
  ReLU: 46.105677 seconds
  Pool: 14.802871 seconds
  FC:   1.694125 seconds
  Softmax: 0.017843 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000725 seconds
Free memory time:0.021763 seconds
Total time:349.094740 seconds
END!
==1108531== Profiling application: ./cnn-cifar10-profile
==1108531== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:  100.00%  281.667s    150000  1.8778ms  632.13us  6.7727ms  _8layers_c_conv_forward_48_gpu
      API calls:   99.47%  282.437s    300000  941.46us  1.2930us  6.7756ms  cuStreamSynchronize
                    0.38%  1.07378s    150000  7.1580us  4.6880us  1.1479ms  cuLaunchKernel
                    0.06%  173.74ms         1  173.74ms  173.74ms  173.74ms  cuDevicePrimaryCtxRetain
                    0.05%  131.43ms    300000     438ns     182ns  804.01us  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.02%  46.182ms     50018     923ns     312ns  919.92us  cuPointerGetAttributes
                    0.01%  39.947ms    150009     266ns     139ns  657.99us  cuDeviceGetAttribute
                    0.01%  21.679ms         1  21.679ms  21.679ms  21.679ms  cuMemFree
                    0.01%  20.642ms         2  10.321ms  82.478us  20.560ms  cuMemAllocManaged
                    0.00%  1.2433ms         1  1.2433ms  1.2433ms  1.2433ms  cuMemAllocHost
                    0.00%  131.17us         1  131.17us  131.17us  131.17us  cuMemAlloc
                    0.00%  115.93us         1  115.93us  115.93us  115.93us  cuModuleLoadDataEx
                    0.00%  20.243us         1  20.243us  20.243us  20.243us  cuModuleGetFunction
                    0.00%  9.7330us         1  9.7330us  9.7330us  9.7330us  cuDeviceGetPCIBusId
                    0.00%  2.1290us         3     709ns     194ns  1.2980us  cuDeviceGetCount
                    0.00%  2.0510us         3     683ns     217ns  1.3190us  cuCtxSetCurrent
                    0.00%  1.7320us         2     866ns     113ns  1.6190us  cuDeviceTotalMem
                    0.00%     802ns         1     802ns     802ns     802ns  cuDeviceComputeCapability
                    0.00%     766ns         2     383ns     246ns     520ns  cuDeviceGet
                    0.00%     688ns         3     229ns     158ns     336ns  cuDriverGetVersion
                    0.00%     495ns         1     495ns     495ns     495ns  cuCtxGetCurrent
 OpenACC (excl):   99.03%  282.767s    300000  942.56us  1.9170us  6.7767ms  acc_wait@layers.c:48
                    0.47%  1.34475s    150000  8.9650us  5.9610us  2.0855ms  acc_enqueue_launch@layers.c:48 (_8layers_c_conv_forward_48_gpu)
                    0.21%  610.03ms    150000  4.0660us  2.7400us  982.62us  acc_compute_construct@layers.c:48
                    0.19%  545.30ms    150000  3.6350us  1.8690us  1.8649ms  acc_enter_data@layers.c:48
                    0.10%  272.86ms    150000  1.8190us  1.1110us  852.29us  acc_exit_data@layers.c:48
                    0.00%  149.60us         1  149.60us  149.60us  149.60us  acc_device_init

==1108531== Unified Memory profiling result:
Device "Tesla V100-PCIE-32GB (0)"
   Count  Avg Size  Min Size  Max Size  Total Size  Total Time  Name
 1023248  26.825KB  4.0000KB  0.9961MB  26.17808GB   4.558754s  Host To Device
 1805969  14.867KB  4.0000KB  252.00KB  25.60593GB   3.860360s  Device To Host
  237763         -         -         -           -  56.523584s  Gpu page fault groups
  566127  4.0000KB  4.0000KB  4.0000KB  2.159603GB           -  Memory thrashes
Total CPU Page faults: 1061919
Total CPU thrashes: 566127
```