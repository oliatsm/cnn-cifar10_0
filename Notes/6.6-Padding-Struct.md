# Improving serial code with padding

## Padding on Conv Struct

#### 1200 images
```
$ ./cnn-cifar10-serial 
Serial Code
CNN for 1200 images
Loading input batch 1...
Load Data time:0.027480 seconds
Create Network time:0.000069 seconds
Load Network Parameters time:0.008305 seconds
Create Ouputs time:0.000055 seconds

Net Forward total time:23.127095 seconds
    Time for conv1: 7.182014 seconds
    Time for relu1: 0.109774 seconds
    Time for pool1: 0.153704 seconds
    Time for conv2: 11.878434 seconds
    Time for relu2: 0.030893 seconds
    Time for pool2: 0.045888 seconds
    Time for conv3: 3.690932 seconds
    Time for relu3: 0.008189 seconds
    Time for pool3: 0.012544 seconds
    Time for fc: 0.013559 seconds
    Time for softmax: 0.000582 seconds

  Conv: 22.751379 seconds
  ReLU: 0.148856 seconds
  Pool: 0.212136 seconds
  FC:   0.013559 seconds
  Softmax: 0.000582 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000102 seconds
Free memory time:0.001775 seconds
Total time:23.164882 seconds
END!
```
#### 50k images

```
$ ./cnn-cifar10-serial 
Serial Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.974951 seconds
Create Network time:0.000070 seconds
Load Network Parameters time:0.008447 seconds
Create Ouputs time:0.000443 seconds

Net Forward total time:923.071477 seconds
    Time for conv1: 286.312681 seconds
    Time for relu1: 4.397399 seconds
    Time for pool1: 6.151344 seconds
    Time for conv2: 473.989921 seconds
    Time for relu2: 1.234319 seconds
    Time for pool2: 1.841110 seconds
    Time for conv3: 147.732905 seconds
    Time for relu3: 0.322829 seconds
    Time for pool3: 0.499408 seconds
    Time for fc: 0.544242 seconds
    Time for softmax: 0.022354 seconds

  Conv: 908.035507 seconds
  ReLU: 5.954547 seconds
  Pool: 8.491862 seconds
  FC:   0.544242 seconds
  Softmax: 0.022354 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.004081 seconds
Free memory time:0.060855 seconds
Total time:924.120324 seconds
END!
```

## Parallel with Pad-struct

pad_input -> Parallel

```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -gpu=managed -c main.c -o main.o
arr2txt:
    332, Zero trip check eliminated
arr2txt_2:
    354, Zero trip check eliminated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -gpu=managed -c layers.c -o layers.o
pad_input:
     60, Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         63, #pragma acc loop gang /* blockIdx.x */
         65, #pragma acc loop seq
         67, #pragma acc loop vector(128) /* threadIdx.x */
     60, Generating implicit copyin(X[:]) [if not already present]
         Generating implicit copy(l) [if not already present]
     65, Loop is parallelizable
     67, Loop is parallelizable
conv_forward:
     80, Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         84, #pragma acc loop gang /* blockIdx.x */
         86, #pragma acc loop seq
         88, #pragma acc loop seq
         93, #pragma acc loop seq
         94, #pragma acc loop seq
         95, #pragma acc loop vector(128) /* threadIdx.x */
             Generating reduction(+:sum)
     80, Generating implicit copy(Y[:]) [if not already present]
         Generating implicit copyin(l) [if not already present]
     86, Loop is parallelizable
     88, Loop is parallelizable
     93, Loop is parallelizable
     94, Loop is parallelizable
     95, Loop is parallelizable
    100, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    183, Zero trip check eliminated
fc_forward:
    238, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -gpu=managed -c malloc2D.c -o malloc2D.o
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -gpu=managed -c timer.c -o timer.o
cpu_timer_stop:
     11, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -gpu=managed -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
olia@krylov100:~/Diplomatiki/cnn-cifar10_0/serial2parallel-pad$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 1200 images
Loading input batch 1...
Load Data time:0.013170 seconds
Create Network time:0.000736 seconds
Load Network Parameters time:0.008616 seconds
Create Ouputs time:0.000039 seconds

Net Forward total time:5.583437 seconds
    Time for conv1: 2.423479 seconds
    Time for relu1: 0.090080 seconds
    Time for pool1: 0.075770 seconds
    Time for conv2: 1.836205 seconds
    Time for relu2: 0.072588 seconds
    Time for pool2: 0.067707 seconds
    Time for conv3: 0.824653 seconds
    Time for relu3: 0.060623 seconds
    Time for pool3: 0.026688 seconds
    Time for fc: 0.104544 seconds
    Time for softmax: 0.000635 seconds

  Conv: 5.084337 seconds
  ReLU: 0.223291 seconds
  Pool: 0.170165 seconds
  FC:   0.104544 seconds
  Softmax: 0.000635 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000023 seconds
Free memory time:0.000075 seconds
Total time:5.606095 seconds
END!

$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 1200 images
==1668494== NVPROF is profiling process 1668494, command: ./cnn-cifar10-profile
Loading input batch 1...
Load Data time:0.026003 seconds
Create Network time:0.001077 seconds
Load Network Parameters time:0.009128 seconds
Create Ouputs time:0.000128 seconds

Net Forward total time:6.284660 seconds
    Time for conv1: 2.489260 seconds
    Time for relu1: 0.175896 seconds
    Time for pool1: 0.092586 seconds
    Time for conv2: 1.872586 seconds
    Time for relu2: 0.174134 seconds
    Time for pool2: 0.144162 seconds
    Time for conv3: 0.863933 seconds
    Time for relu3: 0.167714 seconds
    Time for pool3: 0.062198 seconds
    Time for fc: 0.240878 seconds
    Time for softmax: 0.000734 seconds

  Conv: 5.225779 seconds
  ReLU: 0.517745 seconds
  Pool: 0.298946 seconds
  FC:   0.240878 seconds
  Softmax: 0.000734 seconds

Net Accuracy: 78.25 % 
Net Accuracy time:0.000033 seconds
Free memory time:0.000092 seconds
Total time:6.321122 seconds
END!
==1668494== Profiling application: ./cnn-cifar10-profile
==1668494== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   80.19%  4.03290s      3600  1.1202ms  333.34us  3.6756ms  _8layers_c_conv_forward_80_gpu
                   19.80%  995.89ms      3600  276.64us  57.599us  783.39us  _8layers_c_pad_input_60_gpu
                    0.01%  488.19us         3  162.73us  1.6950us  329.15us  [CUDA memset]
      API calls:   95.24%  5.06005s     14400  351.39us  1.0080us  3.6737ms  cuStreamSynchronize
                    3.14%  166.64ms         1  166.64ms  166.64ms  166.64ms  cuDevicePrimaryCtxRetain
                    0.93%  49.453ms      7200  6.8680us  3.5520us  797.48us  cuLaunchKernel
                    0.39%  20.615ms         1  20.615ms  20.615ms  20.615ms  cuMemAllocManaged
                    0.12%  6.1535ms     14400     427ns     187ns  18.283us  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.11%  5.8307ms         1  5.8307ms  5.8307ms  5.8307ms  cuMemAllocHost
                    0.04%  2.0469ms      7209     283ns     119ns  13.588us  cuDeviceGetAttribute
                    0.02%  1.2147ms      1208  1.0050us     357ns  28.699us  cuPointerGetAttributes
                    0.01%  574.96us         3  191.65us  9.7470us  386.65us  cuMemsetD8
                    0.01%  425.80us         1  425.80us  425.80us  425.80us  cuModuleLoadDataEx
                    0.00%  134.90us         1  134.90us  134.90us  134.90us  cuMemAlloc
                    0.00%  15.159us         2  7.5790us     651ns  14.508us  cuModuleGetFunction
                    0.00%  9.2260us         1  9.2260us  9.2260us  9.2260us  cuDeviceGetPCIBusId
                    0.00%  2.7500us         3     916ns     224ns  1.5940us  cuCtxSetCurrent
                    0.00%  1.4020us         3     467ns     137ns  1.0780us  cuDeviceGetCount
                    0.00%  1.3510us         2     675ns     393ns     958ns  cuDeviceTotalMem
                    0.00%     825ns         3     275ns     131ns     487ns  cuDriverGetVersion
                    0.00%     546ns         2     273ns     123ns     423ns  cuDeviceGet
                    0.00%     413ns         1     413ns     413ns     413ns  cuCtxGetCurrent
                    0.00%     289ns         1     289ns     289ns     289ns  cuDeviceComputeCapability
 OpenACC (excl):   77.88%  4.05840s      7200  563.67us  1.6060us  3.6766ms  acc_wait@layers.c:80
                   19.61%  1.02168s      7200  141.90us  1.9140us  1.4865ms  acc_wait@layers.c:60
                    0.67%  34.721ms      3600  9.6440us  5.7940us  799.19us  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.53%  27.615ms      3600  7.6700us  4.4860us  790.32us  acc_enqueue_launch@layers.c:80 (_8layers_c_conv_forward_80_gpu)
                    0.33%  17.189ms      3600  4.7740us  2.7330us  793.06us  acc_compute_construct@layers.c:60
                    0.30%  15.638ms      3600  4.3430us  2.3750us  811.45us  acc_compute_construct@layers.c:80
                    0.27%  14.234ms      3600  3.9530us  1.9170us  100.50us  acc_enter_data@layers.c:60
                    0.14%  7.3292ms      3600  2.0350us  1.1510us  18.505us  acc_enter_data@layers.c:80
                    0.14%  7.0746ms      3600  1.9650us     969ns  798.10us  acc_exit_data@layers.c:60
                    0.13%  6.5648ms      3600  1.8230us     942ns  19.837us  acc_exit_data@layers.c:80
                    0.01%  524.29us         1  524.29us  524.29us  524.29us  acc_device_init

==1668494== Unified Memory profiling result:
Device "Tesla V100-PCIE-32GB (0)"
   Count  Avg Size  Min Size  Max Size  Total Size  Total Time  Name
   15552  16.178KB  4.0000KB  0.9961MB  245.7109MB  53.10339ms  Host To Device
   22891  10.357KB  4.0000KB  448.00KB  231.5391MB  41.96643ms  Device To Host
    8166         -         -         -           -   1.425459s  Gpu page fault groups
      48         -         -         -           -  12.58382ms  Page throttles
    4006  4.0000KB  4.0000KB  4.0000KB  15.64844MB           -  Memory thrashes
       8  4.0000KB  4.0000KB  4.0000KB  32.00000KB           -  Remote mapping from device
Total CPU Page faults: 15929
Total CPU thrashes: 4006
Total CPU throttles: 34
Total remote mappings to CPU: 8

```

#### 50k images

```
$ ./cnn-cifar10
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.543385 seconds
Create Network time:0.001617 seconds
Load Network Parameters time:0.011314 seconds
Create Ouputs time:0.000627 seconds

Net Forward total time:239.967919 seconds
    Time for conv1: 93.458176 seconds
    Time for relu1: 12.831631 seconds
    Time for pool1: 3.626592 seconds
    Time for conv2: 70.340130 seconds
    Time for relu2: 10.607480 seconds
    Time for pool2: 2.829303 seconds
    Time for conv3: 33.426542 seconds
    Time for relu3: 6.589558 seconds
    Time for pool3: 1.100692 seconds
    Time for fc: 5.127136 seconds
    Time for softmax: 0.013117 seconds

  Conv: 197.224848 seconds
  ReLU: 30.028670 seconds
  Pool: 7.556587 seconds
  FC:   5.127136 seconds
  Softmax: 0.013117 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000695 seconds
Free memory time:0.021840 seconds
Total time:240.547397 seconds
END!
```