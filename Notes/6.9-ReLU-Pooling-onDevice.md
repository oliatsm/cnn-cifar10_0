# ReLU and Pooling Layer on Device

Data transfers and parallel

Input: All dataset on device, delete at the end
Outputs: O1-O9 create on device, update O9 for FC, delete at the end
Layer Data: ReLU and Pool, make_* on device, free_* delete

ReLU: parallel loop 
Pool: parallel loop, reduction(max)

```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(X[:],l[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         63, #pragma acc loop gang /* blockIdx.x */
         65, #pragma acc loop seq
         67, #pragma acc loop vector(128) /* threadIdx.x */
     65, Loop is parallelizable
     67, Loop is parallelizable
conv_forward:
     80, Generating present(l[:],Y[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         84, #pragma acc loop gang collapse(2) /* blockIdx.x */
         85,   /* blockIdx.x collapsed */
         87, #pragma acc loop worker(4) /* threadIdx.y */
         92, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         93, #pragma acc loop seq
         94, #pragma acc loop seq
        101, Vector barrier inserted for vector loop reduction
     87, Loop is parallelizable
     92, Loop is parallelizable
     93, Loop is parallelizable
     94, Loop is parallelizable
     99, FMA (fused multiply-add) instruction(s) generated
make_relu_layer:
    131, Generating enter data copyin(layer[:1])
relu_forward:
    136, Generating present(X[:],l[:],Y[:])
         Generating implicit firstprivate(i)
         Generating NVIDIA GPU code
        138, #pragma acc loop gang, vector(128) /* blockIdx.x threadIdx.x */
free_relu:
    148, Generating exit data delete(l[:1])
make_pool_layer:
    176, Generating enter data copyin(layer[:1])
pool_forward:
    181, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
        184, #pragma acc loop gang /* blockIdx.x */
        185, #pragma acc loop seq
        186, #pragma acc loop seq
        191, #pragma acc loop seq
        192, #pragma acc loop vector(128) /* threadIdx.x */
             Generating reduction(max:max)
    185, Loop carried dependence of Y-> prevents parallelization
         Loop carried backward dependence of Y-> prevents vectorization
    186, Loop carried dependence of Y-> prevents parallelization
         Loop carried backward dependence of Y-> prevents vectorization
    191, Loop is parallelizable
    192, Loop is parallelizable
free_pool:
    212, Generating exit data delete(l[:1])
fc_forward:
    249, FMA (fused multiply-add) instruction(s) generated
load_conv:
    307, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native  -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.688774 seconds
Create Network time:0.182666 seconds
Load Network Parameters time:0.008359 seconds
Create Ouputs time:0.000324 seconds

Net Forward total time:29.382484 seconds
    Time for conv1: 2.719469 seconds
    Time for relu1: 0.587285 seconds
    Time for pool1: 14.937806 seconds
    Time for conv2: 2.259674 seconds
    Time for relu2: 0.593400 seconds
    Time for pool2: 4.144960 seconds
    Time for conv3: 1.458763 seconds
    Time for relu3: 0.591770 seconds
    Time for pool3: 1.413455 seconds
    Time for fc: 0.222080 seconds
    Time for softmax: 0.012173 seconds

  Conv: 6.437907 seconds
  ReLU: 1.772455 seconds
  Pool: 20.496221 seconds
  FC:   0.222080 seconds
  Softmax: 0.012173 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001151 seconds
Free memory time:0.058985 seconds
Total time:30.322743 seconds
END!
```

### NV_ACC_TIME
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.690021 seconds
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Create Network time:0.300648 seconds
Load Network Parameters time:0.008507 seconds
Create Ouputs time:0.000352 seconds

Net Forward total time:32.688043 seconds
    Time for conv1: 3.258985 seconds
    Time for relu1: 0.818364 seconds
    Time for pool1: 15.190277 seconds
    Time for conv2: 2.737452 seconds
    Time for relu2: 0.817507 seconds
    Time for pool2: 4.370673 seconds
    Time for conv3: 1.935317 seconds
    Time for relu3: 0.819898 seconds
    Time for pool3: 1.643736 seconds
    Time for fc: 0.216804 seconds
    Time for softmax: 0.011256 seconds

  Conv: 7.931754 seconds
  ReLU: 2.455769 seconds
  Pool: 21.204686 seconds
  FC:   0.216804 seconds
  Softmax: 0.011256 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000721 seconds
Free memory time:0.040471 seconds
Total time:33.728764 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 253
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=253 max=28 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 194
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=194 max=34 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    61: compute region reached 150000 times
        61: kernel launched 150000 times
            grid: [960]  block: [128]
            elapsed time(us): total=1,961,060 max=58 min=11 avg=13
    61: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    80: compute region reached 150000 times
        80: kernel launched 150000 times
            grid: [160-512]  block: [32x4]
            elapsed time(us): total=4,967,291 max=485 min=19 avg=33
    80: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  make_relu_layer  NVIDIA  devicenum=0
    time(us): 10
    131: data region reached 3 times
        131: data copyin transfers: 3
             device time(us): total=10 max=4 min=3 avg=3
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  relu_forward  NVIDIA  devicenum=0
    time(us): 0
    136: compute region reached 150000 times
        136: kernel launched 150000 times
            grid: [1280]  block: [128]
            elapsed time(us): total=1,876,551 max=422 min=11 avg=12
    136: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  free_relu  NVIDIA  devicenum=0
    time(us): 0
    148: data region reached 3 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  make_pool_layer  NVIDIA  devicenum=0
    time(us): 9
    176: data region reached 3 times
        176: data copyin transfers: 3
             device time(us): total=9 max=3 min=3 avg=3
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  pool_forward  NVIDIA  devicenum=0
    time(us): 0
    181: compute region reached 150000 times
        181: kernel launched 150000 times
            grid: [720]  block: [128]
            elapsed time(us): total=20,616,655 max=3,545 min=28 avg=137
    181: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  free_pool  NVIDIA  devicenum=0
    time(us): 0
    212: data region reached 3 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 56
    307: update directive reached 3 times
        307: data copyin transfers: 6
             device time(us): total=56 max=22 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/main.c
  main  NVIDIA  devicenum=0
    time(us): 549,202
    178: data region reached 4 times
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=33 max=33 min=33 avg=33
        178: data copyin transfers: 1
             device time(us): total=141,081 max=141,081 min=141,081 avg=141,081
    219: update directive reached 50000 times
        219: data copyout transfers: 50000
             device time(us): total=408,121 max=68 min=6 avg=8
    233: data region reached 4 times
```
### nvprof

```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.689469 seconds
==3973897== NVPROF is profiling process 3973897, command: ./cnn-cifar10-profile
Create Network time:0.483967 seconds
Load Network Parameters time:0.007696 seconds
Create Ouputs time:0.000320 seconds

Net Forward total time:35.301434 seconds
    Time for conv1: 3.637009 seconds
    Time for relu1: 1.054694 seconds
    Time for pool1: 15.447631 seconds
    Time for conv2: 3.162368 seconds
    Time for relu2: 1.053837 seconds
    Time for pool2: 4.611720 seconds
    Time for conv3: 2.340631 seconds
    Time for relu3: 1.050423 seconds
    Time for pool3: 1.872574 seconds
    Time for fc: 0.222989 seconds
    Time for softmax: 0.013823 seconds

  Conv: 9.140008 seconds
  ReLU: 3.158954 seconds
  Pool: 21.931925 seconds
  FC:   0.222989 seconds
  Softmax: 0.013823 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000867 seconds
Free memory time:0.049053 seconds
Total time:36.532806 seconds
END!
==3973897== Profiling application: ./cnn-cifar10-profile
==3973897== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   79.82%  19.2718s    150000  128.48us  19.871us  326.33us  _8layers_c_pool_forward_181_gpu
                   14.96%  3.61131s    150000  24.075us  10.879us  39.391us  _8layers_c_conv_forward_80_gpu
                    2.22%  536.89ms    150000  3.5790us  2.9110us  13.504us  _8layers_c_pad_input_61_gpu
                    2.14%  516.12ms    150000  3.4400us  3.3910us  13.408us  _8layers_c_relu_forward_136_gpu
                    0.61%  146.91ms        37  3.9705ms     640ns  146.87ms  [CUDA memcpy HtoD]
                    0.26%  62.474ms     50000  1.2490us  1.2150us  2.0160us  [CUDA memcpy DtoH]
                    0.00%  2.6240us         1  2.6240us  2.6240us  2.6240us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   87.47%  26.0389s   1250022  20.830us  1.0280us  4.3255ms  cuStreamSynchronize
                    8.09%  2.40717s    600001  4.0110us  3.3290us  2.4831ms  cuLaunchKernel
                    1.85%  549.65ms     50000  10.992us  9.5620us  1.1546ms  cuMemcpyDtoHAsync
                    0.92%  275.13ms    900000     305ns     175ns  3.4732ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    0.59%  176.99ms         1  176.99ms  176.99ms  176.99ms  cuDevicePrimaryCtxRetain
                    0.49%  147.31ms        37  3.9813ms  2.5840us  147.06ms  cuMemcpyHtoDAsync
                    0.35%  103.19ms    600010     171ns     117ns  1.3065ms  cuDeviceGetAttribute
                    0.17%  49.318ms         1  49.318ms  49.318ms  49.318ms  cuMemHostAlloc
                    0.05%  15.272ms     50029     305ns     227ns  772.90us  cuPointerGetAttributes
                    0.01%  4.3924ms        30  146.41us  1.9240us  4.0859ms  cuMemAlloc
                    0.00%  1.2743ms         1  1.2743ms  1.2743ms  1.2743ms  cuMemAllocHost
                    0.00%  788.40us         2  394.20us  148.23us  640.17us  cuModuleLoadDataEx
                    0.00%  15.419us         6  2.5690us     343ns  12.498us  cuModuleGetFunction
                    0.00%  11.702us         1  11.702us  11.702us  11.702us  cuDeviceGetPCIBusId
                    0.00%  2.9850us         3     995ns     190ns  1.9190us  cuCtxSetCurrent
                    0.00%  2.4460us         3     815ns     285ns  1.8600us  cuDeviceGetCount
                    0.00%     944ns         3     314ns     166ns     525ns  cuDriverGetVersion
                    0.00%     746ns         2     373ns     190ns     556ns  cuDeviceGet
                    0.00%     592ns         1     592ns     592ns     592ns  cuDeviceComputeCapability
                    0.00%     506ns         1     506ns     506ns     506ns  cuCtxGetCurrent
 OpenACC (excl):  100.00%  1.7e+10s         4  4.2e+09s  15.412us  1.7e+10s  acc_enter_data@main.c:178
                    0.00%  20.0331s    300000  66.776us  1.6430us  2.5278ms  acc_wait@layers.c:181
                    0.00%  4.32993s    300000  14.433us  1.6260us  1.2632ms  acc_wait@layers.c:80
                    0.00%  1.26651s    300000  4.2210us  1.6300us  4.3505ms  acc_wait@layers.c:61
                    0.00%  1.23175s    300000  4.1050us  1.6530us  1.3532ms  acc_wait@layers.c:136
                    0.00%  797.50ms    150000  5.3160us  4.2860us  2.4849ms  acc_enqueue_launch@layers.c:61 (_8layers_c_pad_input_61_gpu)
                    0.00%  756.28ms    150000  5.0410us  4.2280us  2.3011ms  acc_enqueue_launch@layers.c:136 (_8layers_c_relu_forward_136_gpu)
                    0.00%  755.63ms    150000  5.0370us  4.2620us  2.2134ms  acc_enqueue_launch@layers.c:80 (_8layers_c_conv_forward_80_gpu)
                    0.00%  751.54ms    150000  5.0100us  4.2480us  1.5895ms  acc_enqueue_launch@layers.c:181 (_8layers_c_pool_forward_181_gpu)
                    0.00%  596.68ms     50000  11.933us  10.335us  1.3193ms  acc_enqueue_download@main.c:219 (O9[:L9->out_size])
                    0.00%  432.93ms    150000  2.8860us  2.3410us  3.4814ms  acc_compute_construct@layers.c:61
                    0.00%  427.16ms    150000  2.8470us  2.3450us  2.3264ms  acc_compute_construct@layers.c:136
                    0.00%  413.29ms    150000  2.7550us  2.3680us  1.3109ms  acc_compute_construct@layers.c:181
                    0.00%  299.65ms    150000  1.9970us  1.7230us  1.2239ms  acc_enter_data@layers.c:136
                    0.00%  296.57ms    150000  1.9770us  1.6970us  1.2442ms  acc_enter_data@layers.c:181
                    0.00%  274.65ms    150000  1.8310us  1.5340us  1.3555ms  acc_compute_construct@layers.c:80
                    0.00%  269.18ms    150000  1.7940us  1.4210us  1.4811ms  acc_enter_data@layers.c:61
                    0.00%  269.07ms    150000  1.7930us  1.5260us  870.48us  acc_exit_data@layers.c:136
                    0.00%  262.60ms    150000  1.7500us  1.4500us  1.9743ms  acc_exit_data@layers.c:181
                    0.00%  242.78ms    150000  1.6180us  1.3670us  1.3352ms  acc_enter_data@layers.c:80
                    0.00%  217.02ms    150000  1.4460us  1.1940us  1.3275ms  acc_exit_data@layers.c:80
                    0.00%  214.82ms    150000  1.4320us  1.2120us  19.999us  acc_exit_data@layers.c:61
                    0.00%  147.07ms         1  147.07ms  147.07ms  147.07ms  acc_enqueue_upload@main.c:178 (input[:50000][:3072])
                    0.00%  107.83ms     50000  2.1560us  1.7620us  849.37us  acc_wait@main.c:219
                    0.00%  88.332ms     50000  1.7660us  1.5120us  28.248us  acc_update@main.c:219
                    0.00%  49.868ms         9  5.5409ms  11.808us  49.488ms  acc_enter_data@layers.c:42
                    0.00%  1.2766ms         4  319.15us  4.1420us  1.2629ms  acc_exit_data@main.c:233
                    0.00%  726.10us         1  726.10us  726.10us  726.10us  acc_device_init@layers.c:42
                    0.00%  91.909us        18  5.1060us     874ns  32.524us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  82.336us         4  20.584us  1.7690us  74.969us  acc_wait@main.c:178
                    0.00%  78.756us        18  4.3750us     919ns  36.258us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  65.564us         9  7.2840us  4.4950us  12.972us  acc_wait@layers.c:42
                    0.00%  55.987us         3  18.662us  3.9420us  47.976us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  44.163us         1  44.163us  44.163us  44.163us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  39.335us         3  13.111us  7.7680us  16.976us  acc_enqueue_upload@layers.c:307 (l->weights[:l->weights_size])
                    0.00%  37.815us         3  12.605us  10.585us  14.553us  acc_enter_data@layers.c:176
                    0.00%  34.881us         9  3.8750us  1.5180us  9.0030us  acc_exit_data@layers.c:53
                    0.00%  31.908us         3  10.636us  7.2580us  12.616us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  31.497us         3  10.499us  6.9940us  13.407us  acc_enter_data@layers.c:131
                    0.00%  21.866us         3  7.2880us  3.6220us  9.3800us  acc_wait@layers.c:307
                    0.00%  18.233us         3  6.0770us  1.6790us  14.729us  acc_exit_data@layers.c:212
                    0.00%  14.901us         3  4.9670us  3.0110us  8.8070us  acc_update@layers.c:307
                    0.00%  14.822us         3  4.9400us  4.6730us  5.1420us  acc_wait@layers.c:131
                    0.00%  14.595us         3  4.8650us  3.7230us  6.4040us  acc_enqueue_upload@layers.c:131 (layer[:1])
                    0.00%  14.579us         3  4.8590us  4.8270us  4.9040us  acc_wait@layers.c:176
                    0.00%  11.197us         3  3.7320us  3.3690us  4.1470us  acc_enqueue_upload@layers.c:307 (l->bias[:l->out_depth])
                    0.00%  11.102us         3  3.7000us  3.6030us  3.7750us  acc_enqueue_upload@layers.c:176 (layer[:1])
                    0.00%  6.6670us         3  2.2220us  1.7110us  2.9100us  acc_exit_data@layers.c:148
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:131
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:176
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns        11       0ns       0ns       0ns  acc_alloc@main.c:178
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:131
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:176
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:212
                    0.00%       0ns        11       0ns       0ns       0ns  acc_create@main.c:178
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:148
                    0.00%       0ns        11       0ns       0ns       0ns  acc_delete@main.c:233
```

## Pool: gang collapse, worker, vector

```c
File: layers.c
181: void pool_forward(float* restrict X, Pool_Layer* l, float* restrict Y) {
182:   // For each output feature map
183: #pragma acc parallel loop present(X,l,Y) gang collapse(2)
184:   for (int m = 0; m < l->out_depth; m++) {
185:     for (int j = 0; j < l->out_height; j++) {
186:     #pragma acc loop worker
187:       for (int i = 0; i < l->out_width; i++) {
188:         int y_idx = i + l->out_width * (j + m * l->out_height); // Output index
189:         // Find Max in pooling filter
190:         float max = -INFINITY;
191:       #pragma acc loop reduction(max:max) vector
192:         for (int p_j = 0; p_j < l->pool_width; p_j++) {
193:           for (int p_i = 0; p_i < l->pool_width; p_i++) {
194:             int x_j = j * l->stride + p_j; // Input height index, increased by stride
195:             int x_i = i * l->stride + p_i; // Input width index, increased by stride
196:             int x_idx = x_i + (x_j + m * l->in_height) * l->in_width; // Input index
197:             if (X[x_idx] > max) {
198:               max = X[x_idx];
199:             } // if max
200:           } // for p_i
201:         } // for p_j
202:         Y[y_idx] = max;
203:       } // for i
204:     } // for j
205:   } // for m
206: }
```

```
pool_forward:
    181, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
        184, #pragma acc loop gang collapse(2) /* blockIdx.x */
        185,   /* blockIdx.x collapsed */
        187, #pragma acc loop worker(4) /* threadIdx.y */
        192, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(max:max)
        193, #pragma acc loop seq
        200, Vector barrier inserted for vector loop reduction
    187, Loop is parallelizable
    192, Loop is parallelizable
    193, Loop is parallelizable
```

```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.681201 seconds
Create Network time:0.217061 seconds
Load Network Parameters time:0.007862 seconds
Create Ouputs time:0.000339 seconds

Net Forward total time:29.209534 seconds
    Time for conv1: 2.702817 seconds
    Time for relu1: 0.570772 seconds
    Time for pool1: 14.954428 seconds
    Time for conv2: 2.230113 seconds
    Time for relu2: 0.569149 seconds
    Time for pool2: 4.130975 seconds
    Time for conv3: 1.426768 seconds
    Time for relu3: 0.573026 seconds
    Time for pool3: 1.393290 seconds
    Time for fc: 0.215348 seconds
    Time for softmax: 0.010809 seconds

  Conv: 6.359698 seconds
  ReLU: 1.712947 seconds
  Pool: 20.478694 seconds
  FC:   0.215348 seconds
  Softmax: 0.010809 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000763 seconds
Free memory time:0.040667 seconds
Total time:30.157427 seconds
END!
```

### nvprof
```
$ nvprof ./cnn-cifar10-profile 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.691482 seconds
==4012134== NVPROF is profiling process 4012134, command: ./cnn-cifar10-profile
Create Network time:0.503037 seconds
Load Network Parameters time:0.008599 seconds
Create Ouputs time:0.000351 seconds

Net Forward total time:17.050333 seconds
    Time for conv1: 3.821586 seconds
    Time for relu1: 1.064454 seconds
    Time for pool1: 1.209997 seconds
    Time for conv2: 3.275079 seconds
    Time for relu2: 1.092273 seconds
    Time for pool2: 1.051747 seconds
    Time for conv3: 2.418402 seconds
    Time for relu3: 1.075065 seconds
    Time for pool3: 0.986291 seconds
    Time for fc: 0.221699 seconds
    Time for softmax: 0.012725 seconds

  Conv: 9.515067 seconds
  ReLU: 3.231793 seconds
  Pool: 3.248035 seconds
  FC:   0.221699 seconds
  Softmax: 0.012725 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000745 seconds
Free memory time:0.050564 seconds
Total time:18.305110 seconds
END!
==4012134== Profiling application: ./cnn-cifar10-profile
==4012134== Profiling result:
            Type  Time(%)      Time     Calls       Avg       Min       Max  Name
 GPU activities:   65.14%  3.91941s    150000  26.129us  11.807us  39.904us  _8layers_c_conv_forward_80_gpu
                   12.52%  753.05ms    150000  5.0200us  3.0710us  13.631us  _8layers_c_pool_forward_181_gpu
                    9.63%  579.21ms    150000  3.8610us  3.1670us  13.536us  _8layers_c_pad_input_60_gpu
                    9.31%  560.45ms    150000  3.7360us  3.6790us  13.376us  _8layers_c_relu_forward_136_gpu
                    2.32%  139.47ms        37  3.7694ms     704ns  139.42ms  [CUDA memcpy HtoD]
                    1.08%  65.278ms     50000  1.3050us  1.2470us  2.0790us  [CUDA memcpy DtoH]
                    0.00%  2.6880us         1  2.6880us  2.6880us  2.6880us  _21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu
      API calls:   69.08%  7.96762s   1250022  6.3730us  1.0240us  3.4259ms  cuStreamSynchronize
                   20.63%  2.37979s    600001  3.9660us  3.2280us  2.7922ms  cuLaunchKernel
                    4.76%  549.24ms     50000  10.984us  9.8130us  1.8028ms  cuMemcpyDtoHAsync
                    1.49%  171.94ms    600000     286ns     180ns  4.8422ms  cuOccupancyMaxActiveBlocksPerMultiprocessor
                    1.47%  169.37ms         1  169.37ms  169.37ms  169.37ms  cuDevicePrimaryCtxRetain
                    1.21%  139.85ms        37  3.7798ms  2.6700us  139.60ms  cuMemcpyHtoDAsync
                    0.74%  85.718ms    600010     142ns     117ns  730.48us  cuDeviceGetAttribute
                    0.43%  50.129ms         1  50.129ms  50.129ms  50.129ms  cuMemHostAlloc
                    0.15%  16.865ms     50029     337ns     247ns  828.63us  cuPointerGetAttributes
                    0.01%  1.2369ms         1  1.2369ms  1.2369ms  1.2369ms  cuMemAllocHost
                    0.01%  745.96us         2  372.98us  147.22us  598.74us  cuModuleLoadDataEx
                    0.00%  569.26us        30  18.975us  1.9020us  267.35us  cuMemAlloc
                    0.00%  8.9160us         1  8.9160us  8.9160us  8.9160us  cuDeviceGetPCIBusId
                    0.00%  5.4060us         6     901ns     335ns  1.8300us  cuModuleGetFunction
                    0.00%  2.9460us         3     982ns     208ns  1.6720us  cuCtxSetCurrent
                    0.00%  1.3770us         3     459ns     172ns     964ns  cuDeviceGetCount
                    0.00%     901ns         3     300ns     161ns     493ns  cuDriverGetVersion
                    0.00%     796ns         2     398ns     161ns     635ns  cuDeviceGet
                    0.00%     546ns         1     546ns     546ns     546ns  cuCtxGetCurrent
                    0.00%     535ns         1     535ns     535ns     535ns  cuDeviceComputeCapability
 OpenACC (excl):  100.00%  1.7e+10s         4  4.2e+09s  16.627us  1.7e+10s  acc_enter_data@main.c:178
                    0.00%  4.68116s    300000  15.603us  1.6120us  3.4365ms  acc_wait@layers.c:80
                    0.00%  1.52108s    300000  5.0700us  1.6070us  1.3683ms  acc_wait@layers.c:181
                    0.00%  1.30421s    300000  4.3470us  1.6420us  1.0146ms  acc_wait@layers.c:60
                    0.00%  1.27272s    300000  4.2420us  1.6220us  3.2724ms  acc_wait@layers.c:136
                    0.00%  793.31ms    150000  5.2880us  4.2160us  2.7942ms  acc_enqueue_launch@layers.c:60 (_8layers_c_pad_input_60_gpu)
                    0.00%  758.20ms    150000  5.0540us  4.1690us  1.4891ms  acc_enqueue_launch@layers.c:136 (_8layers_c_relu_forward_136_gpu)
                    0.00%  742.60ms    150000  4.9500us  4.1230us  794.57us  acc_enqueue_launch@layers.c:181 (_8layers_c_pool_forward_181_gpu)
                    0.00%  741.22ms    150000  4.9410us  4.1060us  2.6217ms  acc_enqueue_launch@layers.c:80 (_8layers_c_conv_forward_80_gpu)
                    0.00%  588.46ms     50000  11.769us  10.559us  1.8070ms  acc_enqueue_download@main.c:219 (O9[:L9->out_size])
                    0.00%  441.39ms    150000  2.9420us  2.4460us  1.0603ms  acc_compute_construct@layers.c:60
                    0.00%  440.61ms    150000  2.9370us  2.3850us  7.8602ms  acc_compute_construct@layers.c:136
                    0.00%  319.88ms    150000  2.1320us  1.6880us  4.2626ms  acc_enter_data@layers.c:136
                    0.00%  298.93ms    150000  1.9920us  1.6460us  771.27us  acc_enter_data@layers.c:181
                    0.00%  270.67ms    150000  1.8040us  1.4000us  771.67us  acc_enter_data@layers.c:60
                    0.00%  267.81ms    150000  1.7850us  1.4820us  755.42us  acc_exit_data@layers.c:136
                    0.00%  263.85ms    150000  1.7580us  1.5830us  746.02us  acc_compute_construct@layers.c:181
                    0.00%  262.27ms    150000  1.7480us  1.5760us  762.35us  acc_compute_construct@layers.c:80
                    0.00%  250.97ms    150000  1.6730us  1.4350us  18.588us  acc_exit_data@layers.c:181
                    0.00%  239.04ms    150000  1.5930us  1.3980us  750.73us  acc_enter_data@layers.c:80
                    0.00%  228.40ms    150000  1.5220us  1.2360us  795.80us  acc_exit_data@layers.c:60
                    0.00%  206.56ms    150000  1.3770us  1.2300us  744.10us  acc_exit_data@layers.c:80
                    0.00%  139.60ms         1  139.60ms  139.60ms  139.60ms  acc_enqueue_upload@main.c:178 (input[:50000][:3072])
                    0.00%  97.230ms     50000  1.9440us  1.6960us  737.64us  acc_wait@main.c:219
                    0.00%  94.812ms     50000  1.8960us  1.4510us  786.53us  acc_update@main.c:219
                    0.00%  50.758ms         9  5.6397ms  8.2920us  50.323ms  acc_enter_data@layers.c:42
                    0.00%  1.0372ms         4  259.30us  3.7960us  1.0247ms  acc_exit_data@main.c:233
                    0.00%  685.11us         1  685.11us  685.11us  685.11us  acc_device_init@layers.c:42
                    0.00%  99.221us        18  5.5120us  1.0550us  32.072us  acc_enqueue_upload@layers.c:42 (.attach.)
                    0.00%  81.465us        18  4.5250us     917ns  36.259us  acc_enqueue_upload@layers.c:53 (.detach.)
                    0.00%  80.847us         4  20.211us  1.8330us  74.343us  acc_wait@main.c:178
                    0.00%  63.318us         9  7.0350us  4.5220us  11.324us  acc_wait@layers.c:42
                    0.00%  59.063us         3  19.687us  4.4000us  50.073us  acc_enqueue_upload@layers.c:42 (layer[:1])
                    0.00%  55.680us         9  6.1860us  1.6500us  26.776us  acc_exit_data@layers.c:53
                    0.00%  44.018us         3  14.672us  14.379us  14.910us  acc_enter_data@layers.c:176
                    0.00%  43.978us         3  14.659us  13.562us  16.137us  acc_enter_data@layers.c:131
                    0.00%  40.811us         3  13.603us  7.1730us  17.365us  acc_enqueue_upload@layers.c:308 (l->weights[:l->weights_size])
                    0.00%  34.108us         3  11.369us  8.2500us  13.461us  acc_enqueue_upload@layers.c:42 (layer->in_padded[:layer->padded_size])
                    0.00%  32.309us         1  32.309us  32.309us  32.309us  acc_enqueue_launch@(runtime):44 (_21______src_cuda_fill_c___pgi_uacc_cuda_fill_44_gpu)
                    0.00%  25.140us         3  8.3800us  1.7710us  21.590us  acc_exit_data@layers.c:213
                    0.00%  21.646us         3  7.2150us  3.8980us  9.1020us  acc_wait@layers.c:308
                    0.00%  14.895us         3  4.9650us  3.5040us  7.8210us  acc_update@layers.c:308
                    0.00%  14.341us         3  4.7800us  4.6020us  5.1250us  acc_wait@layers.c:131
                    0.00%  13.917us         3  4.6390us  4.6110us  4.6750us  acc_wait@layers.c:176
                    0.00%  13.891us         3  4.6300us  4.4350us  4.9700us  acc_enqueue_upload@layers.c:131 (layer[:1])
                    0.00%  13.648us         3  4.5490us  4.3990us  4.7300us  acc_enqueue_upload@layers.c:176 (layer[:1])
                    0.00%  10.918us         3  3.6390us  3.4930us  3.8750us  acc_enqueue_upload@layers.c:308 (l->bias[:l->out_depth])
                    0.00%  6.9830us         3  2.3270us  1.8190us  3.3270us  acc_exit_data@layers.c:148
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:131
                    0.00%       0ns         3       0ns       0ns       0ns  acc_create@layers.c:176
                    0.00%       0ns        12       0ns       0ns       0ns  acc_delete@layers.c:53
                    0.00%       0ns        11       0ns       0ns       0ns  acc_alloc@main.c:178
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:131
                    0.00%       0ns         3       0ns       0ns       0ns  acc_alloc@layers.c:176
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:213
                    0.00%       0ns        11       0ns       0ns       0ns  acc_create@main.c:178
                    0.00%       0ns        12       0ns       0ns       0ns  acc_alloc@layers.c:42
                    0.00%       0ns        12       0ns       0ns       0ns  acc_create@layers.c:42
                    0.00%       0ns         3       0ns       0ns       0ns  acc_delete@layers.c:148
                    0.00%       0ns        11       0ns       0ns       0ns  acc_delete@main.c:233
```

### NV_ACC_TIME

```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.684536 seconds
CUPTI ERROR: cuptiActivityEnable(CUPTI_ACTIVITY_KIND_KERNEL) returned: CUPTI_ERROR_INSUFFICIENT_PRIVILEGES, 
         at ../../src-cupti/prof_cuda_cupti.c:338.
Create Network time:0.322954 seconds
Load Network Parameters time:0.008530 seconds
Create Ouputs time:0.000341 seconds

Net Forward total time:13.975697 seconds
    Time for conv1: 3.235160 seconds
    Time for relu1: 0.813520 seconds
    Time for pool1: 0.966655 seconds
    Time for conv2: 2.712527 seconds
    Time for relu2: 0.810970 seconds
    Time for pool2: 0.831626 seconds
    Time for conv3: 1.916957 seconds
    Time for relu3: 0.815018 seconds
    Time for pool3: 0.769663 seconds
    Time for fc: 0.216883 seconds
    Time for softmax: 0.011087 seconds

  Conv: 7.864644 seconds
  ReLU: 2.439508 seconds
  Pool: 2.567945 seconds
  FC:   0.216883 seconds
  Softmax: 0.011087 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000769 seconds
Free memory time:0.042431 seconds
Total time:15.035259 seconds
END!

Accelerator Kernel Timing data
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 261
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=261 max=40 min=3 avg=10
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 213
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=213 max=42 min=3 avg=11
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 0
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [960]  block: [128]
            elapsed time(us): total=1,944,836 max=2,501 min=11 avg=12
    60: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 0
    80: compute region reached 150000 times
        80: kernel launched 150000 times
            grid: [160-512]  block: [32x4]
            elapsed time(us): total=4,937,698 max=3,155 min=19 avg=32
    80: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  make_relu_layer  NVIDIA  devicenum=0
    time(us): 9
    131: data region reached 3 times
        131: data copyin transfers: 3
             device time(us): total=9 max=3 min=3 avg=3
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  relu_forward  NVIDIA  devicenum=0
    time(us): 0
    136: compute region reached 150000 times
        136: kernel launched 150000 times
            grid: [1280]  block: [128]
            elapsed time(us): total=1,870,346 max=446 min=11 avg=12
    136: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  free_relu  NVIDIA  devicenum=0
    time(us): 0
    148: data region reached 3 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  make_pool_layer  NVIDIA  devicenum=0
    time(us): 11
    176: data region reached 3 times
        176: data copyin transfers: 3
             device time(us): total=11 max=4 min=3 avg=3
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  pool_forward  NVIDIA  devicenum=0
    time(us): 0
    181: compute region reached 150000 times
        181: kernel launched 150000 times
            grid: [80-256]  block: [32x4]
            elapsed time(us): total=2,034,016 max=335 min=11 avg=13
    181: data region reached 300000 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  free_pool  NVIDIA  devicenum=0
    time(us): 0
    213: data region reached 3 times
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 59
    308: update directive reached 3 times
        308: data copyin transfers: 6
             device time(us): total=59 max=24 min=3 avg=9
/home/olia/Diplomatiki/cnn-cifar10_0/serial2parallel-relu/main.c
  main  NVIDIA  devicenum=0
    time(us): 557,486
    178: data region reached 4 times
        44: kernel launched 1 time
            grid: [391]  block: [128]
            elapsed time(us): total=24 max=24 min=24 avg=24
        178: data copyin transfers: 1
             device time(us): total=143,574 max=143,574 min=143,574 avg=143,574
    219: update directive reached 50000 times
        219: data copyout transfers: 50000
             device time(us): total=413,912 max=98 min=6 avg=8
    233: data region reached 4 times
```