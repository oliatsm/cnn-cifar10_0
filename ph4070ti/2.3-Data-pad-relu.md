# Data Pad

## Code
```c
void pad_input(float* restrict X, Conv_Layer* l) {
#pragma acc parallel loop present(X,l)
  for ( int c = 0; c < l->in_depth; c++) {
    #pragma acc loop
    for (int j = 0; j < l->in_height; j++) {
      #pragma acc loop
      for (int i = 0; i < l->in_width; i++) {
        ...
}
    
void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {

  int in_size = l->in_width*l->in_height*l->in_depth;
#pragma acc data copyin(X[0:in_size]) present(l) copyout(Y[0:l->out_size])
{
    pad_input(X, l); //Create input with zero-padding
   // For each output feature map
#pragma acc parallel loop  
    for ( int m = 0; m < l->out_depth; m++) {
      #pragma acc loop
      for (int j = 0; j < l->out_height; j++) {
       #pragma acc loop
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); 
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
        #pragma acc loop  reduction(+:sum) 
          for (int c = 0; c < l->in_depth; c++) {
           ...
  }//acc data
}

```

## Minfo
```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -c main.c -o main.o
arr2txt:
    332, Zero trip check eliminated
arr2txt_2:
    354, Zero trip check eliminated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -c layers.c -o layers.o
make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(l[:],X[:])
         Generating NVIDIA GPU code
         62, #pragma acc loop gang /* blockIdx.x */
         64, #pragma acc loop seq
         66, #pragma acc loop vector(128) /* threadIdx.x */
     64, Loop is parallelizable
     66, Loop is parallelizable
conv_forward:
     82, Generating present(l[:])
         Generating copyout(Y[:l->out_size]) [if not already present]
         Generating copyin(X[:in_size]) [if not already present]
     83, Generating NVIDIA GPU code
         86, #pragma acc loop gang /* blockIdx.x */
         88, #pragma acc loop seq
         90, #pragma acc loop seq
         95, #pragma acc loop seq
         96, #pragma acc loop seq
         97, #pragma acc loop vector(128) /* threadIdx.x */
             Generating reduction(+:sum)
     88, Loop is parallelizable
     90, Loop is parallelizable
     95, Loop is parallelizable
     96, Loop is parallelizable
     97, Loop is parallelizable
    102, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    185, Zero trip check eliminated
fc_forward:
    240, FMA (fused multiply-add) instruction(s) generated
load_conv:
    302, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -c malloc2D.c -o malloc2D.o
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -c timer.c -o timer.o
cpu_timer_stop:
     11, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```

## Execution
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Load Data time:0.408148 seconds
Create Network time:0.112206 seconds
Load Network Parameters time:0.012719 seconds
Create Ouputs time:0.000158 seconds

Net Forward total time:93.606754 seconds
    Time for conv1: 50.610879 seconds
    Time for relu1: 0.217270 seconds
    Time for pool1: 0.573588 seconds
    Time for conv2: 31.396484 seconds
    Time for relu2: 0.079625 seconds
    Time for pool2: 0.188580 seconds
    Time for conv3: 10.323737 seconds
    Time for relu3: 0.026027 seconds
    Time for pool3: 0.048227 seconds
    Time for fc: 0.123704 seconds
    Time for softmax: 0.006182 seconds

  Conv: 92.331101 seconds
  ReLU: 0.322922 seconds
  Pool: 0.810395 seconds
  FC:   0.123704 seconds
  Softmax: 0.006182 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000254 seconds
Free memory time:0.031054 seconds
Total time:94.171293 seconds
```

## nsys

# Data Pad, ReLU & Pooling on Device

## Code

## Minfo
```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -c layers.c -o layers.o
"layers.c", line 80: warning: variable "in_size" was declared but never referenced [declared_but_not_referenced]
    int in_size = l->in_width*l->in_height*l->in_depth;
        ^

Remark: individual warnings can be suppressed with "--diag_suppress <warning-name>"

make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(l[:],X[:])
         Generating NVIDIA GPU code
         62, #pragma acc loop gang /* blockIdx.x */
         64, #pragma acc loop seq
         66, #pragma acc loop vector(128) /* threadIdx.x */
     64, Loop is parallelizable
     66, Loop is parallelizable
conv_forward:
     83, Generating present(Y[:],l[:],X[:])
         Generating NVIDIA GPU code
         86, #pragma acc loop gang /* blockIdx.x */
         88, #pragma acc loop seq
         90, #pragma acc loop seq
         95, #pragma acc loop seq
         96, #pragma acc loop seq
         97, #pragma acc loop vector(128) /* threadIdx.x */
             Generating reduction(+:sum)
     88, Loop is parallelizable
     90, Loop is parallelizable
     95, Loop is parallelizable
     96, Loop is parallelizable
     97, Loop is parallelizable
    102, FMA (fused multiply-add) instruction(s) generated
make_relu_layer:
    134, Generating enter data copyin(layer[:1])
relu_forward:
    139, Generating present(Y[:],l[:],X[:])
         Generating NVIDIA GPU code
        141, #pragma acc loop gang, vector(128) /* blockIdx.x threadIdx.x */
free_relu:
    151, Generating exit data delete(l[:1])
make_pool_layer:
    178, Generating enter data copyin(layer[:1])
pool_forward:
    183, Generating present(Y[:],l[:],X[:])
         Generating NVIDIA GPU code
        186, #pragma acc loop gang /* blockIdx.x */
        188, #pragma acc loop seq
        190, #pragma acc loop seq
        195, #pragma acc loop seq
        196, #pragma acc loop vector(128) /* threadIdx.x */
             Generating reduction(max:max)
    188, Loop is parallelizable
    190, Loop is parallelizable
    195, Loop is parallelizable
    196, Loop is parallelizable
free_pool:
    215, Generating exit data delete(l[:1])
fc_forward:
    252, FMA (fused multiply-add) instruction(s) generated
load_conv:
    314, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```

## Execution
```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.605806 seconds
Create Network time:0.000219 seconds
Load Network Parameters time:0.003364 seconds
Create Ouputs time:0.000160 seconds

Net Forward total time:103.209293 seconds
    Time for conv1: 49.260589 seconds
    Time for relu1: 0.365806 seconds
    Time for pool1: 8.811698 seconds
    Time for conv2: 30.416565 seconds
    Time for relu2: 0.362382 seconds
    Time for pool2: 2.484070 seconds
    Time for conv3: 9.673255 seconds
    Time for relu3: 0.360799 seconds
    Time for pool3: 0.886709 seconds
    Time for fc: 0.130200 seconds
    Time for softmax: 0.005671 seconds

  Conv: 89.350409 seconds
  ReLU: 1.088987 seconds
  Pool: 12.182477 seconds
  FC:   0.130200 seconds
  Softmax: 0.005671 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000262 seconds
Free memory time:0.031686 seconds
Total time:103.850790 seconds
END!
```
## nsys