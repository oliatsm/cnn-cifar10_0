# Kernels Independent

## Code 
```c
46: void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
  
    // For each output feature map
  #pragma acc kernels 
  {
    #pragma acc loop independent
    for (int m = 0; m < l->out_depth; m++) {
      #pragma acc loop independent
      for (int j = 0; j < l->out_height; j++) {
        #pragma acc loop independent
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); 
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
          #pragma acc loop reduction(+:sum) 
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
```

## Minfo

```
$ make
nvc -acc=gpu -gpu=managed -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
conv_forward:
     50, Generating implicit copy(Y[:]) [if not already present]
         Generating implicit copyin(l,X[:]) [if not already present]
     52, Loop is parallelizable
         Generating NVIDIA GPU code
         52, #pragma acc loop gang, vector(128) /* blockIdx.x threadIdx.x */
         54, #pragma acc loop seq
         56, #pragma acc loop seq
         61, #pragma acc loop seq collapse(3)
         62,   auto-collapsed */
         63,   auto-collapsed */
     54, Loop is parallelizable
     56, Loop is parallelizable
     61, Loop is parallelizable
     62, Loop is parallelizable
     63, Loop is parallelizable
pool_forward:
    155, Zero trip check eliminated
fc_forward:
    210, FMA (fused multiply-add) instruction(s) generated
nvc -acc=gpu -gpu=managed -Minfo=all -c11 -Wall -Wextra -march=native  -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```

## Execution

```
$ ./cnn-cifar10 
Parallel (if) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.272896 seconds
Create Network time:0.000312 seconds
Load Network Parameters time:0.003304 seconds
Create Ouputs time:0.000273 seconds

Net Forward total time:409.086217 seconds
    Time for conv1: 131.702955 seconds
    Time for relu1: 8.351947 seconds
    Time for pool1: 3.743111 seconds
    Time for conv2: 197.052602 seconds
    Time for relu2: 6.056559 seconds
    Time for pool2: 1.315422 seconds
    Time for conv3: 55.188404 seconds
    Time for relu3: 4.169697 seconds
    Time for pool3: 0.379354 seconds
    Time for fc: 1.103756 seconds
    Time for softmax: 0.009819 seconds

  Conv: 383.943962 seconds
  ReLU: 18.578204 seconds
  Pool: 5.437888 seconds
  FC:   1.103756 seconds
  Softmax: 0.009819 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000277 seconds
Free memory time:0.016528 seconds
Total time:409.379807 seconds
END!
```

## Profiling
## nc_acc

```
$ ./cnn-cifar10 
Parallel (if) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.273413 seconds
Create Network time:0.000294 seconds
Load Network Parameters time:0.003293 seconds
Create Ouputs time:0.000276 seconds

Net Forward total time:410.174451 seconds
    Time for conv1: 132.103772 seconds
    Time for relu1: 8.392358 seconds
    Time for pool1: 3.736079 seconds
    Time for conv2: 197.271065 seconds
    Time for relu2: 6.505940 seconds
    Time for pool2: 0.873340 seconds
    Time for conv3: 55.563786 seconds
    Time for relu3: 4.223308 seconds
    Time for pool3: 0.376135 seconds
    Time for fc: 1.106002 seconds
    Time for softmax: 0.009835 seconds

  Conv: 384.938623 seconds
  ReLU: 19.121607 seconds
  Pool: 4.985554 seconds
  FC:   1.106002 seconds
  Softmax: 0.009835 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000271 seconds
Free memory time:0.016523 seconds
Total time:410.468521 seconds
END!

Accelerator Kernel Timing data
/home/gskondras/cifar/cnn-cifar10_0/1.1-Kernels/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 382,607,671
    50: compute region reached 150000 times
        52: kernel launched 150000 times
            grid: [1]  block: [128]
             device time(us): total=382,607,671 max=4,381 min=1,066 avg=2,550
            elapsed time(us): total=384,420,450 max=4,395 min=1,077 avg=2,562
    50: data region reached 300000 times
```
```
                     Call graph (explanation follows)


granularity: each sample hit covers 4 byte(s) for 0.04% of 25.43 seconds

index % time    self  children    called     name
                                                 <spontaneous>
[1]    100.0    0.00   25.43                 main [1]
               18.90    0.00  150000/150000      relu_forward [2]
                5.12    0.00  150000/150000      pool_forward [3]
                1.09    0.00   50000/50000       fc_forward [4]
                0.27    0.00       1/1           load_data [5]
                0.04    0.00  150000/150000      conv_forward [6]
                0.01    0.00  550007/550007      cpu_timer_stop [7]
                0.00    0.00  550007/550007      cpu_timer_start [8]
                0.00    0.00   50000/50000       softmax_forward [9]
                0.00    0.00       3/3           make_conv_layer [14]
                0.00    0.00       3/3           make_relu_layer [16]
                0.00    0.00       3/3           make_pool_layer [15]
                0.00    0.00       3/3           load_conv [13]
                0.00    0.00       3/3           free_pool [11]
                0.00    0.00       3/3           free_conv [10]
                0.00    0.00       3/3           free_relu [12]
                0.00    0.00       2/2           malloc2D [17]
                0.00    0.00       1/1           make_fc_layer [21]
                0.00    0.00       1/1           make_softmax_layer [22]
                0.00    0.00       1/1           load_fc [20]
                0.00    0.00       1/1           free_softmax [19]
                0.00    0.00       1/1           free_fc [18]
-----------------------------------------------
               18.90    0.00  150000/150000      main [1]
[2]     74.3   18.90    0.00  150000         relu_forward [2]
-----------------------------------------------
                5.12    0.00  150000/150000      main [1]
[3]     20.1    5.12    0.00  150000         pool_forward [3]
-----------------------------------------------
                1.09    0.00   50000/50000       main [1]
[4]      4.3    1.09    0.00   50000         fc_forward [4]
-----------------------------------------------
                0.27    0.00       1/1           main [1]
[5]      1.1    0.27    0.00       1         load_data [5]
-----------------------------------------------
                0.04    0.00  150000/150000      main [1]
[6]      0.2    0.04    0.00  150000         conv_forward [6]
-----------------------------------------------
                0.01    0.00  550007/550007      main [1]
[7]      0.0    0.01    0.00  550007         cpu_timer_stop [7]
-----------------------------------------------
                0.00    0.00  550007/550007      main [1]
[8]      0.0    0.00    0.00  550007         cpu_timer_start [8]
-----------------------------------------------
                0.00    0.00   50000/50000       main [1]
[9]      0.0    0.00    0.00   50000         softmax_forward [9]
-----------------------------------------------
                0.00    0.00       3/3           main [1]
[10]     0.0    0.00    0.00       3         free_conv [10]
-----------------------------------------------
                0.00    0.00       3/3           main [1]
[11]     0.0    0.00    0.00       3         free_pool [11]
-----------------------------------------------
                0.00    0.00       3/3           main [1]
[12]     0.0    0.00    0.00       3         free_relu [12]
-----------------------------------------------
                0.00    0.00       3/3           main [1]
[13]     0.0    0.00    0.00       3         load_conv [13]
-----------------------------------------------
                0.00    0.00       3/3           main [1]
[14]     0.0    0.00    0.00       3         make_conv_layer [14]
-----------------------------------------------
                0.00    0.00       3/3           main [1]
[15]     0.0    0.00    0.00       3         make_pool_layer [15]
-----------------------------------------------
                0.00    0.00       3/3           main [1]
[16]     0.0    0.00    0.00       3         make_relu_layer [16]
-----------------------------------------------
                0.00    0.00       2/2           main [1]
[17]     0.0    0.00    0.00       2         malloc2D [17]
-----------------------------------------------
                0.00    0.00       1/1           main [1]
[18]     0.0    0.00    0.00       1         free_fc [18]
-----------------------------------------------
                0.00    0.00       1/1           main [1]
[19]     0.0    0.00    0.00       1         free_softmax [19]
-----------------------------------------------
                0.00    0.00       1/1           main [1]
[20]     0.0    0.00    0.00       1         load_fc [20]
-----------------------------------------------
                0.00    0.00       1/1           main [1]
[21]     0.0    0.00    0.00       1         make_fc_layer [21]
-----------------------------------------------
                0.00    0.00       1/1           main [1]
[22]     0.0    0.00    0.00       1         make_softmax_layer [22]
-----------------------------------------------

Index by function name

   [6] conv_forward           [12] free_relu              [15] make_pool_layer
   [8] cpu_timer_start        [19] free_softmax           [16] make_relu_layer
   [7] cpu_timer_stop         [13] load_conv              [22] make_softmax_layer
   [4] fc_forward              [5] load_data              [17] malloc2D
  [10] free_conv              [20] load_fc                 [3] pool_forward
  [18] free_fc                [14] make_conv_layer         [2] relu_forward
  [11] free_pool              [21] make_fc_layer           [9] softmax_forward
```
