# Loop Opt Conv
## copyin x, copyout y, present l, on conv_forward

$ export NV_ACC_TIME=1

```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -c main.c -o main.o
arr2txt:
    332, Zero trip check eliminated
arr2txt_2:
    354, Zero trip check eliminated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -c layers.c -o layers.o
make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(X[:],l[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         63, #pragma acc loop gang /* blockIdx.x */
         65, #pragma acc loop vector(128) collapse(2) /* threadIdx.x */
         66,   /* threadIdx.x collapsed */
     65, Loop is parallelizable
     66, Loop is parallelizable
conv_forward:
     82, Generating present(l[:])
         Generating copyout(Y[:l->out_size]) [if not already present]
         Generating copyin(X[:in_size]) [if not already present]
     83, Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         86, #pragma acc loop gang collapse(3) /* blockIdx.x */
         87,   /* blockIdx.x collapsed */
         88,   /* blockIdx.x collapsed */
         93, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         94, #pragma acc loop seq
         95, #pragma acc loop seq
     93, Loop is parallelizable
     94, Loop is parallelizable
     95, Loop is parallelizable
    100, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    183, Zero trip check eliminated
fc_forward:
    238, FMA (fused multiply-add) instruction(s) generated
load_conv:
    300, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -c malloc2D.c -o malloc2D.o
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -c timer.c -o timer.o
cpu_timer_stop:
     11, FMA (fused multiply-add) instruction(s) generated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -o cnn-cifar10 main.o layers.o malloc2D.o timer.o


$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Load Data time:0.372975 seconds
Create Network time:0.143019 seconds
Load Network Parameters time:0.003389 seconds
Create Ouputs time:0.000158 seconds

Net Forward total time:12.289634 seconds
    Time for conv1: 4.637900 seconds
    Time for relu1: 0.312542 seconds
    Time for pool1: 0.601098 seconds
    Time for conv2: 3.488303 seconds
    Time for relu2: 0.113247 seconds
    Time for pool2: 0.208803 seconds
    Time for conv3: 2.687712 seconds
    Time for relu3: 0.036407 seconds
    Time for pool3: 0.062087 seconds
    Time for fc: 0.123482 seconds
    Time for softmax: 0.005632 seconds

  Conv: 10.813916 seconds
  ReLU: 0.462196 seconds
  Pool: 0.871988 seconds
  FC:   0.123482 seconds
  Softmax: 0.005632 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000309 seconds
Free memory time:0.031722 seconds
Total time:12.841205 seconds
END!

Accelerator Kernel Timing data
/home/gskondras/cifar/cnn-cifar10_0/3.1-Data-pad-opt/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 174
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=174 max=21 min=2 avg=7
/home/gskondras/cifar/cnn-cifar10_0/3.1-Data-pad-opt/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 98
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=98 max=16 min=2 avg=5
/home/gskondras/cifar/cnn-cifar10_0/3.1-Data-pad-opt/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 338,371
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [540]  block: [128]
             device time(us): total=338,371 max=3 min=1 avg=2
            elapsed time(us): total=1,688,483 max=435 min=9 avg=11
    60: data region reached 300000 times
/home/gskondras/cifar/cnn-cifar10_0/3.1-Data-pad-opt/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 5,165,180
    82: data region reached 300000 times
        82: data copyin transfers: 150000
             device time(us): total=714,458 max=21 min=3 avg=4
        109: data copyout transfers: 150000
             device time(us): total=1,708,482 max=48 min=5 avg=11
    83: compute region reached 150000 times
        83: kernel launched 150000 times
            grid: [1280-16384]  block: [32]
             device time(us): total=2,742,240 max=32 min=7 avg=18
            elapsed time(us): total=3,955,350 max=50 min=15 avg=26
/home/gskondras/cifar/cnn-cifar10_0/3.1-Data-pad-opt/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 36
    300: update directive reached 3 times
        300: data copyin transfers: 6
             device time(us): total=36 max=13 min=2 avg=6
```

## update self(O3,O7) device(O1,O4,O6) enter data input

```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -c main.c -o main.o
main:
    121, Generating enter data copyin(input[:50000][:3072])
    181, Generating enter data create(O2[:L2->out_size],O1[:L1->out_size],O5[:L5->out_size],O4[:L4->out_size],O3[:L3->out_size],O9[:L9->out_size],O8[:L8->out_size],O7[:L7->out_size],O6[:L6->out_size])
    188, Generating update self(O1[:L1->out_size])
    196, Generating update device(O3[:L3->out_size])
    200, Generating update self(O4[:L4->out_size])
    208, Generating update device(O6[:L6->out_size])
    212, Generating update self(O7[:L7->out_size])
arr2txt:
    339, Zero trip check eliminated
arr2txt_2:
    361, Zero trip check eliminated
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
gskondras@ph4070ti:~/cifar/cnn-cifar10_0/3.1.2-Data-pad-opt$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -c layers.c -o layers.o
make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(X[:],l[:])
         Generating implicit firstprivate(c)
         Generating NVIDIA GPU code
         63, #pragma acc loop gang /* blockIdx.x */
         65, #pragma acc loop vector(128) collapse(2) /* threadIdx.x */
         66,   /* threadIdx.x collapsed */
     65, Loop is parallelizable
     66, Loop is parallelizable
conv_forward:
     83, Generating present(Y[:],l[:],X[:])
         Generating implicit firstprivate(m)
         Generating NVIDIA GPU code
         86, #pragma acc loop gang collapse(3) /* blockIdx.x */
         87,   /* blockIdx.x collapsed */
         88,   /* blockIdx.x collapsed */
         93, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         94, #pragma acc loop seq
         95, #pragma acc loop seq
     93, Loop is parallelizable
     94, Loop is parallelizable
     95, Loop is parallelizable
    100, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    183, Zero trip check eliminated
fc_forward:
    238, FMA (fused multiply-add) instruction(s) generated
load_conv:
    300, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
gskondras@ph4070ti:~/cifar/cnn-cifar10_0/3.1.2-Data-pad-opt$ ./cnn-cifar10
Parallel (pad) Code
CNN for 50000 images
Load Data time:0.556749 seconds
Create Network time:0.031082 seconds
Load Network Parameters time:0.003386 seconds
Create Ouputs time:0.000162 seconds

Net Forward total time:8.072138 seconds
    Time for conv1: 2.130584 seconds
    Time for relu1: 0.240875 seconds
    Time for pool1: 0.601550 seconds
    Time for conv2: 1.373653 seconds
    Time for relu2: 0.081231 seconds
    Time for pool2: 0.212859 seconds
    Time for conv3: 0.893718 seconds
    Time for relu3: 0.032215 seconds
    Time for pool3: 0.060870 seconds
    Time for fc: 0.123119 seconds
    Time for softmax: 0.005609 seconds

  Conv: 4.397954 seconds
  ReLU: 0.354321 seconds
  Pool: 0.875279 seconds
  FC:   0.123119 seconds
  Softmax: 0.005609 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000249 seconds
Free memory time:0.030422 seconds
Total time:8.694188 seconds
END!

$ ./cnn-cifar10
Parallel (pad) Code
CNN for 50000 images
Load Data time:0.596442 seconds
Create Network time:0.031216 seconds
Load Network Parameters time:0.003457 seconds
Create Ouputs time:0.000164 seconds

Net Forward total time:11.678340 seconds
    Time for conv1: 2.862633 seconds
    Time for relu1: 0.221149 seconds
    Time for pool1: 0.608568 seconds
    Time for conv2: 2.104681 seconds
    Time for relu2: 0.079772 seconds
    Time for pool2: 0.214278 seconds
    Time for conv3: 1.621423 seconds
    Time for relu3: 0.031010 seconds
    Time for pool3: 0.062141 seconds
    Time for fc: 0.123090 seconds
    Time for softmax: 0.006733 seconds

  Conv: 6.588737 seconds
  ReLU: 0.331931 seconds
  Pool: 0.884987 seconds
  FC:   0.123090 seconds
  Softmax: 0.006733 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000271 seconds
Free memory time:0.031677 seconds
Total time:12.341567 seconds
END!

Accelerator Kernel Timing data
/home/gskondras/cifar/cnn-cifar10_0/3.1.2-Data-pad-opt/layers.c
  make_conv_layer  NVIDIA  devicenum=0
    time(us): 161
    42: data region reached 9 times
        42: data copyin transfers: 24
             device time(us): total=161 max=19 min=2 avg=6
/home/gskondras/cifar/cnn-cifar10_0/3.1.2-Data-pad-opt/layers.c
  free_conv  NVIDIA  devicenum=0
    time(us): 107
    53: data region reached 9 times
        53: data copyin transfers: 18
             device time(us): total=107 max=11 min=2 avg=5
/home/gskondras/cifar/cnn-cifar10_0/3.1.2-Data-pad-opt/layers.c
  pad_input  NVIDIA  devicenum=0
    time(us): 377,303
    60: compute region reached 150000 times
        60: kernel launched 150000 times
            grid: [540]  block: [128]
             device time(us): total=377,303 max=5 min=1 avg=2
            elapsed time(us): total=1,736,459 max=34 min=9 avg=11
    60: data region reached 300000 times
/home/gskondras/cifar/cnn-cifar10_0/3.1.2-Data-pad-opt/layers.c
  conv_forward  NVIDIA  devicenum=0
    time(us): 2,745,452
    83: compute region reached 150000 times
        83: kernel launched 150000 times
            grid: [1280-16384]  block: [32]
             device time(us): total=2,745,452 max=32 min=7 avg=18
            elapsed time(us): total=3,987,522 max=433 min=15 avg=26
    83: data region reached 300000 times
/home/gskondras/cifar/cnn-cifar10_0/3.1.2-Data-pad-opt/layers.c
  load_conv  NVIDIA  devicenum=0
    time(us): 36
    300: update directive reached 3 times
        300: data copyin transfers: 6
             device time(us): total=36 max=13 min=3 avg=6
/home/gskondras/cifar/cnn-cifar10_0/3.1.2-Data-pad-opt/main.c
  main  NVIDIA  devicenum=0
    time(us): 2,263,957
    121: data region reached 1 time
        44: kernel launched 1 time
            grid: [391]  block: [128]
             device time(us): total=2 max=2 min=2 avg=2
            elapsed time(us): total=386 max=386 min=386 avg=386
        121: data copyin transfers: 1
             device time(us): total=96,212 max=96,212 min=96,212 avg=96,212
    181: data region reached 3 times
    188: update directive reached 50000 times
        188: data copyout transfers: 50000
             device time(us): total=950,644 max=50 min=18 avg=19
    196: update directive reached 50000 times
        196: data copyin transfers: 50000
             device time(us): total=301,067 max=19 min=5 avg=6
    200: update directive reached 50000 times
        200: data copyout transfers: 50000
             device time(us): total=456,513 max=20 min=8 avg=9
    208: update directive reached 50000 times
        208: data copyin transfers: 50000
             device time(us): total=157,550 max=9 min=3 avg=3
    212: update directive reached 50000 times
        212: data copyout transfers: 50000
             device time(us): total=301,969 max=19 min=5 avg=6
```
