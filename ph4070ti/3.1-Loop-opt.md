# Loop Opt, Conv_forward
## gang, vector
```
$ make
...
pad_input:
     60, Generating present(l[:],X[:])
         Generating NVIDIA GPU code
         62, #pragma acc loop gang /* blockIdx.x */
         64, #pragma acc loop seq
         66, #pragma acc loop vector(128) /* threadIdx.x */
     64, Loop is parallelizable
     66, Loop is parallelizable
conv_forward:
     82, Generating present(l[:])
         Generating copyout(Y[:l->out_size]) [if not already present]
         Generating copyin(X[:in_size]) [if not already present]
     83, Generating NVIDIA GPU code
         86, #pragma acc loop gang /* blockIdx.x */
         88, #pragma acc loop seq
         90, #pragma acc loop seq
         95, #pragma acc loop vector(128) /* threadIdx.x */
             Generating reduction(+:sum)
         96, #pragma acc loop seq
         97, #pragma acc loop seq
     88, Loop is parallelizable
     90, Loop is parallelizable
     95, Loop is parallelizable
     96, Loop is parallelizable
     97, Loop is parallelizable
    102, FMA (fused multiply-add) instruction(s) generated
...

$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Load Data time:0.369928 seconds
Create Network time:0.132898 seconds
Load Network Parameters time:0.003321 seconds
Create Ouputs time:0.000159 seconds

Net Forward total time:93.471340 seconds
    Time for conv1: 66.572305 seconds
    Time for relu1: 0.222943 seconds
    Time for pool1: 0.572499 seconds
    Time for conv2: 19.577683 seconds
    Time for relu2: 0.080437 seconds
    Time for pool2: 0.187900 seconds
    Time for conv3: 6.032097 seconds
    Time for relu3: 0.032145 seconds
    Time for pool3: 0.048958 seconds
    Time for fc: 0.123031 seconds
    Time for softmax: 0.006082 seconds

  Conv: 92.182085 seconds
  ReLU: 0.335525 seconds
  Pool: 0.809358 seconds
  FC:   0.123031 seconds
  Softmax: 0.006082 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000249 seconds
Free memory time:0.032211 seconds
Total time:94.010107 seconds
```
## gang, vector, worker
```
$ make
...
pad_input:
     60, Generating present(l[:],X[:])
         Generating NVIDIA GPU code
         62, #pragma acc loop gang /* blockIdx.x */
         64, #pragma acc loop seq
         66, #pragma acc loop vector(128) /* threadIdx.x */
     64, Loop is parallelizable
     66, Loop is parallelizable
conv_forward:
     82, Generating present(l[:])
         Generating copyout(Y[:l->out_size]) [if not already present]
         Generating copyin(X[:in_size]) [if not already present]
     83, Generating NVIDIA GPU code
         86, #pragma acc loop gang /* blockIdx.x */
         88, #pragma acc loop seq
         90, #pragma acc loop worker(4) /* threadIdx.y */
         95, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         96, #pragma acc loop seq
         97, #pragma acc loop seq
        104, Vector barrier inserted for vector loop reduction
     88, Loop is parallelizable
     90, Loop is parallelizable
     95, Loop is parallelizable
     96, Loop is parallelizable
     97, Loop is parallelizable
    102, FMA (fused multiply-add) instruction(s) generated
...
```

```
$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Load Data time:0.367611 seconds
Create Network time:0.124734 seconds
Load Network Parameters time:0.003360 seconds
Create Ouputs time:0.000166 seconds

Net Forward total time:28.475866 seconds
    Time for conv1: 16.592780 seconds
    Time for relu1: 0.220221 seconds
    Time for pool1: 0.577040 seconds
    Time for conv2: 7.563129 seconds
    Time for relu2: 0.081167 seconds
    Time for pool2: 0.187146 seconds
    Time for conv3: 3.032225 seconds
    Time for relu3: 0.029806 seconds
    Time for pool3: 0.048097 seconds
    Time for fc: 0.122946 seconds
    Time for softmax: 0.006099 seconds

  Conv: 27.188134 seconds
  ReLU: 0.331193 seconds
  Pool: 0.812283 seconds
  FC:   0.122946 seconds
  Softmax: 0.006099 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000253 seconds
Free memory time:0.030261 seconds
Total time:29.002251 seconds
```

## gang, worker collapse(2), vector
```
$ make
...
pad_input:
     60, Generating present(l[:],X[:])
         Generating NVIDIA GPU code
         62, #pragma acc loop gang /* blockIdx.x */
         64, #pragma acc loop seq
         66, #pragma acc loop vector(128) /* threadIdx.x */
     64, Loop is parallelizable
     66, Loop is parallelizable
conv_forward:
     82, Generating present(l[:])
         Generating copyout(Y[:l->out_size]) [if not already present]
         Generating copyin(X[:in_size]) [if not already present]
     83, Generating NVIDIA GPU code
         86, #pragma acc loop gang /* blockIdx.x */
         88, #pragma acc loop worker(4) collapse(2) /* threadIdx.y */
         90,   /* threadIdx.y collapsed */
         95, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         96, #pragma acc loop seq
         97, #pragma acc loop seq
        104, Vector barrier inserted for vector loop reduction
     88, Loop is parallelizable
     90, Loop is parallelizable
     95, Loop is parallelizable
     96, Loop is parallelizable
     97, Loop is parallelizable
    102, FMA (fused multiply-add) instruction(s) generated
...

$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Load Data time:0.367230 seconds
Create Network time:0.116404 seconds
Load Network Parameters time:0.003323 seconds
Create Ouputs time:0.000157 seconds

Net Forward total time:29.604962 seconds
    Time for conv1: 17.701766 seconds
    Time for relu1: 0.223916 seconds
    Time for pool1: 0.573317 seconds
    Time for conv2: 7.578199 seconds
    Time for relu2: 0.079089 seconds
    Time for pool2: 0.188012 seconds
    Time for conv3: 3.036754 seconds
    Time for relu3: 0.030900 seconds
    Time for pool3: 0.048202 seconds
    Time for fc: 0.123499 seconds
    Time for softmax: 0.006030 seconds

  Conv: 28.316720 seconds
  ReLU: 0.333905 seconds
  Pool: 0.809531 seconds
  FC:   0.123499 seconds
  Softmax: 0.006030 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000258 seconds
Free memory time:0.030165 seconds
Total time:30.122499 seconds
```

## gang collapse(2), worker, vector

```
$ make
...
pad_input:
     60, Generating present(l[:],X[:])
         Generating NVIDIA GPU code
         62, #pragma acc loop gang /* blockIdx.x */
         64, #pragma acc loop seq
         66, #pragma acc loop vector(128) /* threadIdx.x */
     64, Loop is parallelizable
     66, Loop is parallelizable
conv_forward:
     82, Generating present(l[:])
         Generating copyout(Y[:l->out_size]) [if not already present]
         Generating copyin(X[:in_size]) [if not already present]
     83, Generating NVIDIA GPU code
         86, #pragma acc loop gang collapse(2) /* blockIdx.x */
         88,   /* blockIdx.x collapsed */
         90, #pragma acc loop worker(4) /* threadIdx.y */
         95, #pragma acc loop vector(32) /* threadIdx.x */
             Generating reduction(+:sum)
         96, #pragma acc loop seq
         97, #pragma acc loop seq
        104, Vector barrier inserted for vector loop reduction
     90, Loop is parallelizable
     95, Loop is parallelizable
     96, Loop is parallelizable
     97, Loop is parallelizable
    102, FMA (fused multiply-add) instruction(s) generated
...

$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Load Data time:0.365715 seconds
Create Network time:0.122700 seconds
Load Network Parameters time:0.003327 seconds
Create Ouputs time:0.000158 seconds

Net Forward total time:8.322097 seconds
    Time for conv1: 3.260930 seconds
    Time for relu1: 0.218356 seconds
    Time for pool1: 0.573917 seconds
    Time for conv2: 2.314470 seconds
    Time for relu2: 0.075062 seconds
    Time for pool2: 0.188394 seconds
    Time for conv3: 1.466207 seconds
    Time for relu3: 0.030609 seconds
    Time for pool3: 0.048352 seconds
    Time for fc: 0.123657 seconds
    Time for softmax: 0.006811 seconds

  Conv: 7.041607 seconds
  ReLU: 0.324027 seconds
  Pool: 0.810662 seconds
  FC:   0.123657 seconds
  Softmax: 0.006811 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000265 seconds
Free memory time:0.029627 seconds
Total time:8.843890 seconds
```

## gang collapse(3), vector collapse(2)
!! Best performance, no vector barier -> no use of worker

```
$ make
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -c layers.c -o layers.o
make_conv_layer:
     42, Generating enter data copyin(layer[:1])
         Generating enter data create(layer->weights[:layer->weights_size])
         Generating enter data copyin(layer->in_padded[:layer->padded_size])
         Generating enter data create(layer->bias[:M])
free_conv:
     53, Generating exit data delete(l->bias[:l->out_depth],l->in_padded[:l->padded_size],l[:1],l->weights[:l->weights_size])
pad_input:
     60, Generating present(l[:],X[:])
         Generating NVIDIA GPU code
         62, #pragma acc loop gang /* blockIdx.x */
         64, #pragma acc loop seq
         66, #pragma acc loop vector(128) /* threadIdx.x */
     64, Loop is parallelizable
     66, Loop is parallelizable
conv_forward:
     82, Generating present(l[:])
         Generating copyout(Y[:l->out_size]) [if not already present]
         Generating copyin(X[:in_size]) [if not already present]
     83, Generating NVIDIA GPU code
         86, #pragma acc loop gang collapse(3) /* blockIdx.x */
         87,   /* blockIdx.x collapsed */
         89,   /* blockIdx.x collapsed */
         94, #pragma acc loop vector(32) collapse(2) /* threadIdx.x */
             Generating reduction(+:sum)
         95,   /* threadIdx.x collapsed */
         96, #pragma acc loop seq
     94, Loop is parallelizable
     95, Loop is parallelizable
     96, Loop is parallelizable
    101, FMA (fused multiply-add) instruction(s) generated
pool_forward:
    184, Zero trip check eliminated
fc_forward:
    239, FMA (fused multiply-add) instruction(s) generated
load_conv:
    301, Generating update device(l->weights[:l->weights_size],l->bias[:l->out_depth])
nvc -acc -Minfo=all -c11 -Wall -Wextra -march=native -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
gskondras@ph4070ti:~/cifar/cnn-cifar10_0/2.2-Data-pad$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Load Data time:0.368958 seconds
Create Network time:0.136932 seconds
Load Network Parameters time:0.003337 seconds
Create Ouputs time:0.000161 seconds

Net Forward total time:7.591493 seconds
    Time for conv1: 2.864526 seconds
    Time for relu1: 0.221736 seconds
    Time for pool1: 0.572139 seconds
    Time for conv2: 2.077245 seconds
    Time for relu2: 0.075605 seconds
    Time for pool2: 0.187883 seconds
    Time for conv3: 1.371806 seconds
    Time for relu3: 0.028304 seconds
    Time for pool3: 0.048267 seconds
    Time for fc: 0.122935 seconds
    Time for softmax: 0.005846 seconds

  Conv: 6.313577 seconds
  ReLU: 0.325644 seconds
  Pool: 0.808288 seconds
  FC:   0.122935 seconds
  Softmax: 0.005846 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000265 seconds
Free memory time:0.030851 seconds
Total time:8.131996 seconds
```