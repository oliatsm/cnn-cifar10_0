# Kernels Independent

## Code 
```c
46: void conv_forward(float* restrict X, Conv_Layer* l, float* restrict Y) {
  
    // For each output feature map
  #pragma acc kernels 
  {
    #pragma acc loop independent
    for (int m = 0; m < l->out_depth; m++) {
      #pragma acc loop independent
      for (int j = 0; j < l->out_height; j++) {
        #pragma acc loop independent
        for (int i = 0; i < l->out_width; i++) {
          int y_idx = i + (l->out_width * (j + m * l->out_height)); 
          // Calculate dot product of Weights*Input
          float sum = 0.0f;
          #pragma acc loop reduction(+:sum) 
          for (int c = 0; c < l->in_depth; c++) {
            for (int f_j = 0; f_j < l->filter_width; f_j++) {
              for (int f_i = 0; f_i < l->filter_width; f_i++) {
```

## Minfo

```
$ make
nvc -acc=gpu -gpu=managed -Minfo=all -c11 -Wall -Wextra -march=native  -c layers.c -o layers.o
conv_forward:
     50, Generating implicit copy(Y[:]) [if not already present]
         Generating implicit copyin(l,X[:]) [if not already present]
     52, Loop is parallelizable
         Generating NVIDIA GPU code
         52, #pragma acc loop gang, vector(128) /* blockIdx.x threadIdx.x */
         54, #pragma acc loop seq
         56, #pragma acc loop seq
         61, #pragma acc loop seq collapse(3)
         62,   auto-collapsed */
         63,   auto-collapsed */
     54, Loop is parallelizable
     56, Loop is parallelizable
     61, Loop is parallelizable
     62, Loop is parallelizable
     63, Loop is parallelizable
pool_forward:
    155, Zero trip check eliminated
fc_forward:
    210, FMA (fused multiply-add) instruction(s) generated
nvc -acc=gpu -gpu=managed -Minfo=all -c11 -Wall -Wextra -march=native  -o cnn-cifar10 main.o layers.o malloc2D.o timer.o
```

## Execution

```
$ ./cnn-cifar10 
Parallel (if) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.272896 seconds
Create Network time:0.000312 seconds
Load Network Parameters time:0.003304 seconds
Create Ouputs time:0.000273 seconds

Net Forward total time:409.086217 seconds
    Time for conv1: 131.702955 seconds
    Time for relu1: 8.351947 seconds
    Time for pool1: 3.743111 seconds
    Time for conv2: 197.052602 seconds
    Time for relu2: 6.056559 seconds
    Time for pool2: 1.315422 seconds
    Time for conv3: 55.188404 seconds
    Time for relu3: 4.169697 seconds
    Time for pool3: 0.379354 seconds
    Time for fc: 1.103756 seconds
    Time for softmax: 0.009819 seconds

  Conv: 383.943962 seconds
  ReLU: 18.578204 seconds
  Pool: 5.437888 seconds
  FC:   1.103756 seconds
  Softmax: 0.009819 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000277 seconds
Free memory time:0.016528 seconds
Total time:409.379807 seconds
END!
```

