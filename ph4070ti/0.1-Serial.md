# Serial Execution
## -Minfo
```
$ make
nvc -Minfo=all -c11 -Wall -Wextra -march=native -c main_serial.c -o main_serial.o
nvc -Minfo=all -c11 -Wall -Wextra -march=native -c layers_serial.c -o layers_serial.o
conv_forward:
     62, FMA (fused multiply-add) instruction(s) generated
fc_forward:
    201, FMA (fused multiply-add) instruction(s) generated
nvc -Minfo=all -c11 -Wall -Wextra -march=native -c malloc2D.c -o malloc2D.o
nvc -Minfo=all -c11 -Wall -Wextra -march=native -c timer.c -o timer.o
cpu_timer_stop:
     11, FMA (fused multiply-add) instruction(s) generated
nvc -Minfo=all -c11 -Wall -Wextra -march=native -o cnn-cifar10-serial main_serial.o layers_serial.o malloc2D.o timer.o
```

## Execution
```
$ ./cnn-cifar10-serial 
Serial Code
CNN for 50000 images
Load Data time:0.540534 seconds
Create Network time:0.000006 seconds
Load Network Parameters time:0.003323 seconds
Create Ouputs time:0.000252 seconds

Net Forward total time:751.865668 seconds
    Time for conv1: 244.149581 seconds
    Time for relu1: 3.200438 seconds
    Time for pool1: 3.355876 seconds
    Time for conv2: 385.739643 seconds
    Time for relu2: 0.916781 seconds
    Time for pool2: 0.993138 seconds
    Time for conv3: 112.546422 seconds
    Time for relu3: 0.244944 seconds
    Time for pool3: 0.258361 seconds
    Time for fc: 0.439608 seconds
    Time for softmax: 0.008307 seconds

  Conv: 742.435646 seconds
  ReLU: 4.362163 seconds
  Pool: 4.607375 seconds
  FC:   0.439608 seconds
  Softmax: 0.008307 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001710 seconds
Free memory time:0.039750 seconds
Total time:752.451243 seconds
```

## GProf

```
$ ./cnn-cifar10-serial-profile 
Serial Code
CNN for 50000 images
Load Data time:0.538620 seconds
Create Network time:0.000006 seconds
Load Network Parameters time:0.003312 seconds
Create Ouputs time:0.000252 seconds

Net Forward total time:792.083721 seconds
    Time for conv1: 257.857886 seconds
    Time for relu1: 3.017700 seconds
    Time for pool1: 3.371451 seconds
    Time for conv2: 406.165904 seconds
    Time for relu2: 0.859824 seconds
    Time for pool2: 1.006675 seconds
    Time for conv3: 118.838808 seconds
    Time for relu3: 0.229953 seconds
    Time for pool3: 0.271156 seconds
    Time for fc: 0.439602 seconds
    Time for softmax: 0.009686 seconds

  Conv: 782.862598 seconds
  ReLU: 4.107478 seconds
  Pool: 4.649283 seconds
  FC:   0.439602 seconds
  Softmax: 0.009686 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.001717 seconds
Free memory time:0.040406 seconds
Total time:792.668035 seconds
END!

$ gprof ./cnn-cifar10-serial -b
Flat profile:

Each sample counts as 0.01 seconds.
  %   cumulative   self              self     total           
 time   seconds   seconds    calls   s/call   s/call  name    
 98.43    780.10   780.10        3   260.03   260.03  conv_forward
  0.58    784.71     4.61        3     1.54     1.54  pool_forward
  0.35    787.46     2.75                             free_conv
  0.27    789.58     2.12        3     0.71     0.71  relu_forward
  0.26    791.67     2.09   150000     0.00     0.00  make_relu_layer
  0.06    792.18     0.51        1     0.51     0.51  load_data
  0.04    792.53     0.35        1     0.35     0.35  fc_forward
  0.00    792.55     0.02   150000     0.00     0.00  make_pool_layer
  0.00    792.55     0.00   550007     0.00     0.00  cpu_timer_start
  0.00    792.55     0.00   550007     0.00     0.00  malloc2D
  0.00    792.55     0.00   150003     0.00     0.00  make_conv_layer
  0.00    792.55     0.00    50000     0.00     0.00  make_fc_layer
  0.00    792.55     0.00    50000     0.00     0.00  make_softmax_layer
  0.00    792.55     0.00        3     0.00     0.00  arr2txt_2
  0.00    792.55     0.00        3     0.00     0.00  free_fc
  0.00    792.55     0.00        3     0.00     0.00  free_relu
  0.00    792.55     0.00        2     0.00     0.00  free_softmax
  0.00    792.55     0.00        1     0.00     0.00  free_pool
  0.00    792.55     0.00        1     0.00     0.00  load_conv
  0.00    792.55     0.00        1     0.00     0.00  load_fc
  0.00    792.55     0.00        1     0.00     0.00  softmax_forward


                        Call graph


granularity: each sample hit covers 4 byte(s) for 0.00% of 792.55 seconds

index % time    self  children    called     name
                                                 <spontaneous>
[1]     99.7    0.00  789.80                 main [1]
              780.10    0.00       3/3           conv_forward [2]
                4.61    0.00       3/3           pool_forward [3]
                2.12    0.00       3/3           relu_forward [5]
                2.09    0.00  150000/150000      make_relu_layer [6]
                0.51    0.00       1/1           load_data [7]
                0.35    0.00       1/1           fc_forward [8]
                0.02    0.00  150000/150000      make_pool_layer [9]
                0.00    0.00  550007/550007      malloc2D [11]
                0.00    0.00  550007/550007      cpu_timer_start [10]
                0.00    0.00  150003/150003      make_conv_layer [12]
                0.00    0.00   50000/50000       make_fc_layer [13]
                0.00    0.00   50000/50000       make_softmax_layer [14]
                0.00    0.00       3/3           arr2txt_2 [15]
                0.00    0.00       3/3           free_relu [17]
                0.00    0.00       3/3           free_fc [16]
                0.00    0.00       2/2           free_softmax [18]
                0.00    0.00       1/1           free_pool [19]
                0.00    0.00       1/1           load_fc [21]
                0.00    0.00       1/1           load_conv [20]
                0.00    0.00       1/1           softmax_forward [22]
-----------------------------------------------
              780.10    0.00       3/3           main [1]
[2]     98.4  780.10    0.00       3         conv_forward [2]
-----------------------------------------------
                4.61    0.00       3/3           main [1]
[3]      0.6    4.61    0.00       3         pool_forward [3]
-----------------------------------------------
                                                 <spontaneous>
[4]      0.3    2.75    0.00                 free_conv [4]
-----------------------------------------------
                2.12    0.00       3/3           main [1]
[5]      0.3    2.12    0.00       3         relu_forward [5]
-----------------------------------------------
                2.09    0.00  150000/150000      main [1]
[6]      0.3    2.09    0.00  150000         make_relu_layer [6]
-----------------------------------------------
                0.51    0.00       1/1           main [1]
[7]      0.1    0.51    0.00       1         load_data [7]
-----------------------------------------------
                0.35    0.00       1/1           main [1]
[8]      0.0    0.35    0.00       1         fc_forward [8]
-----------------------------------------------
                0.02    0.00  150000/150000      main [1]
[9]      0.0    0.02    0.00  150000         make_pool_layer [9]
-----------------------------------------------
                0.00    0.00  550007/550007      main [1]
[10]     0.0    0.00    0.00  550007         cpu_timer_start [10]
-----------------------------------------------
                0.00    0.00  550007/550007      main [1]
[11]     0.0    0.00    0.00  550007         malloc2D [11]
-----------------------------------------------
                0.00    0.00  150003/150003      main [1]
[12]     0.0    0.00    0.00  150003         make_conv_layer [12]
-----------------------------------------------
                0.00    0.00   50000/50000       main [1]
[13]     0.0    0.00    0.00   50000         make_fc_layer [13]
-----------------------------------------------
                0.00    0.00   50000/50000       main [1]
[14]     0.0    0.00    0.00   50000         make_softmax_layer [14]
-----------------------------------------------
                0.00    0.00       3/3           main [1]
[15]     0.0    0.00    0.00       3         arr2txt_2 [15]
-----------------------------------------------
                0.00    0.00       3/3           main [1]
[16]     0.0    0.00    0.00       3         free_fc [16]
-----------------------------------------------
                0.00    0.00       3/3           main [1]
[17]     0.0    0.00    0.00       3         free_relu [17]
-----------------------------------------------
                0.00    0.00       2/2           main [1]
[18]     0.0    0.00    0.00       2         free_softmax [18]
-----------------------------------------------
                0.00    0.00       1/1           main [1]
[19]     0.0    0.00    0.00       1         free_pool [19]
-----------------------------------------------
                0.00    0.00       1/1           main [1]
[20]     0.0    0.00    0.00       1         load_conv [20]
-----------------------------------------------
                0.00    0.00       1/1           main [1]
[21]     0.0    0.00    0.00       1         load_fc [21]
-----------------------------------------------
                0.00    0.00       1/1           main [1]
[22]     0.0    0.00    0.00       1         softmax_forward [22]
-----------------------------------------------


Index by function name

  [15] arr2txt_2              [17] free_relu               [9] make_pool_layer
   [2] conv_forward           [18] free_softmax            [6] make_relu_layer
  [10] cpu_timer_start        [20] load_conv              [14] make_softmax_layer
   [8] fc_forward              [7] load_data              [11] malloc2D
   [4] free_conv              [21] load_fc                 [3] pool_forward
  [16] free_fc                [12] make_conv_layer         [5] relu_forward
  [19] free_pool              [13] make_fc_layer          [22] softmax_forward
```

---
# Final acceleration

```
serial2parallel-3.2-full$ ./cnn-cifar10 
Parallel (pad) Code
CNN for 50000 images
Loading input batch 1...
Loading input batch 2...
Loading input batch 3...
Loading input batch 4...
Loading input batch 5...
Load Data time:0.612413 seconds
Create Network time:0.000247 seconds
Load Network Parameters time:0.003377 seconds
Create Ouputs time:0.000169 seconds

Net Forward total time:7.108899 seconds
    Time for conv1: 1.403592 seconds
    Time for relu1: 0.470102 seconds
    Time for pool1: 0.460670 seconds
    Time for conv2: 1.076372 seconds
    Time for relu2: 0.356371 seconds
    Time for pool2: 0.365225 seconds
    Time for conv3: 0.775531 seconds
    Time for relu3: 0.325080 seconds
    Time for pool3: 0.334027 seconds
    Time for fc: 0.348964 seconds
    Time for softmax: 1.176221 seconds

  Conv: 3.255494 seconds
  ReLU: 1.151553 seconds
  Pool: 1.159922 seconds
  FC:   0.348964 seconds
  Softmax: 1.176221 seconds

Net Accuracy: 78.84 % 
Net Accuracy time:0.000247 seconds
Free memory time:0.040184 seconds
Total time:7.765537 seconds
END!
```